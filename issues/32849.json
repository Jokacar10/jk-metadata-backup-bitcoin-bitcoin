{
  "type": "issue",
  "issue": {
    "id": 3192609044,
    "node_id": "I_kwDOABII586-S1kU",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32849",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32849/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32849/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32849/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32849",
    "number": 32849,
    "state": "open",
    "state_reason": null,
    "title": "Internal bug detected: FinalizeAndExtractPSBT(psbtx_copy, mtx)",
    "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\n```\nbitcoin-cli -testnet4 descriptorprocesspsbt cHNidP8BAF4CAAAAAfrAU8xRZDY7er/kAUGzVtup++LN4otxeOtANj9Tw8xYAAAAAAD9////AeAPlwAAAAAAIlEgmQIRpk7kW78uK6z/DBX37H4Pi4OLy3Fau0pXquQSXLUAAAAAAAEBK4CWmAAAAAAAIlEg5cugS+vKVwm3OSTEr0sIVU/ahEJzIS6iXjsvWNwJ0VUBAwSDAAAAAQhDAUFATOMkSjzzD+7k1AnzZgJ+G+sDZXX5ob0tlQ9mZIseDe73u4fU6SPKdtxve2Wm/mVNrRIP5cPEnkcMv0BJ2iIWgyEWtJa/uuFJh4F8U9WSvgqmbEXHuURDwfdFUTc/nONNI0YZAP/2NCNWAACAAAAAgAAAAIAAAAAAAAAAAAEXILSWv7rhSYeBfFPVkr4KpmxFx7lEQ8H3RVE3P5zjTSNGAAA= \"[\\\"tr([fff63423/86'/0'/0']tpubDDfvptb1GNdu4TRUUNf9bwsFFpHADAmwaB3uoC8ukv5JMsYPzEc3E6yg4w8t49Wq7jtL8LC3VPmuhXoSJxpamWDPfphAz3Fioki3WerwH3Y/0/0)#twc4a4lc\\\"]\"\nerror code: -1\nerror message:\nInternal bug detected: FinalizeAndExtractPSBT(psbtx_copy, mtx)\nrpc/rawtransaction.cpp:1986 (operator())\nBitcoin Core v29.0.0\nPlease report this issue here: https://github.com/bitcoin/bitcoin/issues\n```\n\n### Expected behaviour\n\nThis should give an error maybe stating that the signature inside the final_scriptwitness is an invalid schnorr signature.\nPlease note that the signature inside the psbt uses SIGHASH_SINGLE | ANYONECANPAY flag\n\n\n### Steps to reproduce\n\nThe same command should work on any local regtest or testnet4.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\nv29.0.0\n\n### Operating system and version\n\nmacOS Sequoia 15.1.1\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "ekrembal",
      "id": 29926881,
      "node_id": "MDQ6VXNlcjI5OTI2ODgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/29926881?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekrembal",
      "html_url": "https://github.com/ekrembal",
      "followers_url": "https://api.github.com/users/ekrembal/followers",
      "following_url": "https://api.github.com/users/ekrembal/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ekrembal/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ekrembal/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ekrembal/subscriptions",
      "organizations_url": "https://api.github.com/users/ekrembal/orgs",
      "repos_url": "https://api.github.com/users/ekrembal/repos",
      "events_url": "https://api.github.com/users/ekrembal/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ekrembal/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 98279177,
        "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
        "name": "RPC/REST/ZMQ",
        "color": "0052cc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 2,
    "created_at": "2025-07-01T13:57:25Z",
    "updated_at": "2025-07-16T04:28:47Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 3026550370,
      "node_id": "IC_kwDOABII5860ZX5i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3026550370",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-02T05:55:14Z",
      "updated_at": "2025-07-02T05:55:14Z",
      "author_association": "MEMBER",
      "body": "uploaded to oss-fuzz (https://issues.oss-fuzz.com/issues/429003360) to get a regression range: https://github.com/bitcoin/bitcoin/compare/b000ed5ee54438efb72e190262faeb535489d35d...ac9fa6ec78158e41006d621ee62e44dec0f934c0 (exists since the beginning, when the line was added)",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32849#issuecomment-3026550370",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32849"
    },
    {
      "event": "labeled",
      "id": 18424736925,
      "node_id": "LE_lADOABII586-S1kUzwAAAARKMyyd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18424736925",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-02T05:55:21Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "labeled",
      "id": 18424736932,
      "node_id": "LE_lADOABII586-S1kUzwAAAARKMyyk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18424736932",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-02T05:55:21Z",
      "label": {
        "name": "RPC/REST/ZMQ",
        "color": "0052cc"
      }
    },
    {
      "event": "commented",
      "id": 3038398123,
      "node_id": "IC_kwDOABII5861Gkar",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3038398123",
      "actor": {
        "login": "b-l-u-e",
        "id": 32414660,
        "node_id": "MDQ6VXNlcjMyNDE0NjYw",
        "avatar_url": "https://avatars.githubusercontent.com/u/32414660?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/b-l-u-e",
        "html_url": "https://github.com/b-l-u-e",
        "followers_url": "https://api.github.com/users/b-l-u-e/followers",
        "following_url": "https://api.github.com/users/b-l-u-e/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/b-l-u-e/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/b-l-u-e/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/b-l-u-e/subscriptions",
        "organizations_url": "https://api.github.com/users/b-l-u-e/orgs",
        "repos_url": "https://api.github.com/users/b-l-u-e/repos",
        "events_url": "https://api.github.com/users/b-l-u-e/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/b-l-u-e/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-05T07:48:31Z",
      "updated_at": "2025-07-05T07:48:31Z",
      "author_association": "NONE",
      "body": "Hi @ekrembal,\n\nI've analyzed this issue. The \"Internal bug detected\" error occurs because `descriptorprocesspsbt` uses `PSBTInputSigned()` which only checks for signature **presence**, not **validity**.\n\n### Root Cause\nIn `src/rpc/rawtransaction.cpp` around lines 2092-2094:\n```cpp\nbool complete = true;\nfor (const auto& input : psbtx.inputs) {\n    complete &= PSBTInputSigned(input);  // ❌ Only checks presence, not validity\n}\n```\n\nWhen `complete` is `true`, the code calls `CHECK_NONFATAL(FinalizeAndExtractPSBT(...))`, but `FinalizeAndExtractPSBT` eventually fails signature verification, causing the internal bug.\n\n### Suggestion fix\nReplace with `PSBTInputSignedAndVerified` to actually verify signatures:\n```cpp\nbool complete = true;\nconst PrecomputedTransactionData txdata = PrecomputePSBTData(psbtx);\nfor (unsigned int i = 0; i < psbtx.inputs.size(); ++i) {\n    complete &= PSBTInputSignedAndVerified(psbtx, i, &txdata);\n}\n```\n\n### Test Results\nAfter implementing the fix, the problematic PSBT returns:\n```json\n{\n  \"psbt\": \"cHNidP8BAF4CAAAAAfrAU8xRZDY7er/kAUGzVtup++LN4otxeOtANj9Tw8xYAAAAAAD9////AeAPlwAAAAAAIlEgmQIRpk7kW78uK6z/DBX37H4Pi4OLy3Fau0pXquQSXLUAAAAAAAEBK4CWmAAAAAAAIlEg5cugS+vKVwm3OSTEr0sIVU/ahEJzIS6iXjsvWNwJ0VUBCEMBQUBM4yRKPPMP7uTUCfNmAn4b6wNldfmhvS2VD2Zkix4N7ve7h9TpI8p23G97Zab+ZU2tEg/lw8SeRwy/QEnaIhaDAAA=\",\n  \"complete\": false\n}\n```",
      "user": {
        "login": "b-l-u-e",
        "id": 32414660,
        "node_id": "MDQ6VXNlcjMyNDE0NjYw",
        "avatar_url": "https://avatars.githubusercontent.com/u/32414660?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/b-l-u-e",
        "html_url": "https://github.com/b-l-u-e",
        "followers_url": "https://api.github.com/users/b-l-u-e/followers",
        "following_url": "https://api.github.com/users/b-l-u-e/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/b-l-u-e/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/b-l-u-e/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/b-l-u-e/subscriptions",
        "organizations_url": "https://api.github.com/users/b-l-u-e/orgs",
        "repos_url": "https://api.github.com/users/b-l-u-e/repos",
        "events_url": "https://api.github.com/users/b-l-u-e/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/b-l-u-e/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32849#issuecomment-3038398123",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32849"
    },
    {
      "event": "mentioned",
      "id": 18482228013,
      "node_id": "MEE_lADOABII586-S1kUzwAAAARNoGst",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18482228013",
      "actor": {
        "login": "ekrembal",
        "id": 29926881,
        "node_id": "MDQ6VXNlcjI5OTI2ODgx",
        "avatar_url": "https://avatars.githubusercontent.com/u/29926881?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ekrembal",
        "html_url": "https://github.com/ekrembal",
        "followers_url": "https://api.github.com/users/ekrembal/followers",
        "following_url": "https://api.github.com/users/ekrembal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ekrembal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ekrembal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ekrembal/subscriptions",
        "organizations_url": "https://api.github.com/users/ekrembal/orgs",
        "repos_url": "https://api.github.com/users/ekrembal/repos",
        "events_url": "https://api.github.com/users/ekrembal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ekrembal/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-05T07:48:32Z"
    },
    {
      "event": "subscribed",
      "id": 18482228018,
      "node_id": "SE_lADOABII586-S1kUzwAAAARNoGsy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18482228018",
      "actor": {
        "login": "ekrembal",
        "id": 29926881,
        "node_id": "MDQ6VXNlcjI5OTI2ODgx",
        "avatar_url": "https://avatars.githubusercontent.com/u/29926881?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ekrembal",
        "html_url": "https://github.com/ekrembal",
        "followers_url": "https://api.github.com/users/ekrembal/followers",
        "following_url": "https://api.github.com/users/ekrembal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ekrembal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ekrembal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ekrembal/subscriptions",
        "organizations_url": "https://api.github.com/users/ekrembal/orgs",
        "repos_url": "https://api.github.com/users/ekrembal/repos",
        "events_url": "https://api.github.com/users/ekrembal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ekrembal/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-05T07:48:32Z"
    },
    {
      "event": "user_blocked",
      "id": 18650874449,
      "node_id": "UBE_lADOABII586-S1kUzwAAAARXrcJR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18650874449",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-16T04:28:41Z"
    },
    {
      "event": "comment_deleted",
      "id": 18650875225,
      "node_id": "CDE_lADOABII586-S1kUzwAAAARXrcVZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18650875225",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-16T04:28:46Z"
    }
  ]
}