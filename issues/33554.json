{
  "type": "issue",
  "issue": {
    "id": 3489318431,
    "node_id": "I_kwDOABII587P-sYf",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33554",
    "number": 33554,
    "state": "open",
    "state_reason": null,
    "title": "[`v30.0rc3`]`bitcoin-node` aborts with mining IPC interface usage",
    "body": "this is similar to #33463 cc @ryanofsky \n\nhowever there's no usage of `waitTipChanged`, only `waitNext`... and the proble is not that `bitcoin-node` is unkillable, but that it aborts\n\nsteps to reproduce:\n- build `bitcoin-node` from `v30.0rc3` tag\n- clone https://github.com/plebhash/sv2-bitcoin-core\n- check out `2025-10-06-abort-proxy-io` branch\n- launch `bitcoin-node` with `-ipc-bind=unix`\n- launch `sv2-bitcoin-core` with `cargo run --example logger \"/path/to/node.sock\"`\n\nhere's a stack trace of `bitcoin-node` with a failed assertion at file `proxy-io.h`, line 289:\n\nhttps://pastebin.com/uugSA6cD\n\nand another one with a failed assertion at file `proxy.h`, line 59:\n\nhttps://pastebin.com/g2NBei2n\n\n(exceeds 65536 characters so github doesn't allow me to paste here, I hope I'm not violating any rules)",
    "user": {
      "login": "plebhash",
      "id": 147345153,
      "node_id": "U_kgDOCMhPAQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/147345153?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/plebhash",
      "html_url": "https://github.com/plebhash",
      "followers_url": "https://api.github.com/users/plebhash/followers",
      "following_url": "https://api.github.com/users/plebhash/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/plebhash/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/plebhash/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/plebhash/subscriptions",
      "organizations_url": "https://api.github.com/users/plebhash/orgs",
      "repos_url": "https://api.github.com/users/plebhash/repos",
      "events_url": "https://api.github.com/users/plebhash/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/plebhash/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 2260068353,
        "node_id": "MDU6TGFiZWwyMjYwMDY4MzUz",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/interfaces",
        "name": "interfaces",
        "description": "",
        "color": "83c9fc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 3,
    "created_at": "2025-10-06T22:20:25Z",
    "updated_at": "2025-10-07T08:45:23Z"
  },
  "events": [
    {
      "event": "mentioned",
      "id": 20128114302,
      "node_id": "MEE_lADOABII587P-sYfzwAAAASvuqZ-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20128114302",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-06T22:20:26Z"
    },
    {
      "event": "subscribed",
      "id": 20128114323,
      "node_id": "SE_lADOABII587P-sYfzwAAAASvuqaT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20128114323",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-06T22:20:26Z"
    },
    {
      "event": "commented",
      "id": 3374530494,
      "node_id": "IC_kwDOABII587JIz--",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3374530494",
      "actor": {
        "login": "plebhash",
        "id": 147345153,
        "node_id": "U_kgDOCMhPAQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/147345153?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/plebhash",
        "html_url": "https://github.com/plebhash",
        "followers_url": "https://api.github.com/users/plebhash/followers",
        "following_url": "https://api.github.com/users/plebhash/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/plebhash/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/plebhash/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/plebhash/subscriptions",
        "organizations_url": "https://api.github.com/users/plebhash/orgs",
        "repos_url": "https://api.github.com/users/plebhash/repos",
        "events_url": "https://api.github.com/users/plebhash/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/plebhash/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-06T22:45:43Z",
      "updated_at": "2025-10-06T22:45:43Z",
      "author_association": "NONE",
      "body": "also reproducible on `v30-0rc1` tag",
      "user": {
        "login": "plebhash",
        "id": 147345153,
        "node_id": "U_kgDOCMhPAQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/147345153?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/plebhash",
        "html_url": "https://github.com/plebhash",
        "followers_url": "https://api.github.com/users/plebhash/followers",
        "following_url": "https://api.github.com/users/plebhash/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/plebhash/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/plebhash/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/plebhash/subscriptions",
        "organizations_url": "https://api.github.com/users/plebhash/orgs",
        "repos_url": "https://api.github.com/users/plebhash/repos",
        "events_url": "https://api.github.com/users/plebhash/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/plebhash/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33554#issuecomment-3374530494",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554"
    },
    {
      "event": "commented",
      "id": 3374565734,
      "node_id": "IC_kwDOABII587JI8lm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3374565734",
      "actor": {
        "login": "plebhash",
        "id": 147345153,
        "node_id": "U_kgDOCMhPAQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/147345153?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/plebhash",
        "html_url": "https://github.com/plebhash",
        "followers_url": "https://api.github.com/users/plebhash/followers",
        "following_url": "https://api.github.com/users/plebhash/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/plebhash/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/plebhash/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/plebhash/subscriptions",
        "organizations_url": "https://api.github.com/users/plebhash/orgs",
        "repos_url": "https://api.github.com/users/plebhash/repos",
        "events_url": "https://api.github.com/users/plebhash/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/plebhash/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-06T22:57:55Z",
      "updated_at": "2025-10-06T22:57:55Z",
      "author_association": "NONE",
      "body": "one relevant detail here is that our rust code has evolved from what it looked like when I first reported https://github.com/bitcoin/bitcoin/issues/33463, and there I did not witness this behavior\n\nnow, every 10s, we receive a Sv2 [`CoinbaseOutputConstraints`](https://github.com/stratum-mining/sv2-spec/blob/main/07-Template-Distribution-Protocol.md#71-coinbaseoutputconstraints-client---server) message, which is meant to set the coinbase parameters with regards to blockspace consumption (weight and sigops)\n\nso everytime this message arrives, we create a fresh new `BlockTemplate` IPC client with those new parameters\n\nwe do not call `destroy` on the previous one, because we don't know if we could still receive a [`submitSolution`](https://github.com/stratum-mining/sv2-spec/blob/main/07-Template-Distribution-Protocol.md#77-submitsolution-client---server) associated with a template that was generated from it\n\nso we keep clones of past `BlockTemplate` IPC client in memory (as many clones as templates generated from the same instance) and drop them all whenever there's a new chain tip (also without calling `destroy`)",
      "user": {
        "login": "plebhash",
        "id": 147345153,
        "node_id": "U_kgDOCMhPAQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/147345153?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/plebhash",
        "html_url": "https://github.com/plebhash",
        "followers_url": "https://api.github.com/users/plebhash/followers",
        "following_url": "https://api.github.com/users/plebhash/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/plebhash/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/plebhash/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/plebhash/subscriptions",
        "organizations_url": "https://api.github.com/users/plebhash/orgs",
        "repos_url": "https://api.github.com/users/plebhash/repos",
        "events_url": "https://api.github.com/users/plebhash/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/plebhash/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33554#issuecomment-3374565734",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554"
    },
    {
      "event": "commented",
      "id": 3374751529,
      "node_id": "IC_kwDOABII587JJp8p",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3374751529",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-07T00:44:15Z",
      "updated_at": "2025-10-07T00:44:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "(So far I'm not able to reproduce a crash with v30.0rc3, but that might just be because I was testing with regtest.)\n\nThe assert you see happening on [line 289](https://github.com/bitcoin-core/libmultiprocess/blob/13424cf2ecc1e5eadc85556cf1f4c65e915f702a/include/mp/proxy-io.h#L289) just happens when the IPC client asks the server to execute multiple IPC calls simultaneously on the same thread. The IPC server does not expect this and currently aborts when it happens.\n\nIt is possible for the server to execute multiple IPC calls simultaneously, but the client needs to create more than one thread thread with [ThreadMap.makeThread](https://github.com/plebhash/sv2-bitcoin-core/blob/93fd9dcf1baf8d8897bcd34e4f4cb86d0616cc19/src/lib.rs#L136-L140) and [assign](https://github.com/plebhash/sv2-bitcoin-core/blob/93fd9dcf1baf8d8897bcd34e4f4cb86d0616cc19/src/lib.rs#L283) different threads to the IPC calls that are supposed to execute simultaneously.\n\nThe server is pretty fragile and unhelpful for failing this way, but a recently merged PR https://github.com/bitcoin-core/libmultiprocess/pull/214 should make the situation better by having the server return with a \"thread busy\" error instead of aborting when this happens.\n\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33554#issuecomment-3374751529",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33554"
    },
    {
      "event": "labeled",
      "id": 20135472998,
      "node_id": "LE_lADOABII587P-sYfzwAAAASwKu9m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20135472998",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-07T08:45:23Z",
      "label": {
        "name": "interfaces",
        "color": "83c9fc"
      }
    }
  ]
}