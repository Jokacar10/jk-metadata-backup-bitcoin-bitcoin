{
  "type": "issue",
  "issue": {
    "id": 2807733549,
    "node_id": "I_kwDOABII586nWp0t",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31728",
    "number": 31728,
    "state": "open",
    "state_reason": null,
    "title": "Bug: Non-Ranged Descriptors with Range [0,0] Trigger Unexpected Wallet Errors in `AddWalletDescriptor`",
    "body": "**Summary:**\n\nWhen attempting to add a **non-ranged** descriptor with a start/end range of `[0,0]` via `AddWalletDescriptor`, an error may appear:  \n```\nUpdateWalletDescriptor: new range must include current range = [0,0].\n```\nThis is unexpected for a non-ranged descriptor, as `[0,0]` should effectively mean “no range.” In some cases, changing the end to `1` (i.e. `[0,1]`) circumvents the issue, but that implies a single-index range rather than a truly non-ranged descriptor.\n\nFurther debugging revealed this seems tied to:\n1. **Multiple calls** to `AddWalletDescriptor` for the same descriptor.\n2. **Internal handling of descriptor ranges** (the wallet expects a valid range for ranged descriptors, but still enforces checks on `start/end` even if the descriptor is meant to be non-ranged).\n3. A possible **bug in `UpdateWalletDescriptor`** when it encounters repeated or zero-width ranges.\n\n**What was expected:**\n- Specifying `[0,0]` for a non-ranged descriptor (or not specifying a range at all) should *not* fail.\n- A truly non-ranged descriptor should not require these range checks.\n- `AddWalletDescriptor` should be idempotent\n\n**What actually happens:**\n- Repeatedly adding a descriptor (or calling it in a way that triggers `UpdateWalletDescriptor`) with `[0,0]` can cause the wallet to complain that the “new range must include current range = [0,0]”.\n\n**Why this matters:**\n- Non-ranged descriptor workflows should be consistent and should not require a dummy range.\n- The wallet code should either cleanly ignore range parameters for non-ranged descriptors or handle a `[0,0]` range gracefully.\n\n**Proposed fix or investigation:**\n- Review `AddWalletDescriptor` and `UpdateWalletDescriptor` logic to ensure zero-width (`[0,0]`) or absent ranges are handled properly for non-ranged descriptors.\n- Confirm if the internal code should treat `[0,0]` as a valid non-ranged descriptor or if that scenario should simply be disallowed/ignored in favor of no range parameters at all.\n- Add tests to cover repeatedly adding the same descriptor and verifying correct behavior for non-ranged descriptors.\n- Change the wallet::WalletDescriptor to have `std::optional<std::pair<start,end>>` to differentiate unranged v.s. empty ranged descriptors.\n\nThis appears to be a minor bug, but it can lead to confusion and error messages when using or experimenting with non-ranged descriptors in custom wallet workflows.",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 3,
    "created_at": "2025-01-23T19:25:03Z",
    "updated_at": "2025-03-09T17:11:38Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 16049439343,
      "node_id": "LE_lADOABII586nWp0tzwAAAAO8nwJv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16049439343",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-23T20:24:20Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "comment_deleted",
      "id": 16061586991,
      "node_id": "CDE_lADOABII586nWp0tzwAAAAO9WF4v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16061586991",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-24T17:15:52Z"
    },
    {
      "event": "subscribed",
      "id": 16163559973,
      "node_id": "SE_lADOABII586nWp0tzwAAAAPDbFol",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16163559973",
      "actor": {
        "login": "emc99",
        "id": 20481828,
        "node_id": "MDQ6VXNlcjIwNDgxODI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/20481828?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/emc99",
        "html_url": "https://github.com/emc99",
        "followers_url": "https://api.github.com/users/emc99/followers",
        "following_url": "https://api.github.com/users/emc99/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/emc99/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/emc99/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/emc99/subscriptions",
        "organizations_url": "https://api.github.com/users/emc99/orgs",
        "repos_url": "https://api.github.com/users/emc99/repos",
        "events_url": "https://api.github.com/users/emc99/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/emc99/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-03T14:44:58Z"
    },
    {
      "event": "commented",
      "id": 2696014125,
      "node_id": "IC_kwDOABII586gsekt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2696014125",
      "actor": {
        "login": "asklokesh",
        "id": 49921737,
        "node_id": "MDQ6VXNlcjQ5OTIxNzM3",
        "avatar_url": "https://avatars.githubusercontent.com/u/49921737?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/asklokesh",
        "html_url": "https://github.com/asklokesh",
        "followers_url": "https://api.github.com/users/asklokesh/followers",
        "following_url": "https://api.github.com/users/asklokesh/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/asklokesh/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/asklokesh/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/asklokesh/subscriptions",
        "organizations_url": "https://api.github.com/users/asklokesh/orgs",
        "repos_url": "https://api.github.com/users/asklokesh/repos",
        "events_url": "https://api.github.com/users/asklokesh/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/asklokesh/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-04T02:23:42Z",
      "updated_at": "2025-03-09T17:11:38Z",
      "author_association": "NONE",
      "body": "I've investigated this issue and have a fix for the uninitialized `subtype` variable in `LoadWalletFlags()`.\n\nThe bug occurs because `subtype` is being used for version compatibility checks but may remain uninitialized if the data stream doesn't contain subtype information.\n\n**Fix approach:**\n1. Initialize `subtype` with a safe default value (`DBWrapperSubType::UNKNOWN`) at declaration\n2. Ensure all code paths properly set `subtype` with explicit handling for cases where:\n   - The stream contains only flags with no subtype\n   - The subtype value is out of the valid range\n\nThis approach maintains backward compatibility while preventing potential undefined behavior when reading older wallet formats. I'll submit a PR with this fix shortly.",
      "user": {
        "login": "asklokesh",
        "id": 49921737,
        "node_id": "MDQ6VXNlcjQ5OTIxNzM3",
        "avatar_url": "https://avatars.githubusercontent.com/u/49921737?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/asklokesh",
        "html_url": "https://github.com/asklokesh",
        "followers_url": "https://api.github.com/users/asklokesh/followers",
        "following_url": "https://api.github.com/users/asklokesh/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/asklokesh/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/asklokesh/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/asklokesh/subscriptions",
        "organizations_url": "https://api.github.com/users/asklokesh/orgs",
        "repos_url": "https://api.github.com/users/asklokesh/repos",
        "events_url": "https://api.github.com/users/asklokesh/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/asklokesh/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31728#issuecomment-2696014125",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728"
    },
    {
      "event": "commented",
      "id": 2708961954,
      "node_id": "IC_kwDOABII586hd3qi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2708961954",
      "actor": {
        "login": "Chand-ra",
        "id": 114725427,
        "node_id": "U_kgDOBtaSMw",
        "avatar_url": "https://avatars.githubusercontent.com/u/114725427?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Chand-ra",
        "html_url": "https://github.com/Chand-ra",
        "followers_url": "https://api.github.com/users/Chand-ra/followers",
        "following_url": "https://api.github.com/users/Chand-ra/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Chand-ra/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Chand-ra/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Chand-ra/subscriptions",
        "organizations_url": "https://api.github.com/users/Chand-ra/orgs",
        "repos_url": "https://api.github.com/users/Chand-ra/repos",
        "events_url": "https://api.github.com/users/Chand-ra/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Chand-ra/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-09T17:00:32Z",
      "updated_at": "2025-03-09T17:00:32Z",
      "author_association": "NONE",
      "body": "Hey @asklokesh, are you still working on this or can I chime in to help as well?",
      "user": {
        "login": "Chand-ra",
        "id": 114725427,
        "node_id": "U_kgDOBtaSMw",
        "avatar_url": "https://avatars.githubusercontent.com/u/114725427?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Chand-ra",
        "html_url": "https://github.com/Chand-ra",
        "followers_url": "https://api.github.com/users/Chand-ra/followers",
        "following_url": "https://api.github.com/users/Chand-ra/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Chand-ra/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Chand-ra/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Chand-ra/subscriptions",
        "organizations_url": "https://api.github.com/users/Chand-ra/orgs",
        "repos_url": "https://api.github.com/users/Chand-ra/repos",
        "events_url": "https://api.github.com/users/Chand-ra/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Chand-ra/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31728#issuecomment-2708961954",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728"
    },
    {
      "event": "mentioned",
      "id": 16645433638,
      "node_id": "MEE_lADOABII586nWp0tzwAAAAPgJSkm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16645433638",
      "actor": {
        "login": "asklokesh",
        "id": 49921737,
        "node_id": "MDQ6VXNlcjQ5OTIxNzM3",
        "avatar_url": "https://avatars.githubusercontent.com/u/49921737?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/asklokesh",
        "html_url": "https://github.com/asklokesh",
        "followers_url": "https://api.github.com/users/asklokesh/followers",
        "following_url": "https://api.github.com/users/asklokesh/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/asklokesh/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/asklokesh/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/asklokesh/subscriptions",
        "organizations_url": "https://api.github.com/users/asklokesh/orgs",
        "repos_url": "https://api.github.com/users/asklokesh/repos",
        "events_url": "https://api.github.com/users/asklokesh/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/asklokesh/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-09T17:00:33Z"
    },
    {
      "event": "subscribed",
      "id": 16645433650,
      "node_id": "SE_lADOABII586nWp0tzwAAAAPgJSky",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16645433650",
      "actor": {
        "login": "asklokesh",
        "id": 49921737,
        "node_id": "MDQ6VXNlcjQ5OTIxNzM3",
        "avatar_url": "https://avatars.githubusercontent.com/u/49921737?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/asklokesh",
        "html_url": "https://github.com/asklokesh",
        "followers_url": "https://api.github.com/users/asklokesh/followers",
        "following_url": "https://api.github.com/users/asklokesh/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/asklokesh/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/asklokesh/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/asklokesh/subscriptions",
        "organizations_url": "https://api.github.com/users/asklokesh/orgs",
        "repos_url": "https://api.github.com/users/asklokesh/repos",
        "events_url": "https://api.github.com/users/asklokesh/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/asklokesh/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-09T17:00:33Z"
    },
    {
      "event": "commented",
      "id": 2708965049,
      "node_id": "IC_kwDOABII586hd4a5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2708965049",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-09T17:06:52Z",
      "updated_at": "2025-03-09T17:07:31Z",
      "author_association": "MEMBER",
      "body": "> Hey [@asklokesh](https://github.com/asklokesh), are you still working on this or can I chime in to help as well?\n\nYou can tackle it. asklokesh comment is surely from chatGPT and makes no sense in our code. We should delete it.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31728#issuecomment-2708965049",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31728"
    }
  ]
}