{
  "type": "issue",
  "issue": {
    "id": 2738933690,
    "node_id": "I_kwDOABII586jQM-6",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31494",
    "number": 31494,
    "state": "open",
    "state_reason": null,
    "title": "assumevalid is not always applied when reindexing",
    "body": "`assumevalid` (which disables script verification and therefore speeds up IBD) is not always applied in the context of a `-reindex`:\r\n \r\nThe assumevalid criteria are\r\nhttps://github.com/bitcoin/bitcoin/blob/d73f37dda221835b5109ede1b84db2dc7c4b74a1/src/validation.cpp#L2497-L2500\r\n\r\nmeaning that our best known header needs to have at least as much work than the hard-coded minchainwork. \r\nDuring normal IBD, we don't connect blocks before having minchainwork headers (headers sync phase), so this is not a problem.\r\nHowever,`-reindex` deletes the block tree db and attempts to rebuild it based on local block files, without attempting to re-request headers for which we don't have the full block yet (because we didn't get to that point in the previous IBD).\r\n\r\nTherefore, users that encounter an error somewhere midway through IBD and need to reindex, won't use `-assumevalid` and will rebuild the chainstate slowly. \r\nThis has also been encountered in the context of benchmarking.\r\n\r\nPossible solutions:\r\n - always enable assumvalid while connecting blocks in the context of reindexing\r\n - attempt to sync remaining headers via the p2p nework after rebuilding the block tree db, but before calling `ActivateBestChain()` to start connecting blocks",
    "user": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 3,
    "created_at": "2024-12-13T18:07:54Z",
    "updated_at": "2025-01-06T21:34:48Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2573704148,
      "node_id": "IC_kwDOABII586ZZ5vU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2573704148",
      "actor": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-06T18:46:25Z",
      "updated_at": "2025-01-06T18:46:25Z",
      "author_association": "NONE",
      "body": "I added a test reproducing this bug https://github.com/eunovo/bitcoin/commit/5e1ff5fe2c7374f97eb56454099c1b235c75e23c",
      "user": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31494#issuecomment-2573704148",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494"
    },
    {
      "event": "commented",
      "id": 2573707408,
      "node_id": "IC_kwDOABII586ZZ6iQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2573707408",
      "actor": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-06T18:48:24Z",
      "updated_at": "2025-01-06T18:48:24Z",
      "author_association": "NONE",
      "body": "> * always enable assumvalid while connecting blocks in the context of reindexing\r\n\r\nIsn't it still valuable to check that the current block is an ancestor of the most work chain?",
      "user": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31494#issuecomment-2573707408",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494"
    },
    {
      "event": "commented",
      "id": 2573967744,
      "node_id": "IC_kwDOABII586Za6GA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2573967744",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-06T21:34:47Z",
      "updated_at": "2025-01-06T21:34:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I added a test reproducing this bug https://github.com/Eunovo/bitcoin/commit/5e1ff5fe2c7374f97eb56454099c1b235c75e23c\r\n\r\nThanks, nice test (which should fail on master if I understand it correctly)!\r\n\r\n> Isn't it still valuable to check that the current block is an ancestor of the most work chain?\r\n\r\nKeeping the check doesn't hurt, but I think in the situation of a reindex this should automatically be the case:\r\n\r\nOutside of a reindex, we could have additional headers received via p2p for which we don't have the block yet, so that the `m_chainman.m_best_header` isn't necessarily the best block we are trying to activate (we can't fully validate blocks for which we just have the header).\r\nBut during a reindex, we have disabled p2p header download and our only source for blocks and headers is the disk, so we cannot be in a situation where we have headers for which we don't have the full block. We might have some full blocks on disk that don't lead to the best header, but we shouldn't attempt to connect them in the first place in `ActivateBestChain()`, which attempts to connect towards the most-work chain for which we have all the block data (see `FindMostWorkChain`).\r\n",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31494#issuecomment-2573967744",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31494"
    }
  ]
}