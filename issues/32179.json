{
  "type": "issue",
  "issue": {
    "id": 2961485137,
    "node_id": "I_kwDOABII586whK1R",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32179",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32179/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32179/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32179/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32179",
    "number": 32179,
    "state": "open",
    "state_reason": null,
    "title": "p2p: Inefficiency in block download / stalling algorithm",
    "body": "When we were in a stalling situation during IBD, we may kick a peer and download the block needed to advance our tip from another peer.\nWhen we then receive the block, that will often result in many (hundreds) of blocks being connected in one go, resolving the stalling situation:  A 1024-blocks window beginning at the new tip now has several open slots.\n\nThere is a bug in what happens next, which results in a less efficient IBD and possibly an unnecessary disconnection of a peer:\n\nIn the next `FindNextBlocksToDownload` call for each peer, `pindexLastCommonBlock` (the last full block both we and that peer have) will not be updated immediately. Instead, we calculate the window of blocks we might request based on the old `pindexLastCommonBlock`, call `FindNextBlocks` with that - `pindexLastCommonBlock` will  only then be moved forward [within that call](https://github.com/bitcoin/bitcoin/blob/3358b1d105196647230e6f828b8ec820426b96a0/src/net_processing.cpp#L1454-L1456).\n\nThis is bad for two reasons:\n1.) We waste one `FindNextBlocksToDownload` call iterating over blocks we won't need to download anyway (just improving `pindexLastCommonBlock` along the way)\n2.) If we, as a consequence, don't request any block from that peer, we will [start a new stalling procedure](https://github.com/bitcoin/bitcoin/blob/74d9598bfbc24c3b7bfe1dad5bf9d988381bf893/src/net_processing.cpp#L5886-L5889) and mark a peer as a possible staller, possibly disconnecting it after a short timeout. This is incorrect, because the stalling situation was already resolved, and can result in unnecessary disconnects.\n\nI think it would be better to adjust  `pindexLastCommonBlock` based on the new tip in `FindNextBlocksToDownload` (because we certainly don't need to download any blocks below that in case of a linear chain with no forks), and calculate `nWindowEnd`  based on that, so that the following `FindNextBlocks` will download blocks based on a 1024-blocks window based on the new, current tip instead of the old one.\n\nI opened #32180 to fix this.",
    "user": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 0,
    "created_at": "2025-03-31T20:17:09Z",
    "updated_at": "2025-04-02T15:04:42Z"
  },
  "events": [
    {
      "event": "subscribed",
      "id": 17095870378,
      "node_id": "SE_lADOABII586whK1RzwAAAAP6_keq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17095870378",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-04-02T15:04:36Z"
    },
    {
      "event": "labeled",
      "id": 17095872249,
      "node_id": "LE_lADOABII586whK1RzwAAAAP6_k75",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17095872249",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-04-02T15:04:42Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    }
  ]
}