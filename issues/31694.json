{
  "type": "issue",
  "issue": {
    "id": 2800269300,
    "node_id": "I_kwDOABII586m6Lf0",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31694",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31694/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31694/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31694/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31694",
    "number": 31694,
    "state": "open",
    "state_reason": null,
    "title": "Inconsistent hardened derivation marker in `listdescriptors` output",
    "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nIf I use `importdescriptors` to import a descriptor that uses only `'` as the hardened derivation marker, the corresponding output of `listdescriptors` sometimes uses a mix of `'` and `h`.\n\n### Expected behaviour\n\nI would expect the output for a given imported descriptor to either match my input or otherwise use only one of `'` and `h`.\n\nI would also expect the behaviour to be consistent across different descriptors. \n\n### Steps to reproduce\n\n1. Create wallet:\n```\n$ bitcoin-cli -regtest createwallet test_h_vs_apostrophe true\n{\n  \"name\": \"test_h_vs_apostrophe\"\n}\n```\n2. Import `tr` descriptor:\n```\n$ bitcoin-cli -regtest -rpcwallet=test_h_vs_apostrophe importdescriptors \"[{\\\"desc\\\": \\\"tr([1dce71b2/48'/1'/0'/2']tpubDEeP3GefjqbaDTTaVAF5JkXWhoFxFDXQ9KuhVrMBViFXXNR2B3Lvme2d2AoyiKfzRFZChq2AGMNbU1qTbkBMfNv7WGVXLt2pnYXY87gXqcs/0/*,and_v(v:pk([1dce71b2/48'/1'/0'/2']tpubDEeP3GefjqbaDTTaVAF5JkXWhoFxFDXQ9KuhVrMBViFXXNR2B3Lvme2d2AoyiKfzRFZChq2AGMNbU1qTbkBMfNv7WGVXLt2pnYXY87gXqcs/2/*),older(65535)))#xhrh0cvn\\\", \\\"timestamp\\\": \\\"now\\\"}]\"\n[\n  {\n    \"success\": true,\n    \"warnings\": [\n      \"Range not given, using default keypool range\"\n    ]\n  }\n]\n```\n3. Import `wsh` descriptor:\n```\n$ bitcoin-cli -regtest -rpcwallet=test_h_vs_apostrophe importdescriptors \"[{\\\"desc\\\": \\\"wsh(or_d(pk([a233d117/48'/1'/0'/2']tpubDF8d1Q2U8WWfxUHMiqqrYiavBReX2r7hwD7oQsEuq1AiXj5nJcLBkoh1uTLZVx66VrbRfeHyg5bSFvRKzesa1yzYuXDvawZeRi9m97a2Qzd/0/*),and_v(v:pkh([a233d117/48'/1'/0'/2']tpubDF8d1Q2U8WWfxUHMiqqrYiavBReX2r7hwD7oQsEuq1AiXj5nJcLBkoh1uTLZVx66VrbRfeHyg5bSFvRKzesa1yzYuXDvawZeRi9m97a2Qzd/2/*),older(65535))))#segwrd5h\\\", \\\"timestamp\\\": \\\"now\\\"}]\"\n[\n  {\n    \"success\": true,\n    \"warnings\": [\n      \"Range not given, using default keypool range\"\n    ]\n  }\n]\n```\nWhen calling `listdescriptors`, the `tr` descriptor uses a mix of `h` and `'` (and checksum has changed), while `wsh` uses only `'` (and has same checksum):\n```\n$ bitcoin-cli -regtest -rpcwallet=test_h_vs_apostrophe listdescriptors\n{\n  \"wallet_name\": \"test_h_vs_apostrophe\",\n  \"descriptors\": [\n    {\n      \"desc\": \"tr([1dce71b2/48h/1h/0h/2h]tpubDEeP3GefjqbaDTTaVAF5JkXWhoFxFDXQ9KuhVrMBViFXXNR2B3Lvme2d2AoyiKfzRFZChq2AGMNbU1qTbkBMfNv7WGVXLt2pnYXY87gXqcs/0/*,and_v(v:pk([1dce71b2/48'/1'/0'/2']tpubDEeP3GefjqbaDTTaVAF5JkXWhoFxFDXQ9KuhVrMBViFXXNR2B3Lvme2d2AoyiKfzRFZChq2AGMNbU1qTbkBMfNv7WGVXLt2pnYXY87gXqcs/2/*),older(65535)))#2h7g2wme\",\n      \"timestamp\": 1296688602,\n      \"active\": false,\n      \"range\": [\n        0,\n        999\n      ],\n      \"next\": 0,\n      \"next_index\": 0\n    },\n    {\n      \"desc\": \"wsh(or_d(pk([a233d117/48'/1'/0'/2']tpubDF8d1Q2U8WWfxUHMiqqrYiavBReX2r7hwD7oQsEuq1AiXj5nJcLBkoh1uTLZVx66VrbRfeHyg5bSFvRKzesa1yzYuXDvawZeRi9m97a2Qzd/0/*),and_v(v:pkh([a233d117/48'/1'/0'/2']tpubDF8d1Q2U8WWfxUHMiqqrYiavBReX2r7hwD7oQsEuq1AiXj5nJcLBkoh1uTLZVx66VrbRfeHyg5bSFvRKzesa1yzYuXDvawZeRi9m97a2Qzd/2/*),older(65535))))#segwrd5h\",\n      \"timestamp\": 1296688602,\n      \"active\": false,\n      \"range\": [\n        0,\n        999\n      ],\n      \"next\": 0,\n      \"next_index\": 0\n    }\n  ]\n}\n```\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\nv28.0.0\n\n### Operating system and version\n\nUbuntu 24.04\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "jp1ac4",
      "id": 121959000,
      "node_id": "U_kgDOB0TyWA",
      "avatar_url": "https://avatars.githubusercontent.com/u/121959000?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jp1ac4",
      "html_url": "https://github.com/jp1ac4",
      "followers_url": "https://api.github.com/users/jp1ac4/followers",
      "following_url": "https://api.github.com/users/jp1ac4/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/jp1ac4/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/jp1ac4/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/jp1ac4/subscriptions",
      "organizations_url": "https://api.github.com/users/jp1ac4/orgs",
      "repos_url": "https://api.github.com/users/jp1ac4/repos",
      "events_url": "https://api.github.com/users/jp1ac4/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/jp1ac4/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 2,
    "created_at": "2025-01-20T21:05:28Z",
    "updated_at": "2025-01-24T06:42:32Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2604807583,
      "node_id": "IC_kwDOABII586bQjWf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2604807583",
      "actor": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T13:56:51Z",
      "updated_at": "2025-01-21T19:43:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "> If I use importdescriptors to import a descriptor that uses only ' as the hardened derivation marker, the corresponding output of listdescriptors sometimes uses a mix of ' and h.\n\nI think this is due to `ToNormalizedString` called by `GetDescriptorString` from`listdescriptors`:\n```cpp\nbool ToNormalizedString(const SigningProvider& arg, std::string& ret, const DescriptorCache* cache) const override\n{\n    std::string sub;\n    if (!m_provider->ToNormalizedString(arg, sub, cache)) return false;\n    // If m_provider is a BIP32PubkeyProvider, we may get a string formatted like a OriginPubkeyProvider\n    // In that case, we need to strip out the leading square bracket and fingerprint from the substring,\n    // and append that to our own origin string.\n    if (sub[0] == '[') {\n        sub = sub.substr(9);\n        ret = \"[\" + OriginString(StringType::PUBLIC, /*normalized=*/true) + std::move(sub);\n    } else {\n        ret = \"[\" + OriginString(StringType::PUBLIC, /*normalized=*/true) + \"]\" + std::move(sub);\n    }\n    return true;\n}\n```",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31694#issuecomment-2604807583",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31694"
    },
    {
      "event": "commented",
      "id": 2611716176,
      "node_id": "IC_kwDOABII586bq6BQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2611716176",
      "actor": {
        "login": "pythcoiner",
        "id": 124568858,
        "node_id": "U_kgDOB2zFGg",
        "avatar_url": "https://avatars.githubusercontent.com/u/124568858?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pythcoiner",
        "html_url": "https://github.com/pythcoiner",
        "followers_url": "https://api.github.com/users/pythcoiner/followers",
        "following_url": "https://api.github.com/users/pythcoiner/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pythcoiner/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pythcoiner/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pythcoiner/subscriptions",
        "organizations_url": "https://api.github.com/users/pythcoiner/orgs",
        "repos_url": "https://api.github.com/users/pythcoiner/repos",
        "events_url": "https://api.github.com/users/pythcoiner/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pythcoiner/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-24T06:42:30Z",
      "updated_at": "2025-01-24T06:42:30Z",
      "author_association": "NONE",
      "body": "it looks I got a [fix](https://github.com/bitcoin/bitcoin/commit/95220e5aac4839ba0dbdcca070ed34c6226de217), will write tests & PR",
      "user": {
        "login": "pythcoiner",
        "id": 124568858,
        "node_id": "U_kgDOB2zFGg",
        "avatar_url": "https://avatars.githubusercontent.com/u/124568858?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pythcoiner",
        "html_url": "https://github.com/pythcoiner",
        "followers_url": "https://api.github.com/users/pythcoiner/followers",
        "following_url": "https://api.github.com/users/pythcoiner/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pythcoiner/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pythcoiner/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pythcoiner/subscriptions",
        "organizations_url": "https://api.github.com/users/pythcoiner/orgs",
        "repos_url": "https://api.github.com/users/pythcoiner/repos",
        "events_url": "https://api.github.com/users/pythcoiner/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pythcoiner/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31694#issuecomment-2611716176",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31694"
    }
  ]
}