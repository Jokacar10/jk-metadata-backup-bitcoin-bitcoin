{
  "type": "issue",
  "issue": {
    "id": 3078112840,
    "node_id": "I_kwDOABII5863eEZI",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32574",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32574/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32574/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32574/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32574",
    "number": 32574,
    "state": "open",
    "state_reason": null,
    "title": "subprocess: `sh -c 'echo err 1>&2 && false'` must return `1`",
    "body": "On OpenIndiana:\n```\n./test/system_tests.cpp(54): error: in \"system_tests/run_command\": check what.find(tfm::format(\"RunCommandParseJSON error: process(%s) returned\", command)) != std::string::npos has failed\n./test/system_tests.cpp(55): error: in \"system_tests/run_command\": check what.find(expected) != std::string::npos has failed\n```\n\nSame on [OmniOS](https://github.com/hebasto/bitcoin-core-nightly/actions/runs/15121791773/job/42505618501):\n```\n./test/system_tests.cpp(54): error: in \"system_tests/run_command\": check what.find(tfm::format(\"RunCommandParseJSON error: process(%s) returned\", command)) != std::string::npos has failed\n./test/system_tests.cpp(55): error: in \"system_tests/run_command\": check what.find(expected) != std::string::npos has failed\n```",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 2,
    "created_at": "2025-05-20T20:07:00Z",
    "updated_at": "2025-05-23T19:26:27Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 17741030745,
      "node_id": "LE_lADOABII5863eEZIzwAAAAQhcqVZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17741030745",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-20T20:07:08Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "commented",
      "id": 2903353573,
      "node_id": "IC_kwDOABII586tDajl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2903353573",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-23T05:58:29Z",
      "updated_at": "2025-05-23T05:58:29Z",
      "author_association": "MEMBER",
      "body": "The underlying issue is not specific to illumos.\n\nWith the following patch:\n```diff\n--- a/src/test/system_tests.cpp\n+++ b/src/test/system_tests.cpp\n@@ -67,7 +67,7 @@ BOOST_AUTO_TEST_CASE(run_command)\n         const std::string expected{\"err\"};\n         BOOST_CHECK_EXCEPTION(RunCommandParseJSON(command), std::runtime_error, [&](const std::runtime_error& e) {\n             const std::string what(e.what());\n-            BOOST_CHECK(what.find(strprintf(\"RunCommandParseJSON error: process(%s) returned\", command)) != std::string::npos);\n+            BOOST_CHECK(what.find(strprintf(\"RunCommandParseJSON error: process(%s) returned 1\", command)) != std::string::npos);\n             BOOST_CHECK(what.find(expected) != std::string::npos);\n             return true;\n         });\n```\n\nit becomes evident that the command `sh -c 'echo err 1>&2 && false'` does not exit with status `1`.",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32574#issuecomment-2903353573",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32574"
    },
    {
      "event": "renamed",
      "id": 17783819159,
      "node_id": "RTE_lADOABII5863eEZIzwAAAAQj_4uX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17783819159",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-23T05:59:04Z",
      "rename": {
        "from": "`system_tests/run_command` test fails on illumos OS",
        "to": "subprocess: `sh -c 'echo err 1>&2 && false` must return `1`"
      }
    },
    {
      "event": "renamed",
      "id": 17783821812,
      "node_id": "RTE_lADOABII5863eEZIzwAAAAQj_5X0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17783821812",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-23T05:59:17Z",
      "rename": {
        "from": "subprocess: `sh -c 'echo err 1>&2 && false` must return `1`",
        "to": "subprocess: `sh -c 'echo err 1>&2 && false'` must return `1`"
      }
    },
    {
      "event": "commented",
      "id": 2905570392,
      "node_id": "IC_kwDOABII586tL3xY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2905570392",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-23T19:23:02Z",
      "updated_at": "2025-05-23T19:26:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "> The underlying issue is not specific to illumos.\n\nI couldn't find an explanation of the underlying issue, but looking at this more, I think I maybe understand the problem. The test code that is failing looks like:\n\n```c++\n    49          // Return non-zero exit code, with error message for stderr\n    50          const std::string command{\"sh -c 'echo err 1>&2 && false'\"};\n    51          const std::string expected{\"err\"};\n    52          BOOST_CHECK_EXCEPTION(RunCommandParseJSON(command), std::runtime_error, [&](const std::runtime_error& e) {\n    53              const std::string what(e.what());\n    54              BOOST_CHECK(what.find(strprintf(\"RunCommandParseJSON error: process(%s) returned\", command)) != std::string::npos);\n    55              BOOST_CHECK(what.find(expected) != std::string::npos);\n    56              return true;\n    57          });\n```\n\nAnd the specific checks that are failing are on line 54 and 55 as reported initially.\n\nWhat the test is trying to do here is execute the command `sh -c 'echo err 1>&2 && false` on the current system.\n\nThen line 54 is checking trying to look for the [RunCommandParseJSON error](https://github.com/bitcoin/bitcoin/blob/master/src/common/run_command.cpp#L41) thrown when the command returns a nonzero exit code. Apparently this check is failing because on illumos the command returns a 0 exit code?\n\nAnd line 55 is checking for the string \"err\" somewhere in the same error message. But that check also fails for the same reason.\n\nThe fact that these BOOST_CHECK statements are failing inside the BOOST_CHECK_EXCEPTION check for a std::runtime_error exception probably indicates that some std::runtime_error exception is being thrown, so it is probably just the one thrown when the command returns [invalid json](https://github.com/bitcoin/bitcoin/blob/2df824f4e62b6bc569044819cd64f66f3839ba13/src/common/run_command.cpp#L42)\n\nThe test seems pretty broken currently, so not surprising that it returns inconsistent results on different operating systems.\n\nBecause we are not enabling the subprocess module's shell option, the subprocess module is attempting to parse the command line `sh -c 'echo err 1>&2 && false'` itself. And it looks like it does that [pretty poorly](https://github.com/bitcoin/bitcoin/blob/2df824f4e62b6bc569044819cd64f66f3839ba13/src/util/subprocess.h#L316-L334) splitting the command up into an argv array consisting of `[\"sh\", \"-c\", \"'echo\", \"err\", \"1>&2\", \"&&\", \"false'\"]` arguments. On linux, because `'echo` is not a valid shell script, the bash shell returns exit code 2 and error message ``err: -c: line 1: unexpected EOF while looking for matching `''``. The reason why the bash message begins with \"err\" is that bash interprets the trailing arguments \"'echo\", \"err\", \"1>&2\", ... as $0, $1, $2, .... arguments to the bash script, so it treating \"err\" as $0 as the name of the script it thinks it is executing and using that script name in its error message.\n\nSo that explains why the test is passing on linux with bash, even if its not checking for a particularly meaningful condition.\n\nIt is unclear what exactly is causing the behavior on illumos, but my guess would be that illumos shell might be just treating `sh -c \"'echo\" \"err\" \"1>&2\" \"&&\" \"false'\"` as an echo command and returning success and not bothering to complain that the `'echo` quote is unterminated.\n\nIn any case, I couldn't think of any way to fix this test to use RunCommandParseJSON to run a command printing to stderr on linux, because the split function splits on spaces and tabs and it's hard to write a shell script that doesn't include spaces or tabs.\n\nWe could change RunCommandParseJSON to actually execute full shell commands as was done in 4837fdc1569d58541fb310251b969ae160907e6e from #32577. But ultimately the best approach for our use-case might be to avoid even more joining and splitting and unnecessary use of shell and just make RunCommandParseJSON take an `vector<string>` array that it can pass to the subprocess library, instead of passing any string that needs to be parsed\n\n\n\n\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32574#issuecomment-2905570392",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32574"
    }
  ]
}