{
  "type": "issue",
  "issue": {
    "id": 3042847431,
    "node_id": "I_kwDOABII5861XirH",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32426",
    "number": 32426,
    "state": "open",
    "state_reason": null,
    "title": "external signer: PSBT error code `EXTERNAL_SIGNER_NOT_FOUND` is never returned",
    "body": "The error code [`PSBTError::EXTERNAL_SIGNER_NOT_FOUND`](https://github.com/bitcoin/bitcoin/blob/baa848b8d38187ce6b24a57cfadf1ea180209711/src/common/types.h#L20) is never returned anywhere in our codebase, hence code that handles it (currently done [only in the GUI](https://github.com/bitcoin/bitcoin/blob/baa848b8d38187ce6b24a57cfadf1ea180209711/src/qt/sendcoinsdialog.cpp#L458)) is effectively dead. I have never looked deeper into external signing, but at a first glance the two obvious logical choices would be to either:\n* simply get rid of this error code and its handling (if e.g. a more generic error thrown in this case already provides enough information to the user)\n* implement the returning of the error condition; the areas that need to be touched are likely [`ExternalSignerScriptPubKeyMan::GetExternalSigner`](https://github.com/bitcoin/bitcoin/blob/baa848b8d38187ce6b24a57cfadf1ea180209711/src/wallet/external_signer_scriptpubkeyman.cpp#L48) and its call-site in `::FillPSBT` below\n\n(Noticed while reviewing #31622, where new PSBTError codes are added in the third commit)",
    "user": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 3,
    "created_at": "2025-05-06T13:25:25Z",
    "updated_at": "2025-06-04T09:19:21Z"
  },
  "events": [
    {
      "event": "subscribed",
      "id": 17545388309,
      "node_id": "SE_lADOABII5861XirHzwAAAAQVyWEV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17545388309",
      "actor": {
        "login": "Ekene1998",
        "id": 157784712,
        "node_id": "U_kgDOCWeaiA",
        "avatar_url": "https://avatars.githubusercontent.com/u/157784712?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Ekene1998",
        "html_url": "https://github.com/Ekene1998",
        "followers_url": "https://api.github.com/users/Ekene1998/followers",
        "following_url": "https://api.github.com/users/Ekene1998/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Ekene1998/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Ekene1998/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Ekene1998/subscriptions",
        "organizations_url": "https://api.github.com/users/Ekene1998/orgs",
        "repos_url": "https://api.github.com/users/Ekene1998/repos",
        "events_url": "https://api.github.com/users/Ekene1998/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Ekene1998/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-06T22:23:20Z"
    },
    {
      "event": "commented",
      "id": 2934669487,
      "node_id": "IC_kwDOABII586u64Cv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2934669487",
      "actor": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-03T10:52:30Z",
      "updated_at": "2025-06-03T10:52:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "\n> * simply get rid of this error code and its handling (if e.g. a more generic error thrown in this case already provides enough information to the user)\n> * implement the returning of the error condition; the areas that need to be touched are likely [`ExternalSignerScriptPubKeyMan::GetExternalSigner`](https://github.com/bitcoin/bitcoin/blob/baa848b8d38187ce6b24a57cfadf1ea180209711/src/wallet/external_signer_scriptpubkeyman.cpp#L48) and its call-site in `::FillPSBT` below\n\nI'm in favour of   deleting [PSBTError::EXTERNAL_SIGNER_NOT_FOUND](https://github.com/bitcoin/bitcoin/blob/baa848b8d38187ce6b24a57cfadf1ea180209711/src/common/types.h#L20)\n\nI've tested the error on [GetExternalSigner](https://github.com/bitcoin/bitcoin/blob/baa848b8d38187ce6b24a57cfadf1ea180209711/src/wallet/external_signer_scriptpubkeyman.cpp#L53) in both `walletdisplayaddress` and `walletprocesspsbt` it seems sufficient to me.\n```\nbitcoin-cli -regtest -rpcwallet=hww_working walletprocesspsbt \"$PSBT\"\nerror code: -1\nerror message:\nGetExternalSigner: No external signers found\n```\n```\nbitcoin-cli -regtest -rpcwallet=hww_working walletdisplayaddress $ADDRESS\nerror code: -1\nerror message:\nGetExternalSigner: No external signers found\n```\n\nEven if we return `PSBTError::EXTERNAL_SIGNER_NOT_FOUND;`  in `ExternalSignerScriptPubKeyMan::FillPSBT` we'll still need to keep the error in GetExternalSigner, since it's also useful in other call sites.\n\n maybe the intention of having `PSBTError::EXTERNAL_SIGNER_NOT_FOUND`   error was to have a more PSBT-specific error,  But honestly, that doesn't seem very necessary.\n\n\nI tried returning from FillPSBT directly, and it's possible to do that without touching GetExternalSigner. But I still think deleting is the better approach\n\n\n``` diff\n-    if (finalize) FinalizePSBT(psbt); // This won't work in a multisig setup\n+\n+    try {\n+        ExternalSigner signer = GetExternalSigner();\n+        if(!signer.SignTransaction(psbt, strFailReason)) {\n+            tfm::format(std::cerr, \"Failed to sign: %s\\n\", strFailReason);\n+            return PSBTError::EXTERNAL_SIGNER_FAILED;\n+        }\n+    } catch (const std::runtime_error& e) {\n+        return PSBTError::EXTERNAL_SIGNER_NOT_FOUND;\n+    }\n+    if (finalize) {\n+        FinalizePSBT(psbt); // This won't work in a multisig setup\n+\n+    }\n\n```\n",
      "user": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32426#issuecomment-2934669487",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426"
    },
    {
      "event": "commented",
      "id": 2934709732,
      "node_id": "IC_kwDOABII586u7B3k",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2934709732",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-03T11:05:21Z",
      "updated_at": "2025-06-03T11:05:21Z",
      "author_association": "MEMBER",
      "body": "@hebasto @Sjors ",
      "user": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32426#issuecomment-2934709732",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426"
    },
    {
      "event": "mentioned",
      "id": 17955331656,
      "node_id": "MEE_lADOABII5861XirHzwAAAAQuOJ5I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17955331656",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-03T11:05:21Z"
    },
    {
      "event": "subscribed",
      "id": 17955331756,
      "node_id": "SE_lADOABII5861XirHzwAAAAQuOJ6s",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17955331756",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-03T11:05:22Z"
    },
    {
      "event": "mentioned",
      "id": 17955331933,
      "node_id": "MEE_lADOABII5861XirHzwAAAAQuOJ9d",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17955331933",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-03T11:05:22Z"
    },
    {
      "event": "subscribed",
      "id": 17955332053,
      "node_id": "SE_lADOABII5861XirHzwAAAAQuOJ_V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17955332053",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-03T11:05:22Z"
    },
    {
      "event": "commented",
      "id": 2939202952,
      "node_id": "IC_kwDOABII586vMK2I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2939202952",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-04T08:58:38Z",
      "updated_at": "2025-06-04T09:19:20Z",
      "author_association": "MEMBER",
      "body": "I made a note to refactor `GetExternalSigner()` and `ExternalSignerScriptPubKeyMan::FillPSBT` so the latter can return `PSBTError::EXTERNAL_SIGNER_NOT_FOUND`.\n\nWe call GetExternalSigner in three scenarios:\n\n1. During initial wallet setup to fetch keys from the device\n2. When attempting to display an address on the device\n3. When signing a PSBT\n\nFor scenario (1) and (2) the current `std::runtime_error` approach seems fine.\n\nIn particular scenario (1) is unlikely, and definitely an error, if a user unplugs their device right after we fetched its name (via `ExternalSigner::Enumerate`).\n\nScenario (2) is more likely to occur if e.g. they plug in their device, forget to unlock it, or somehow HWI can't find it.\n\nThat leaves (3) which is more nuanced. The external signer interface \"officially\" only supports single signature setup, but my longer term ambition still is to make this work well in multisig. And that's where we should use `PSBTError::EXTERNAL_SIGNER_NOT_FOUND`.\n\nCoincidentally I ran into the `No external signers found` std::error during recent MuSig2 testing. Let's say you have a 2-of-2 setup with one key from Bitcoin Core and one from an external signer, and a delayed fallback where either can sign. Normally it's an error when the device isn't present, but for the fallback it's not.\n\nI'm not entirely sure yet how such a case should be handled. The signing code doesn't know that the user lost their hardware wallet, and we don't want to accidentally publish a `scriptPath` spend since that hurts privacy and is more expensive.\n\nOne approach could be that if `PSBTError::EXTERNAL_SIGNER_NOT_FOUND` is returned, we ask the user whether they want to try again or if we should only sign the fallback condition.\n\n---\n\nIt looks like I introduced `TransactionError::EXTERNAL_SIGNER_NOT_FOUND` in d4b0107d68a91ed4d1a5c78c8ca76251329d3f3c as part of #16546, followed by https://github.com/bitcoin-core/gui/pull/4 that renders them. But no code actually triggered the error. I'm not sure why. Perhaps an earlier iteration did use them, but browsing through some of those versions I don't see it. Neither did the immediate followup https://github.com/bitcoin/bitcoin/pull/16378.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32426#issuecomment-2939202952",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32426"
    }
  ]
}