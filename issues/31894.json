{
  "type": "issue",
  "issue": {
    "id": 2860034758,
    "node_id": "I_kwDOABII586qeKrG",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31894",
    "number": 31894,
    "state": "open",
    "state_reason": null,
    "title": "qa: timeout in StopHTTPServer()",
    "body": "Ran into a CI timeout in *feature_assumeutxo.py* on Windows: https://github.com/hodlinator/bitcoin/actions/runs/13371466603/job/37340702068#step:12:123\n\nIn the combined log we see the following, \"Restarting node to stop at height\" is [referring to node 1](https://github.com/bitcoin/bitcoin/blob/790c509a4796ec47be2275d86b35370ff25a599a/test/functional/feature_assumeutxo.py#L586)):\n```\ntest  ...T14:10:53.420000Z TestFramework (INFO): Restarting node to stop at height 359\ntest  ...T14:10:53.420000Z TestFramework.node1 (DEBUG): Stopping node\nnode1 ...T14:10:53.420155Z (mocktime...) [http] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:306] [http_request_cb] [http] Received a POST request for / from 127.0.0.1:56740\nnode1 ...T14:10:53.420240Z (mocktime...) [httpworker.8] [D:\\a\\bitcoin\\bitcoin\\src\\rpc\\request.cpp:241] [parse] [rpc] ThreadRPCServer method=gettxout user=__cookie__\nnode1 ...T14:10:53.421024Z (mocktime...) [http] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:306] [http_request_cb] [http] Received a POST request for / from 127.0.0.1:56740\nnode1 ...T14:10:53.421114Z (mocktime...) [httpworker.11] [D:\\a\\bitcoin\\bitcoin\\src\\rpc\\request.cpp:241] [parse] [rpc] ThreadRPCServer method=stop user=__cookie__\nnode1 ...T14:10:53.421203Z (mocktime...) [init] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:508] [InterruptHTTPServer] [http] Interrupting HTTP server\nnode1 ...T14:10:53.421251Z (mocktime...) [init] [D:\\a\\bitcoin\\bitcoin\\src\\httprpc.cpp:382] [InterruptHTTPRPC] [rpc] Interrupting HTTP RPC server\nnode1 ...T14:10:53.421280Z (mocktime...) [init] [D:\\a\\bitcoin\\bitcoin\\src\\rpc\\server.cpp:291] [operator ()] [rpc] Interrupting RPC\nnode1 ...T14:10:53.421320Z (mocktime...) [init] [D:\\a\\bitcoin\\bitcoin\\src\\init.cpp:287] [Shutdown] Shutdown: In progress...\nnode1 ...T14:10:53.421345Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\httprpc.cpp:387] [StopHTTPRPC] [rpc] Stopping HTTP RPC server\nnode1 ...T14:10:53.422054Z (mocktime...) [addcon] [D:\\a\\bitcoin\\bitcoin\\src\\util\\thread.cpp:22] [TraceThread] addcon thread exit \nnode1 ...T14:10:53.422540Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:770] [UnregisterHTTPHandler] [http] Unregistering HTTP handler for / (exactmatch 1) \nnode1 ...T14:10:53.422641Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:770] [UnregisterHTTPHandler] [http] Unregistering HTTP handler for /wallet/ (exactmatch 0) \nnode1 ...T14:10:53.422674Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\rpc\\server.cpp:303] [operator ()] [rpc] Stopping RPC\nnode1 ...T14:10:53.422847Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\rpc\\server.cpp:306] [operator ()] [rpc] RPC stopped.\nnode1 ...T14:10:53.422879Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:520] [StopHTTPServer] [http] Stopping HTTP server\nnode1 ...T14:10:53.422945Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:522] [StopHTTPServer] [http] Waiting for HTTP worker threads to exit\nnode1 ...T14:10:53.423118Z (mocktime...) [shutoff] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:536] [StopHTTPServer] [http] Waiting for 1 connections to stop HTTP server\nnode1 ...T14:10:53.423164Z (mocktime...) [http] [D:\\a\\bitcoin\\bitcoin\\src\\httpserver.cpp:355] [ThreadHTTP] [http] Exited http event loop\nnode1 ...T14:10:53.440186Z (mocktime...) [net] [D:\\a\\bitcoin\\bitcoin\\src\\util\\thread.cpp:22] [TraceThread] net thread exit\nnode1 ...T14:10:53.652881Z (mocktime...) [msghand] [D:\\a\\bitcoin\\bitcoin\\src\\util\\thread.cpp:22] [TraceThread] msghand thread exit\n...\nnode1 ...T14:11:32.925206Z (mocktime...) [scheduler] [D:\\a\\bitcoin\\bitcoin\\src\\net.cpp:2428] [StartExtraBlockRelayPeers] [net] enabling extra block-relay-only peers\n...\nnode1 ...T14:25:47.935847Z (mocktime...) [scheduler] [D:\\a\\bitcoin\\bitcoin\\src\\net.cpp:2391] [DumpAddresses] [net] Flushed 0 addresses to peers.dat  1ms\n...\nnode1 ...T14:40:47.947785Z (mocktime...) [scheduler] [D:\\a\\bitcoin\\bitcoin\\src\\net.cpp:2391] [DumpAddresses] [net] Flushed 0 addresses to peers.dat  1ms\n...\ntest  ...T14:50:53.446000Z TestFramework (ERROR): JSONRPC error\n\n    Traceback (most recent call last):\n      File \"D:\\a\\bitcoin\\bitcoin\\build\\test\\functional\\test_framework\\authproxy.py\", line 164, in _get_response\n        http_response = self.__conn.getresponse()\n...\n      File \"C:\\hostedtoolcache\\windows\\Python\\3.13.2\\x64\\Lib\\socket.py\", line 719, in readinto\n        return self._sock.recv_into(b)\n               ~~~~~~~~~~~~~~~~~~~~^^^\n    TimeoutError: timed out\n    During handling of the above exception, another exception occurred:\n    Traceback (most recent call last):\n      File \"D:\\a\\bitcoin\\bitcoin\\build\\test\\functional\\test_framework\\test_framework.py\", line 135, in main\n        self.run_test()\n        ~~~~~~~~~~~~~^^\n      File \"D:\\a\\bitcoin\\bitcoin\\build\\test\\functional\\feature_assumeutxo.py\", line 587, in run_test\n        self.restart_node(1, extra_args=[\n        ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^\n            f\"-stopatheight={PAUSE_HEIGHT}\", *self.extra_args[1]])\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n...\n      File \"D:\\a\\bitcoin\\bitcoin\\build\\test\\functional\\test_framework\\test_node.py\", line 395, in stop_node\n        self.stop(wait=wait)\n        ~~~~~~~~~^^^^^^^^^^^\n...\n      File \"D:\\a\\bitcoin\\bitcoin\\build\\test\\functional\\test_framework\\authproxy.py\", line 106, in _request\n        return self._get_response()\n               ~~~~~~~~~~~~~~~~~~^^\n      File \"D:\\a\\bitcoin\\bitcoin\\build\\test\\functional\\test_framework\\authproxy.py\", line 166, in _get_response\n        raise JSONRPCException({\n...\n    test_framework.authproxy.JSONRPCException: 'stop' RPC took longer than 2400.000000 seconds. Consider using larger timeout for calls that take longer to return. (-344)\n```\nNote how it takes:\n- ~40 seconds to go from receiving stop-RPC to \"enabling extra block-relay-only peers\"\n- Additional *14 minutes* to reach \"Flushed 0 addresses to peers.dat\"\n- Additional *15 minutes* for the second one\n- Additional *10 minutes* until we reach the JSONRPC error/timeout.\n\nIt would be good to have log output describing what the node is doing, it obviously started shutting down, and is maybe still flushing some state to disk?\n\nAlso, I wonder if bitcoind might have terminated the TCP/HTTP connection before responding to the `stop`-RPC (maybe `gettxout`-RPC being called right before it is a factor)?\n\nIncluded in the log, but seems unrelated as it's another node:\n```\nnode0 stderr Error: A fatal internal error occurred, see debug.log for details: Assumeutxo data not found for the given blockhash '7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a7a'.\n```",
    "user": {
      "login": "hodlinator",
      "id": 172445034,
      "node_id": "U_kgDOCkdNag",
      "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hodlinator",
      "html_url": "https://github.com/hodlinator",
      "followers_url": "https://api.github.com/users/hodlinator/followers",
      "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
      "organizations_url": "https://api.github.com/users/hodlinator/orgs",
      "repos_url": "https://api.github.com/users/hodlinator/repos",
      "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/hodlinator/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 98279177,
        "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
        "name": "RPC/REST/ZMQ",
        "color": "0052cc",
        "default": false
      },
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 10,
    "created_at": "2025-02-18T10:49:20Z",
    "updated_at": "2025-02-20T11:57:27Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 16346112937,
      "node_id": "LE_lADOABII586qeKrGzwAAAAPOTeOp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16346112937",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T10:56:08Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 16346153466,
      "node_id": "LE_lADOABII586qeKrGzwAAAAPOToH6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16346153466",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T10:59:02Z",
      "label": {
        "name": "Windows",
        "color": "884400"
      }
    },
    {
      "event": "commented",
      "id": 2665304532,
      "node_id": "IC_kwDOABII586e3VHU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2665304532",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T11:02:16Z",
      "updated_at": "2025-02-18T11:02:16Z",
      "author_association": "CONTRIBUTOR",
      "body": "@pinheadmz since you are working on the HTTP rewrite... have you noticed anything fishy regarding whether the stop-RPC will actually always get the response sent off back to the client or not?\n\nCurrent stop-RPC implementation implies it should always work:\nhttps://github.com/bitcoin/bitcoin/blob/790c509a4796ec47be2275d86b35370ff25a599a/src/rpc/server.cpp#L170-L172\n\nBut it's from 2015 and the log above makes me very suspicious.",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2665304532",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "mentioned",
      "id": 16346197361,
      "node_id": "MEE_lADOABII586qeKrGzwAAAAPOTy1x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16346197361",
      "actor": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T11:02:18Z"
    },
    {
      "event": "subscribed",
      "id": 16346197377,
      "node_id": "SE_lADOABII586qeKrGzwAAAAPOTy2B",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16346197377",
      "actor": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T11:02:18Z"
    },
    {
      "event": "commented",
      "id": 2665368484,
      "node_id": "IC_kwDOABII586e3kuk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2665368484",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T11:23:47Z",
      "updated_at": "2025-02-18T11:25:22Z",
      "author_association": "MEMBER",
      "body": "It looks like the scheduler thread never exited? It may be related to the comment:\n\n```\n    // After everything has been shut down, but before things get flushed, stop the\n    // the scheduler. After this point, SyncWithValidationInterfaceQueue() should not be called anymore\n    // as this would prevent the shutdown from completing.\n    if (node.scheduler) node.scheduler->stop();\n```\n\nHowever, the scheduler thread seems to cycle normally, so there doesn't seem to be any `SyncWithValidationInterfaceQueue` event stuck in it.",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2665368484",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "commented",
      "id": 2665433174,
      "node_id": "IC_kwDOABII586e30hW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2665433174",
      "actor": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T11:44:48Z",
      "updated_at": "2025-02-18T11:44:48Z",
      "author_association": "MEMBER",
      "body": "> [@pinheadmz](https://github.com/pinheadmz) since you are working on the HTTP rewrite...\n\nI hadn't noticed anything about the current implementation but managing the RPC `stop` race condition was definitely a tricky part of the rewrite. \n\nOne thing to note about the actual total time elapsed in your case is that on CI the timeout factors are multiplied by large factors in some cases to avoid timeout errors on low-resource runners:\n\nhttps://github.com/bitcoin/bitcoin/blob/78c19ddd7c56a275d2ae835fd13ed1508acd7806/.github/workflows/ci.yml#L153-L163\n\nI suppose enabling `libevent` logs may help understanding whats happening...\n\nOr maybe investigate why the `net` thread appears to not get the interrupt signal?",
      "user": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2665433174",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "commented",
      "id": 2665500269,
      "node_id": "IC_kwDOABII586e4E5t",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2665500269",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T12:06:28Z",
      "updated_at": "2025-02-18T12:06:28Z",
      "author_association": "MEMBER",
      "body": "> Or maybe investigate why the `net` thread appears to not get the interrupt signal?\n\nMy impression was that the `net` thread is stopped, along with the http workers, and the http thread. See:\n\n```\nnode1 ...T14:10:53.440186Z (mocktime...) [net] [D:\\a\\bitcoin\\bitcoin\\src\\util\\thread.cpp:22] [TraceThread] net thread exit\n```\n\nThere seem to be two issues here:\n\n* The `stop` RPC timing out\n* The node not stopping",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2665500269",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "commented",
      "id": 2665506921,
      "node_id": "IC_kwDOABII586e4Ghp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2665506921",
      "actor": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T12:08:29Z",
      "updated_at": "2025-02-18T12:08:29Z",
      "author_association": "MEMBER",
      "body": "Hm yeah, but then why does `enabling extra block-relay-only peers` happen after that?",
      "user": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2665506921",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "commented",
      "id": 2665688808,
      "node_id": "IC_kwDOABII586e4y7o",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2665688808",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T13:15:59Z",
      "updated_at": "2025-02-18T13:15:59Z",
      "author_association": "MEMBER",
      "body": "> Hm yeah, but then why does `enabling extra block-relay-only peers` happen after that?\n\nThe `StartExtraBlockRelayPeers` function is logging to the `[net]` category (not to be confused with the `[net]` thread) and is called by `CheckForStaleTipAndEvictPeers`, which is running in the `[scheduler]` thread.",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2665688808",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "commented",
      "id": 2666012863,
      "node_id": "IC_kwDOABII586e6CC_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2666012863",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T15:15:05Z",
      "updated_at": "2025-02-18T15:15:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "```\n[shutoff] [...\\httpserver.cpp:536] [StopHTTPServer] [http] Waiting for 1 connections to stop HTTP server\n[http] [...\\httpserver.cpp:355] [ThreadHTTP] [http] Exited http event loop\n[net] [...\\util\\thread.cpp:22] [TraceThread] net thread exit\n```\nThe fact that we don't get \"Stopped HTTP server\" or even \"Waiting for HTTP event thread to exit\" after these indicates that we are stuck in the lower part of `StopHTTPServer()`:\n\nhttps://github.com/bitcoin/bitcoin/blob/790c509a4796ec47be2275d86b35370ff25a599a/src/httpserver.cpp#L518-L557\n\nSo we're either stuck on `g_requests.WaitUntilEmpty();` or just after, in the `evhttp_free` logic.\n\nThe pending request taking time to complete is likely `stop` or `gettxout`.\n\nIt is a bit worrying that we get \"net thread exit\" before completely stopping HTTP, but I guess the \"net\" thread (`CConnman::ThreadSocketHandler`) is only used for P2P traffic anyways, not HTTP/RPC, so it shouldn't be related.",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2666012863",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "commented",
      "id": 2666205108,
      "node_id": "IC_kwDOABII586e6w-0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2666205108",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T16:21:21Z",
      "updated_at": "2025-02-18T16:21:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "#31019 (macOS) might be the same issue, in which case this would not be windows-specific.\n",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2666205108",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "unlabeled",
      "id": 16351386073,
      "node_id": "UNLE_lADOABII586qeKrGzwAAAAPOnlnZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16351386073",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T16:27:02Z",
      "label": {
        "name": "Windows",
        "color": "884400"
      }
    },
    {
      "event": "commented",
      "id": 2666236912,
      "node_id": "IC_kwDOABII586e64vw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2666236912",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T16:32:57Z",
      "updated_at": "2025-02-18T16:32:57Z",
      "author_association": "MEMBER",
      "body": "> `StopHTTPServer`\n\nCould update the issue title to say \"timeout in StopHTTPServer\"?\n\n> #31019 \n\nThey are not exactly identical. 31019 likely never received an RPC, and the node is expected to raise an init error after running into a wallet init error. However, the function of the deadlock is the same:\n\n```\n node0 2024-10-02T00:15:45.783904Z [shutoff] [src/httpserver.cpp:522] [StopHTTPServer] [http] Stopping HTTP server \n node0 2024-10-02T00:15:45.783911Z [shutoff] [src/httpserver.cpp:524] [StopHTTPServer] [http] Waiting for HTTP worker threads to exit \n...\n(no further log messages from the `[shutoff]` thread)\n```\n\nSo I agree with you that they seem to be the same underlying cause/issue.",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2666236912",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "renamed",
      "id": 16353699235,
      "node_id": "RTE_lADOABII586qeKrGzwAAAAPOwaWj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16353699235",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T18:49:37Z",
      "rename": {
        "from": "test: feature_assumeutxo.py Windows timeout",
        "to": "qa: timeout in StopHTTPServer()"
      }
    },
    {
      "event": "commented",
      "id": 2668999318,
      "node_id": "IC_kwDOABII586fFbKW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2668999318",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-19T15:32:15Z",
      "updated_at": "2025-02-19T15:32:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'm working on making the code a bit more robust:\n- Impose a timeout on HTTP connections shutting down - Maybe related to this issue.\n- Fix an issue where we were not always processing the event to free eventHTTP - Would probably just leak otherwise, shutdown completes regardless of this in my testing.\n```diff\ndiff --git a/src/httpserver.cpp b/src/httpserver.cpp\nindex 88e640c377..ce2534fbd0 100644\n--- a/src/httpserver.cpp\n+++ b/src/httpserver.cpp\n@@ -197,10 +197,15 @@ public:\n         return WITH_LOCK(m_mutex, return m_tracker.size());\n     }\n     //! Wait until there are no more connections with active requests in the tracker\n-    void WaitUntilEmpty() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    //! or return the number of remaining requests on timeout.\n+    size_t WaitUntilEmpty(std::chrono::seconds timeout) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n     {\n-        WAIT_LOCK(m_mutex, lock);\n-        m_cv.wait(lock, [this]() EXCLUSIVE_LOCKS_REQUIRED(m_mutex) { return m_tracker.empty(); });\n+        {\n+            WAIT_LOCK(m_mutex, lock);\n+            m_cv.wait_for(lock, timeout, [this]() EXCLUSIVE_LOCKS_REQUIRED(m_mutex) { return m_tracker.empty(); });\n+        }\n+\n+        return WITH_LOCK(m_mutex, return m_tracker.size());\n     }\n };\n //! Track active requests\n@@ -535,13 +540,17 @@ void StopHTTPServer()\n         if (const auto n_connections{g_requests.CountActiveConnections()}; n_connections != 0) {\n             LogDebug(BCLog::HTTP, \"Waiting for %d connections to stop HTTP server\\n\", n_connections);\n         }\n-        g_requests.WaitUntilEmpty();\n+        if (int connections = g_requests.WaitUntilEmpty(/*timeout=*/5min); connections > 0) {\n+            LogError(\"%d HTTP connections remain after timeout expired. Aborting to avoid freeing resources still under use.\", connections);\n+            std::abort();\n+        }\n     }\n     if (eventHTTP) {\n         // Schedule a callback to call evhttp_free in the event base thread, so\n         // that evhttp_free does not need to be called again after the handling\n         // of unfinished request connections that follows.\n         event_base_once(eventBase, -1, EV_TIMEOUT, [](evutil_socket_t, short, void*) {\n+            LogDebug(BCLog::HTTP, \"Freeing eventHTTP\");\n             evhttp_free(eventHTTP);\n             eventHTTP = nullptr;\n         }, nullptr, nullptr);\n@@ -549,6 +558,17 @@ void StopHTTPServer()\n     if (eventBase) {\n         LogDebug(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n         if (g_thread_http.joinable()) g_thread_http.join();\n+        bool first_run = true;\n+        while (event_base_get_num_events(eventBase, EVENT_BASE_COUNT_ACTIVE | EVENT_BASE_COUNT_ADDED) > 0) {\n+            if (first_run) LogDebug(BCLog::HTTP, \"Processing events left behind by HTTP event thread\");\n+            event_base_loop(eventBase, EVLOOP_NONBLOCK);\n+            if (first_run) {\n+                first_run = false;\n+            } else {\n+                // Only sleep when this happens repetitively.\n+                std::this_thread::sleep_for(100ms);\n+            }\n+        }\n         event_base_free(eventBase);\n         eventBase = nullptr;\n     }\n```\nWith the change I get:\n```\n2025-02-19T15:22:35Z [http] Stopping HTTP server\n2025-02-19T15:22:35Z [http] Waiting for HTTP worker threads to exit\n2025-02-19T15:22:35Z [http] Exited http event loop\n2025-02-19T15:22:35Z [http] Waiting for HTTP event thread to exit\n2025-02-19T15:22:35Z [http] Processing events left behind by HTTP event thread\n2025-02-19T15:22:35Z [http] Freeing eventHTTP\n2025-02-19T15:22:35Z [http] Stopped HTTP server\n```",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31894#issuecomment-2668999318",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31894"
    },
    {
      "event": "labeled",
      "id": 16381085583,
      "node_id": "LE_lADOABII586qeKrGzwAAAAPQY4eP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16381085583",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-20T11:57:27Z",
      "label": {
        "name": "RPC/REST/ZMQ",
        "color": "0052cc"
      }
    }
  ]
}