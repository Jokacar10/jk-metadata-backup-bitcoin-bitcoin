{
  "type": "issue",
  "issue": {
    "id": 2940914827,
    "node_id": "I_kwDOABII586vSsyL",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32124",
    "number": 32124,
    "state": "open",
    "state_reason": null,
    "title": "bitcoind crash with corrupt wallet.dat",
    "body": "```\n2025-03-20T00:52:09Z Using SQLite Version 3.38.5\n2025-03-20T00:52:09Z Using wallet w1\n2025-03-20T00:52:09Z init message: Loading walletâ€¦\n2025-03-20T00:52:09Z SQLite Error. Code: 1. Message: no such column: minversion in \"INSERT INTO main VALUES(?, ?)\"\n2025-03-20T00:52:09Z [w1] Releasing wallet w1..\nterminate called after throwing an instance of 'std::runtime_error'\n  what():  SQLiteDatabase: Failed to close database: database is locked\n```\n\nI had observed `bitcoind` crash a few days back while testing it with a corrupt database. I was testing this because sqlite version was recently updated in core.\n\nNot sure if it is relevant to https://github.com/bitcoin/bitcoin/issues/32111. I can't comment in that issue because @dergoegge has blocked me on GitHub.\n\nFeel free to ignore and close the issue if it's unrelated.",
    "user": {
      "login": "1440000bytes",
      "id": 147166694,
      "node_id": "U_kgDOCMWV5g",
      "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/1440000bytes",
      "html_url": "https://github.com/1440000bytes",
      "followers_url": "https://api.github.com/users/1440000bytes/followers",
      "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
      "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
      "repos_url": "https://api.github.com/users/1440000bytes/repos",
      "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 3,
    "created_at": "2025-03-23T04:47:24Z",
    "updated_at": "2025-03-25T07:51:42Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 16945495187,
      "node_id": "LE_lADOABII586vSsyLzwAAAAPyB7yT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16945495187",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-23T19:32:16Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 2747328830,
      "node_id": "IC_kwDOABII586jwOk-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2747328830",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-24T08:47:10Z",
      "updated_at": "2025-03-24T08:47:10Z",
      "author_association": "MEMBER",
      "body": "> Not sure if it is relevant to [#32111](https://github.com/bitcoin/bitcoin/issues/32111).\n\n32111 is about migrating (corrupt) bdb wallets (likely obtained from fuzzing), with exact steps to reproduce and the crash being due to `Assertion m_wallet_flags == 0 failed`. Whereas this issue is about loading (?) a corrupt (?) sqlite wallet, without steps to reproduce. Also, it is unclear how the two sqlite errors interact and if the second one is due to another dangling process on the system, or not.\n\nSo my recommendation would be to add exact steps to reproduce, similar to #32111.",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32124#issuecomment-2747328830",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124"
    },
    {
      "event": "commented",
      "id": 2748493704,
      "node_id": "IC_kwDOABII586j0q-I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2748493704",
      "actor": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-24T15:16:29Z",
      "updated_at": "2025-03-24T15:16:29Z",
      "author_association": "NONE",
      "body": "Steps to reproduce:\n\n1. Run bitcoind with `bitcoind -regtest`\n2. Create a new wallet which loads on startup with ` bitcoin-cli -regtest -named createwallet wallet_name=w1 load_on_startup=true`\n3. Download sqlite binary: https://www.sqlite.org/download.html\n4. Exit bitcoind\n5. Use arbitrary SQL statements for wallet db with sqlite binary. Use the below SQL statements for the error mentioned in OP.\n    \n    ```\n   $ sqlite3 \"wallet.dat file path\"\n   SQLite version 3.49.1 2025-02-18 13:38:58\n   Enter \".help\" for usage hints.\n   sqlite> CREATE TRIGGER test_trigger BEFORE INSERT ON main\n      ...> BEGIN\n      ...>     UPDATE main SET minversion = 'test' WHERE minversion = minversion;\n      ...> END;\n   sqlite> .exit\n   ```\n6. Restart bitcoind and see the error in logs\n\nNote: I have used v28.0 bitcoin core in this experiment.",
      "user": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32124#issuecomment-2748493704",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124"
    },
    {
      "event": "commented",
      "id": 2750380771,
      "node_id": "IC_kwDOABII586j73rj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2750380771",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-25T07:50:53Z",
      "updated_at": "2025-03-25T07:51:41Z",
      "author_association": "CONTRIBUTOR",
      "body": "This specific crash occurs after an unhandled [exception is thrown](https://github.com/bitcoin/bitcoin/blob/1d281daf8613a3cb7a26759c351ffb34dab0f656/src/wallet/sqlite.cpp#L162-L165) in `SQLiteBatch::SetupSQLStatements()`, when creating a `WalletBatch()` [during](https://github.com/bitcoin/bitcoin/blob/1d281daf8613a3cb7a26759c351ffb34dab0f656/src/wallet/wallet.cpp#L2389) `LoadWallet()`.\n\nIIUC, none of `SQLiteBatch()`'s users, handle errors thrown during batch creation, which seems like an issue to me.",
      "user": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32124#issuecomment-2750380771",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32124"
    }
  ]
}