{
  "type": "issue",
  "issue": {
    "id": 2834239231,
    "node_id": "I_kwDOABII586o7w7_",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31808",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31808/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31808/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31808/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31808",
    "number": 31808,
    "state": "open",
    "state_reason": null,
    "title": "nSequence is not set when spending from satisfiable descriptor with relative timelock",
    "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWhile experimenting with miniscript expressions on regtest (on commit [a43f08c4ae](https://github.com/bitcoin/bitcoin/commits/a43f08c4ae3235f2fa460dd17a7f5f9f9842efd9/)) with the cli, I imported a descriptor with the `older` fragment:\n`wsh(and_v(v:older(2),pk(tprv8ZgxMBicQKsPe5EVQ3cw3S1GdWyKxTeVvgVujejwFgJYGPucrUyPhsR2Zd4ngq3QSfB4HehpXqSPtwdoV7b8JYunU2kPai1AWUUxvb5gkrf/84h/1h/0h/1/*)))#tcaf9v8u`\n\nAfter sending money to an address made from this descriptor using `sendtoaddress` with an amount, I received the error message:\n```\nerror code: -6\nerror message:\nSigning transaction failed\n```\n\nAfter stepping through the code in debug mode I found it was failing on [the following line within `CheckSequence`](https://github.com/bitcoin/bitcoin/blob/a43f08c4ae3235f2fa460dd17a7f5f9f9842efd9/src/script/interpreter.cpp#L1742):\n`const int64_t txToSequence = (int64_t)txTo->vin[nIn].nSequence;`\n\nThis is because the nSequence on the input isn't being set according to the value specified in `older`. \n\nThe easy workaround to this is to use `createrawtransaction` and manually set nSequence\n\n### Expected behaviour\n\nThe expected behavior is a transaction is made with the descriptor-locked input. I'm split between labeling this as a bug or feature request, but chose to file as a bug because the wallet has everything it needs to spend the input. Please reclassify this as a feature request if you do find it fits better with that label.\n\n### Steps to reproduce\n\n- Create a new wallet\n- Import the descriptor and derive an address:\n```\nexport desc=\"wsh(and_v(v:older(2),pk(tprv8ZgxMBicQKsPe5EVQ3cw3S1GdWyKxTeVvgVujejwFgJYGPucrUyPhsR2Zd4ngq3QSfB4HehpXqSPtwdoV7b8JYunU2kPai1AWUUxvb5gkrf/84h/1h/0h/1/*)))#tcaf9v8u\"\nexport descriptors=\"[{\\\"desc\\\":\\\"$desc\\\",\\\"timestamp\\\":\\\"now\\\"}]\"\nb importdescriptors $descriptors\nb deriveaddresses $desc \"[1,1]\"\n```\n- Send money to the generated address from another wallet\n- Generate 3 blocks\n-  Switch back to the wallet with the above descriptor and try to send funds out\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@a43f08c4ae\n\n### Operating system and version\n\nUbuntu\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "Randy808",
      "id": 4742100,
      "node_id": "MDQ6VXNlcjQ3NDIxMDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4742100?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Randy808",
      "html_url": "https://github.com/Randy808",
      "followers_url": "https://api.github.com/users/Randy808/followers",
      "following_url": "https://api.github.com/users/Randy808/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Randy808/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Randy808/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Randy808/subscriptions",
      "organizations_url": "https://api.github.com/users/Randy808/orgs",
      "repos_url": "https://api.github.com/users/Randy808/repos",
      "events_url": "https://api.github.com/users/Randy808/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Randy808/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 2,
    "created_at": "2025-02-06T00:36:29Z",
    "updated_at": "2025-02-06T17:06:45Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2640347090,
      "node_id": "IC_kwDOABII586dYH_S",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2640347090",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-06T16:32:28Z",
      "updated_at": "2025-02-06T16:33:33Z",
      "author_association": "MEMBER",
      "body": "We discussed this a bit off-line.\n\nThere are a number of issues here, and the simple ones can be solved in specialized cases, but the general problem is really a sign of a deeper issue.\n\nThe superficial problems are at least these, which stem from the specific order decisions are made: (1) coin selection, (2) transaction building, (3) input signing.\n* Coin selection may be picking coins which are not (yet) spendable (assuming the intent is to spend right now, and not something to be presigned and broadcast later).\n* Fees may be too wrong because a different spending path is expected to be used at coin selection time then the one actually signed for (which has a different weight), see also https://github.com/bitcoin/bitcoin/pull/26573.\n* Transaction building may be setting nLockTime / nSequence values which aren't actually compatible with what we can sign for.\n\nIn the \"simple\" case, where the signing keys are part of the wallet doing coin selection and transaction building itself, this is in theory solvable (for the locktime/sequence part at least a default could be provided based on the selected coins, but it may still need to be overridden for transactions intended to be broadcast later). I do wonder how common these cases are, though; I expect that most situations that involve multiple branches, locktimes, ... also involve multiple parties. Can you elaborate on your use case?\n\nThe more fundamental issue, I think, is that the descriptors-centric structuring of the wallet isn't well-equiped to reason about \"which keys/spending paths/... will be available at signing time\". It offers a way to derive a set of scriptPubKeys to watch (\"we may have access to a group of participants/wallets which together can spend these coins, but unsure how\") and a way to actually sign after coin-selection and transaction building is already complete.\n\nBut in the general case, one would need a way to provide additional information, in the wallet, or at transaction building time, about which signers/keys one expects the be available. With that information, coin selection can avoid coins which aren't spendable by those parties, locktimes/sequences can be set appropriately for those coins, and fee estimation can be done more correctly. This feels like something [wallet policies](https://github.com/bitcoin/bips/blob/master/bip-0388.mediawiki) are more appropriate for, which are not implemented in Bitcoin Core.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31808#issuecomment-2640347090",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31808"
    },
    {
      "event": "subscribed",
      "id": 16213000064,
      "node_id": "SE_lADOABII586o7w7_zwAAAAPGXr-A",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16213000064",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-06T16:42:40Z"
    },
    {
      "event": "commented",
      "id": 2640490507,
      "node_id": "IC_kwDOABII586dYrAL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2640490507",
      "actor": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-06T17:06:43Z",
      "updated_at": "2025-02-06T17:06:43Z",
      "author_association": "MEMBER",
      "body": ">  I have searched the existing issues\n\nHmm https://github.com/bitcoin/bitcoin/issues/27527. :)\n\n> Transaction building may be setting nLockTime / nSequence values which aren't actually compatible with what we can sign for.\n\nTo add to this, the coin selection algorithm right now may even be selecting coins that are incompatible with each other: https://github.com/bitcoin/bitcoin/issues/27526.",
      "user": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31808#issuecomment-2640490507",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31808"
    }
  ]
}