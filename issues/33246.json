{
  "type": "issue",
  "issue": {
    "id": 3348060065,
    "node_id": "I_kwDOABII587Hj1eh",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33246",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33246/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33246/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33246/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33246",
    "number": 33246,
    "state": "open",
    "state_reason": null,
    "title": "tracing: test `interface_usdt_net.py` fails due to garbage message type in `net:outbound_message` tracepoint",
    "body": "The functional test `interface_usdt_net.py` currently fails on master (commit 73220fc0f958f9b65f66cf0cf042af220b312fc6) on my aarch64 machine, running Ubuntu 25.04:\n```\n$ cmake -B build -DWITH_USDT=ON\n$ cmake --build build -j12\n# ./build/test/functional/interface_usdt_net.py\n2025-08-23T10:53:12.137229Z TestFramework (INFO): PRNG seed is: 2587673157417500984\n2025-08-23T10:53:12.137976Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_iem787yt\n2025-08-23T10:53:12.415409Z TestFramework (INFO): hook into the net:inbound_message and net:outbound_message tracepoints\n2025-08-23T10:53:13.229315Z TestFramework (INFO): connect a P2P test node to our bitcoind node\n2025-08-23T10:53:13.336504Z TestFramework (INFO): check receipt and content of in- and outbound version messages\n2025-08-23T10:53:13.336668Z TestFramework (INFO): check_p2p_message(): inbound P2PMessage(peer=0, addr=127.0.0.1:54608, conn_type=inbound, msg_type=version, msg_size=111)\n2025-08-23T10:53:13.341459Z TestFramework (ERROR): Unexpected exception\nTraceback (most recent call last):\n  File \"/home/thestack/bitcoin/test/functional/test_framework/test_framework.py\", line 195, in main\n    self.run_test()\n    ~~~~~~~~~~~~~^^\n  File \"/home/thestack/bitcoin/./build/test/functional/interface_usdt_net.py\", line 260, in run_test\n    self.p2p_message_tracepoint_test()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/home/thestack/bitcoin/./build/test/functional/interface_usdt_net.py\", line 334, in p2p_message_tracepoint_test\n    check_p2p_message(event, is_inbound)\n    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^\n  File \"/home/thestack/bitcoin/./build/test/functional/interface_usdt_net.py\", line 300, in check_p2p_message\n    if event.msg_type.decode(\"utf-8\") == \"version\":\n       ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xa8 in position 0: invalid start byte\n.....\n```\n\nThe message type parameter in the `net:outbound_message` tracepoint seems to point to garbage at the time it is evaluated in the probe, as printing out the `event.msg_type` contents over a few test runs shows:\n```\nevent.msg_type == b'\\xa8\\xc2\\xffG\\xff\\xff'\nevent.msg_type == b'\\xa8\\xb2\\xfbt\\xff\\xff'\nevent.msg_type == b'\\xa8\\xb2|i\\xff\\xff'\nevent.msg_type == b'\\xa8\\xc2\\xffo\\xff\\xff'\nevent.msg_type == b'\\xa8\\xc2~S\\xff\\xff'\n.....\n```\n\nIt looks like a potential life-time issue, but it's unclear to me how this could be possible at all  (see also e.g. https://github.com/bitcoin/bitcoin/issues/27380#issuecomment-2286970765), given that probes should be executed synchronously and the relevant msgtype object is clearly still alive after the tracepoint call (`msg` gets `std::move`d later in the function though):\nhttps://github.com/bitcoin/bitcoin/blob/73220fc0f958f9b65f66cf0cf042af220b312fc6/src/net.cpp#L3885\n\nOS / compiler / packages:\n```\n$ head -1 /etc/issue\nUbuntu 25.04 \\n \\l\n$ uname -s -r -v -m\nLinux 6.16.0-21-qcom-x1e #21-Ubuntu SMP PREEMPT_DYNAMIC Sun Aug 10 00:54:48 UTC 2025 aarch64\n$ gcc --version | head -1\ngcc (Ubuntu 14.2.0-19ubuntu2) 14.2.0\n$ apt info systemtap-sdt-dev | grep Version\nVersion: 5.1-4.1\n```",
    "user": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 1,
    "created_at": "2025-08-23T11:25:21Z",
    "updated_at": "2025-08-26T23:28:30Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 3226064329,
      "node_id": "IC_kwDOABII587ASdXJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3226064329",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-08-26T23:28:30Z",
      "updated_at": "2025-08-26T23:28:30Z",
      "author_association": "MEMBER",
      "body": "I'm able to reproduce this with a release build, but not a debug build.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33246#issuecomment-3226064329",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33246"
    }
  ]
}