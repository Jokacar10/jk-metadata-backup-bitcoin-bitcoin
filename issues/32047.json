{
  "type": "issue",
  "issue": {
    "id": 2915097814,
    "node_id": "I_kwDOABII586twNzW",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32047",
    "number": 32047,
    "state": "open",
    "state_reason": null,
    "title": "BnB untested/unused condition in UTXO exclusion optimization",
    "body": "If the following condition is remove, no failure occurs:\n`utxo.fee != utxo_pool.at(utxo_pool_index - 1).fee)`\n\nhttps://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177\n\nFurthermore, I believe that this condition isn't actually needed and can be removed, which would slightly boost performance.  The section is checking if a UTXO can be omitted from evaluation if it has the same effective_value as the previous UTXO and the previous was already omitted.  The condition in question is comparing if the fee is different between the previous and the current UTXO.  The only way for the fees to be different is if the effective_value is different, however the previous condition: `utxo.GetSelectionAmount() != utxo_pool.at(utxo_pool_index - 1).GetSelectionAmount()` already compared the effective_values.\n\nPut another way, if one of the conditions is true, the UTXO shortcut can _not_ be applied.  If the effective_values where not the same, then don't do the shortcut except if the fees are the same.  But the only way fees can be different is if the effective_values are different which creates a contradiction.\n\nLastly, I'm struggling to understand what the motivation is to have this condition in the first place.  The condition translates to: If the fee is different between the current UTXO and the previous UTXO, then exclude the current one from the selection shortcut (which as I pointed out would never happen because of the aforementioned contradiction where the effective_value and fee are conditionally dependent).",
    "user": {
      "login": "yancyribbens",
      "id": 817736,
      "node_id": "MDQ6VXNlcjgxNzczNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yancyribbens",
      "html_url": "https://github.com/yancyribbens",
      "followers_url": "https://api.github.com/users/yancyribbens/followers",
      "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
      "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
      "repos_url": "https://api.github.com/users/yancyribbens/repos",
      "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 13,
    "created_at": "2025-03-12T20:30:37Z",
    "updated_at": "2025-03-22T13:06:14Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2719074335,
      "node_id": "IC_kwDOABII586iEcgf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2719074335",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:39:21Z",
      "updated_at": "2025-03-12T20:39:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "cc @murchandamus ",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2719074335",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "mentioned",
      "id": 16720868033,
      "node_id": "MEE_lADOABII586twNzWzwAAAAPkpDLB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16720868033",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:39:22Z"
    },
    {
      "event": "subscribed",
      "id": 16720868048,
      "node_id": "SE_lADOABII586twNzWzwAAAAPkpDLQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16720868048",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:39:22Z"
    },
    {
      "event": "commented",
      "id": 2719110760,
      "node_id": "IC_kwDOABII586iElZo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2719110760",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:57:01Z",
      "updated_at": "2025-03-12T20:57:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "I also just wanted to add that, even if there was the extremely unlikely event where two utxos had the same effective_value and different fee values, the optimization should only compare effective_values as I understand it.",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2719110760",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2719272219,
      "node_id": "IC_kwDOABII586iFM0b",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2719272219",
      "actor": {
        "login": "Nouridin",
        "id": 39697812,
        "node_id": "MDQ6VXNlcjM5Njk3ODEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/39697812?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Nouridin",
        "html_url": "https://github.com/Nouridin",
        "followers_url": "https://api.github.com/users/Nouridin/followers",
        "following_url": "https://api.github.com/users/Nouridin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Nouridin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Nouridin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Nouridin/subscriptions",
        "organizations_url": "https://api.github.com/users/Nouridin/orgs",
        "repos_url": "https://api.github.com/users/Nouridin/repos",
        "events_url": "https://api.github.com/users/Nouridin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Nouridin/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T22:32:03Z",
      "updated_at": "2025-03-12T22:32:03Z",
      "author_association": "NONE",
      "body": "In summary, while the fee check may be redundant given the current relationships between effective value and fee, it was likely originally added to ensure that the shortcut is _only_ applied when both the effective value and the spending fee are identical. Since testing shows that removing it does not lead to failures, it appears safe to remove it, but any change in this well‐tuned coin selection code must be approached with caution given the subtle and sometimes unexpected interactions in coin selection.\n(at least that what I believe)",
      "user": {
        "login": "Nouridin",
        "id": 39697812,
        "node_id": "MDQ6VXNlcjM5Njk3ODEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/39697812?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Nouridin",
        "html_url": "https://github.com/Nouridin",
        "followers_url": "https://api.github.com/users/Nouridin/followers",
        "following_url": "https://api.github.com/users/Nouridin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Nouridin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Nouridin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Nouridin/subscriptions",
        "organizations_url": "https://api.github.com/users/Nouridin/orgs",
        "repos_url": "https://api.github.com/users/Nouridin/repos",
        "events_url": "https://api.github.com/users/Nouridin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Nouridin/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2719272219",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "labeled",
      "id": 16725824286,
      "node_id": "LE_lADOABII586twNzWzwAAAAPk79Me",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16725824286",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T06:01:28Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 2721005512,
      "node_id": "IC_kwDOABII586iLz_I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2721005512",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T11:56:05Z",
      "updated_at": "2025-03-13T11:56:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "I believe it's possible for effective_value to _not_ be equal between two successive UTXO combinations while two fees _are_ equal.  This would have the consequence of _not_ applying the optimization when in principle the optimization _should_ be applied.  In fact, I think it's very likely for two fees to be equal since it's likely the fee_rates are equal and the weight is equal of two UTXOs.  Therefore, leaving this condition in has the disadvantage of nullifying the effect of the UTXO optimization performance increase. Earlier I believe I misspoke when I said it was unlikely for effective_value and fee to contradict each other per UTXO, but I believe adding this [parameter](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) is unneeded and is likely to worsen performance.",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2721005512",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2721031585,
      "node_id": "IC_kwDOABII586iL6Wh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2721031585",
      "actor": {
        "login": "Nouridin",
        "id": 39697812,
        "node_id": "MDQ6VXNlcjM5Njk3ODEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/39697812?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Nouridin",
        "html_url": "https://github.com/Nouridin",
        "followers_url": "https://api.github.com/users/Nouridin/followers",
        "following_url": "https://api.github.com/users/Nouridin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Nouridin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Nouridin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Nouridin/subscriptions",
        "organizations_url": "https://api.github.com/users/Nouridin/orgs",
        "repos_url": "https://api.github.com/users/Nouridin/repos",
        "events_url": "https://api.github.com/users/Nouridin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Nouridin/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T12:07:26Z",
      "updated_at": "2025-03-13T12:07:26Z",
      "author_association": "NONE",
      "body": "Your reasoning is sound. If you consider that many UTXOs will have equal fees—because they share the same fee rate and weight—then requiring both the effective value and the fee to match before applying the shortcut can indeed be overly strict. In scenarios where the fees are identical but the effective values differ slightly (perhaps due to minor rounding or variation in the UTXO values), the condition\n`utxo.fee != utxo_pool.at(utxo_pool_index - 1).fee`\n\nwill cause the optimization to be bypassed. This means that even if the fee component is effectively the same across UTXOs, any difference in effective value prevents the shortcut from being used, thereby nullifying the potential performance improvement.\n\nRemoving the fee comparison would allow the optimization to trigger based solely on matching effective values. This is particularly attractive if, in practice, the fee rates and weights are uniform enough that fees are almost always equal. Of course, such a change would need thorough testing to ensure that no edge cases are missed where the fee difference might indicate a meaningful divergence between UTXOs.\n\nIn summary, if the vast majority of your UTXOs have equal fees due to identical fee rates and weights, then the fee check can indeed be seen as an unnecessary constraint that prevents the coin selection optimization from being applied, potentially worsening performance.",
      "user": {
        "login": "Nouridin",
        "id": 39697812,
        "node_id": "MDQ6VXNlcjM5Njk3ODEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/39697812?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Nouridin",
        "html_url": "https://github.com/Nouridin",
        "followers_url": "https://api.github.com/users/Nouridin/followers",
        "following_url": "https://api.github.com/users/Nouridin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Nouridin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Nouridin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Nouridin/subscriptions",
        "organizations_url": "https://api.github.com/users/Nouridin/orgs",
        "repos_url": "https://api.github.com/users/Nouridin/repos",
        "events_url": "https://api.github.com/users/Nouridin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Nouridin/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2721031585",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2729873842,
      "node_id": "IC_kwDOABII586itpGy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2729873842",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-17T15:04:25Z",
      "updated_at": "2025-03-17T15:04:25Z",
      "author_association": "CONTRIBUTOR",
      "body": "I did some testing on this issue and I found that if the [parameter](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) is removed, one of [tests](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/test/coinselector_tests.cpp#L427) finishes in 3 fewer iterations, from 38 iterations to 35.  The reason the test is more efficient without the added parameter is that there are two UTXOs with the same effective value of `5000000 sats` but different weights and fees:\n\n```\nUTXO A\nvalue: 5000000\nfee: 204\nweight: 272\n\nUTXO B\nvalue: 5000000\nfee: 1200000\nweight: 1600000\n```\n\nDuring the selection, if UTXO A is found to not contribute towards a solution, the algorithm should dismiss UTXO B as also not contributing toward the  solution and skip without an iteration consumed.  However, since the parameter will only skip if the fees are equivalent, the UTXO is instead evaluated and _not_skipped.\n\nA few other observations about this test is that the fee of `UTXO B` is not a practical value because the weight is extreme (1600000).  However, even if the fee and weight are reasonable and different, the same fault would occur during evaluation of the UTXO skip optimization.  Furthermore, this code could also be improved by skipping evaluation of the UTXO if the weight is greater than `max_selection_weight` which it is by far.\n\nLastly, I tried to track down when the [parameter](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) was added in hopes of understanding why.  Unfortunately the param was present in the origin PR  [here](\nhttps://github.com/bitcoin/bitcoin/pull/10637/files#diff-d473ed8396f9451afb848923cfcfaa630c9811a78e07f3ae1ffd3a65da218accR145) by @achow101 without an explanation from what I can tell.  So I'm at a loss to understand why this parameter exists which appears to degrade performance without any added benefit that I can find.\n\nThe recommendations I have to improve the state of the algorithm:\n* Remove the [parameter](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) which is degrading performance in some occasions where two effective values are the same but have different fees\n* Add an iteration count to the API so it can be clearly seen when performance improves or degrades in terms of iteration count\n* Skip evaluating UTXOs that are greater than `max_selection_weight`",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2729873842",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "mentioned",
      "id": 16807754513,
      "node_id": "MEE_lADOABII586twNzWzwAAAAPp0fsR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16807754513",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-17T15:04:26Z"
    },
    {
      "event": "subscribed",
      "id": 16807754591,
      "node_id": "SE_lADOABII586twNzWzwAAAAPp0ftf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16807754591",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-17T15:04:26Z"
    },
    {
      "event": "commented",
      "id": 2734990522,
      "node_id": "IC_kwDOABII586jBKS6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2734990522",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-19T00:09:02Z",
      "updated_at": "2025-03-19T14:39:09Z",
      "author_association": "CONTRIBUTOR",
      "body": "> The only way for the fees to be different is if the effective_value is different, however the previous condition: `utxo.GetSelectionAmount() != utxo_pool.at(utxo_pool_index - 1).GetSelectionAmount()` already compared the effective_values.\n\nThis is not accurate. You could have two UTXOs of different output types that have the same effective value but differing fees. Counterexample:\n\nFeerate: 10 sat/vB\n\nUTXO_1:\n  type: P2WPKH,\n  amount: 10,680 sats\n  input weight: 68 vB\n  **fee: 680 sats**\n  **eff_value: 10,000**\n\nUTXO_2:\n  type: P2TR\n  amount: 10,575 sats\n  input_weight: 57.5 vB\n  **fee: 575 sats**\n  **eff_value: 10,000**\n\nHowever, since [CoinGrinder got merged](https://github.com/bitcoin/bitcoin/pull/27877/commits/89d09566431f57034d9a7df32547ceb13d79c62c) UTXO sorting tiebreaks by preferring lower waste on equal effective value, so yes, if the first UTXO is skipped combining with a later UTXO of same effective value will always have worse waste, so I think skipping a subsequent UTXO even when the fee differs is now correct.\n\nI.e. at low feerates, P2WPKH would sort before P2TR when effective value ties, and at high feerates P2TR would sort before P2WPKH when effective value ties.",
      "user": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2734990522",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "comment_deleted",
      "id": 16853423038,
      "node_id": "CDE_lADOABII586twNzWzwAAAAPsitO-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16853423038",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-19T03:39:27Z"
    },
    {
      "event": "commented",
      "id": 2737655586,
      "node_id": "IC_kwDOABII586jLU8i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2737655586",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-19T18:33:01Z",
      "updated_at": "2025-03-19T18:34:08Z",
      "author_association": "CONTRIBUTOR",
      "body": "> This is not accurate. You could have two UTXOs of different output types that have the same effective value but differing fees. Counterexample:\n\nYes, I redacted that comment later in the thread as my understand of the problem improved.  As I posted last, there's even a test [here](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/test/coinselector_tests.cpp#L427) that tests two UTXOs with the same effective_value yet different fees.\n\n> However, since [CoinGrinder got merged](https://github.com/bitcoin/bitcoin/pull/27877/commits/89d09566431f57034d9a7df32547ceb13d79c62c) UTXO sorting tiebreaks by preferring lower waste on equal effective value, so yes, if the first UTXO is skipped combining with a later UTXO of same effective value will always have worse waste, so I think skipping a subsequent UTXO even when the fee differs is now correct\n\nAh that's interesting.  I see now why the param was originally added.  Before `coin_grinder` was added which imposed a sort order on waste and effective value, it _was_ possible for two UTXOs to have the same `effective_value` yet different waste scores.  That is, two UTXOs can have the same `effective_value` but a different future `effective_value` as calculated with `long_term_fee_rate`.  I agree though that now the parameter is superfluous where as before the sort order was improved, it did make a difference.\n",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2737655586",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2737675105,
      "node_id": "IC_kwDOABII586jLZth",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2737675105",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-19T18:41:09Z",
      "updated_at": "2025-03-19T18:41:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "However, doesn't the waste score account for long_term_fee_rate as well as fee_rate?  In other-words, just comparing `fee` amounts and not `long_term_fee_rate` would not be enough to know if comparing two UTXOs have different waste scores..",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2737675105",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2741233287,
      "node_id": "IC_kwDOABII586jY-aH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2741233287",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-20T17:46:39Z",
      "updated_at": "2025-03-20T17:46:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "The `long_term_fee_rate` and `fee_rate` are the same for all UTXOs in a single coin selection attempt, so if two UTXOs have the same fee, their inputs have the same weight, if they also have the same effective value, they are interchangeable. If they only have the same effective value but different fees, it means that they have differing weights. Similarly, waste simply scales with the weight across UTXOs, as it is weight times `long_term_fee_rate - fee_rate`. So, if two UTXOs have the same effective value, but different waste scores, it is congruent to them having different fees.",
      "user": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2741233287",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2743737637,
      "node_id": "IC_kwDOABII586jih0l",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2743737637",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-21T15:33:12Z",
      "updated_at": "2025-03-21T15:33:12Z",
      "author_association": "CONTRIBUTOR",
      "body": "> The long_term_fee_rate and fee_rate are the same for all UTXOs in a single coin selection attempt\n\nAgree.  I think that's a little confusing the way the C++ algorithm is structured and treats fee_rate and long_term_fee_rate per UTXO instead of just passing in the fee_rate params as a per sort argument.\n\n> so if two UTXOs have the same fee, their inputs have the same weight\n\nRight, since fee is derived from fee_rate and weight, and fee_rate is guaranteed to be the same, the only true variable is weight.\n\n>  if they also have the same effective value, they are interchangeable.\n\nYes, so they are interchangeable if they have the same weight and the same value since effective_value is derived from fee_rate (not variable between UTXOs), value and weight.\n\n> If they only have the same effective value but different fees, it means that they have differing weights.\n\nYes, it follows given that the only variable of consequence have been shown to be value and weight.\n\n> Similarly, waste simply scales with the weight across UTXOs, as it is weight times long_term_fee_rate - fee_rate\n\nAlright, so that means waste is derivative of Weight since long_term_fee_rate and fee_rate are both non-variable between UTXOs.\n\n> So, if two UTXOs have the same effective value, but different waste scores, it is congruent to them having different fees.\n\nAnd different Weights.\n\nIn summery, two UTXOs are equivalent if both value and weight are the same, and if value is the same but weight is different, prefer the UTXO with lower weight since waste score is a derivative of weight.  Therefore, if UTXOs are sorted by value with a tie breaker of weight, then if UTXO A was a skip during selection and a successive UTXO B has the same value, it can also be skipped regardless of fee given it's sort order.  A sort by only `effective_value` would not be enough to make such a guarantee since `effective_values` between two successive UTXOs could have the same `effective_value` but different `weights` and therefore different waste scores.\n\nAlso, sorting UTXOs by the ratio of value/weight would have the same benefit as sorting by value with tie breaker of weight but that's besides the point.\n",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2743737637",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2744164157,
      "node_id": "IC_kwDOABII586jkJ89",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2744164157",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-21T18:36:07Z",
      "updated_at": "2025-03-21T18:42:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "> In summery, two UTXOs are equivalent if both value and weight are the same, and if value is the same but weight is different, prefer the UTXO with lower weight since waste score is a derivative of weight. \n\nClose, but there is a subtlety here. If we were sorting by effective_value and tie-breaking fee or weight, we would always be preferring lower weight, but instead, we tie-break on waste. That means that we will prefer lower weight if `fee_rate` is higher than `long_term_fee_rate`, but we will prefer _higher_ weight if `fee_rate` is lower than `long_term_fee_rate`. This dynamic ensures that we prefer spending old, less blockspace-efficient UTXOs at low feerates, but prefer more blockspace-efficient UTXOs at high feerates.\n\n> Therefore, if UTXOs are sorted by value with a tie breaker of weight, then if UTXO A was a skip during selection and a successive UTXO B has the same value, it can also be skipped regardless of fee given it's sort order. A sort by only `effective_value` would not be enough to make such a guarantee since `effective_values` between two successive UTXOs could have the same `effective_value` but different `weights` and therefore different waste scores.\n\nCorrect, and this still works with our waste-based sort order as intended: if we are in a low-feerate situation, the heaviest UTXOs are sorted first, and we skip same-weight or lighter UTXOs of the same effective value. If we are in a high-feerate situation, we skip same-weight and heavier UTXOs of the same effective value, because in both situation the subsequent UTXOs would lead to a similar selection with a worse waste score.\n\n> Also, sorting UTXOs by the ratio of value/weight would have the same benefit as sorting by value with tie breaker of weight but that's besides the point.\n\nUnfortunately not. We explored sorting by descending value density while developing CoinGrinder, and the problem with that approach is that two subsequent UTXO no longer make similar progress toward the `selection_target` and may not be good replacements for each other (e.g., a P2PKH UTXO with 148,000 sats and a P2TR UTXO with 57,500 sats have the same value density). It lead to CoinGrinder sometimes finding the best solution much faster, but sometimes finding it slower. It just traversed the combination space in a radically different order. I think that it would not be compatible with most of the optimizations we found for CoinGrinder, although there might be other similar ones. We had wondered whether it might generally be stronger for CoinGrinder, but discarded the approach after determining that it was just different—vying instead to keep it similar to BnB and easier to reason about. I think that sorting by value density would not work at all for BnB, as I would expect it to significantly reduce the opportunities to bound the search space if we cannot skip many subtrees in the search graph after overshooting the target.",
      "user": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2744164157",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2745259917,
      "node_id": "IC_kwDOABII586joVeN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2745259917",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-22T13:06:14Z",
      "updated_at": "2025-03-22T13:06:14Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Close, but there is a subtlety here..\n\nThanks, that's a good point I might have overlooked, that in a high fee environment, the tie break on weight is different than in a low fee environment.\n\n> Unfortunately not. We explored sorting by descending value density while developing CoinGrinder..\n\nHmm that make sense now that you say it.  sorting by density isn't strictly equivalent to sorting by value with weight as a tie break and as such would change the behavior of the search.\n\nSo, it sounds like we are in agreement that the [fee comparison](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) in BnB can be removed.  I'm tempted to explore adding an iteration count to BnB like coin-grinder since that would make the change nicer.  IE if we had an iteration count, then removing the parameter wouldn't require any test changes because it would be apparent that in [test](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/test/coinselector_tests.cpp#L427) the iteration count was reduced with the removal of the condition.  Adding an iteration count would also strengthen the tests now and against future changes.  However, the easiest change for this would be to add a test where 5k or so inputs have the same effective_value and different fee values and a solution can't be found because the [condition](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) causes the UTXO shortcut to not be evaluated.  And maybe a test to show it behaves different in low-fee vs high-fee environment.",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2745259917",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    }
  ]
}