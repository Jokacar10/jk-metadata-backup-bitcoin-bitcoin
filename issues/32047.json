{
  "type": "issue",
  "issue": {
    "id": 2915097814,
    "node_id": "I_kwDOABII586twNzW",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/32047",
    "number": 32047,
    "state": "open",
    "state_reason": null,
    "title": "BnB untested/unused condition in UTXO exclusion optimization",
    "body": "If the following condition is remove, no failure occurs:\n`utxo.fee != utxo_pool.at(utxo_pool_index - 1).fee)`\n\nhttps://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177\n\nFurthermore, I believe that this condition isn't actually needed and can be removed, which would slightly boost performance.  The section is checking if a UTXO can be omitted from evaluation if it has the same effective_value as the previous UTXO and the previous was already omitted.  The condition in question is comparing if the fee is different between the previous and the current UTXO.  The only way for the fees to be different is if the effective_value is different, however the previous condition: `utxo.GetSelectionAmount() != utxo_pool.at(utxo_pool_index - 1).GetSelectionAmount()` already compared the effective_values.\n\nPut another way, if one of the conditions is true, the UTXO shortcut can _not_ be applied.  If the effective_values where not the same, then don't do the shortcut except if the fees are the same.  But the only way fees can be different is if the effective_values are different which creates a contradiction.\n\nLastly, I'm struggling to understand what the motivation is to have this condition in the first place.  The condition translates to: If the fee is different between the current UTXO and the previous UTXO, then exclude the current one from the selection shortcut (which as I pointed out would never happen because of the aforementioned contradiction where the effective_value and fee are conditionally dependent).",
    "user": {
      "login": "yancyribbens",
      "id": 817736,
      "node_id": "MDQ6VXNlcjgxNzczNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yancyribbens",
      "html_url": "https://github.com/yancyribbens",
      "followers_url": "https://api.github.com/users/yancyribbens/followers",
      "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
      "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
      "repos_url": "https://api.github.com/users/yancyribbens/repos",
      "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 4,
    "created_at": "2025-03-12T20:30:37Z",
    "updated_at": "2025-03-13T11:56:08Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2719074335,
      "node_id": "IC_kwDOABII586iEcgf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2719074335",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:39:21Z",
      "updated_at": "2025-03-12T20:39:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "cc @murchandamus ",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2719074335",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "mentioned",
      "id": 16720868033,
      "node_id": "MEE_lADOABII586twNzWzwAAAAPkpDLB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16720868033",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:39:22Z"
    },
    {
      "event": "subscribed",
      "id": 16720868048,
      "node_id": "SE_lADOABII586twNzWzwAAAAPkpDLQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16720868048",
      "actor": {
        "login": "murchandamus",
        "id": 4060799,
        "node_id": "MDQ6VXNlcjQwNjA3OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4060799?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/murchandamus",
        "html_url": "https://github.com/murchandamus",
        "followers_url": "https://api.github.com/users/murchandamus/followers",
        "following_url": "https://api.github.com/users/murchandamus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/murchandamus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/murchandamus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/murchandamus/subscriptions",
        "organizations_url": "https://api.github.com/users/murchandamus/orgs",
        "repos_url": "https://api.github.com/users/murchandamus/repos",
        "events_url": "https://api.github.com/users/murchandamus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/murchandamus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:39:22Z"
    },
    {
      "event": "commented",
      "id": 2719110760,
      "node_id": "IC_kwDOABII586iElZo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2719110760",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T20:57:01Z",
      "updated_at": "2025-03-12T20:57:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "I also just wanted to add that, even if there was the extremely unlikely event where two utxos had the same effective_value and different fee values, the optimization should only compare effective_values as I understand it.",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2719110760",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "commented",
      "id": 2719272219,
      "node_id": "IC_kwDOABII586iFM0b",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2719272219",
      "actor": {
        "login": "Nouridin",
        "id": 39697812,
        "node_id": "MDQ6VXNlcjM5Njk3ODEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/39697812?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Nouridin",
        "html_url": "https://github.com/Nouridin",
        "followers_url": "https://api.github.com/users/Nouridin/followers",
        "following_url": "https://api.github.com/users/Nouridin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Nouridin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Nouridin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Nouridin/subscriptions",
        "organizations_url": "https://api.github.com/users/Nouridin/orgs",
        "repos_url": "https://api.github.com/users/Nouridin/repos",
        "events_url": "https://api.github.com/users/Nouridin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Nouridin/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T22:32:03Z",
      "updated_at": "2025-03-12T22:32:03Z",
      "author_association": "NONE",
      "body": "In summary, while the fee check may be redundant given the current relationships between effective value and fee, it was likely originally added to ensure that the shortcut is _only_ applied when both the effective value and the spending fee are identical. Since testing shows that removing it does not lead to failures, it appears safe to remove it, but any change in this well‐tuned coin selection code must be approached with caution given the subtle and sometimes unexpected interactions in coin selection.\n(at least that what I believe)",
      "user": {
        "login": "Nouridin",
        "id": 39697812,
        "node_id": "MDQ6VXNlcjM5Njk3ODEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/39697812?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Nouridin",
        "html_url": "https://github.com/Nouridin",
        "followers_url": "https://api.github.com/users/Nouridin/followers",
        "following_url": "https://api.github.com/users/Nouridin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Nouridin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Nouridin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Nouridin/subscriptions",
        "organizations_url": "https://api.github.com/users/Nouridin/orgs",
        "repos_url": "https://api.github.com/users/Nouridin/repos",
        "events_url": "https://api.github.com/users/Nouridin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Nouridin/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2719272219",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    },
    {
      "event": "labeled",
      "id": 16725824286,
      "node_id": "LE_lADOABII586twNzWzwAAAAPk79Me",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16725824286",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T06:01:28Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 2721005512,
      "node_id": "IC_kwDOABII586iLz_I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2721005512",
      "actor": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T11:56:05Z",
      "updated_at": "2025-03-13T11:56:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "I believe it's possible for effective_value to _not_ be equal between two successive UTXO combinations while two fees _are_ equal.  This would have the consequence of _not_ applying the optimization when in principle the optimization _should_ be applied.  In fact, I think it's very likely for two fees to be equal since it's likely the fee_rates are equal and the weight is equal of two UTXOs.  Therefore, leaving this condition in has the disadvantage of nullifying the effect of the UTXO optimization performance increase. Earlier I believe I misspoke when I said it was unlikely for effective_value and fee to contradict each other per UTXO, but I believe adding this [parameter](https://github.com/bitcoin/bitcoin/blob/eb9730ab65887279309af338ad0201924f945ac5/src/wallet/coinselection.cpp#L177) is unneeded and is likely to worsen performance.",
      "user": {
        "login": "yancyribbens",
        "id": 817736,
        "node_id": "MDQ6VXNlcjgxNzczNg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/817736?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yancyribbens",
        "html_url": "https://github.com/yancyribbens",
        "followers_url": "https://api.github.com/users/yancyribbens/followers",
        "following_url": "https://api.github.com/users/yancyribbens/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yancyribbens/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yancyribbens/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yancyribbens/subscriptions",
        "organizations_url": "https://api.github.com/users/yancyribbens/orgs",
        "repos_url": "https://api.github.com/users/yancyribbens/repos",
        "events_url": "https://api.github.com/users/yancyribbens/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yancyribbens/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/32047#issuecomment-2721005512",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32047"
    }
  ]
}