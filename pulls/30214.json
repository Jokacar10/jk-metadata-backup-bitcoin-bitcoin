{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214",
    "id": 1898129875,
    "node_id": "PR_kwDOABII585xIynT",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30214",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30214.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30214.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/12f276ba2bfc106083c1615539857cdefff9794b",
    "number": 30214,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "refactor: Improve assumeutxo state representation",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "This PR contains the first part of #28608, which tries to make assumeutxo code more maintainable, and improve it by not locking `cs_main` for a long time when the snapshot block is connected, and by deleting the snapshot validation chainstate when it is no longer used, instead of waiting until the next restart.\r\n\r\nThe changes in this PR are just refactoring. They make `Chainstate` objects self-contained, so for example, it is possible to determine what blocks to connect to a chainstate without querying `ChainstateManager`, and to determine whether a Chainstate is validated without basing it on inferences like `&cs != &ActiveChainstate()` or `GetAll().size() == 1`.\r\n\r\nThe PR also tries to make assumeutxo terminology less confusing, using \"current chainstate\" to refer to the chainstate targeting the current network tip, and \"historical chainstate\" to refer to the chainstate downloading old blocks and validating the assumeutxo snapshot. It removes uses of the terms \"active chainstate,\" \"usable chainstate,\" \"disabled chainstate,\" \"ibd chainstate,\" and \"snapshot chainstate\" which are confusing for various reasons.",
    "labels": [
      {
        "id": 135961,
        "node_id": "MDU6TGFiZWwxMzU5NjE=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
        "name": "Refactoring",
        "color": "E6F6D6",
        "default": false
      },
      {
        "id": 955867938,
        "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
        "name": "Needs rebase",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2024-05-31T14:53:10Z",
    "updated_at": "2025-04-16T17:46:58Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "224fd128743218b251b8fbef919eaa7169fa1333",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "ryanofsky:pr/cstate",
      "ref": "pr/cstate",
      "sha": "12f276ba2bfc106083c1615539857cdefff9794b",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 69901633,
        "node_id": "MDEwOlJlcG9zaXRvcnk2OTkwMTYzMw==",
        "name": "bitcoin",
        "full_name": "ryanofsky/bitcoin",
        "owner": {
          "login": "ryanofsky",
          "id": 7133040,
          "node_id": "MDQ6VXNlcjcxMzMwNDA=",
          "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/ryanofsky",
          "html_url": "https://github.com/ryanofsky",
          "followers_url": "https://api.github.com/users/ryanofsky/followers",
          "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
          "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
          "repos_url": "https://api.github.com/users/ryanofsky/repos",
          "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/ryanofsky/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/ryanofsky/bitcoin",
        "archive_url": "https://api.github.com/repos/ryanofsky/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/ryanofsky/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/ryanofsky/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/ryanofsky/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/ryanofsky/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/ryanofsky/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/ryanofsky/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/ryanofsky/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/ryanofsky/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/ryanofsky/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/ryanofsky/bitcoin/events",
        "forks_url": "https://api.github.com/repos/ryanofsky/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/ryanofsky/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/ryanofsky/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/ryanofsky/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/ryanofsky/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/ryanofsky/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/ryanofsky/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/ryanofsky/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/ryanofsky/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/ryanofsky/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/ryanofsky/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/ryanofsky/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/ryanofsky/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:ryanofsky/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/ryanofsky/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/ryanofsky/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/ryanofsky/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/ryanofsky/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/ryanofsky/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/ryanofsky/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/ryanofsky/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/ryanofsky/bitcoin/hooks",
        "svn_url": "https://github.com/ryanofsky/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 6,
        "stargazers_count": 17,
        "watchers_count": 17,
        "size": 280208,
        "default_branch": "master",
        "open_issues_count": 3,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-04-16T17:45:21Z",
        "created_at": "2016-10-03T19:05:43Z",
        "updated_at": "2025-03-31T20:15:25Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "cdc32994feadf3f15df3cfac5baae36b4b011462",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 37067,
        "stargazers_count": 82922,
        "watchers_count": 82922,
        "size": 279803,
        "default_branch": "master",
        "open_issues_count": 708,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-04-15T10:07:58Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-04-16T17:54:35Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 710,
    "deletions": 750,
    "changed_files": 39,
    "commits": 18,
    "review_comments": 51,
    "comments": 14
  },
  "events": [
    {
      "event": "commented",
      "id": 2142439540,
      "node_id": "IC_kwDOABII585_swh0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142439540",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T14:53:13Z",
      "updated_at": "2025-04-10T16:21:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/30214.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2699856438) |\n| Approach ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2177291599), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2685423528) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32043](https://github.com/bitcoin/bitcoin/pull/32043) ([IBD] Tracking PR for speeding up Initial Block Download by l0rinc)\n* [#31845](https://github.com/bitcoin/bitcoin/pull/31845) (Add -pruneduringinit option to temporarily use another prune target during IBD by luke-jr)\n* [#31615](https://github.com/bitcoin/bitcoin/pull/31615) (validation: ensure assumevalid is always used during reindex by Eunovo)\n* [#31533](https://github.com/bitcoin/bitcoin/pull/31533) (fuzz: Add fuzz target for block index tree and related validation events by mzumsande)\n* [#31382](https://github.com/bitcoin/bitcoin/pull/31382) (kernel: Flush in ChainstateManager destructor by TheCharlatan)\n* [#31282](https://github.com/bitcoin/bitcoin/pull/31282) (refactor: Make node_id a const& in RemoveBlockRequest by maflcko)\n* [#31144](https://github.com/bitcoin/bitcoin/pull/31144) ([IBD] multi-byte block obfuscation by l0rinc)\n* [#30610](https://github.com/bitcoin/bitcoin/pull/30610) (validation: do not wipe utxo cache for stats/scans/snapshots by sipa)\n* [#30595](https://github.com/bitcoin/bitcoin/pull/30595) (kernel: Introduce initial C header API by TheCharlatan)\n* [#30221](https://github.com/bitcoin/bitcoin/pull/30221) (wallet: Ensure best block matches wallet scan state by achow101)\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n* [#29680](https://github.com/bitcoin/bitcoin/pull/29680) (wallet: fix unrelated parent conflict doesn't cause child tx to be marked as conflict by Eunovo)\n* [#29652](https://github.com/bitcoin/bitcoin/pull/29652) (wallet: Avoid potentially writing incorrect best block locator by ryanofsky)\n* [#29641](https://github.com/bitcoin/bitcoin/pull/29641) (scripted-diff: Use LogInfo over LogPrintf [WIP, NOMERGE, DRAFT] by maflcko)\n* [#29039](https://github.com/bitcoin/bitcoin/pull/29039) (versionbits refactoring by ajtowns)\n* [#28710](https://github.com/bitcoin/bitcoin/pull/28710) (Remove the legacy wallet and BDB dependency by achow101)\n* [#26022](https://github.com/bitcoin/bitcoin/pull/26022) (Add util::ResultPtr class by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2142439540",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "labeled",
      "id": 13001884170,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMG-QIK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13001884170",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T14:53:15Z",
      "label": {
        "name": "Refactoring",
        "color": "E6F6D6"
      }
    },
    {
      "event": "labeled",
      "id": 13005246304,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMHLE9g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13005246304",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T19:56:38Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2142897707,
      "node_id": "IC_kwDOABII585_ugYr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142897707",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T19:56:39Z",
      "updated_at": "2024-05-31T19:56:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\n🚧 At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25656143496</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2142897707",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13026031143,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMIaXYn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13026031143",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "685e1e21d10ebf4892bb0ac892f142a18f7dbe70",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/685e1e21d10ebf4892bb0ac892f142a18f7dbe70",
      "created_at": "2024-06-03T19:38:28Z"
    },
    {
      "event": "unlabeled",
      "id": 13041415557,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMJVDWF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13041415557",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-04T20:15:11Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2155889026,
      "node_id": "IC_kwDOABII586AgEGC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155889026",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-08T09:21:00Z",
      "updated_at": "2024-06-08T09:21:00Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2155889026",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "labeled",
      "id": 13103465275,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMNBwM7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13103465275",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-10T15:31:29Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13188697652,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMSG440",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13188697652",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "26f3c7d53f192cf20467bb80bb4b7948d43449f8",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/26f3c7d53f192cf20467bb80bb4b7948d43449f8",
      "created_at": "2024-06-17T16:52:15Z"
    },
    {
      "event": "unlabeled",
      "id": 13188709437,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMSG7w9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13188709437",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-17T16:53:19Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13191760481,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMSSkph",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13191760481",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-17T21:15:41Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13192550228,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMSVldU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13192550228",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "created_at": "2024-06-17T22:54:13Z"
    },
    {
      "event": "unlabeled",
      "id": 13192801579,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMSWi0r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13192801579",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-17T23:28:48Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13273157528,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMXJE-Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13273157528",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-25T00:04:30Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2177291599,
      "node_id": "PRR_kwDOABII586BxtVP",
      "url": null,
      "actor": null,
      "commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Approach ACK\r\n\r\nI think pretty much everything here is a worth while improvement and should set up the following improvements well. I am not so deep into the current state of the kernel work though, so I can not comment on that part, for example the newly introduced typing file. I guess @TheCharlatan could give his nod to that here.\r\n\r\n> It removes uses of the terms \"active chainstate,\" \"usable chainstate,\" \"disabled chainstate,\" \"ibd chainstate,\" and \"snapshot chainstate\" which are confusing for various reasons.\r\n\r\nI think this is a bit confusing because it sounds like you are getting rid of this completely but it's actually just avoided where you touch the code, right? Cleaning the terms up everywhere can be a follow-up, I would like to try to rewrite the design doc a bit more anyway. But I think (selfishly) would like to break it up into design and usage docs because IMO that makes it way more manageable, i.e. the last commit of #29553.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2177291599",
      "submitted_at": "2024-07-15T11:11:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "reviewed",
      "id": 2186500256,
      "node_id": "PRR_kwDOABII586CU1ig",
      "url": null,
      "actor": null,
      "commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2177291599\r\n\r\nThanks for reviewing! Will rebase and try to address comments. I'm especially interested if you have ideas on splitting up documentation and code changes into separate PRs.\r\n\r\n> I am not so deep into the current state of the kernel work though, so I can not comment on that part, for example the newly introduced typing file. I guess @TheCharlatan could give his nod to that here.\r\n\r\nSure, for background kernel/types.h is analogous to node/types.h, wallet/types.h, and common/types.h. The types files are used when libraries want to define shared struct and enum types that can be used by code NOT directly depending on the library. For example the gui code uses the `wallet::isminetype` enum type, but the gui should not depend on the wallet library, so the enum is defined in a shared header `wallet/types.h`. In this PR, wallet code uses the `kernel::ChainstateRole` struct type, but the wallet code should not depend on the kernel library, so the struct is defined in a shared header `kernel/types.h`. This pattern started with the wallet library, but has been useful for node and common libraries as well, so it is natural to extend to the kernel.\r\n\r\nA more stricter separation between libraries would be possible with a more complicated structure, but having shared types files has been a reasonable way to separate the libraries while having a 1 library = 1 directory = 1 namespace structure.\r\n\r\n> > It removes uses of the terms \"active chainstate,\" \"usable chainstate,\" \"disabled chainstate,\" \"ibd chainstate,\" and \"snapshot chainstate\" which are confusing for various reasons.\r\n>\r\n> I think this is a bit confusing because it sounds like you are getting rid of this completely but it's actually just avoided where you touch the code, right? Cleaning the terms up everywhere can be a follow-up, I would like to try to rewrite the design doc a bit more anyway. But I think (selfishly) would like to break it up into design and usage docs because IMO that makes it way more manageable, i.e. the last commit of #29553.\r\n\r\nYeah this description was written aspirationally before I implemented this PR and I did not get around to removing all the old language. I'd be interested if you have specific ideas on how to break this PR up better. I definitely think it could make sense to move documentation / comment changes to a separate PR, and I hope #29553 can be reviewed more and merged soon, before this PR. (This is a good reminder for me to re-ack #29553)\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2186500256",
      "submitted_at": "2024-07-18T18:41:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13582586904,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMpldQY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13582586904",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "2c1d8b426fa1832fa464c12f3cae7e2976584430",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/2c1d8b426fa1832fa464c12f3cae7e2976584430",
      "created_at": "2024-07-19T21:52:57Z"
    },
    {
      "event": "reviewed",
      "id": 2189391816,
      "node_id": "PRR_kwDOABII586Cf3fI",
      "url": null,
      "actor": null,
      "commit_id": "2c1d8b426fa1832fa464c12f3cae7e2976584430",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Rebased 493d3844cfc8628fd63184fa7a657126d9b5dc95 -> 2c1d8b426fa1832fa464c12f3cae7e2976584430 ([`pr/cstate.4`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.4) -> [`pr/cstate.5`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.5), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.4-rebase..pr/cstate.5)) due to conflicts with various prs including #30267, #30388, #30395, #29996, #30406, #30320. Also made suggested simplifications.\r\nRebased 2c1d8b426fa1832fa464c12f3cae7e2976584430 -> 4c995842e3689974364c8c82ee220bfaa30f7f79 ([`pr/cstate.5`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.5) -> [`pr/cstate.6`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.6), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.5-rebase..pr/cstate.6)) due to conflict with #30111\r\nRebased 4c995842e3689974364c8c82ee220bfaa30f7f79 -> 7fd7960389254c7a2ba50614e1cbdf8911ef6a7d ([`pr/cstate.6`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.6) -> [`pr/cstate.7`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.7), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.6-rebase..pr/cstate.7)) due to conflict with #29656",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2189391816",
      "submitted_at": "2024-07-19T21:55:00Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "unlabeled",
      "id": 13583496678,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMpo7Xm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13583496678",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-19T22:21:05Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13627342485,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMsQL6V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13627342485",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-24T09:07:55Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13633128345,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMsmQeZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13633128345",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4c995842e3689974364c8c82ee220bfaa30f7f79",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/4c995842e3689974364c8c82ee220bfaa30f7f79",
      "created_at": "2024-07-24T16:14:04Z"
    },
    {
      "event": "unlabeled",
      "id": 13634114258,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMsqBLS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13634114258",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-24T17:30:40Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13761754364,
      "node_id": "LE_lADOABII586KwuWzzwAAAAM0Q7T8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13761754364",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-05T10:01:38Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13796072129,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAM2T1rB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13796072129",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "created_at": "2024-08-07T18:06:48Z"
    },
    {
      "event": "unlabeled",
      "id": 13797187317,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAM2YF71",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13797187317",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-07T19:56:09Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13826041283,
      "node_id": "LE_lADOABII586KwuWzzwAAAAM4GKXD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13826041283",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-09T22:19:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2308980712,
      "node_id": "IC_kwDOABII586JoD_o",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2308980712",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-25T20:20:01Z",
      "updated_at": "2024-08-25T20:20:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for addressing my feedback @ryanofsky ! I hope we can merge #29553 soon and then I will get back to this with another full review. But it does look very good to me already.\r\n\r\n> I'm especially interested if you have ideas on splitting up documentation and code changes into separate PRs.\r\n\r\nI'm unsure if it's really needed because I find clean refactoring commits like those here can be reviewed quicker than other changes, so I would be fine to keep it as is just based on volume of the change. But I did think about it and if that is feasible maybe splitting along the lines of everything that touches `ChainstateRole` and the rest (in whatever order you think works better) could be an idea. If you feel like splitting it that's fine for me but I think I would prefer to keep it as one PR as I have already passed everything so I am biased towards fewer fundamental changes ;)\r\n\r\nAh, and since the first is a fix you could just open that as a separate PR now. That should be an easy review and merge that doesn't conflict with anything else. The docs changes it feels like it's better to keep them along the code since you need to get your head into the topic either way. I often feel like reviewing docs and code side by side challenges your understanding and might lead to higher quality review.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2308980712",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "mentioned",
      "id": 14005196273,
      "node_id": "MEE_lADOABII586KwuWzzwAAAANCxlXx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14005196273",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-25T20:20:03Z"
    },
    {
      "event": "subscribed",
      "id": 14005196276,
      "node_id": "SE_lADOABII586KwuWzzwAAAANCxlX0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14005196276",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-25T20:20:03Z"
    },
    {
      "event": "commented",
      "id": 2403433476,
      "node_id": "IC_kwDOABII586PQXwE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2403433476",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-09T21:09:16Z",
      "updated_at": "2024-10-09T21:09:16Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2403433476",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "reviewed",
      "id": 2669420393,
      "node_id": "PRR_kwDOABII586fHB9p",
      "url": null,
      "actor": null,
      "commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2669420393",
      "submitted_at": "2025-03-09T12:57:19Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "commented",
      "id": 2718373984,
      "node_id": "IC_kwDOABII586iBxhg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2718373984",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T16:01:06Z",
      "updated_at": "2025-03-12T16:01:06Z",
      "author_association": "CONTRIBUTOR",
      "body": "Reading through commit a35a2a05887202de8c49727b6ea9166bf5f1a6f2 I am asking myself if with the addition of `m_target_blockhash`, the state of `m_validity` can just be computed on the fly without having to lug around and assert its state. For tracking the change in validity to `INVALID` once the tip reaches the target block the historical chainstate, could the presence of the `m_target_utxo_hash` (similar to how the belt-and-suspenders check is done later on) be checked instead? And for the current chainstate could the `ASSUMED_VALID` state be tracked with the presence of the snapshot base block and then the transition to the `VALIDATED` state by checking if the blocks up to the snapshot base block have `BLOCK_VALID_MASK`?",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2718373984",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "commented",
      "id": 2718492650,
      "node_id": "IC_kwDOABII586iCOfq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2718492650",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T16:42:25Z",
      "updated_at": "2025-03-12T16:42:25Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Reading through commit [a35a2a0](https://github.com/bitcoin/bitcoin/commit/a35a2a05887202de8c49727b6ea9166bf5f1a6f2) I am asking myself if with the addition of `m_target_blockhash`, the state of `m_validity` can just be computed on the fly without having to lug around and assert its state.\r\n\r\nI think it could probably work but two reasons not to do it might be:\r\n\r\n(1) to avoid performance regressions in parts of the code that are assuming it is possible to determine whether a chainstate is valid or valid instantly without without iterating over the chain\r\n(2) to make intent explicit and make code general and future proof\r\n\r\nTo explain (2) maybe it is safe right now to assume that any chain that is not invalid and not fully validated must be assumed-valid. But it's not clear that this should always be the case. Maybe a potential libbitcoinkernel application could be a fork-monitoring client that tracks multiple chains for some other reason and doesn't want to mark any of them as assume-valid. Having an explicit assume-valid state could make purpose of the chain more explicit and could let code dealing with multiple chainstates use chains based on how they are intended to be used without trying to infer intent from other attributes.\r\n\r\nMaybe what you are are suggesting could be an improvement, through, and it's been a while since I thought about this and reasons I listed above are speculative. Could try implementing the suggestion and see if it simplifies the code.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2718492650",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "commented",
      "id": 2720898462,
      "node_id": "IC_kwDOABII586iLZ2e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2720898462",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T11:18:14Z",
      "updated_at": "2025-03-13T11:56:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Maybe what you are are suggesting could be an improvement, through, and it's been a while since I thought about this and reasons I listed above are speculative. Could try implementing the suggestion and see if it simplifies the code.\r\n\r\nThis is what I had in mind: https://github.com/TheCharlatan/bitcoin/commit/9c89548c670e7b807a969e13408ff03df15143a2 (also rebased this branch to get cmake) . It is very broken in its current state though. There are a few problems with it, but I guess the fundamental problem is that the current application of a snapshot is done in relation to an existing chain and its state, and not against the block index and its state.  E.g. [the check](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L5835) for not loading a snapshot with less work only looks at the chain state, not the block index. If the chain is behind the block index, but the block index already has more fully-validated work, the snapshot application passes, but my new function would think it is already fully validated. The tests heavily rely on the current behaviour, where the best work chain is taken from the existing chainstate.\r\n\r\nThinking outside of this proposed change, is this really the desired behaviour though? Shouldn't the block index be our fundamental source of truth? I can think of a few scenarios outside of the tests where the chain being behind the fully-validated block index can be encountered, for example during a chainstate reindex, but I don't think they are something where snapshots should be supported.\r\n\r\n>  (2) to make intent explicit and make code general and future proof\r\n\r\nI would argue that adding this validity state could also make it more complicated to implement, or compose from existing functionality, parallel validation, or similar IBD speedups that might partition the chain even more.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2720898462",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16745661866,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPmHoWq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16745661866",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "58f62c2221d82e22e7c2d9cccedd58e4390ace5a",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/58f62c2221d82e22e7c2d9cccedd58e4390ace5a",
      "created_at": "2025-03-13T17:10:46Z"
    },
    {
      "event": "commented",
      "id": 2722056036,
      "node_id": "IC_kwDOABII586iP0dk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722056036",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T17:14:58Z",
      "updated_at": "2025-03-13T17:36:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased 7fd7960389254c7a2ba50614e1cbdf8911ef6a7d -> 58f62c2221d82e22e7c2d9cccedd58e4390ace5a ([`pr/cstate.7`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.7) -> [`pr/cstate.8`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.8), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.7-rebase..pr/cstate.8)) due to various conflicts.\r\nUpdated 58f62c2221d82e22e7c2d9cccedd58e4390ace5a -> d09b82156ced5d543d08226e8d7b8fda2e0ec532 ([`pr/cstate.8`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.8) -> [`pr/cstate.9`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.9), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.8..pr/cstate.9)) to fix \"error: private field 'm_is_memory' is not used\" https://github.com/bitcoin/bitcoin/pull/30214/checks?check_run_id=38726768015\r\n\r\n---\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2720898462\r\n\r\n> Shouldn't the block index be our fundamental source of truth?\r\n\r\nI'm open to this idea but not sure the block index has enough information in this case to provide information efficiently since you can't know if a particular block is fully validated without iterating over the whole chain back to genesis. Also, if mulltiple chainstates might exist for different purposes, it may be useful to store information about the purpose of each chainstate and what assumptions it was created under in the chainstate itself not in blocks that it is pointing to. I think the `Chainstate::m_validity` member in this PR does both of these things in a pretty straightforward way, but if we want to replace it with something better, hopefully that should not be too hard since it is a private member, so the public Chainstate interface would not have change.\r\n\r\nOne thing this PR is trying to accomplish is making it possible determine status of `Chainstate` objects independently, without having to look at `ChainstateManager` objects and other `Chainstate` objects. But it should be fine for `Chainstate` methods to use BlockIndex flags to return their status.\r\n\r\n> I would argue that adding this validity state could also make it more complicated to implement, or compose from existing functionality, parallel validation, or similar IBD speedups that might partition the chain even more.\r\n\r\nI think if multiple chainstates will exist for different purposes, the chainstate objects will need to have some field describing their purpose and controlling their behavior. I can easily see the `m_validity` field not being general enough to do that, but it's more easy for me to imagine it being replaced by another field than being eliminated entirely. But again I think the fact that it's a private field should make it easier to change or eliminate.\r\n\r\nShould also point out the that `m_validity` member added here is not really new. It's just replacing the previous `m_disabled` member with something more positive and less ambiguous.\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722056036",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16746268914,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPmJ8jy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16746268914",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "created_at": "2025-03-13T17:34:03Z"
    },
    {
      "event": "labeled",
      "id": 16746274673,
      "node_id": "LE_lADOABII586KwuWzzwAAAAPmJ99x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16746274673",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T17:34:09Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2722127023,
      "node_id": "IC_kwDOABII586iQFyv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722127023",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T17:34:10Z",
      "updated_at": "2025-03-13T17:34:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n🚧 At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/38726767974</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722127023",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "unlabeled",
      "id": 16747653095,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAPmPOfn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16747653095",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T18:33:30Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 16747851374,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAPmP-5u",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16747851374",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T18:50:07Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2722641649,
      "node_id": "IC_kwDOABII586iSDbx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722641649",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T20:39:27Z",
      "updated_at": "2025-03-13T20:39:27Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I think if multiple chainstates will exist for different purposes, the chainstate objects will need to have some field describing their purpose and controlling their behavior. \r\n\r\nYes, I think I have come to a similar conclusion, and I think the introduced reliance here on the `m_target_blockhash` and `m_from_snapshot_blockhash` are very good changes. Having some kind of \"start\" and \"stop\" blocks for a chainstate seems like something that is easy to understand and might also be useful beyond assumeutxo.\r\n\r\n> since you can't know if a particular block is fully validated without iterating over the whole chain back to genesis\r\n\r\nIsn't that only true when iterating over the snapshot block or when you don't know if you might come across it? My understanding is that is also what the [docs](https://github.com/bitcoin/bitcoin/blob/master/src/chain.h#L111) say about `BLOCK_VALID_CHAIN` and `BLOCK_VALID_SCRIPTS` and is also checked in `CheckBlockIndex`.\r\n\r\n> I think if multiple chainstates will exist for different purposes, the chainstate objects will need to have some field describing their purpose and controlling their behavior. \r\n\r\nI would also like to see a future with more diverse modes of validation, but I feel like we already have the `ChainstateManager` class for controlling the behaviour of a `Chainstate`. In my mind a `Chainstate` should not have to know all the details of what it is being used for, or have rich descriptive state about its own behaviour. I feel like many of the self-describing behaviours, like passing the `ChainstateRole` through a notification, should actually be done by the `ChainstateManager`. I don't think the changes in this PR go diametrically against that goal, but I am also not sure yet if the changes here really make it easier to eventually go into that direction.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722641649",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "commented",
      "id": 2722882679,
      "node_id": "IC_kwDOABII586iS-R3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722882679",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T23:08:56Z",
      "updated_at": "2025-03-13T23:08:56Z",
      "author_association": "CONTRIBUTOR",
      "body": "I think I agree with all that, and think chainstate objects should just contain information for chainstatemanager to deal with them, not to have \"rich\" data or application specific data. I also think depending on what you want to do with chainstates, block status flags may provide enough information, but they are not equivalent to the old `Chainstate::m_disabled` field or the new `Chainstate::m_validity` field replacing it, since block flags only tell you about validity back to the last snapshot block, not back to genesis block.\r\n\r\nI guess I'm not really sure what problems you see with chainstates knowing their role or validity, but it is true they continue to know some of that information after this PR just like they knew it before. If you want to move that information elsewhere like chainstate manager or derive it from block validity flags I don't think this PR should get in the way of that, and it probably even helps a little because it narrows the definition of `ChainstateRole` to not indicate assumeutxo status but only indicate basic information about whether the chainstate is validated and what block it is targeting. The PR should also help more if you are interested in using chainstate objects for applications other than assumeutxo, because it is dropping assumeutxo-specific assumptions many places in validation and networking code and adding a generic `ChainstateManager::m_chainstates` vector that can hold arbitrary chainstates.\r\n\r\nI'd also point out that the `Chainstate::m_validity` field only gets written in 2 places: in the `Chainstate` constructor and in the `ChainstateManager::MaybeCompleteSnapshotValidation` method, so I don't think it adds much maintenance burden even if you think other fields might be more useful.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722882679",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "labeled",
      "id": 16754527220,
      "node_id": "LE_lADOABII586KwuWzzwAAAAPmpcv0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16754527220",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-14T03:48:18Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2685423528,
      "node_id": "PRR_kwDOABII586gEE-o",
      "url": null,
      "actor": null,
      "commit_id": "d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Approach ACK\r\n\r\nI am not yet convinced of the last three commits changing the code (5e22fdcdb2665c0bb5e47c53719796096afe2dd1, 58265b955a3d8622f22958943f79409129d58b36, ca48478fbfcc83cc6f8c928e57800707fe0c3b51), maybe they could do with some more motivation in the commit message? I guess the last of the commits ca48478fbfcc83cc6f8c928e57800707fe0c3b51 is kind of the result of the preceding two and it is nice not to have to construct the vector on the fly for every `GetAll()` call anymore.\r\n\r\nThere is an opportunity for also simplifying the pruning code a bit, I made a commit here https://github.com/TheCharlatan/bitcoin/commit/fe76cc3a04c94ca4fdbb9550d478909f3b13d8ec that removes the chainman arguments from the manual pruning function. I think it would fit in well with the patch set here.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2685423528",
      "submitted_at": "2025-03-14T21:24:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16849449200,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPsTjDw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16849449200",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/467528960689c2913c101ef75bc833e8f04bd0f3",
      "created_at": "2025-03-18T21:26:06Z"
    },
    {
      "event": "reviewed",
      "id": 2691157663,
      "node_id": "PRR_kwDOABII586gZ86f",
      "url": null,
      "actor": null,
      "commit_id": "d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Rebased d09b82156ced5d543d08226e8d7b8fda2e0ec532 -> 467528960689c2913c101ef75bc833e8f04bd0f3 ([`pr/cstate.9`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.9) -> [`pr/cstate.10`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.10), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.9-rebase..pr/cstate.10)) due to conflict 31961 and implementing various suggestions.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2685423528\r\n\r\nThanks for the review! I added comments to the `m_chainstates` commits to motivate them better, also added your simplification fe76cc3a04c94ca4fdbb9550d478909f3b13d8ec and implemented other suggestions below.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2691157663",
      "submitted_at": "2025-03-18T21:26:48Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "unlabeled",
      "id": 16879548947,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAPuGXoT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16879548947",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-19T21:00:45Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2699856438,
      "node_id": "PRR_kwDOABII586g7Io2",
      "url": null,
      "actor": null,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\nonly reviewed up to 199a2eb87c3ad9382f2fe4ae97524099224a7b04 so far.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2699856438",
      "submitted_at": "2025-03-19T21:42:59Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "labeled",
      "id": 16899916546,
      "node_id": "LE_lADOABII586KwuWzzwAAAAPvUEMC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16899916546",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-20T10:20:39Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16909597540,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPv4_tk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16909597540",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "00c3e4db49ebd2c3bf2f3c7f2a8c9ba5dfb3c8f5",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/00c3e4db49ebd2c3bf2f3c7f2a8c9ba5dfb3c8f5",
      "created_at": "2025-03-20T13:33:04Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16910586364,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPv8xH8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16910586364",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "137d5980abd49a1d2bf783cb57a9386b1941550f",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/137d5980abd49a1d2bf783cb57a9386b1941550f",
      "created_at": "2025-03-20T14:17:55Z"
    },
    {
      "event": "reviewed",
      "id": 2702602071,
      "node_id": "PRR_kwDOABII586hFm9X",
      "url": null,
      "actor": null,
      "commit_id": "00c3e4db49ebd2c3bf2f3c7f2a8c9ba5dfb3c8f5",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for the reviews\r\n\r\nRebased 467528960689c2913c101ef75bc833e8f04bd0f3 -> 00c3e4db49ebd2c3bf2f3c7f2a8c9ba5dfb3c8f5 ([`pr/cstate.10`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.10) -> [`pr/cstate.11`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.11), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.10-rebase..pr/cstate.11)) due to conflict with #31519, also adding test comments.\r\nUpdate 00c3e4db49ebd2c3bf2f3c7f2a8c9ba5dfb3c8f5 -> 137d5980abd49a1d2bf783cb57a9386b1941550f ([`pr/cstate.11`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.11) -> [`pr/cstate.12`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.12), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.11..pr/cstate.12)) just fixing a commit message",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2702602071",
      "submitted_at": "2025-03-20T14:18:07Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "unlabeled",
      "id": 16912250827,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAPwDHfL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16912250827",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-20T14:41:41Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 17161072938,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAP-4TEq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17161072938",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "created_at": "2025-04-07T22:03:24Z"
    },
    {
      "event": "reviewed",
      "id": 2748216830,
      "node_id": "PRR_kwDOABII586jznX-",
      "url": null,
      "actor": null,
      "commit_id": "abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Updated 137d5980abd49a1d2bf783cb57a9386b1941550f -> abe6f0642493402d858dc3aa297ec941bfeaaf87 ([`pr/cstate.12`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.12) -> [`pr/cstate.13`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.13), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.12..pr/cstate.13)) adding a new assert to deal with concern in https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2016904181 and make sure the impossible condition that would have previously triggered a BASE_BLOCKHASH_MISMATCH error will still reliably be caught, instead of potentially keeping the background chainstate around forever in a state where it is not syncing.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2748216830",
      "submitted_at": "2025-04-07T22:11:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "reviewed",
      "id": 2749329967,
      "node_id": "PRR_kwDOABII586j33Iv",
      "url": null,
      "actor": null,
      "commit_id": "abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Last changes look good, but I think the interim compilation error in the fuzz binary should be fixed. There are some formatting and include ordering issues, can you run `clang-format-diff` over the commits?",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2749329967",
      "submitted_at": "2025-04-08T09:45:19Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "reviewed",
      "id": 2750555125,
      "node_id": "PRR_kwDOABII586j8iP1",
      "url": null,
      "actor": null,
      "commit_id": "abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2749329967\r\n\r\nThanks for the suggestion. Will try to make sure all the intermediate commits compile again and run clang-format-diff on them in the next few days.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2750555125",
      "submitted_at": "2025-04-08T16:07:09Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "reviewed",
      "id": 2761594904,
      "node_id": "PRR_kwDOABII586kmpgY",
      "url": null,
      "actor": null,
      "commit_id": "abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2761594904",
      "submitted_at": "2025-04-11T21:47:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "reviewed",
      "id": 2764664174,
      "node_id": "PRR_kwDOABII586kyW1u",
      "url": null,
      "actor": null,
      "commit_id": "abe6f0642493402d858dc3aa297ec941bfeaaf87",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for the reviews! I still planning to address the fuzz/clang-tidy comments, and will also update `TryAddBlockIndexCandidate` as mentioned below to clarify the `GetAll()` removal commit.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2764664174",
      "submitted_at": "2025-04-14T15:11:37Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "labeled",
      "id": 17257202891,
      "node_id": "LE_lADOABII586KwuWzzwAAAAQEnATL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17257202891",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-04-14T22:56:39Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2803247361,
      "node_id": "IC_kwDOABII586nFikB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2803247361",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-04-14T22:56:40Z",
      "updated_at": "2025-04-14T22:56:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n🐙 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2803247361",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk2YmI5MzFjYjhiOTkyNGQ2NjZlNzJkZWMwZjE3ODZmMDhiOTQwZWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/96bb931cb8b9924d666e72dec0f1786f08b940eb",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/96bb931cb8b9924d666e72dec0f1786f08b940eb",
      "tree": {
        "sha": "706f581d2128b9735da146d2f3dea2b8897cb5f7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/706f581d2128b9735da146d2f3dea2b8897cb5f7"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cdc32994feadf3f15df3cfac5baae36b4b011462",
          "sha": "cdc32994feadf3f15df3cfac5baae36b4b011462",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/cdc32994feadf3f15df3cfac5baae36b4b011462"
        }
      ],
      "message": "test: Fix broken chainstatemanager_snapshot_init check\n\nThe following test code never checked anything because the if statement was\nalways false:\n\n    if (cs != &chainman_restarted.ActiveChainstate()) {\n        BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n    }\n\nAlso, the height of the background chainstate it was intending to check is 110,\nnot 109. Fix both problems by rewriting the check.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-15T10:07:52Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-31T10:53:50Z"
      },
      "sha": "96bb931cb8b9924d666e72dec0f1786f08b940eb"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE3MzVmYjYxNjk4YTgzNDI0ZTZmZTM3Zjk0ZGY3Mjk5NTJlZjg0NGQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1735fb61698a83424e6fe37f94df729952ef844d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1735fb61698a83424e6fe37f94df729952ef844d",
      "tree": {
        "sha": "f4f3aa6e71802e1660fae3b2cfa69ff90ef5dc17",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f4f3aa6e71802e1660fae3b2cfa69ff90ef5dc17"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/96bb931cb8b9924d666e72dec0f1786f08b940eb",
          "sha": "96bb931cb8b9924d666e72dec0f1786f08b940eb",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/96bb931cb8b9924d666e72dec0f1786f08b940eb"
        }
      ],
      "message": "refactor: Add Chainstate::m_target_blockhash member\n\nMake Chainstate objects aware of what block they are targeting. This makes\nChainstate objects more self contained, so it's possible to determine what\nblocks should be downloaded and connected to them without needing to query\nChainstateManager or look at other Chainstate objects.\n\nThe motivation for this change is to make code more readable, so it only\nrequires knowing about Chainstate targets, not reasoning about the assumeutxo\nsnapshot validation sequence. This change also enables simplifications to the\nChainstateManager interface in subsequent commits, and could make it easier to\nimplement new features like creating new Chainstate objects to generate UTXO\nsnapshots or index UTXO data.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-15T10:07:52Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T00:27:27Z"
      },
      "sha": "1735fb61698a83424e6fe37f94df729952ef844d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDhhNTIwZWI3NTIxODcxM2Y5ZTI0MGE5ZDg3YzUyOTY0MTExZjVmZGE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8a520eb75218713f9e240a9d87c52964111f5fda",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8a520eb75218713f9e240a9d87c52964111f5fda",
      "tree": {
        "sha": "a56a66c359a80bdc2f77c3e4e0e596a3a910c6c5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a56a66c359a80bdc2f77c3e4e0e596a3a910c6c5"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1735fb61698a83424e6fe37f94df729952ef844d",
          "sha": "1735fb61698a83424e6fe37f94df729952ef844d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1735fb61698a83424e6fe37f94df729952ef844d"
        }
      ],
      "message": "refactor: Add Chainstate m_validity and m_target_utxohash members\n\nGet rid of m_disabled/IsUsable members. Instead of marking chains disabled for\ndifferent reasons, record chainstate validity and validation progress\nexplicitly and use that information directly.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T15:53:44Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T15:53:44Z"
      },
      "sha": "8a520eb75218713f9e240a9d87c52964111f5fda"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGMxODMzZmNhNGYyNGY2NTVhMjJlNzA2ZDAxYWVhYjU0ZTZjYmU2ODk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c1833fca4f24f655a22e706d01aeab54e6cbe689",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c1833fca4f24f655a22e706d01aeab54e6cbe689",
      "tree": {
        "sha": "27b42a94e8e409df15f1fe508fbbd63ab2de6550",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/27b42a94e8e409df15f1fe508fbbd63ab2de6550"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8a520eb75218713f9e240a9d87c52964111f5fda",
          "sha": "8a520eb75218713f9e240a9d87c52964111f5fda",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8a520eb75218713f9e240a9d87c52964111f5fda"
        }
      ],
      "message": "refactor: Deduplicate Chainstate activation code\n\nMove duplicate code from ChainstateManager::ActivateSnapshot and\nChainstateManager::ActivateExistingSnapshot methods to a new\nChainstateManager::AddChainstate method.\n\nThe \"AddChainstate\" method name doesn't mention snapshots even though it is\nonly used to add snapshot chainstates now, because it becomes more generalized\nin a later commit in this PR (\"refactor: Add ChainstateManager::m_chainstates\nmember\")",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T15:53:44Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T13:42:03Z"
      },
      "sha": "c1833fca4f24f655a22e706d01aeab54e6cbe689"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU1YjdiZmJhNmQxMmE5NWE2Y2NjYjM2NTJjNzVkYzljZWUyZjg3NTE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/55b7bfba6d12a95a6cccb3652c75dc9cee2f8751",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/55b7bfba6d12a95a6cccb3652c75dc9cee2f8751",
      "tree": {
        "sha": "20c1c19b07ba9eb677117a72cf0bbe173f1189c7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/20c1c19b07ba9eb677117a72cf0bbe173f1189c7"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c1833fca4f24f655a22e706d01aeab54e6cbe689",
          "sha": "c1833fca4f24f655a22e706d01aeab54e6cbe689",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c1833fca4f24f655a22e706d01aeab54e6cbe689"
        }
      ],
      "message": "refactor: Pass chainstate parameters to MaybeCompleteSnapshotValidation\n\nRemove hardcoded references to m_ibd_chainstate and m_snapshot_chainstate so\nMaybeCompleteSnapshotValidation function can be simpler and focus on validating\nthe snapshot without dealing with internal ChainstateManager states.\n\nThis is a step towards being able to validate the snapshot outside of\nActivateBestChain loop so cs_main is not locked for minutes when the snapshot\nblock is connected.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "sha": "55b7bfba6d12a95a6cccb3652c75dc9cee2f8751"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDgzZDE5ZmQwOTgxOGUxMWEwM2I5ZWJkYmZiZjc2MTk2ZjM4MDhhZTI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/83d19fd09818e11a03b9ebdbfbf76196f3808ae2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/83d19fd09818e11a03b9ebdbfbf76196f3808ae2",
      "tree": {
        "sha": "adbab5bb7681b50fd70d88fe4a06dc5aeb4c0adb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/adbab5bb7681b50fd70d88fe4a06dc5aeb4c0adb"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/55b7bfba6d12a95a6cccb3652c75dc9cee2f8751",
          "sha": "55b7bfba6d12a95a6cccb3652c75dc9cee2f8751",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/55b7bfba6d12a95a6cccb3652c75dc9cee2f8751"
        }
      ],
      "message": "refactor: Pass chainstate parameters to MaybeCompleteSnapshotValidation\n\nRemove hardcoded references to m_ibd_chainstate and m_snapshot_chainstate so\nMaybeCompleteSnapshotValidation function can be simpler and focus on validating\nthe snapshot without dealing with internal ChainstateManager states.\n\nThis is a step towards being able to validate the snapshot outside of\nActivateBestChain loop so cs_main is not locked for minutes when the snapshot\nblock is connected.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-31T13:17:10Z"
      },
      "sha": "83d19fd09818e11a03b9ebdbfbf76196f3808ae2"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQyYTY2MzkyZjE1ZmM3NGE3NzdhNTBlZmZmOGZjZWQ2Y2U3Yjc3YzU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d2a66392f15fc74a777a50efff8fced6ce7b77c5",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d2a66392f15fc74a777a50efff8fced6ce7b77c5",
      "tree": {
        "sha": "7b888dad4482fe527e213c93d81e948d9e977341",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7b888dad4482fe527e213c93d81e948d9e977341"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/83d19fd09818e11a03b9ebdbfbf76196f3808ae2",
          "sha": "83d19fd09818e11a03b9ebdbfbf76196f3808ae2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/83d19fd09818e11a03b9ebdbfbf76196f3808ae2"
        }
      ],
      "message": "refactor: Add Chainstate::StoragePath() method\n\nUse to simplify code determining the chainstate leveldb paths.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T15:25:04Z"
      },
      "sha": "d2a66392f15fc74a777a50efff8fced6ce7b77c5"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDJlZjliYmZkM2ExMGZlMzJjNmY0YTA1MzQ2Mjg4ODM3ZGU1MzE5ZDk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2ef9bbfd3a10fe32c6f4a05346288837de5319d9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/2ef9bbfd3a10fe32c6f4a05346288837de5319d9",
      "tree": {
        "sha": "68efe368a6c1995b8e1848ae0077b47fe6325250",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/68efe368a6c1995b8e1848ae0077b47fe6325250"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d2a66392f15fc74a777a50efff8fced6ce7b77c5",
          "sha": "d2a66392f15fc74a777a50efff8fced6ce7b77c5",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d2a66392f15fc74a777a50efff8fced6ce7b77c5"
        }
      ],
      "message": "refactor: Add ChainstateManager::CurrentChainstate() method\n\nCurrentChainstate() is basically the same as ActiveChainstate() except it\nrequires cs_main to be locked when it is called, instead of locking cs_main\ninternally.\n\nThe name \"current\" should also be less confusing than \"active\" because multiple\nchainstates can be active, and CurrentChainstate() returns the chainstate\ntargeting the current network tip, regardless of what chainstates are being\ndownloaded or how they are used.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T16:03:47Z"
      },
      "sha": "2ef9bbfd3a10fe32c6f4a05346288837de5319d9"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI2ZDQ0MDNlZGJiZDliZDg1YmYzNDY4MWQ4NjBkZDk3OWQ3MmZjYWE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b6d4403edbbd9bd85bf34681d860dd979d72fcaa",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b6d4403edbbd9bd85bf34681d860dd979d72fcaa",
      "tree": {
        "sha": "2ca3919a18346ce3f8692b5725a2d850c68f92a3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2ca3919a18346ce3f8692b5725a2d850c68f92a3"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2ef9bbfd3a10fe32c6f4a05346288837de5319d9",
          "sha": "2ef9bbfd3a10fe32c6f4a05346288837de5319d9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/2ef9bbfd3a10fe32c6f4a05346288837de5319d9"
        }
      ],
      "message": "refactor: Add ChainstateManager::ValidatedChainstate() method\n\nValidatedChainstate() accessor replaces GetChainstateForIndexing() with no\nchange in behavior.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T16:03:47Z"
      },
      "sha": "b6d4403edbbd9bd85bf34681d860dd979d72fcaa"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg0NjVhOTUwM2QwM2FiYWYzYjdjMWIxOTFhYWU4MzIyZjdhMDkxZDc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8465a9503d03abaf3b7c1b191aae8322f7a091d7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8465a9503d03abaf3b7c1b191aae8322f7a091d7",
      "tree": {
        "sha": "3270e03b0620b32d520f84c3595a5b92c4fcdf24",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3270e03b0620b32d520f84c3595a5b92c4fcdf24"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b6d4403edbbd9bd85bf34681d860dd979d72fcaa",
          "sha": "b6d4403edbbd9bd85bf34681d860dd979d72fcaa",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b6d4403edbbd9bd85bf34681d860dd979d72fcaa"
        }
      ],
      "message": "refactor: Convert ChainstateRole enum to struct\n\nChange ChainstateRole parameter passed to wallets and indexes. Wallets and\nindexes need to know whether chainstate is historical and whether it is fully\nvalidated. They should not be aware of the assumeutxo snapshot validation\nprocess.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-07-19T16:12:07Z"
      },
      "sha": "8465a9503d03abaf3b7c1b191aae8322f7a091d7"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDdhMDg1ZWVlZWFmZDg4OTM3NDg4ZjQ2YWI0ZTliODZkYzZkOWM3ODU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7a085eeeeafd88937488f46ab4e9b86dc6d9c785",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7a085eeeeafd88937488f46ab4e9b86dc6d9c785",
      "tree": {
        "sha": "d8d53eac7053f55e39620b51017e70b021bcde6c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d8d53eac7053f55e39620b51017e70b021bcde6c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8465a9503d03abaf3b7c1b191aae8322f7a091d7",
          "sha": "8465a9503d03abaf3b7c1b191aae8322f7a091d7",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8465a9503d03abaf3b7c1b191aae8322f7a091d7"
        }
      ],
      "message": "refactor: Delete ChainstateManager::IsSnapshotActive() method\n\nIsSnapshotActive() method is only called one place outside of tests and\nasserts, and is confusing because it returns true even after the snapshot is\nfully validated.\n\nThe documentation which said this \"implies that a background validation\nchainstate is also in use\" is also incorrect, because after the snapshot is\nvalidated, the background chainstate gets disabled and IsUsable() would return\nfalse.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-31T11:00:40Z"
      },
      "sha": "7a085eeeeafd88937488f46ab4e9b86dc6d9c785"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDcyZmU4YTUxZTcxYmY0YTRhZGFjNWZiMGY2NzY5YTg3ZmQxODM2YzQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/72fe8a51e71bf4a4adac5fb0f6769a87fd1836c4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/72fe8a51e71bf4a4adac5fb0f6769a87fd1836c4",
      "tree": {
        "sha": "22464d60c8ba9b6da4d28efd526fba12fabf26bf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/22464d60c8ba9b6da4d28efd526fba12fabf26bf"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7a085eeeeafd88937488f46ab4e9b86dc6d9c785",
          "sha": "7a085eeeeafd88937488f46ab4e9b86dc6d9c785",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7a085eeeeafd88937488f46ab4e9b86dc6d9c785"
        }
      ],
      "message": "refactor: Delete ChainstateManager::IsSnapshotValidated() method\n\nIsSnapshotValidated() is only called one place outside of tests, and is use\nredundantly in some tests, asserting that a snapshot is not validated when a\nsnapshot chainstate does not even exist. Simplify by dropping the method and\nchecking Chainstate validity field directly.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T20:14:42Z"
      },
      "sha": "72fe8a51e71bf4a4adac5fb0f6769a87fd1836c4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU1NTE5ODQxYTY3NjY2ZTRmNzhhNTA1NjQxNTljNWI2ZDg0ZjRkNjQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/55519841a67666e4f78a50564159c5b6d84f4d64",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/55519841a67666e4f78a50564159c5b6d84f4d64",
      "tree": {
        "sha": "1c76af3ff589ac412c55ef98947f4943464e2b57",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1c76af3ff589ac412c55ef98947f4943464e2b57"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/72fe8a51e71bf4a4adac5fb0f6769a87fd1836c4",
          "sha": "72fe8a51e71bf4a4adac5fb0f6769a87fd1836c4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/72fe8a51e71bf4a4adac5fb0f6769a87fd1836c4"
        }
      ],
      "message": "refactor: Delete ChainstateManager::SnapshotBlockhash() method\n\nSnapshotBlockhash() is only called two places outside of tests, and is used\nredundantly in some tests, checking the same field as other checks. Simplify by\ndropping the method and using the m_from_snapshot_blockhash field directly.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T20:30:22Z"
      },
      "sha": "55519841a67666e4f78a50564159c5b6d84f4d64"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGYxY2IwMzVmMzllYzkyOWIxYzExN2JiMjdiOWM0ODkyYzM3ODE5ZGE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f1cb035f39ec929b1c117bb27b9c4892c37819da",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/f1cb035f39ec929b1c117bb27b9c4892c37819da",
      "tree": {
        "sha": "ebfe596c3259dfa01b4f4dc7123845c524f4c8b4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ebfe596c3259dfa01b4f4dc7123845c524f4c8b4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/55519841a67666e4f78a50564159c5b6d84f4d64",
          "sha": "55519841a67666e4f78a50564159c5b6d84f4d64",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/55519841a67666e4f78a50564159c5b6d84f4d64"
        }
      ],
      "message": "refactor: Add ChainstateManager::m_chainstates member\n\nUse to replace m_active_chainstate, m_ibd_chainstate, and m_snapshot_chainstate\nmembers. This has several benefits:\n\n- Ensures ChainstateManager treats chainstates instances equally, making\n  distinctions based on their attributes, not having special cases and making\n  assumptions based on their identities.\n\n- Normalizes ChainstateManager representation so states that should be\n  impossible to reach and validation code has no handling for (like\n  m_snapshot_chainstate being set and m_ibd_chainstate being unset, or both\n  being set but m_active_chainstate pointing to the m_ibd_chainstate) can no\n  longer be represented.\n\n- Makes ChainstateManager more extensible so new chainstates can be added for\n  different purposes, like indexing or generating and validating assumeutxo\n  snapshots without interrupting regular node operations. With the\n  m_chainstates member, new chainstates can be added and handled without needing\n  to make changes all over validation code or to copy/paste/modify the existing\n  code that's been already been written to handle m_ibd_chainstate and\n  m_snapshot_chainstate.\n\n- Avoids terms that are confusing and misleading:\n\n  - The term \"active chainstate\" term is confusing because multiple chainstates\n    will be active and in use at the same time. Before a snapshot is validated,\n    wallet code will use the snapshot chainstate, while indexes will use the IBD\n    chainstate, and netorking code will use both chainstates, downloading\n    snapshot blocks at higher priority, but also IBD blocks simultaneously.\n\n  - The term \"snapshot chainstate\" is ambiguous because it could refer either\n    to the chainstate originally loaded from a snapshot, or to the chainstate\n    being used to validate a snapshot that was loaded, or to a chainstate being\n    used to produce a snapshot, but it is arbitrary used to refer the first\n    thing. The terms \"most-work chainstate\" or \"assumed-valid chainstate\" should\n    be less ambiguous ways to refer to chainstates loaded from snapshots.\n\n  - The term \"IBD chainstate\" is not just ambiguous because actively confusing\n    because technically IBD ends and the node is considered synced when the\n    snapshot chainstate finishes syncing, so in practice the IBD chainstate\n    will mostly by synced after IBD is complete. The term \"fully-validated\" is\n    a better way of describing the characteristics and purpose of this\n    chainstate.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T17:26:01Z"
      },
      "sha": "f1cb035f39ec929b1c117bb27b9c4892c37819da"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDVhMmRhMjMyZTY3ZDA3Zjg2NGY1N2Q3NDM5ZjVkNTBjZjRhYmRlNzg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5a2da232e67d07f864f57d7439f5d50cf4abde78",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/5a2da232e67d07f864f57d7439f5d50cf4abde78",
      "tree": {
        "sha": "14389ad42a79421435f67e03a78efe911d5330cc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/14389ad42a79421435f67e03a78efe911d5330cc"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f1cb035f39ec929b1c117bb27b9c4892c37819da",
          "sha": "f1cb035f39ec929b1c117bb27b9c4892c37819da",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f1cb035f39ec929b1c117bb27b9c4892c37819da"
        }
      ],
      "message": "refactor: Add ChainstateManager::ActivateBestChains() method\n\nDeduplicate code looping over chainstate objects and calling\nActivateBestChain() and avoid need for code outside ChainstateManager to use\nthe GetAll() method.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T18:52:28Z"
      },
      "sha": "5a2da232e67d07f864f57d7439f5d50cf4abde78"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDY0ZmM2NjAzNTI1ZjUxNWM1MzAzZjU1N2IwMzg3NTM5MDRjNjU0MWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/64fc6603525f515c5303f557b038753904c6541e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/64fc6603525f515c5303f557b038753904c6541e",
      "tree": {
        "sha": "56999a2c05d4aa06711514176a469e99263fe7bd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/56999a2c05d4aa06711514176a469e99263fe7bd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5a2da232e67d07f864f57d7439f5d50cf4abde78",
          "sha": "5a2da232e67d07f864f57d7439f5d50cf4abde78",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/5a2da232e67d07f864f57d7439f5d50cf4abde78"
        }
      ],
      "message": "refactor: Delete ChainstateManager::GetAll() method\n\nJust use m_chainstates array instead.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T23:45:14Z"
      },
      "sha": "64fc6603525f515c5303f557b038753904c6541e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGUwY2Y0YWRmM2ZmZjNhNzcyNmFkZWI5ZjhiZjIwMTA2OTYxMDU0ZGM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e0cf4adf3fff3a7726adeb9f8bf20106961054dc",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e0cf4adf3fff3a7726adeb9f8bf20106961054dc",
      "tree": {
        "sha": "dcc5bd18111f9d50990b22b378dbe120e7040674",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dcc5bd18111f9d50990b22b378dbe120e7040674"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/64fc6603525f515c5303f557b038753904c6541e",
          "sha": "64fc6603525f515c5303f557b038753904c6541e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/64fc6603525f515c5303f557b038753904c6541e"
        }
      ],
      "message": "refactor: Simplify pruning functions",
      "committer": {
        "name": "TheCharlatan",
        "email": "seb.kung@gmail.com",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "TheCharlatan",
        "email": "seb.kung@gmail.com",
        "date": "2025-03-14T21:19:17Z"
      },
      "sha": "e0cf4adf3fff3a7726adeb9f8bf20106961054dc"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDEyZjI3NmJhMmJmYzEwNjA4M2MxNjE1NTM5ODU3Y2RlZmZmOTc5NGI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/12f276ba2bfc106083c1615539857cdefff9794b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/12f276ba2bfc106083c1615539857cdefff9794b",
      "tree": {
        "sha": "6b3b5296bbf5ab5bc53ba4fa5bc32166fdd033ae",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6b3b5296bbf5ab5bc53ba4fa5bc32166fdd033ae"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e0cf4adf3fff3a7726adeb9f8bf20106961054dc",
          "sha": "e0cf4adf3fff3a7726adeb9f8bf20106961054dc",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e0cf4adf3fff3a7726adeb9f8bf20106961054dc"
        }
      ],
      "message": "doc: Improve ChainstateManager documentation, use consistent terms",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-04-16T16:02:33Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T23:50:47Z"
      },
      "sha": "12f276ba2bfc106083c1615539857cdefff9794b"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 17293127284,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAQGwC50",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17293127284",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "feaf9fc6d15a9f06470a94423bb9e167b8657652",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/feaf9fc6d15a9f06470a94423bb9e167b8657652",
      "created_at": "2025-04-16T17:24:24Z"
    },
    {
      "event": "reviewed",
      "id": 2773308310,
      "node_id": "PRR_kwDOABII586lTVOW",
      "url": null,
      "actor": null,
      "commit_id": "feaf9fc6d15a9f06470a94423bb9e167b8657652",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Rebased abe6f0642493402d858dc3aa297ec941bfeaaf87 -> feaf9fc6d15a9f06470a94423bb9e167b8657652 ([`pr/cstate.13`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.13) -> [`pr/cstate.14`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.14), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.13-rebase..pr/cstate.14)) due to conflict with #31282, also running clang-tidy and fixing the early compile error in the fuzz test\r\n\r\n---\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2749329967\r\n\r\n> Last changes look good, but I think the interim compilation error in the fuzz binary should be fixed. There are some formatting and include ordering issues, can you run `clang-format-diff` over the commits?\r\n\r\nThanks for pointing this out! These should all be fixed now",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2773308310",
      "submitted_at": "2025-04-16T17:28:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 17293384069,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAQGxBmF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17293384069",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/12f276ba2bfc106083c1615539857cdefff9794b",
      "created_at": "2025-04-16T17:45:23Z"
    },
    {
      "event": "commented",
      "id": 2810282674,
      "node_id": "IC_kwDOABII586ngYKy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2810282674",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-04-16T17:46:57Z",
      "updated_at": "2025-04-16T17:46:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "Updated feaf9fc6d15a9f06470a94423bb9e167b8657652 -> 12f276ba2bfc106083c1615539857cdefff9794b ([`pr/cstate.14`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.14) -> [`pr/cstate.15`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.15), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.14..pr/cstate.15)) adding an extra validity check to address a comment https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2040321756\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2810282674",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677573399",
      "pull_request_review_id": 2177291599,
      "id": 1677573399,
      "node_id": "PRRC_kwDOABII585j_b0X",
      "diff_hunk": "@@ -544,6 +546,18 @@ class Chainstate\n     //! @sa ChainstateRole\n     ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_validity;\n+    }\n+\n+    //! Return true if chainstate fully validated or is assumed valid.\n+    bool IsValid() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 55,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "cdc44e878a859a34dfe0c198641531ec26b0730d",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: In other places similar checks are inlined without a helper method. That might be actually a bit more clear as well.",
      "created_at": "2024-07-15T09:49:39Z",
      "updated_at": "2024-07-15T11:11:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677573399",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677573399"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 556,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677599944",
      "pull_request_review_id": 2177291599,
      "id": 1677599944,
      "node_id": "PRRC_kwDOABII585j_iTI",
      "diff_hunk": "@@ -29,6 +29,17 @@ using node::BlockManager;\n using node::KernelNotifications;\n using node::SnapshotMetadata;\n \n+static std::vector<Chainstate*> GetAll(const ChainstateManager& chainman)",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ce02d68008c2f61a6033b22df1a5ef54bba38d9f",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why do you add this function around here instead of using `m_chainstates` as well?",
      "created_at": "2024-07-15T10:13:00Z",
      "updated_at": "2024-07-15T11:11:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677599944",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677599944"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 32,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677640152",
      "pull_request_review_id": 2177291599,
      "id": 1677640152,
      "node_id": "PRRC_kwDOABII585j_sHY",
      "diff_hunk": "@@ -535,11 +542,26 @@ class Chainstate\n         ChainstateManager& chainman,\n         std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n \n+    //! Return path to chainstate leveldb directory.\n+    fs::path StoragePath() const;\n+\n     //! Return the current role of the chainstate. See `ChainstateManager`\n     //! documentation for a description of the different types of chainstates.\n     //!\n     //! @sa ChainstateRole\n-    ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    kernel::ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 71,
      "original_position": 80,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Not sure why we need this when in another commit we remove `GetAll()` and instead use `m_chainstates`. Seems kind of inconsistent but maybe I am missing something.",
      "created_at": "2024-07-15T10:51:47Z",
      "updated_at": "2024-07-15T11:11:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677640152",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677640152"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252537",
      "pull_request_review_id": 2186500256,
      "id": 1683252537,
      "node_id": "PRRC_kwDOABII585kVGU5",
      "diff_hunk": "@@ -29,6 +29,17 @@ using node::BlockManager;\n using node::KernelNotifications;\n using node::SnapshotMetadata;\n \n+static std::vector<Chainstate*> GetAll(const ChainstateManager& chainman)",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ce02d68008c2f61a6033b22df1a5ef54bba38d9f",
      "in_reply_to_id": 1677599944,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> Why do you add this function around here instead of using `m_chainstates` as well?\r\n\r\nI need to double-check but IIRC, the issue is that m_chainstates requires a lock to access, and it would require larger changes and more verbosity in the tests if they had to be changed to access m_chainstates directly. Will follow up and add a comment describing purpose of this function.",
      "created_at": "2024-07-18T17:43:21Z",
      "updated_at": "2024-07-18T18:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1683252537",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252537"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 32,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252990",
      "pull_request_review_id": 2186500256,
      "id": 1683252990,
      "node_id": "PRRC_kwDOABII585kVGb-",
      "diff_hunk": "@@ -535,11 +542,26 @@ class Chainstate\n         ChainstateManager& chainman,\n         std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n \n+    //! Return path to chainstate leveldb directory.\n+    fs::path StoragePath() const;\n+\n     //! Return the current role of the chainstate. See `ChainstateManager`\n     //! documentation for a description of the different types of chainstates.\n     //!\n     //! @sa ChainstateRole\n-    ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    kernel::ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 71,
      "original_position": 80,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "in_reply_to_id": 1677640152,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677640152\r\n\r\n> Not sure why we need this when in another commit we remove `GetAll()` and instead use `m_chainstates`. Seems kind of inconsistent but maybe I am missing something.\r\n\r\nIs this comment about the `Validity()` method? This is just supposed to be a public accessor for code that cannot access the private m_validity member/",
      "created_at": "2024-07-18T17:43:36Z",
      "updated_at": "2024-07-18T18:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1683252990",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252990"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683253240",
      "pull_request_review_id": 2186500256,
      "id": 1683253240,
      "node_id": "PRRC_kwDOABII585kVGf4",
      "diff_hunk": "@@ -544,6 +546,18 @@ class Chainstate\n     //! @sa ChainstateRole\n     ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_validity;\n+    }\n+\n+    //! Return true if chainstate fully validated or is assumed valid.\n+    bool IsValid() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 55,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "cdc44e878a859a34dfe0c198641531ec26b0730d",
      "in_reply_to_id": 1677573399,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677573399\r\n\r\n> nit: In other places similar checks are inlined without a helper method. That might be actually a bit more clear as well.\r\n\r\nGood point, at least at first glance this looks reasonable to inline.",
      "created_at": "2024-07-18T17:43:47Z",
      "updated_at": "2024-07-18T18:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1683253240",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683253240"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 556,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023046",
      "pull_request_review_id": 2189391816,
      "id": 1685023046,
      "node_id": "PRRC_kwDOABII585kb2lG",
      "diff_hunk": "@@ -29,6 +29,17 @@ using node::BlockManager;\n using node::KernelNotifications;\n using node::SnapshotMetadata;\n \n+static std::vector<Chainstate*> GetAll(const ChainstateManager& chainman)",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ce02d68008c2f61a6033b22df1a5ef54bba38d9f",
      "in_reply_to_id": 1677599944,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677599944\r\n\r\n> Why do you add this function around here instead of using `m_chainstates` as well?\r\n\r\nDropped this function now, it was not hard to get rid of.",
      "created_at": "2024-07-19T21:47:51Z",
      "updated_at": "2024-07-19T21:55:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1685023046",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023046"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 32,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023239",
      "pull_request_review_id": 2189391816,
      "id": 1685023239,
      "node_id": "PRRC_kwDOABII585kb2oH",
      "diff_hunk": "@@ -544,6 +546,18 @@ class Chainstate\n     //! @sa ChainstateRole\n     ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_validity;\n+    }\n+\n+    //! Return true if chainstate fully validated or is assumed valid.\n+    bool IsValid() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 55,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "cdc44e878a859a34dfe0c198641531ec26b0730d",
      "in_reply_to_id": 1677573399,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677573399\r\n\r\n> nit: In other places similar checks are inlined without a helper method. That might be actually a bit more clear as well.\r\n\r\nYou're right, that is clearer. Updated different places where this was used.\r\n",
      "created_at": "2024-07-19T21:48:04Z",
      "updated_at": "2024-07-19T21:55:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1685023239",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023239"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 556,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1986316731",
      "pull_request_review_id": 2669420393,
      "id": 1986316731,
      "node_id": "PRRC_kwDOABII5852ZMm7",
      "diff_hunk": "@@ -3451,10 +3484,10 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n-    // Belt-and-suspenders check that we aren't attempting to advance the background\n-    // chainstate past the snapshot base block.\n-    if (WITH_LOCK(::cs_main, return m_disabled)) {\n-        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. \"\n+    // Belt-and-suspenders check that we aren't attempting to advance the\n+    // chainstate past the target block.\n+    if (WITH_LOCK(::cs_main, return m_target_utxohash)) {\n+        LogPrintf(\"m_target_utxohash is set - this chainstate should not be in operation. \"",
      "path": "src/validation.cpp",
      "position": 144,
      "original_position": 126,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I've always been a bit puzzled of this check. Is it really required? If so, why don't we need to check it on every iteration of the do loop further down? What if it is actually reached, will validation on that chain just always be stuck in an unrecoverable state? Wouldn't a fatal error be more appropriate then?",
      "created_at": "2025-03-09T12:57:19Z",
      "updated_at": "2025-03-09T12:57:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1986316731",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1986316731"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3524,
      "original_line": 3524,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1987579951",
      "pull_request_review_id": 2671479089,
      "id": 1987579951,
      "node_id": "PRRC_kwDOABII5852eBAv",
      "diff_hunk": "@@ -3451,10 +3484,10 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n-    // Belt-and-suspenders check that we aren't attempting to advance the background\n-    // chainstate past the snapshot base block.\n-    if (WITH_LOCK(::cs_main, return m_disabled)) {\n-        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. \"\n+    // Belt-and-suspenders check that we aren't attempting to advance the\n+    // chainstate past the target block.\n+    if (WITH_LOCK(::cs_main, return m_target_utxohash)) {\n+        LogPrintf(\"m_target_utxohash is set - this chainstate should not be in operation. \"",
      "path": "src/validation.cpp",
      "position": 144,
      "original_position": 126,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "in_reply_to_id": 1986316731,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1986316731\r\n\r\n> I've always been a bit puzzled of this check. Is it really required? If so, why don't we need to check it on every iteration of the do loop further down? What if it is actually reached, will validation on that chain just always be stuck in an unrecoverable state? Wouldn't a fatal error be more appropriate then?\r\n\r\nThis is labeled as \"Belt-and-suspenders check\" so it should be safe to assume that it is not required. Sometimes it is useful to have checks for unexpected states that should never happen, so it is possible to detect bugs that may otherwise go unnoticed, or to provide better debug information if the unexpected state does lead to a problem later. \r\n\r\nSometimes unexpected states should trigger asserts or fatal errors, but sometimes they don't need to be fatal and can just trigger warnings like this one. In this case the unexpected state may cause the current snapshot to never get fully validated (if the background chainstate is disabled), but since the node will still be functional, and the user might be able to recover from it by loading another snapshot, maybe it is not worth causing a fatal error. Also it might make sense to have this check at the top of this function not in the loop below because it is checking a precondition: looking for an invalid state set by previous code, not invalid state set by this code. It may be possible to improve this by adding other checks, though. And it would probably be good to use `if (Assume(...))` here so if this condition is reached it will be detected in fuzz and debug builds.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2025-03-10T15:53:28Z",
      "updated_at": "2025-03-10T15:53:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1987579951",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1987579951"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3524,
      "original_line": 3524,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995503615",
      "pull_request_review_id": 2685423528,
      "id": 1995503615,
      "node_id": "PRRC_kwDOABII58528Pf_",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit 22bfd948f0d45083748724a304fa2c8482464028:\r\nJust a note: The removal of this particular check in this commit seems a bit random with all the following kind of redundant assertions, but the code does get cleaned up in later commits.",
      "created_at": "2025-03-14T12:52:06Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995503615",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995503615"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995511334",
      "pull_request_review_id": 2685423528,
      "id": 1995511334,
      "node_id": "PRRC_kwDOABII58528RYm",
      "diff_hunk": "@@ -6161,14 +6182,7 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n         GetNotifications().fatalError(user_error);\n     };\n \n-    if (index_new.GetBlockHash() != snapshot_blockhash) {\n-        LogPrintf(\"[snapshot] supposed base block %s does not match the \"\n-          \"snapshot base block %s (height %d). Snapshot is not valid.\\n\",\n-          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n-        handle_invalid_snapshot();\n-        return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;",
      "path": "src/validation.cpp",
      "position": 564,
      "original_position": 166,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think this `SnapshotcompletionResult` variant can be removed, no?",
      "created_at": "2025-03-14T12:56:23Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995511334",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995511334"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6161,
      "original_line": 6161,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995597388",
      "pull_request_review_id": 2685423528,
      "id": 1995597388,
      "node_id": "PRRC_kwDOABII58528mZM",
      "diff_hunk": "@@ -1136,7 +1139,7 @@ class ChainstateManager\n     Chainstate* HistoricalChainstate() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex())\n     {\n         auto* cs{m_ibd_chainstate.get()};\n-        return IsUsable(cs) && cs->m_target_blockhash ? cs : nullptr;\n+        return cs && cs->Validity() != ChainValidity::INVALID && cs->m_target_blockhash && !cs->m_target_utxohash ? cs : nullptr;",
      "path": "src/validation.h",
      "position": null,
      "original_position": 96,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "9853c8384e1df9ad14c2801e780cc189ac20c6d0",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit 9853c8384e1df9ad14c2801e780cc189ac20c6d0:\r\nIs the validity check required? AFAICT the historic chainstate is never invalid.",
      "created_at": "2025-03-14T13:37:00Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995597388",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995597388"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995921074",
      "pull_request_review_id": 2685423528,
      "id": 1995921074,
      "node_id": "PRRC_kwDOABII585291ay",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers",
      "path": "src/kernel/types.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: Are we still doing `-present` now? I thought I saw some discussion about that recently, but can't find it anymore.",
      "created_at": "2025-03-14T16:52:32Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995921074",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995921074"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995924122",
      "pull_request_review_id": 2685423528,
      "id": 1995924122,
      "node_id": "PRRC_kwDOABII585292Ka",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 20,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: `s/if is/if it is/`. I think there are some missing articles around here too.",
      "created_at": "2025-03-14T16:53:52Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995924122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995924122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995939302",
      "pull_request_review_id": 2685423528,
      "id": 1995939302,
      "node_id": "PRRC_kwDOABII5852953m",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an\n+    //! assumeutxo snapshot chainstate that has not been validated yet.\n+    bool validated{true};\n+\n+    //! Whether this a historical chainstate downloading old blocks to validate",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 24,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: `s/this a/this is a/`",
      "created_at": "2025-03-14T16:58:26Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995939302",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995939302"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996212305",
      "pull_request_review_id": 2685423528,
      "id": 1996212305,
      "node_id": "PRRC_kwDOABII5852-8hR",
      "diff_hunk": "@@ -3927,7 +3927,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n     // m_chain_tx_count value is not zero, assert that value is actually correct.\n     auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n     if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n-                pindexNew == CurrentChainstate().SnapshotBase())) {\n+                std::any_of(m_chainstates.begin(), m_chainstates.end(), [&](auto& cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->SnapshotBase() == pindexNew; }))) {",
      "path": "src/validation.cpp",
      "position": 226,
      "original_position": 14,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "5e22fdcdb2665c0bb5e47c53719796096afe2dd1",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't quite follow this change. What is wrong with using `CurrentChainstate` here?",
      "created_at": "2025-03-14T20:07:06Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996212305",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996212305"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3939,
      "original_line": 3939,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996244623",
      "pull_request_review_id": 2685423528,
      "id": 1996244623,
      "node_id": "PRRC_kwDOABII5852_EaP",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why is this not re-used for `ProcessNewBlock`?",
      "created_at": "2025-03-14T20:36:29Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996244623",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996244623"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6510,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996247059",
      "pull_request_review_id": 2685423528,
      "id": 1996247059,
      "node_id": "PRRC_kwDOABII5852_FAT",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const\n+{\n+    // We can't hold cs_main during ActivateBestChain even though we're accessing\n+    // the chainman unique_ptrs since ABC requires us not to be holding cs_main, so retrieve\n+    // the relevant pointers before the ABC call.\n+    std::vector<Chainstate*> chainstates;\n+    {\n+        LOCK(GetMutex());\n+        for (auto& chainstate : m_chainstates) {\n+            chainstates.emplace_back(chainstate.get());",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Shouldn't this skip over the historical chainstate if `m_target_utxohash` is set?",
      "created_at": "2025-03-14T20:38:48Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996247059",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996247059"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996249639",
      "pull_request_review_id": 2685423528,
      "id": 1996249639,
      "node_id": "PRRC_kwDOABII5852_Fon",
      "diff_hunk": "@@ -310,8 +310,9 @@ void BlockManager::FindFilesToPrune(\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n     // Distribute our -prune budget over all chainstates.\n+    const int num_chainstates{chainman.HistoricalChainstate() ? 2 : 1};",
      "path": "src/node/blockstorage.cpp",
      "position": 43,
      "original_position": 4,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm surprised this is not just taking the `m_chainstates` size. Why is that?",
      "created_at": "2025-03-14T20:40:59Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996249639",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996249639"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 317,
      "original_line": 317,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996263354",
      "pull_request_review_id": 2685423528,
      "id": 1996263354,
      "node_id": "PRRC_kwDOABII5852_I-6",
      "diff_hunk": "@@ -365,15 +369,17 @@ struct SnapshotTestSetup : TestChain100Setup {\n \n         BOOST_TEST_MESSAGE(\"Simulating node restart\");\n         {\n-            for (Chainstate* cs : chainman.GetAll()) {\n-                LOCK(::cs_main);\n-                cs->ForceFlushStateToDisk();\n+            LOCK(::cs_main);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 76,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm a bit confused when it is appropriate to use `::cs_main` and when `chainman.GetMutex()`. Is there a rule to that?",
      "created_at": "2025-03-14T20:52:50Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996263354",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996263354"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 372,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999102885",
      "pull_request_review_id": 2691157663,
      "id": 1999102885,
      "node_id": "PRRC_kwDOABII5853J-Ol",
      "diff_hunk": "@@ -6161,14 +6182,7 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n         GetNotifications().fatalError(user_error);\n     };\n \n-    if (index_new.GetBlockHash() != snapshot_blockhash) {\n-        LogPrintf(\"[snapshot] supposed base block %s does not match the \"\n-          \"snapshot base block %s (height %d). Snapshot is not valid.\\n\",\n-          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n-        handle_invalid_snapshot();\n-        return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;",
      "path": "src/validation.cpp",
      "position": 564,
      "original_position": 166,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995511334,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995511334\r\n\r\n> I think this `SnapshotcompletionResult` variant can be removed, no?\r\n\r\nGood catch, removed.",
      "created_at": "2025-03-17T16:04:13Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999102885",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999102885"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6161,
      "original_line": 6161,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999111743",
      "pull_request_review_id": 2691157663,
      "id": 1999111743,
      "node_id": "PRRC_kwDOABII5853KAY_",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995503615\r\n\r\n> In commit [22bfd94](https://github.com/bitcoin/bitcoin/commit/22bfd948f0d45083748724a304fa2c8482464028): Just a note: The removal of this particular check in this commit seems a bit random with all the following kind of redundant assertions, but the code does get cleaned up in later commits.\r\n\r\nWe might be noticing different things here so let me know if you have suggestions for improving this, but I don't think this change is random. This is replacing the `index_new.nHeight < snapshot_base_height` check with a `ReachedTarget()` check, and combining the `return SKIPPED` it triggers with the earlier one with a more complete comment about when SKIPPED is returned.\r\n\r\nThe other changes to this function that happen in later commit don't really affect these things, they just pass new parameters into this function so it can be more independent of ChainstateManager.",
      "created_at": "2025-03-17T16:06:10Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999111743",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999111743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999397249",
      "pull_request_review_id": 2691157663,
      "id": 1999397249,
      "node_id": "PRRC_kwDOABII5853LGGB",
      "diff_hunk": "@@ -1136,7 +1139,7 @@ class ChainstateManager\n     Chainstate* HistoricalChainstate() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex())\n     {\n         auto* cs{m_ibd_chainstate.get()};\n-        return IsUsable(cs) && cs->m_target_blockhash ? cs : nullptr;\n+        return cs && cs->Validity() != ChainValidity::INVALID && cs->m_target_blockhash && !cs->m_target_utxohash ? cs : nullptr;",
      "path": "src/validation.h",
      "position": null,
      "original_position": 96,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "9853c8384e1df9ad14c2801e780cc189ac20c6d0",
      "in_reply_to_id": 1995597388,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995597388\r\n\r\n> In commit [9853c83](https://github.com/bitcoin/bitcoin/commit/9853c8384e1df9ad14c2801e780cc189ac20c6d0): Is the validity check required? AFAICT the historic chainstate is never invalid.\r\n\r\nThat's true. This anticipates a later change but there is no reason to add that complexity here. Dropped this condition.",
      "created_at": "2025-03-17T18:35:07Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999397249",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999397249"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999444438",
      "pull_request_review_id": 2691157663,
      "id": 1999444438,
      "node_id": "PRRC_kwDOABII5853LRnW",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers",
      "path": "src/kernel/types.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995921074,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995921074\r\n\r\n> Nit: Are we still doing `-present` now? I thought I saw some discussion about that recently, but can't find it anymore.\r\n\r\nThe change to \"present\" never made sense to me because I think the only thing \"present\" could mean is \"when this line was written\", not what we might want it to mean like \"whenever the code here was last modified\" or \"whenever the code here was published.\"\r\n\r\nSince \"present\" just seems like a more ambiguous way of writing the current year, I'd be inclined to stick with a more a conventional approach. But I'm happy to change if the project wants to make a wider switch to \"present\" or someone can explain why writing \"present\" is better than writing the current year and never updating it. I couldn't find much discussion about this topic, but https://opensource.stackexchange.com/questions/4885/copyright-until-the-present-year-in-bsd-license seems to back up my suspicions here.",
      "created_at": "2025-03-17T19:04:43Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999444438",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999444438"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999459380",
      "pull_request_review_id": 2691157663,
      "id": 1999459380,
      "node_id": "PRRC_kwDOABII5853LVQ0",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 20,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995924122,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995924122\r\n\r\n> Nit: `s/if is/if it is/`. I think there are some missing articles around here too.\r\n\r\nThanks, fixed up various comments in this header.",
      "created_at": "2025-03-17T19:16:11Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999459380",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999459380"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999460229",
      "pull_request_review_id": 2691157663,
      "id": 1999460229,
      "node_id": "PRRC_kwDOABII5853LVeF",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an\n+    //! assumeutxo snapshot chainstate that has not been validated yet.\n+    bool validated{true};\n+\n+    //! Whether this a historical chainstate downloading old blocks to validate",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 24,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995939302,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995939302\r\n\r\n> Nit: `s/this a/this is a/`\r\n\r\nThanks, fixed",
      "created_at": "2025-03-17T19:16:54Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999460229",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999460229"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001593749",
      "pull_request_review_id": 2691157663,
      "id": 2001593749,
      "node_id": "PRRC_kwDOABII5853TeWV",
      "diff_hunk": "@@ -3927,7 +3927,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n     // m_chain_tx_count value is not zero, assert that value is actually correct.\n     auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n     if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n-                pindexNew == CurrentChainstate().SnapshotBase())) {\n+                std::any_of(m_chainstates.begin(), m_chainstates.end(), [&](auto& cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->SnapshotBase() == pindexNew; }))) {",
      "path": "src/validation.cpp",
      "position": 226,
      "original_position": 14,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "5e22fdcdb2665c0bb5e47c53719796096afe2dd1",
      "in_reply_to_id": 1996212305,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Add ChainstateManager::m_chainstates member\" (5e22fdcdb2665c0bb5e47c53719796096afe2dd1)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996212305\r\n\r\n> I don't quite follow this change. What is wrong with using `CurrentChainstate` here?\r\n\r\nIMO chainstatemanager should generally just validate and update chainstates with incoming data and not rely on concept of a \"current\" chainstate. The concept of a current chainstate is a little vague and makes more sense at the appilcation level than this level. For example wallets will treat chainstates loaded from assumeutxo snapshots as the current chainstate while indexes ignore that chainstate and treat the fully validated background chainstate as the current one.\r\n\r\nMore specifically in this case avoiding `CurrentChainstate()` makes this code more correct, and would avoid a failed Assume check and a warning if multiple snapshot chainstates were loaded, since loading a snapshot updates the snapshots block's `m_chain_tx_count` value when when the previous block may have a 0 value. (We don't currently support loading multiple snapshot chainstates now, but there is no reason we could not allow it in the future, for example to support loading a new snapshot after an older one has been loaded.)",
      "created_at": "2025-03-18T17:30:05Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001593749",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001593749"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3939,
      "original_line": 3939,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594093",
      "pull_request_review_id": 2691157663,
      "id": 2001594093,
      "node_id": "PRRC_kwDOABII5853Tebt",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": 1996244623,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Add ChainstateManager::ActivateBestChains() method\" (58265b955a3d8622f22958943f79409129d58b36)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996244623\r\n\r\n> Why is this not re-used for `ProcessNewBlock`?\r\n\r\n`ProcessNewBlock()` passes a non-null block pointer to `ActivateBestChain` so it can't directly reuse the new method. It might make sense for generalize the method, but the main goal here to get rid of unnecessary uses of ChainstateManager::GetAll() by outside code, so it's a bit outside the scope of what this particular commit is trying to do.",
      "created_at": "2025-03-18T17:30:13Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001594093",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594093"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6510,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594456",
      "pull_request_review_id": 2691157663,
      "id": 2001594456,
      "node_id": "PRRC_kwDOABII5853TehY",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const\n+{\n+    // We can't hold cs_main during ActivateBestChain even though we're accessing\n+    // the chainman unique_ptrs since ABC requires us not to be holding cs_main, so retrieve\n+    // the relevant pointers before the ABC call.\n+    std::vector<Chainstate*> chainstates;\n+    {\n+        LOCK(GetMutex());\n+        for (auto& chainstate : m_chainstates) {\n+            chainstates.emplace_back(chainstate.get());",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": 1996247059,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Add ChainstateManager::ActivateBestChains() method\" (58265b955a3d8622f22958943f79409129d58b36)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996247059\r\n\r\n> Shouldn't this skip over the historical chainstate if `m_target_utxohash` is set?\r\n\r\nYes good catch. Updated this to be equivalent.",
      "created_at": "2025-03-18T17:30:21Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001594456",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594456"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594940",
      "pull_request_review_id": 2691157663,
      "id": 2001594940,
      "node_id": "PRRC_kwDOABII5853Teo8",
      "diff_hunk": "@@ -310,8 +310,9 @@ void BlockManager::FindFilesToPrune(\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n     // Distribute our -prune budget over all chainstates.\n+    const int num_chainstates{chainman.HistoricalChainstate() ? 2 : 1};",
      "path": "src/node/blockstorage.cpp",
      "position": 43,
      "original_position": 4,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": 1996249639,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Delete ChainstateManager::GetAll() method\" (ca48478fbfcc83cc6f8c928e57800707fe0c3b51)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996249639\r\n\r\n> I'm surprised this is not just taking the `m_chainstates` size. Why is that?\r\n\r\nWrote a better comment since existing comment wasn't really explaining what was happening here. It's possible this code might need to be updated to customize pruning behavior if more chainstates are added in the future. But I think default behavior should just be to reserve block storage for the two chainstates we know about: the most-work chainstate and a historical chainstate, not to reserve storage for an arbitrary number of chainstates which may or may not need it.",
      "created_at": "2025-03-18T17:30:32Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001594940",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594940"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 317,
      "original_line": 317,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001595381",
      "pull_request_review_id": 2691157663,
      "id": 2001595381,
      "node_id": "PRRC_kwDOABII5853Tev1",
      "diff_hunk": "@@ -365,15 +369,17 @@ struct SnapshotTestSetup : TestChain100Setup {\n \n         BOOST_TEST_MESSAGE(\"Simulating node restart\");\n         {\n-            for (Chainstate* cs : chainman.GetAll()) {\n-                LOCK(::cs_main);\n-                cs->ForceFlushStateToDisk();\n+            LOCK(::cs_main);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 76,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": 1996263354,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Delete ChainstateManager::GetAll() method\" (ca48478fbfcc83cc6f8c928e57800707fe0c3b51)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996263354\r\n\r\n> I'm a bit confused when it is appropriate to use `::cs_main` and when `chainman.GetMutex()`. Is there a rule to that?\r\n\r\nI don't really make any distinction between the two but probably it's better to use the latter so switched to that in these tests",
      "created_at": "2025-03-18T17:30:41Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001595381",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001595381"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 372,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2004115942",
      "pull_request_review_id": 2699856438,
      "id": 2004115942,
      "node_id": "PRRC_kwDOABII5853dGHm",
      "diff_hunk": "@@ -600,9 +600,14 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n     // This call reinitializes the chainstates.\n     this->LoadVerifyActivateChainstate();\n \n+    std::vector<Chainstate*> chainstates;\n     {\n         LOCK(chainman_restarted.GetMutex());\n-        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 2);\n+        chainstates = chainman_restarted.GetAll();\n+        BOOST_CHECK_EQUAL(chainstates.size(), 2);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 9,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "df99f19d81537ecfbf66f6662bc9814b594ef8d2",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "df99f19d81537ecfbf66f6662bc9814b594ef8d2: \r\nI was trying to understand why this fix is correct / the height suddenly changes from 109 to 110, and I find the entire  `chainstatemanager_snapshot_init` subtest very confusing:\r\nFirst, there is a comment saying \"Test that simulating a shutdown (...) we end up with a single chainstate that is at tip\", followed by a check that there are still 2 chainstates - so the test contradicts itself.\r\n\r\nThen the test calls the test-only function `LoadVerifyActivateChainstate` which only calls ABC for the active chainstate, instead of doing it for all chainstates like its counterpart in `ImportBlocks()` during actual init does - why is this using an artificial init process that differs from the way it's done in production?\r\n\r\nBecause of that, only during `mineBlocks()` (as a result of  `ProcessNewBlock()` calling ABC for both chainstates) the block that was previously disconnected in a hacky way (by simply calling `DisconnectBlock()` instead of e.g. invalidating it) is being connected again, and the background snapshot is verified, which is a surprising side effects of just trying to connect some blocks on the tip - and the actual reason why the height is suddenly 110.\r\nI think that this deserves an explanation, but more importantly, I don't see the point / strategy of the subtest in general - what situation is it actually trying to test?\r\n\r\nI realize that this isn't really what this PR is about, so maybe there could be a separate PR to clean this test up properly, especially if the other subtests (which I didn't check) would have similar problems?",
      "created_at": "2025-03-19T19:17:15Z",
      "updated_at": "2025-03-19T21:42:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2004115942",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2004115942"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 607,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2004288056",
      "pull_request_review_id": 2699856438,
      "id": 2004288056,
      "node_id": "PRRC_kwDOABII5853dwI4",
      "diff_hunk": "@@ -598,12 +606,16 @@ class Chainstate\n     //! target the most-work, valid block.\n     std::optional<uint256> m_target_blockhash GUARDED_BY(::cs_main);\n \n+    //! Hash of the UTXO set at the target block, computed when the chainstate\n+    //! reaches the target block, and null before then.\n+    std::optional<AssumeutxoHash> m_target_utxohash GUARDED_BY(::cs_main);",
      "path": "src/validation.h",
      "position": 98,
      "original_position": 63,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "a1fd5a886252ebd813ee69029dcf17de6883e047",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "a1fd5a886252ebd813ee69029dcf17de6883e047:\r\nWhy is `m_target_utxohash` a `std::optional<AssumeutxoHash>` if it's only ever used as a bool? The hash, once set , is never read anywhere as far as I can see.\r\n\r\nnit: it should be `m_target_utxohash` instead of `m_target_blockhash` in the commit message.",
      "created_at": "2025-03-19T20:55:58Z",
      "updated_at": "2025-03-19T21:42:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2004288056",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2004288056"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 615,
      "original_line": 615,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2005190423",
      "pull_request_review_id": 2701919025,
      "id": 2005190423,
      "node_id": "PRRC_kwDOABII5853hMcX",
      "diff_hunk": "@@ -598,12 +606,16 @@ class Chainstate\n     //! target the most-work, valid block.\n     std::optional<uint256> m_target_blockhash GUARDED_BY(::cs_main);\n \n+    //! Hash of the UTXO set at the target block, computed when the chainstate\n+    //! reaches the target block, and null before then.\n+    std::optional<AssumeutxoHash> m_target_utxohash GUARDED_BY(::cs_main);",
      "path": "src/validation.h",
      "position": 98,
      "original_position": 63,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "a1fd5a886252ebd813ee69029dcf17de6883e047",
      "in_reply_to_id": 2004288056,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I was thinking that this might be interesting to add to the getchainstates rpc call. ",
      "created_at": "2025-03-20T09:44:44Z",
      "updated_at": "2025-03-20T09:44:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2005190423",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2005190423"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 615,
      "original_line": 615,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2005575053",
      "pull_request_review_id": 2702602071,
      "id": 2005575053,
      "node_id": "PRRC_kwDOABII5853iqWN",
      "diff_hunk": "@@ -600,9 +600,14 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n     // This call reinitializes the chainstates.\n     this->LoadVerifyActivateChainstate();\n \n+    std::vector<Chainstate*> chainstates;\n     {\n         LOCK(chainman_restarted.GetMutex());\n-        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 2);\n+        chainstates = chainman_restarted.GetAll();\n+        BOOST_CHECK_EQUAL(chainstates.size(), 2);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 9,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "df99f19d81537ecfbf66f6662bc9814b594ef8d2",
      "in_reply_to_id": 2004115942,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2004115942\r\n\r\n> I find the entire  `chainstatemanager_snapshot_init` subtest very confusing\r\n\r\nYes. And thanks for digging into the test. I added comments to try to make it less confusing. For reference the test was added [in e4d7995](https://github.com/bitcoin/bitcoin/pull/25667/commits/e4d799528696c5ede38c257afaffd367917e0de8#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bR472) and seems basically unchanged since when it was written.\r\n\r\n> First, there is a comment saying \"Test that simulating a shutdown (...) we end up with a single chainstate that is at tip\", followed by a check that there are still 2 chainstates - so the test contradicts itself.\r\n\r\nGood catch, the comment is wrong. If you search for \"single chainstate\" you can see the same comment is copied from 2 other tests in this file and is ok in those places. Fixed in latest push.\r\n\r\n> Then the test calls the test-only function `LoadVerifyActivateChainstate` which only calls ABC for the active chainstate, instead of doing it for all chainstates like its counterpart in `ImportBlocks()` during actual init does - why is this using an artificial init process that differs from the way it's done in production?\r\n\r\nI don't know the answer to this. The unit tests do a lot of artificial things and I'd agree it is usually better when we can remove artificial code so tests are more realistic and there is less code to maintain.\r\n\r\n> Because of that, only during `mineBlocks()` (as a result of `ProcessNewBlock()` calling ABC for both chainstates) the block that was previously disconnected in a hacky way (by simply calling `DisconnectBlock()` instead of e.g. invalidating it) is being connected again, and the background snapshot is verified, which is a surprising side effects of just trying to connect some blocks on the tip - and the actual reason why the height is suddenly 110.\r\n\r\nAdded a comment about that instead of changing it so this is still a focused bugfix. Agree if test were more realistic it might be clearer.\r\n\r\n> I think that this deserves an explanation, but more importantly, I don't see the point / strategy of the subtest in general - what situation is it actually trying to test?\r\n\r\nI think the main thing it is trying to test is `BOOST_CHECK_EQUAL(chainstates.size(), 2);` i.e. \"that snapshot chainstates initialize properly when found on disk\" and that the chainstates function as expected when more blocks are mined. Expanded the comment at the top of the test, too.\r\n\r\n> I realize that this isn't really what this PR is about, so maybe there could be a separate PR to clean this test up properly, especially if the other subtests (which I didn't check) would have similar problems?\r\n\r\nI think it would be nice if tests were more realistic, and the main thing that annoys me about these tests that is instead of using literal numbers and expressions, the tests like to declare lots of helper variables, so there are many similarly named variables it it is difficult to keep track of what they all mean and how they are used. It probably would be nice to clean these tests up and make them simpler, though not a priority.\r\n",
      "created_at": "2025-03-20T12:53:16Z",
      "updated_at": "2025-03-20T14:18:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2005575053",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2005575053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 607,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2005739316",
      "pull_request_review_id": 2702602071,
      "id": 2005739316,
      "node_id": "PRRC_kwDOABII5853jSc0",
      "diff_hunk": "@@ -598,12 +606,16 @@ class Chainstate\n     //! target the most-work, valid block.\n     std::optional<uint256> m_target_blockhash GUARDED_BY(::cs_main);\n \n+    //! Hash of the UTXO set at the target block, computed when the chainstate\n+    //! reaches the target block, and null before then.\n+    std::optional<AssumeutxoHash> m_target_utxohash GUARDED_BY(::cs_main);",
      "path": "src/validation.h",
      "position": 98,
      "original_position": 63,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "a1fd5a886252ebd813ee69029dcf17de6883e047",
      "in_reply_to_id": 2004288056,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2004288056\r\n\r\nThanks, fixed commit message. Ultimately I think it would be best to  drop the `m_target_utxohash` member and just check the `ReachedTarget()` condition everywhere instead of using `m_target_utxohash.has_value()`. But this needs to be done carefully, and it might require getting rid of some \"belt and suspenders\" checks in the current code which are technically unnecessary but give some confidence the code works correctly.\r\n\r\nThis commit is a more of a pure refactoring and tries to keep code the working the way it does currently, but add transparency so it clearer why it works and what assumptions it is making. It's trying to replace the opaque `m_disabled` bool which could indicate either (1) that the chainstate target is invalid or (2) that a chainstate is valid but no longer in use after its utxo hash was checked. Storing the utxo hash in the latter state seemed more natural representation than adding a `bool utxohash_checked` member, but I could switch to that if preferred.",
      "created_at": "2025-03-20T14:12:16Z",
      "updated_at": "2025-03-20T14:18:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2005739316",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2005739316"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 615,
      "original_line": 615,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2016515551",
      "pull_request_review_id": 2721344978,
      "id": 2016515551,
      "node_id": "PRRC_kwDOABII5854MZXf",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers",
      "path": "src/kernel/types.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995921074,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I really hate copyright discussions, but I think it would good to at least apply it consistently in the project. Definitely not something that should be hashed out on this PR though.",
      "created_at": "2025-03-27T12:53:16Z",
      "updated_at": "2025-03-27T12:53:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2016515551",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2016515551"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2016904181",
      "pull_request_review_id": 2722123526,
      "id": 2016904181,
      "node_id": "PRRC_kwDOABII5854N4P1",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Missed this in my previous round, but is this not changing behaviour significantly?  As far as I can tell we now just check that the target blockhash is reached at some point, while this check that is removed here only skips blocks up to the snapshot height and tries to complete validation with the rest once the snapshot base height is reached. What if the snapshot block is never reached? Does background validation then just continue on indefinitely?\r\n\r\nI might be missing something, but the way I am reading this we also don't have any tests for exercising what previously was previously the `BASE_BLOCKHASH_MISMATCH` failure case. ",
      "created_at": "2025-03-27T15:12:14Z",
      "updated_at": "2025-03-27T15:12:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2016904181",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2016904181"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2016928925",
      "pull_request_review_id": 2722169688,
      "id": 2016928925,
      "node_id": "PRRC_kwDOABII5854N-Sd",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2016904181\r\n\r\nWill look more closely, but I think both the old code and new code are assuming that the chainstate tip is an ancestor of the chainstate target block, or points directly to it. If that's not true I think you are right that the behavior of this function before and after this change would be different, but a lot of other things would be broken too.",
      "created_at": "2025-03-27T15:22:23Z",
      "updated_at": "2025-03-27T15:22:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2016928925",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2016928925"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2017019283",
      "pull_request_review_id": 2722338536,
      "id": 2017019283,
      "node_id": "PRRC_kwDOABII5854OUWT",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> re: [#30214 (comment)](https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2016904181)\r\n\r\n> What if the snapshot block is never reached? Does background validation then just continue on indefinitely?\r\n\r\nI think you are right and there is an improvement that can be made here. The case where the validation chainstate tip somehow points to a higher block than than target block (snapshot block) is supposed to be impossible and should never occur. That case used to return `BASE_BLOCKHASH_MISMATCH`, but was changed here to trigger an Assert instead, so the code would be simpler and so we would know if a bug occurred. However, because the Assert is place on line 6173 below the SKIPPED check on line 6126 I think the assert would never trigger, and SKIPPED would always be returned instead.\r\n\r\nThere are two callers `MaybeCompleteSnapshotValidation`, one is in `ConnectTip` which was ignoring the return value so would not be affected, but the other call in `LoadChainstate` would be affected and could cause the error to be ignored, instead of causing a startup failure.\r\n\r\nI think it would probably be good to add an assert to the top of this function to make sure the chain tip is really is an ancestor of the target block, to document the assumption make make it for likely for bugs to be caught. ",
      "created_at": "2025-03-27T16:03:56Z",
      "updated_at": "2025-03-27T16:04:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2017019283",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2017019283"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2017635268",
      "pull_request_review_id": 2723438610,
      "id": 2017635268,
      "node_id": "PRRC_kwDOABII5854QqvE",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I find it a bit hard to check this, but wouldn't the assertion then be triggerable if an alternative block at that height is received? How about adding a `ReachedTargetHeight`, and use that in the `if` block? Something like:\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 2d19ce45e5..da9efae00f 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -6091 +6091 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(Chai\r\n-            !validated_chainstate.ReachedTarget()) {\r\n+            !validated_chainstate.ReachedTargetHeight()) {\r\n@@ -6096,0 +6097 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(Chai\r\n+    if (!validated_chainstate.ReachedTarget()) return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 1b872c5af6..2d66995440 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -643,0 +644,7 @@ public:\r\n+    //! Return true if chainstate reached target block height.\r\n+    bool ReachedTargetHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+    {\r\n+        const CBlockIndex* target_block{TargetBlock()};\r\n+        return target_block && target_block->nHeight <= m_chain.Height();\r\n+    }\r\n+\r\n@@ -865,0 +873,2 @@ enum class SnapshotCompletionResult {\r\n+    BASE_BLOCKHASH_MISMATCH,\r\n```",
      "created_at": "2025-03-27T21:40:34Z",
      "updated_at": "2025-03-27T21:40:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2017635268",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2017635268"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2032074111",
      "pull_request_review_id": 2748216830,
      "id": 2032074111,
      "node_id": "PRRC_kwDOABII5855Hv1_",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2017635268\r\n\r\nSince we're talking about a case that should be impossible and indicates a bug I think the best thing to do is just to add asserts where convenient to make sure it does not happen, so I updated `ReachedTarget()` to have a new assert checking that if a target block is set the chain tip must be an ancestor of it. Your suggestion to add a `ReachedTargetHeight()` method could also work to trigger the existing assert on line 6173, but I don't think it's as appealing because any check based on height rather than hashes will be less reliable.\r\n\r\n\r\n",
      "created_at": "2025-04-07T22:05:39Z",
      "updated_at": "2025-04-07T22:11:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2032074111",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2032074111"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2032629060",
      "pull_request_review_id": 2749052966,
      "id": 2032629060,
      "node_id": "PRRC_kwDOABII5855J3VE",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Thanks for considering! I think that your change is good too. I was trying to write a functional test to see what happens when the snapshot block is re-organized while the historical chainstate is still catching up. It seems like we already shut down the node with a fatal error in that case, because `DisconnectTip` will fail to read the historical blocks that are not synced yet. In a way that is similar behaviour to when a re-org beyond the prune height occurs. Since that is the case I agree that reaching such a state on the historical chainstate is a programming error. Should we document this fatal error case with a functional test?",
      "created_at": "2025-04-08T08:01:56Z",
      "updated_at": "2025-04-08T08:01:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2032629060",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2032629060"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2032800133",
      "pull_request_review_id": 2749329967,
      "id": 2032800133,
      "node_id": "PRRC_kwDOABII5855KhGF",
      "diff_hunk": "@@ -160,7 +160,7 @@ void utxo_snapshot_fuzz(FuzzBufferType buffer)\n             const auto* index{chainman.m_blockman.LookupBlockIndex(block->GetHash())};\n             Assert(index);\n             Assert(index->nTx == 0);\n-            if (index->nHeight == chainman.GetSnapshotBaseHeight()) {\n+            if (index->nHeight == chainman.CurrentChainstate().SnapshotBase()->nHeight) {",
      "path": "src/test/fuzz/utxo_snapshot.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "529890d836cb75175c7943ee0a79c536412d002c",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit 529890d836cb75175c7943ee0a79c536412d002c\r\n\r\nI get a compilation error here. The change seems to be two commits too early, but the line also needs to be changed in this commit, so there would be some line churn. ",
      "created_at": "2025-04-08T09:35:56Z",
      "updated_at": "2025-04-08T09:45:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2032800133",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2032800133"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 163,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2033541233",
      "pull_request_review_id": 2750555125,
      "id": 2033541233,
      "node_id": "PRRC_kwDOABII5855NWBx",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 507,
      "original_position": 139,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2032629060\r\n\r\n> Should we document this fatal error case with a functional test?\r\n\r\nIt could be good to have a test or improve handling of that case, but I don't think there is much of a connection between that case and the changes in this PR.\r\n\r\nIt seems to me like implicit assumption than snapshot block will not get reorged is a different than the assumption that `!TargetBlock() || TargetBlock()->GetAncestor(m_chain.Height()) == m_chain.Tip()` will be true for any chainstate. If we would like to gracefully handle the case where the snapshot block gets reorged (which would be nice IMO), I think the best way to do that would be to call `SetTargetBlock(nullptr)` to reset the target block of the validation chainstate and turn it back into a normal chainstate.",
      "created_at": "2025-04-08T16:05:30Z",
      "updated_at": "2025-04-08T16:07:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2033541233",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2033541233"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6116,
      "original_line": 6116,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2040309650",
      "pull_request_review_id": 2761594904,
      "id": 2040309650,
      "node_id": "PRRC_kwDOABII5855nKeS",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {",
      "path": "src/kernel/types.h",
      "position": 18,
      "original_position": 18,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "24aaf0d3a149bf532dd5f87dc58466822f847b07",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "commit 24aaf0d3a149bf532dd5f87dc58466822f847b07:\r\nGoing from a 3-state enum to a struct of two bools means that one of the 4 possible combinations (`validated = false, historical = true`) is now something users of `ChainstateRole` must consider as a theoretical possibility, although it shouldn't be possible to actually occur.\r\n",
      "created_at": "2025-04-11T21:23:32Z",
      "updated_at": "2025-04-11T21:47:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2040309650",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2040309650"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 18,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2040321756",
      "pull_request_review_id": 2761594904,
      "id": 2040321756,
      "node_id": "PRRC_kwDOABII5855nNbc",
      "diff_hunk": "@@ -3961,7 +3961,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n             }\n             pindex->m_chain_tx_count = prev_tx_sum(*pindex);\n             pindex->nSequenceId = nBlockSequenceId++;\n-            for (Chainstate *c : GetAll()) {\n+            for (const auto& c : m_chainstates) {",
      "path": "src/validation.cpp",
      "position": 235,
      "original_position": 5,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "46a44dcae073758d6808444ea33eb37acd0b1248",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "commit 46a44dcae073758d6808444ea33eb37acd0b1248\r\nReplacing `GetAll()` by a loop over `m_chainstates`  looks a bit dubious as a refactor to me. The latter also includes successfully validated chainstates and invalid chainstates, whereas the former doesn't. I see that this is explicitly handled in some spots such as `ActivateBestChains()`, but not everywhere, so I wonder what the consequences of this are. \r\n\r\nIn this spot, for example, it looks that we might add blocks to `setBlockIndexCandidates` for an invalid or validate chainstate. \r\nThis should at least be discussed in the commit message in my opinion, even if the consequences wouldn't be noticable.",
      "created_at": "2025-04-11T21:33:08Z",
      "updated_at": "2025-04-11T21:47:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2040321756",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2040321756"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3973,
      "original_line": 3973,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2042350899",
      "pull_request_review_id": 2764664174,
      "id": 2042350899,
      "node_id": "PRRC_kwDOABII5855u80z",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {",
      "path": "src/kernel/types.h",
      "position": 18,
      "original_position": 18,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "24aaf0d3a149bf532dd5f87dc58466822f847b07",
      "in_reply_to_id": 2040309650,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2040309650\r\n\r\n> commit [24aaf0d](https://github.com/bitcoin/bitcoin/commit/24aaf0d3a149bf532dd5f87dc58466822f847b07): Going from a 3-state enum to a struct of two bools means that one of the 4 possible combinations (`validated = false, historical = true`) is now something users of `ChainstateRole` must consider as a theoretical possibility, although it shouldn't be possible to actually occur.\r\n\r\nIt would be more accurate to say that state _doesn't_ occur than that it _shouldn't_ occur. The point of this change is to only give clients (wallet & indexes) chainstate information they actually care about instead of making them deal with assumeutxo design and implementation details.\r\n\r\nSpecifically indexes care (for now) whether block notifications pertain to blocks that have been fully validated from genesis since the indexes don't currently use snapshot data, while wallets do work with snapshots and only care about whether notifications pertain to the most-work chainstate. So this is information the API now directly provides instead of assumeutxo states that wallets and indexes had to make assumptions and inferences about.\r\n\r\nA (`validated = false, historical = true`) chainstate could also be possible and even useful if you had a previous utxo snapshot that you wanted to use to generate a new snapshot targetting a later block. Theoretically you'd want the node API and wallet and index code not to require any changes if a feature like this were added, which is now the case after this commit.",
      "created_at": "2025-04-14T15:06:26Z",
      "updated_at": "2025-04-14T15:11:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2042350899",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2042350899"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 18,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2042356811",
      "pull_request_review_id": 2764664174,
      "id": 2042356811,
      "node_id": "PRRC_kwDOABII5855u-RL",
      "diff_hunk": "@@ -3961,7 +3961,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n             }\n             pindex->m_chain_tx_count = prev_tx_sum(*pindex);\n             pindex->nSequenceId = nBlockSequenceId++;\n-            for (Chainstate *c : GetAll()) {\n+            for (const auto& c : m_chainstates) {",
      "path": "src/validation.cpp",
      "position": 235,
      "original_position": 5,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "46a44dcae073758d6808444ea33eb37acd0b1248",
      "in_reply_to_id": 2040321756,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2040321756\r\n\r\n> commit [46a44dc](https://github.com/bitcoin/bitcoin/commit/46a44dcae073758d6808444ea33eb37acd0b1248) Replacing `GetAll()` by a loop over `m_chainstates` looks a bit dubious as a refactor to me. The latter also includes successfully validated chainstates and invalid chainstates, whereas the former doesn't.\r\n\r\nThe point getting rid of GetAll is to make code more explicit. If you want to skip invalid chainstates, you should explicitly skip them, not rely on a `GetAll()` method that includes and excludes chainstates in a complicated and arbitrary way. (And a misleading one, if you are a naive person who thinks \"All\" means all.)\r\n\r\n> I see that this is explicitly handled in some spots such as `ActivateBestChains()`, but not everywhere, so I wonder what the consequences of this are.\r\n\r\nThis is a refactoring commit, so if there are consequences this is a bug.\r\n\r\n> In this spot, for example, it looks that we might add blocks to `setBlockIndexCandidates` for an invalid or validate chainstate. This should at least be discussed in the commit message in my opinion, even if the consequences wouldn't be noticable.\r\n\r\nThanks, I think it'd be good to add something like `if (Validity() = ChainValidity::INVALID) return;` to `Chainstate::TryAddBlockIndexCandidate` with a comment to make it more obvious no behavior is changing here. This could also be a future-proofing mechanism in case in the future we wanted to handle invalid snapshots in a different way that didn't trigger an immediate shutdown.",
      "created_at": "2025-04-14T15:09:55Z",
      "updated_at": "2025-04-14T15:11:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2042356811",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2042356811"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3973,
      "original_line": 3973,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2047429601",
      "pull_request_review_id": 2773356219,
      "id": 2047429601,
      "node_id": "PRRC_kwDOABII5856CUvh",
      "diff_hunk": "@@ -3961,7 +3961,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n             }\n             pindex->m_chain_tx_count = prev_tx_sum(*pindex);\n             pindex->nSequenceId = nBlockSequenceId++;\n-            for (Chainstate *c : GetAll()) {\n+            for (const auto& c : m_chainstates) {",
      "path": "src/validation.cpp",
      "position": 235,
      "original_position": 5,
      "commit_id": "12f276ba2bfc106083c1615539857cdefff9794b",
      "original_commit_id": "46a44dcae073758d6808444ea33eb37acd0b1248",
      "in_reply_to_id": 2040321756,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2042356811\r\n\r\n> Thanks, I think it'd be good to add something like `if (Validity() = ChainValidity::INVALID) return;` to `Chainstate::TryAddBlockIndexCandidate` with a comment to make it more obvious no behavior is changing here.\r\n\r\nThis is now done in the latest push (https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2810282674)",
      "created_at": "2025-04-16T17:45:13Z",
      "updated_at": "2025-04-16T17:47:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2047429601",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2047429601"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3973,
      "original_line": 3973,
      "side": "RIGHT"
    }
  ]
}