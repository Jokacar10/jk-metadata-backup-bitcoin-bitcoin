{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488",
    "id": 1517014804,
    "node_id": "PR_kwDOABII585aa88U",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/28488",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/28488.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/28488.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
    "number": 28488,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "p2p: Evict outbound peers with high minFeeRate",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "See issue #28371\r\n\r\nHaving no peers with sufficiently broad mempool limits may prevent our low-fee transactions from propagating, even though they would seem perfectly valid for us locally.\r\n\r\nHaving too few such peers may cause privacy leaks.\r\n\r\nWe should periodically check that we have sufficient peers with mempool limits comparable to ours.\r\nIf that's not true, we should evict some high-minFeeRate outbound peers to make room for a new peer with hopefully broader limits.",
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      },
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2023-09-15T09:28:31Z",
    "updated_at": "2025-01-23T12:57:13Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "bbc325629a1ff3a4b63c9428ca4ff7fac2591f39",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "naumenkogs:2023-9-evict-minfee",
      "ref": "2023-9-evict-minfee",
      "sha": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 115054139,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTUwNTQxMzk=",
        "name": "bitcoin",
        "full_name": "naumenkogs/bitcoin",
        "owner": {
          "login": "naumenkogs",
          "id": 7975071,
          "node_id": "MDQ6VXNlcjc5NzUwNzE=",
          "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/naumenkogs",
          "html_url": "https://github.com/naumenkogs",
          "followers_url": "https://api.github.com/users/naumenkogs/followers",
          "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
          "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
          "repos_url": "https://api.github.com/users/naumenkogs/repos",
          "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/naumenkogs/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/naumenkogs/bitcoin",
        "archive_url": "https://api.github.com/repos/naumenkogs/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/naumenkogs/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/naumenkogs/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/naumenkogs/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/naumenkogs/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/naumenkogs/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/naumenkogs/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/naumenkogs/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/naumenkogs/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/naumenkogs/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/naumenkogs/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/naumenkogs/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/naumenkogs/bitcoin/events",
        "forks_url": "https://api.github.com/repos/naumenkogs/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/naumenkogs/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/naumenkogs/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/naumenkogs/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/naumenkogs/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/naumenkogs/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/naumenkogs/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/naumenkogs/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/naumenkogs/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/naumenkogs/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/naumenkogs/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/naumenkogs/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/naumenkogs/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/naumenkogs/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/naumenkogs/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/naumenkogs/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:naumenkogs/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/naumenkogs/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/naumenkogs/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/naumenkogs/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/naumenkogs/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/naumenkogs/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/naumenkogs/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/naumenkogs/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/naumenkogs/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/naumenkogs/bitcoin/hooks",
        "svn_url": "https://github.com/naumenkogs/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 2,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 259134,
        "default_branch": "master",
        "open_issues_count": 1,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-11T10:56:21Z",
        "created_at": "2017-12-21T22:52:17Z",
        "updated_at": "2021-03-02T13:21:27Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "f01416e23c9c820517c37003a2a98dd46d1022ba",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36597,
        "stargazers_count": 81587,
        "watchers_count": 81587,
        "size": 274683,
        "default_branch": "master",
        "open_issues_count": 693,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-01-23T12:50:42Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-01-23T12:50:48Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
      }
    },
    "author_association": "MEMBER",
    "draft": true,
    "additions": 135,
    "deletions": 1,
    "changed_files": 4,
    "commits": 1,
    "review_comments": 27,
    "comments": 11
  },
  "events": [
    {
      "event": "commented",
      "id": 1720966365,
      "node_id": "IC_kwDOABII585mk9zd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1720966365",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-15T09:28:34Z",
      "updated_at": "2025-01-23T12:57:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28488).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [vasild](https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1635005891) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1720966365",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "labeled",
      "id": 10381254305,
      "node_id": "LE_lADOABII585xIgbjzwAAAAJqxV6h",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10381254305",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-15T09:28:35Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "reviewed",
      "id": 1628658002,
      "node_id": "PRR_kwDOABII585hE1lS",
      "url": null,
      "actor": null,
      "commit_id": "c3353c6aa3b546eaa153a03e99252ff9767a0c94",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1628658002",
      "submitted_at": "2023-09-15T10:25:56Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "reviewed",
      "id": 1628762677,
      "node_id": "PRR_kwDOABII585hFPI1",
      "url": null,
      "actor": null,
      "commit_id": "c3353c6aa3b546eaa153a03e99252ff9767a0c94",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "I don't think it's as simple as disconnecting from peers with a minfee filter X% larger than ours. A minfee filter X% larger doesn't mean the peer's mempool is X% smaller. Take a simple extreme example: our mempool is filled with 299MB of >10sats/vb txs, and 1MB of 1sats/vb transaction. Out peer sets `-maxmempool=299`. It advertizes a minfee filter >=10sats/vb. That's at least 10 times ours, but we really shouldn't disconnect it.\r\n\r\nWhat i was thinking about with my suggestion in #28371 was to get a conservative maximum size of the peer's mempool based on their advertized minfee filter and our own mempool. And disconnect it if it's unreasonably small. (Like 80% smaller than our own `-maxmempool`.)",
      "user": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1628762677",
      "submitted_at": "2023-09-15T11:39:00Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "labeled",
      "id": 10382713103,
      "node_id": "LE_lADOABII585xIgbjzwAAAAJq26EP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10382713103",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-15T12:09:50Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 1722871879,
      "node_id": "IC_kwDOABII585msPBH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1722871879",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-18T07:21:01Z",
      "updated_at": "2023-09-18T07:21:01Z",
      "author_association": "MEMBER",
      "body": "@darosior `m_total_fee / totalTxSize` (instead of GetMinFee()) would kinda solve the example you point out, but it's not perfect either. I agree that what you suggest is ideal. I just haven't found a way to apply other peer's minfeerate to our mempool in a reasonable way.\r\nMaybe this:\r\n\r\nEvery time we consider evicting (say every hour), traverse through our mempool and apply the peer's minfeerate, then see how many transactions are dropped. (A slightly optimized way would be to use a binary search to find at what exact feerate we're at 80% of mempool size — that would be faster, and also will better apply across peers).\r\n\r\nIs that roughly what you're thinking about?",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1722871879",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "mentioned",
      "id": 10394172531,
      "node_id": "MEE_lADOABII585xIgbjzwAAAAJrinxz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10394172531",
      "actor": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-18T07:21:01Z"
    },
    {
      "event": "subscribed",
      "id": 10394172548,
      "node_id": "SE_lADOABII585xIgbjzwAAAAJrinyE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10394172548",
      "actor": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-18T07:21:01Z"
    },
    {
      "event": "commented",
      "id": 1723705521,
      "node_id": "IC_kwDOABII585mvaix",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1723705521",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-18T15:26:46Z",
      "updated_at": "2023-09-18T15:26:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "> If that's not true, we should evict some high-minFeeRate outbound peers to make room for a new peer with hopefully broader limits.\r\n\r\nI think this is coming with the downside of dropping outbound peers, which might be otherwise stable and fast block-relay peers. If an adversary is able to discover our 8 full-relay peers and drop high-feerate _conflicting_  transactions in their mempools, we’ll evict those peers, potentially opening new outbound slots to puppets controlled by the adversary.\r\n\r\nI don’t know if a better direction would be to announce the local `maxmempool` at p2p connection, sounds this is less prone to manipulation by external peers flowing high-feerate transactions in a targeted fashion.",
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1723705521",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "commented",
      "id": 1724907328,
      "node_id": "IC_kwDOABII585mz_9A",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1724907328",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-19T06:33:34Z",
      "updated_at": "2023-09-19T06:33:34Z",
      "author_association": "MEMBER",
      "body": "@ariard \r\n>If an adversary is able to discover our 8 full-relay peers and drop high-feerate conflicting transactions in their mempools, we’ll evict those peers, potentially opening new outbound slots to puppets controlled by the adversary.\r\n\r\nI'm not convinced this is a problem yet. If you assume an attacker can easily take `new outbound slots`, then our peers might belong to an attacker in the first place... Outbound peer eviction should not be too cheap (say, an attacker should not be able to roll a hundred of peers in a day), but for that I think algorithm can be tuned.\r\n\r\nI'm not 100% sure I understand your precise attack scenario. Let's say mempools are equal-size and half empty. What it will take for your attack to force at least one eviction? In fees and capital locked, I guess (dropping the spying effort for now).\r\n\r\n----------------\r\n\r\n>I don’t know if a better direction would be to announce the local maxmempool at p2p connection, sounds this is less prone to manipulation by external peers flowing high-feerate transactions in a targeted fashion.\r\n\r\nDoesn't it have a similar risk? Feed those peers with high-feerate conflicts and they won't be able to accept txs from my mempool, even though everything seems fine? They won't be dropped, but the relay won't work, at the same cost.",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1724907328",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "mentioned",
      "id": 10406261399,
      "node_id": "MEE_lADOABII585xIgbjzwAAAAJsQvKX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10406261399",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-19T06:33:35Z"
    },
    {
      "event": "subscribed",
      "id": 10406261412,
      "node_id": "SE_lADOABII585xIgbjzwAAAAJsQvKk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10406261412",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-19T06:33:35Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDZiNGM0YWVhZjJmOTYyNWYwM2ViOGNjYzY4Y2Y2YTk2MTU4YWMwOTk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "tree": {
        "sha": "7884c721af1b2886dcf1bb13cc935d3109a312fa",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7884c721af1b2886dcf1bb13cc935d3109a312fa"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f1a9fd627b1a669c4dfab797da42825230708f2a",
          "sha": "f1a9fd627b1a669c4dfab797da42825230708f2a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f1a9fd627b1a669c4dfab797da42825230708f2a"
        }
      ],
      "message": "p2p: Evict outbound peers with high minFeeRate\n\nHaving no peers with sufficiently broad mempool\nlimits may prevent our low-fee transactions from\npropagating, even though they would seem perfectly\nvalid for us locally.\n\nHaving too few such peers may cause privacy leaks.\n\nWe should periodically check that we have sufficient\npeers with mempool limits comparable to ours.\n\nIf that's not the case, we should evict some high-minFeeRate\noutbound peers to make room for a new peer with hopefully\nbroader limits.",
      "committer": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2023-09-19T13:52:29Z"
      },
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2023-09-15T09:27:03Z"
      },
      "sha": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 10410967467,
      "node_id": "HRFPE_lADOABII585xIgbjzwAAAAJsisGr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10410967467",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": "https://api.github.com/repos/naumenkogs/bitcoin/commits/6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "created_at": "2023-09-19T13:52:54Z"
    },
    {
      "event": "commented",
      "id": 1725781165,
      "node_id": "IC_kwDOABII585m3VSt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725781165",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-19T14:40:29Z",
      "updated_at": "2023-09-19T14:40:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Outbound peer eviction should not be too cheap (say, an attacker should not be able to roll a hundred of peers in a day), but for that I think algorithm can be tuned.\r\n\r\nI think this is where in my mind this PR is affecting the reliability of our outbound peers topology, as `CheckForLimitedMempoolAndEvictPeers()` will kick out outbound peers with high-feerate every 60s so at max 1440 outbound peers per day. Assuming we have 50k reachable nodes in the network, it will take a month to browse the whole outbound peers space. If an adversary can control a minimal number of peers in this 50k set, it sounds after a bit more than a month our whole outbound peer topology could be controlled. I agree the algorithm can be fine tuned to slow down the peers worst-case roll up.\r\n\r\n> What it will take for your attack to force at least one eviction?\r\n\r\nWe assume 1 MB of max mempool size, both locally and for our outbound peers. The adversary broadcasts \"set A\" 500 parents at 1 sat/vb of size 100 KB (0.5 MB) in our outbound peers mempools, and then simulatenously broadcasts \"set B” 500 parents at 1 sat/vb of size 100 KB (0.5 MB), the 500 parents A conflicting with the 500 parents B. Then the adversary broadcast a \"set C\" of 500 child at 3 sat/vb of size 100  KB (0.5 MB) in our outbound peers mempools, and then simultaneously a \"set D\" of 500 child at 1 sat/vb of size 100 KB (0.5 MB).\r\n\r\nWhen the adversary broadcast one more transaction at 1 sat sat/vb, our outbound peers mempool min fee should jump to 2 sat/vb (descendant score of set A txn) and our local mempool min fee should jump to 1 sat/vb (`TrimToSize()`), our outbound peers will be disconnected due to high minFeeRate. Fees cost for the adfversary is in the order of 0.02 BTC if my maths are correct.\r\n\r\nI agree the cost for the adversary is significant if you assume outbound peers are using default setting (300 MB so 6 BTC), and might not be opportun unless you're eclipsing a high-loaded Lightning node's chain view. Still the interdependency if added, doesn't sounds great.\r\n\r\n> Doesn't it have a similar risk? Feed those peers with high-feerate conflicts and they won't be able to accept txs from my mempool, even though everything seems fine? \r\n\r\nWith this direction, you would only disconnect based on the `maxmempool` announced, not the seen fee filters. Of course, there is similar risk of transaction propagation issue interference, though at least you're not loosing full-relay peers that are good for the honesty of your chain view, I think.",
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1725781165",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "reviewed",
      "id": 1635005891,
      "node_id": "PRR_kwDOABII585hdDXD",
      "url": null,
      "actor": null,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nWhat about triggering this only if it is needed - if we have such a low fee transaction of ours that we want to broadcast? Otherwise it looks like we will be kicking peers unnecessary (a low fee local tx may never be created).\r\n\r\nCould this partition the network, having big mempools on one side and small mempools on the other side?",
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1635005891",
      "submitted_at": "2023-09-20T08:41:49Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "commented",
      "id": 1728160675,
      "node_id": "IC_kwDOABII585nAaOj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1728160675",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-20T17:29:12Z",
      "updated_at": "2023-09-20T17:29:12Z",
      "author_association": "MEMBER",
      "body": "Maybe we want to look at peers that aren't announcing a lot of INV relative to other peers of the same type and use it as some sort of apples-to-apples tie breaker? I'd be extremely careful of self-partitioning if we've already found what we believe to be useful outbound peers for blocks.",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1728160675",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "commented",
      "id": 1729562824,
      "node_id": "IC_kwDOABII585nFwjI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729562824",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:51Z",
      "updated_at": "2023-09-21T13:14:51Z",
      "author_association": "MEMBER",
      "body": "@ariard \r\n\r\n>With this direction, you would only disconnect based on the maxmempool announced, not the seen fee filters. Of course, there is a similar risk of transaction propagation issue interference, though at least you're not losing full-relay peers that are good for the honesty of your chain view.\r\n\r\nMy point was that even though you continue to receive blocks, the same exact cost (6 BTC or whatever) would apply to censoring transactions (through spamming peer's mempool) seamlessly. However, with my patch, an attacker *has to repeat it* until all outbound connections are occupied. With your patch, it's a one-time cost (assuming no other fix is applied). Right?\r\nI agree we should continue comparing these two solutions.\r\n\r\n---------------\r\n\r\n@vasild\r\n\r\n>What about triggering this only if it is needed - if we have such a low-fee transaction\r\n\r\nWith time-sensitive transactions, I think you don't want to deal with it at the last moment. Although you're right, we should be careful with adding structure to the network. That's why my initial policy was *4 peers should have a similar mempool*, but I'm open to discussing it.\r\n\r\n--------------------\r\n\r\n@instagibbs \r\n\r\nThat would be partitioning based on latency instead of just mempool size... Is it any better?",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1729562824",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "mentioned",
      "id": 10435401890,
      "node_id": "MEE_lADOABII585xIgbjzwAAAAJt_5ii",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10435401890",
      "actor": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:51Z"
    },
    {
      "event": "subscribed",
      "id": 10435401930,
      "node_id": "SE_lADOABII585xIgbjzwAAAAJt_5jK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10435401930",
      "actor": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:51Z"
    },
    {
      "event": "mentioned",
      "id": 10435401971,
      "node_id": "MEE_lADOABII585xIgbjzwAAAAJt_5jz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10435401971",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:51Z"
    },
    {
      "event": "subscribed",
      "id": 10435402007,
      "node_id": "SE_lADOABII585xIgbjzwAAAAJt_5kX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10435402007",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:51Z"
    },
    {
      "event": "mentioned",
      "id": 10435402053,
      "node_id": "MEE_lADOABII585xIgbjzwAAAAJt_5lF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10435402053",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:52Z"
    },
    {
      "event": "subscribed",
      "id": 10435402086,
      "node_id": "SE_lADOABII585xIgbjzwAAAAJt_5lm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10435402086",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-09-21T13:14:52Z"
    },
    {
      "event": "reviewed",
      "id": 1655682641,
      "node_id": "PRR_kwDOABII585ir7ZR",
      "url": null,
      "actor": null,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "> My point was that even though you continue to receive blocks, the same exact cost (6 BTC > or whatever) would apply to censoring transactions (through spamming peer's mempool)\r\n> seamlessly. However, with my patch, an attacker has to repeat it until all outbound\r\n> connections are occupied. With your patch, it's a one-time cost (assuming no other fix is\r\n> applied). Right?\r\n> I agree we should continue comparing these two solutions.\r\n\r\nSo I think mempool partitioning attack is a sufficient concern to weigh in the design of outbound peers eviction based on low-mempool limits. From my understanding you have few ways to implement it:\r\n- current solution: on the received bip133 feefilter and some margin\r\n- proposed solution 1: extend p2p protocol to announce mempool size (i.e make `maxmempoolsize`) a p2p parameter\r\n- proposed solution 2 (instagibbs) iiuc: based on the INV traffic received or as a tie-breaker only about current solution\r\n\r\nI think all solutions can be targeted by mempool partitioning attack, the difference between the first solution (feefilter-based) and the second one (maxmempoolsize) sounds low-limit mempool (and as such higher feefilter) sounds cheaper in satoshis amount has to locked up in the mempool. It sounds the same one-time cost or repeating the partitioning the peer for each full-outbound peer, as here the adversary constraint is the real value in satoshi that has to be locked up no, it can be reused for each partition ?\r\n\r\nBeyond Lightning nodes and time-sensitive transactions, I think miners mempools can be a source of concern, they need to receive new blocks while at the same time be informed of the best transaction feerate. If all their transaction-relay peers can be hijacked based on mempool-limits eviction, I believe you can downgrade their marginal income.",
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1655682641",
      "submitted_at": "2023-10-03T17:10:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "reviewed",
      "id": 1674089130,
      "node_id": "PRR_kwDOABII585jyJKq",
      "url": null,
      "actor": null,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1674089130",
      "submitted_at": "2023-10-12T14:51:46Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "reviewed",
      "id": 1672139027,
      "node_id": "PRR_kwDOABII585jqtET",
      "url": null,
      "actor": null,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1672139027",
      "submitted_at": "2023-10-12T15:13:03Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "reviewed",
      "id": 1674624293,
      "node_id": "PRR_kwDOABII585j0L0l",
      "url": null,
      "actor": null,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1674624293",
      "submitted_at": "2023-10-12T16:33:10Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "commented",
      "id": 1759974495,
      "node_id": "IC_kwDOABII585o5xRf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1759974495",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-10-12T16:37:35Z",
      "updated_at": "2023-10-12T16:37:56Z",
      "author_association": "MEMBER",
      "body": "> That would be partitioning based on latency instead of just mempool size... Is it any better?\r\n\r\nI'm not sure I get the question. We should think very carefully about messing with outbounds that are otherwise deemed important for avoiding chainsplit reasons ",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1759974495",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "reviewed",
      "id": 1675373047,
      "node_id": "PRR_kwDOABII585j3Cn3",
      "url": null,
      "actor": null,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "I think it would be good to have some kind of limiting factor (maybe by fee estimation for a reasonably large target?) so that if someone decides to run with a much larger mempool size than the default, they don't keep on dropping outbound peers that run with the default. Otherwise they could spend a long time circling through outbounds until they have found enough peers with a mempool of a similar size than theirs.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#pullrequestreview-1675373047",
      "submitted_at": "2023-10-12T23:14:19Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
    },
    {
      "event": "commented",
      "id": 1761003526,
      "node_id": "IC_kwDOABII585o9sgG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761003526",
      "actor": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-10-13T06:57:30Z",
      "updated_at": "2023-10-13T06:57:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "I second @mzumsande above, plus I see this as too aggressive change that will affect all nodes whereas few will benefit. In other words, this is not needed if a node does not have problems propagating its transactions. For such problems to happen a node must be running with larger than the default mempool or all its peers with smaller than default. Further, if the node's mempool is much larger than default then it may never find a peer with a comparable mempool, so it may loop through peers needlessly while such low fee transactions have not been created yet (and may never be). So this only helps if the node's mempool is larger, but not too large _and_ it creates very low fee transactions.\r\n\r\nI am not saying that this should be dropped, but does it make sense to enable it conditionally, under a configuration parameter? With a suggestion to turn it on if the mempool is larger than default _and_ very low fee, time sensitive transactions are expected to be generated.",
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1761003526",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "mentioned",
      "id": 10640570289,
      "node_id": "MEE_lADOABII585xIgbjzwAAAAJ6Ojex",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10640570289",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-10-13T06:57:30Z"
    },
    {
      "event": "subscribed",
      "id": 10640570305,
      "node_id": "SE_lADOABII585xIgbjzwAAAAJ6OjfB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10640570305",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-10-13T06:57:30Z"
    },
    {
      "event": "commented",
      "id": 1927142375,
      "node_id": "IC_kwDOABII585y3dvn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1927142375",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-05T14:34:39Z",
      "updated_at": "2024-02-05T14:34:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--2e250dc3d92b2c9115b66051148d6e47-->\n🤔 There hasn't been much activity lately and the CI seems to be failing.\n\nIf no one reviewed the current pull request by commit hash, a [rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes) can be considered. While the CI failure may be a false positive, the CI hasn't been running for some time, so there may be a real issue hiding as well. A rebase triggers the latest CI and makes sure that no silent merge conflicts have snuck in.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-1927142375",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    },
    {
      "event": "commented",
      "id": 2567802823,
      "node_id": "IC_kwDOABII586ZDY_H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2567802823",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-02T13:48:00Z",
      "updated_at": "2025-01-02T13:48:00Z",
      "author_association": "CONTRIBUTOR",
      "body": "Are you still working on this?",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#issuecomment-2567802823",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28488"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327103636",
      "pull_request_review_id": 1628658002,
      "id": 1327103636,
      "node_id": "PRRC_kwDOABII585PGf6U",
      "diff_hunk": "@@ -5194,6 +5197,65 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.m_min_relay_feerate.GetFeePerK());",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "c3353c6aa3b546eaa153a03e99252ff9767a0c94",
      "in_reply_to_id": null,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This will always give you 1sat/vB (or whatever the static min relay feerate is). I assume you want the dynamic one?\r\n```suggestion\r\n    const auto our_min_feerate = m_mempool.GetMinFee();\r\n```",
      "created_at": "2023-09-15T10:24:19Z",
      "updated_at": "2023-09-15T10:25:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1327103636",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327103636"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327169760",
      "pull_request_review_id": 1628762677,
      "id": 1327169760,
      "node_id": "PRRC_kwDOABII585PGwDg",
      "diff_hunk": "@@ -5194,6 +5197,65 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.m_min_relay_feerate.GetFeePerK());\n+\n+    if (our_min_feerate == 0) return;\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t above_our_80_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));\n+            } else {\n+                ++above_our_80_percent_fee_filter;\n+            }\n+        }\n+    });\n+\n+    LogPrint(BCLog::NET, \"Filters? %i\\n\", peer_fee_filters.size() );\n+\n+    if (peer_fee_filters.size() == 0) return;\n+\n+    std::sort(peer_fee_filters.begin(), peer_fee_filters.end());\n+\n+    for (auto [node_id, fee_filter] : peer_fee_filters) {\n+        if (fee_filter == 0) ++above_our_80_percent_fee_filter;\n+        if (fee_filter >= our_min_feerate * 0.8) ++above_our_80_percent_fee_filter;;\n+    }\n+\n+    if (above_our_80_percent_fee_filter < 4) {\n+        // Drop one peer at a time to preserve a sufficient total\n+        // number of connections, and to avoid network DoS.\n+        // TODO add randomness chosing among low-feerate candidates.\n+        peer_fee_filters[0].first->fDisconnect = true;\n+    }",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 75,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "c3353c6aa3b546eaa153a03e99252ff9767a0c94",
      "in_reply_to_id": null,
      "user": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It looks like this is backward? It seems you want to be disconnecting from peers with fee filters larger than our, but you are doing the opposite: disconnecting from the peer with the smallest fee filter (and therefore most likely the largest mempool).\r\n\r\nAnyways, i don't think we should base this on the value of the fee filter but rather on the guesstimated size of the peer's mempool.",
      "created_at": "2023-09-15T11:37:48Z",
      "updated_at": "2023-09-15T11:39:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1327169760",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327169760"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": 5249,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 5251,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331221040",
      "pull_request_review_id": 1635005891,
      "id": 1331221040,
      "node_id": "PRRC_kwDOABII585PWNIw",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());",
      "path": "src/net_processing.cpp",
      "position": 38,
      "original_position": 38,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't get it why it is better to compare mempool sizes.\r\n\r\n* If the peer's minfee is larger than the tx fee, then the tx will be dropped by that peer (irrelevant of their mempool size)\r\n* If the peer's minfee is smaller than the tx fee, then the tx will be accepted by that peer (irrelevant of their mempool size).\r\n\r\nNo? I see how the mempool size affects minfee, but is it not minfee what we care about?",
      "created_at": "2023-09-20T08:25:32Z",
      "updated_at": "2023-09-20T08:41:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1331221040",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331221040"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 5214,
      "original_start_line": 5214,
      "start_side": "RIGHT",
      "line": 5217,
      "original_line": 5217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331247152",
      "pull_request_review_id": 1635005891,
      "id": 1331247152,
      "node_id": "PRRC_kwDOABII585PWTgw",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));",
      "path": "src/net_processing.cpp",
      "position": 50,
      "original_position": 50,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This looks like a boolean and got me confused \"if fee filter has been received\". It is actually an integer. When dealing with atomics it is better to read once into a local variable and later refer the local variable to avoid the value changing in the meantime.\r\n\r\n```suggestion\r\n            const auto minfee = tx_relay->m_fee_filter_received.load();\r\n            if (minfee > 0) {\r\n                peer_fee_filters.push_back(std::make_pair(pnode, minfee));\r\n```\r\n\r\n",
      "created_at": "2023-09-20T08:35:26Z",
      "updated_at": "2023-09-20T08:41:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1331247152",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331247152"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 5228,
      "original_start_line": 5228,
      "start_side": "RIGHT",
      "line": 5229,
      "original_line": 5229,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331253962",
      "pull_request_review_id": 1635005891,
      "id": 1331253962,
      "node_id": "PRRC_kwDOABII585PWVLK",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));\n+            } else {\n+                ++around_our_percent_fee_filter;\n+            }\n+        }\n+    });\n+\n+    if (peer_fee_filters.size() == 0) return;\n+\n+    std::sort(peer_fee_filters.begin(), peer_fee_filters.end());",
      "path": "src/net_processing.cpp",
      "position": 59,
      "original_position": 59,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Is this sorting by the `CNode*` pointers instead of the fees? https://en.cppreference.com/w/cpp/utility/pair/operator_cmp\r\nLooks like it would only compare the fees if the pointers are equal.\r\n\r\nIf `std::map<CAmount, CNode*>` is used, then this `std::sort` can be dropped.",
      "created_at": "2023-09-20T08:40:44Z",
      "updated_at": "2023-09-20T08:41:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1331253962",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331253962"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5238,
      "original_line": 5238,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331255189",
      "pull_request_review_id": 1635005891,
      "id": 1331255189,
      "node_id": "PRRC_kwDOABII585PWVeV",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));\n+            } else {\n+                ++around_our_percent_fee_filter;\n+            }\n+        }\n+    });\n+\n+    if (peer_fee_filters.size() == 0) return;\n+\n+    std::sort(peer_fee_filters.begin(), peer_fee_filters.end());\n+\n+    for (auto [node_id, fee_filter] : peer_fee_filters) {\n+        if (fee_filter == 0) ++around_our_percent_fee_filter;",
      "path": "src/net_processing.cpp",
      "position": 62,
      "original_position": 62,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This line can be dropped, only elements with != are added to `peer_fee_filter`.",
      "created_at": "2023-09-20T08:41:37Z",
      "updated_at": "2023-09-20T08:41:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1331255189",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331255189"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5241,
      "original_line": 5241,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332698510",
      "pull_request_review_id": 1637262009,
      "id": 1332698510,
      "node_id": "PRRC_kwDOABII585Pb12O",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());",
      "path": "src/net_processing.cpp",
      "position": 38,
      "original_position": 38,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": 1331221040,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Now I realize that the assumption here is that we don't have yet a problematic low-fee local tx that we cannot broadcast. In that case, yes, I agree that the best approach is to compare the sizes of the mempools.",
      "created_at": "2023-09-21T08:41:58Z",
      "updated_at": "2023-09-21T08:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1332698510",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1332698510"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 5214,
      "original_start_line": 5214,
      "start_side": "RIGHT",
      "line": 5217,
      "original_line": 5217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344422474",
      "pull_request_review_id": 1655682641,
      "id": 1344422474,
      "node_id": "PRRC_kwDOABII585QIkJK",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;",
      "path": "src/net_processing.cpp",
      "position": 45,
      "original_position": 45,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Currently we have at max 2 block-relay-only connections (`MAX_BLOCK_RELAY_ONLY_CONNECTIONS`) and 8 full-relay connections, whatever of the eviction frequency and fee differential that can be adopted as parameters to known when to severe an outbound connection, I think it would be good to have more than 2 outbound block-relay peers strictly protected.\r\n\r\nOne protection heuristic I believe can be to pick-up randomly 2 more `IsFullOutboundConn()` on their sockets and mark them as protected from `CheckForLimitedMempoolAndEvictPeers`.",
      "created_at": "2023-10-03T16:43:11Z",
      "updated_at": "2023-10-03T17:10:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1344422474",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1344422474"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5224,
      "original_line": 5224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355503601",
      "pull_request_review_id": 1672139027,
      "id": 1355503601,
      "node_id": "PRRC_kwDOABII585Qy1fx",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;",
      "path": "src/net_processing.cpp",
      "position": 45,
      "original_position": 45,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`pnode->fDisconnect` shouldn't be needed here. `CConnman::ForEachNode` already filters based on `CConnman::NodeFullyConnected`, which checks `!pnode->fDisconnect`",
      "created_at": "2023-10-11T18:01:57Z",
      "updated_at": "2023-10-12T15:13:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355503601",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355503601"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5224,
      "original_line": 5224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355627694",
      "pull_request_review_id": 1672139027,
      "id": 1355627694,
      "node_id": "PRRC_kwDOABII585QzTyu",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));\n+            } else {\n+                ++around_our_percent_fee_filter;\n+            }\n+        }\n+    });\n+\n+    if (peer_fee_filters.size() == 0) return;\n+\n+    std::sort(peer_fee_filters.begin(), peer_fee_filters.end());",
      "path": "src/net_processing.cpp",
      "position": 59,
      "original_position": 59,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": 1331253962,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Wouldn't it make sense to sort this only if our threshold is met? It seems that the only reason why this is sorted is so we can pick the highest fee filter, but we only need this `if (around_our_percent_fee_filter < 4)`",
      "created_at": "2023-10-11T19:07:30Z",
      "updated_at": "2023-10-12T15:13:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355627694",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355627694"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5238,
      "original_line": 5238,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355653395",
      "pull_request_review_id": 1672139027,
      "id": 1355653395,
      "node_id": "PRRC_kwDOABII585QzaET",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));",
      "path": "src/net_processing.cpp",
      "position": 50,
      "original_position": 50,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Do we really need to store this in a vector and loop over it later? If the goal is to evict a single peer, can we not just perform the comparisons here? \r\n\r\nInstead of storing every `<CNode*, CAmount>` pair we just store the one with the highest filter, starting with the first we see and comparing any other that matches our criteria. That way we don't have to:\r\n\r\n- Loop twice\r\n- Store all the relevant pairs\r\n- Sort the vector to pick the highest fee filter peer ",
      "created_at": "2023-10-11T19:20:54Z",
      "updated_at": "2023-10-12T15:13:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355653395",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355653395"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5229,
      "original_line": 5229,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355656322",
      "pull_request_review_id": 1672139027,
      "id": 1355656322,
      "node_id": "PRRC_kwDOABII585QzayC",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));",
      "path": "src/net_processing.cpp",
      "position": 50,
      "original_position": 50,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": 1355653395,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Given @vasild's comment (https://github.com/bitcoin/bitcoin/pull/28488/files#r1331255189) this should just be replacing the current highest fee filter, or `if (CFeeRate{fee_filter} <= our_min_feerate) ++around_our_percent_fee_filter`",
      "created_at": "2023-10-11T19:22:45Z",
      "updated_at": "2023-10-12T15:13:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355656322",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355656322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5229,
      "original_line": 5229,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355658535",
      "pull_request_review_id": 1672139027,
      "id": 1355658535,
      "node_id": "PRRC_kwDOABII585QzbUn",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()",
      "path": "src/net_processing.cpp",
      "position": 21,
      "original_position": 21,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I wonder how would this interfere with #28538 and whether this logic should be part of `CConnman::GetExtraFullOutboundCount` instead.",
      "created_at": "2023-10-11T19:24:10Z",
      "updated_at": "2023-10-12T15:13:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355658535",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355658535"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5200,
      "original_line": 5200,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355677557",
      "pull_request_review_id": 1672139027,
      "id": 1355677557,
      "node_id": "PRRC_kwDOABII585Qzf91",
      "diff_hunk": "@@ -0,0 +1,67 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+import time\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    msg_pong,\n+    msg_tx,\n+    msg_feefilter,\n+)\n+from test_framework.p2p import (\n+    P2PDataStore,\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, check_node_connections\n+from test_framework.wallet import MiniWallet\n+\n+class P2POutEvict(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        # Start with all the same fee filters.\n+        self.extra_args = [[\"-minrelaytxfee=0.00000100\"]]\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+        node = self.nodes[0]\n+        peers = []\n+        for id in range(8):\n+            peers.append(node.add_outbound_p2p_connection(P2PDataStore(), p2p_idx=id, connection_type=\"outbound-full-relay\"))",
      "path": "test/functional/p2p_out_eviction.py",
      "position": 41,
      "original_position": 41,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: You can simply inline this:\r\n\r\n```suggestion\r\n        peers = [node.add_outbound_p2p_connection(P2PDataStore(), p2p_idx=id, connection_type=\"outbound-full-relay\") for id in range(8)]\r\n```",
      "created_at": "2023-10-11T19:36:45Z",
      "updated_at": "2023-10-12T15:13:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355677557",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355677557"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 39,
      "original_start_line": 39,
      "start_side": "RIGHT",
      "line": 41,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355689879",
      "pull_request_review_id": 1672139027,
      "id": 1355689879,
      "node_id": "PRRC_kwDOABII585Qzi-X",
      "diff_hunk": "@@ -0,0 +1,67 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+import time\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    msg_pong,\n+    msg_tx,\n+    msg_feefilter,\n+)\n+from test_framework.p2p import (\n+    P2PDataStore,\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, check_node_connections\n+from test_framework.wallet import MiniWallet",
      "path": "test/functional/p2p_out_eviction.py",
      "position": 23,
      "original_position": 23,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "A lot of these are not being used:\r\n\r\n- None from `blocktools`\r\n- `msg_pong, msg_tx` from `messages`\r\n- `P2PInterface` from `p2p`\r\n- `MiniWallet` from `wallet`",
      "created_at": "2023-10-11T19:46:49Z",
      "updated_at": "2023-10-12T15:13:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355689879",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355689879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 6,
      "original_start_line": 6,
      "start_side": "RIGHT",
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355692642",
      "pull_request_review_id": 1672139027,
      "id": 1355692642,
      "node_id": "PRRC_kwDOABII585Qzjpi",
      "diff_hunk": "",
      "path": "test/functional/p2p_out_eviction.py",
      "position": 1,
      "original_position": 1,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The code path of not reaching the limit of outbound connections but reaching the threshold of peer over the fee filter limit is not being tested (i.e. `GetExtraFullOutboundCount > 0` and `around_our_percent_fee_filter < 4`)",
      "created_at": "2023-10-11T19:49:05Z",
      "updated_at": "2023-10-12T15:13:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1355692642",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355692642"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356767956",
      "pull_request_review_id": 1674089130,
      "id": 1356767956,
      "node_id": "PRRC_kwDOABII585Q3qLU",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;\n+        auto peer = GetPeerRef(pnode->GetId());\n+\n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+            if (tx_relay->m_fee_filter_received) {\n+                peer_fee_filters.push_back(std::make_pair(pnode, tx_relay->m_fee_filter_received.load()));",
      "path": "src/net_processing.cpp",
      "position": 50,
      "original_position": 50,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Pretty sure you need to call `pnode->AddRef()` before storing it in the vector and `Release()` at the end of `CheckForLimitedMempoolAndEvictPeers` for each `CNode` you stored. This can otherwise result in use-after-free, when a `CNode` is disconnected and deleted from a different thread after the `ForEachNode` loop.\r\n\r\nI think in practice this won't happen because `cs_main` is locked but that looks accidental.",
      "created_at": "2023-10-12T12:51:23Z",
      "updated_at": "2023-10-12T14:51:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1356767956",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356767956"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5229,
      "original_line": 5229,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356781953",
      "pull_request_review_id": 1674089130,
      "id": 1356781953,
      "node_id": "PRRC_kwDOABII585Q3tmB",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);\n+    // It only makes sense once we're out of IBD, because otherwise our mempool\n+    // is not a good source for fee estimation anyway.\n+    // TODO: assumeUTXO?\n+    if (!CanDirectFetch()) return;\n+\n+    // Don't bother if we are still seeking for outbound peers: eviction\n+    // instead will reduce our chances to get blocks and transactions from\n+    // them.\n+    // TODO this could be more nuanced.\n+    if (m_connman.GetExtraFullOutboundCount() < 0) return;\n+\n+    // Ideally we want to compare mempool sizes, not fee filters.\n+    // Otherwise we easily get confused: e.g. at empty mempools this is less\n+    // critical, but that'd be impossible to account for.\n+    const auto our_min_feerate = WITH_LOCK(m_mempool.cs, return m_mempool.GetMinFee());\n+\n+    std::vector<std::pair<CNode*, CAmount>> peer_fee_filters;\n+\n+    size_t around_our_percent_fee_filter = 0;\n+\n+    m_connman.ForEachNode([&](CNode* pnode) {\n+        if (!pnode->IsFullOutboundConn() || pnode->fDisconnect) return;",
      "path": "src/net_processing.cpp",
      "position": 45,
      "original_position": 45,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Disconnection is already filtered in `ForEachNode`\r\n\r\n```suggestion\r\n        if (!pnode->IsFullOutboundConn()) return;\r\n```",
      "created_at": "2023-10-12T13:03:09Z",
      "updated_at": "2023-10-12T14:51:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1356781953",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356781953"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5224,
      "original_line": 5224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356846813",
      "pull_request_review_id": 1674089130,
      "id": 1356846813,
      "node_id": "PRRC_kwDOABII585Q39bd",
      "diff_hunk": "@@ -0,0 +1,67 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+import time\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    msg_pong,\n+    msg_tx,\n+    msg_feefilter,\n+)\n+from test_framework.p2p import (\n+    P2PDataStore,\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, check_node_connections\n+from test_framework.wallet import MiniWallet\n+\n+class P2POutEvict(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        # Start with all the same fee filters.\n+        self.extra_args = [[\"-minrelaytxfee=0.00000100\"]]\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)",
      "path": "test/functional/p2p_out_eviction.py",
      "position": 33,
      "original_position": 33,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Since #28199 we have `bumpmocktime`, so you can just call `self.node[0].bumpmocktime(delta)`.",
      "created_at": "2023-10-12T13:41:44Z",
      "updated_at": "2023-10-12T14:51:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1356846813",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356846813"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 31,
      "original_start_line": 31,
      "start_side": "RIGHT",
      "line": 33,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356862582",
      "pull_request_review_id": 1674089130,
      "id": 1356862582,
      "node_id": "PRRC_kwDOABII585Q4BR2",
      "diff_hunk": "@@ -5194,6 +5197,62 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::CheckForLimitedMempoolAndEvictPeers()\n+{\n+    LOCK(cs_main);",
      "path": "src/net_processing.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why is `cs_main` locked for all of this?",
      "created_at": "2023-10-12T13:50:49Z",
      "updated_at": "2023-10-12T14:51:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1356862582",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356862582"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5202,
      "original_line": 5202,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356868053",
      "pull_request_review_id": 1674089130,
      "id": 1356868053,
      "node_id": "PRRC_kwDOABII585Q4CnV",
      "diff_hunk": "@@ -101,6 +101,14 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n      */\n     virtual void CheckForStaleTipAndEvictPeers() = 0;\n \n+    /**\n+     * We should have outbound peers with broad-enough mempools (comparable to ours) to accept\n+     * transactions constructed according to our mempool. Otherwise, the lower-fee transactions\n+     * will never be relayed to the network.\n+     */\n+    virtual void CheckForLimitedMempoolAndEvictPeers() = 0;",
      "path": "src/net_processing.h",
      "position": 9,
      "original_position": 9,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This does not need to be part of `PeerManager`'s public interface (unless you add unit tests).",
      "created_at": "2023-10-12T13:53:47Z",
      "updated_at": "2023-10-12T14:51:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1356868053",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356868053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 109,
      "original_line": 109,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356975730",
      "pull_request_review_id": 1672139027,
      "id": 1356975730,
      "node_id": "PRRC_kwDOABII585Q4c5y",
      "diff_hunk": "@@ -0,0 +1,67 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+import time\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    msg_pong,\n+    msg_tx,\n+    msg_feefilter,\n+)\n+from test_framework.p2p import (\n+    P2PDataStore,\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, check_node_connections\n+from test_framework.wallet import MiniWallet\n+\n+class P2POutEvict(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        # Start with all the same fee filters.\n+        self.extra_args = [[\"-minrelaytxfee=0.00000100\"]]\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+        node = self.nodes[0]\n+        peers = []\n+        for id in range(8):\n+            peers.append(node.add_outbound_p2p_connection(P2PDataStore(), p2p_idx=id, connection_type=\"outbound-full-relay\"))\n+\n+        node.mockscheduler(60)\n+        check_node_connections(node=node, num_in=0, num_out=8)\n+\n+        # Set a limited number of fee filters. Nothing is evicted because\n+        # the rest of the peers are sufficient.\n+        for id in range(4):\n+            peers[id].send_and_ping(msg_feefilter(10))\n+        node.mockscheduler(60)\n+        check_node_connections(node=node, num_in=0, num_out=8)\n+\n+        # Set one more filter, but make it borderline acceptable.\n+        peers[4].send_and_ping(msg_feefilter(81))\n+        node.mockscheduler(60)\n+        check_node_connections(node=node, num_in=0, num_out=8)\n+\n+        # Now there is too few peers with a comparable min tx relay fee,\n+        # thus one of the peers must be evicted to have a room for a new peer\n+        # (hopefully with sufficient fee filter).\n+        peers[4].send_and_ping(msg_feefilter(10))\n+        node.mockscheduler(60)\n+        self.mock_forward(60)\n+        self.wait_until(lambda: len(self.nodes[0].getpeerinfo()) == 7, timeout=10)",
      "path": "test/functional/p2p_out_eviction.py",
      "position": 64,
      "original_position": 64,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "If we are going to be opinionated about what peer is being evicted (the one with the most restrictive filter) it may be worth setting up the test so we can check that is the case.",
      "created_at": "2023-10-12T15:10:25Z",
      "updated_at": "2023-10-12T15:13:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1356975730",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356975730"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 64,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357082117",
      "pull_request_review_id": 1674624293,
      "id": 1357082117,
      "node_id": "PRRC_kwDOABII585Q424F",
      "diff_hunk": "@@ -0,0 +1,67 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+import time\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    msg_pong,\n+    msg_tx,\n+    msg_feefilter,\n+)\n+from test_framework.p2p import (\n+    P2PDataStore,\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, check_node_connections\n+from test_framework.wallet import MiniWallet\n+\n+class P2POutEvict(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        # Start with all the same fee filters.\n+        self.extra_args = [[\"-minrelaytxfee=0.00000100\"]]\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+        node = self.nodes[0]\n+        peers = []\n+        for id in range(8):\n+            peers.append(node.add_outbound_p2p_connection(P2PDataStore(), p2p_idx=id, connection_type=\"outbound-full-relay\"))\n+\n+        node.mockscheduler(60)\n+        check_node_connections(node=node, num_in=0, num_out=8)\n+\n+        # Set a limited number of fee filters. Nothing is evicted because\n+        # the rest of the peers are sufficient.\n+        for id in range(4):\n+            peers[id].send_and_ping(msg_feefilter(10))\n+        node.mockscheduler(60)\n+        check_node_connections(node=node, num_in=0, num_out=8)\n+\n+        # Set one more filter, but make it borderline acceptable.\n+        peers[4].send_and_ping(msg_feefilter(81))\n+        node.mockscheduler(60)\n+        check_node_connections(node=node, num_in=0, num_out=8)",
      "path": "test/functional/p2p_out_eviction.py",
      "position": 56,
      "original_position": 56,
      "commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "original_commit_id": "6b4c4aeaf2f9625f03eb8ccc68cf6a96158ac099",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think this is wrong. Setting the filter for the fifth node is already triggering the eviction. You can check by just adding `self.wait_until(lambda: len(self.nodes[0].getpeerinfo()) == 7, timeout=10)` here. Looks like there is a race between the peer being marked for disconnection and the check being performed.\r\n\r\nThis is mainly because setting the filter to one additional peer makes the threshold to be met. Also, I don't think 81 is borderline acceptable, that is actually the highest filter you have set so far. ",
      "created_at": "2023-10-12T16:33:10Z",
      "updated_at": "2023-10-12T16:33:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28488#discussion_r1357082117",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1357082117"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28488"
        }
      },
      "start_line": 53,
      "original_start_line": 53,
      "start_side": "RIGHT",
      "line": 56,
      "original_line": 56,
      "side": "RIGHT"
    }
  ]
}