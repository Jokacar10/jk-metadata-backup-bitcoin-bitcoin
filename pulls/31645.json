{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645",
    "id": 2272673972,
    "node_id": "PR_kwDOABII586HdkC0",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31645",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31645.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31645.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/d249a353be58868d41d2a7c57357038ffd779eba",
    "number": 31645,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "optimization: increase default LevelDB write batch size to 64 MiB",
    "user": {
      "login": "l0rinc",
      "id": 1841944,
      "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/l0rinc",
      "html_url": "https://github.com/l0rinc",
      "followers_url": "https://api.github.com/users/l0rinc/followers",
      "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
      "organizations_url": "https://api.github.com/users/l0rinc/orgs",
      "repos_url": "https://api.github.com/users/l0rinc/repos",
      "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/l0rinc/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "The UTXO set has grown significantly [since 2017](https://github.com/bitcoin/bitcoin/pull/10148/files#diff-d102b6032635ce90158c1e6e614f03b50e4449aa46ce23370da5387a658342fdR26-R27), and flushing it from memory to LevelDB often takes over 20 minutes after a successful IBD with large dbcache values.\r\nThe final UTXO set is [written to disk in batches](https://github.com/bitcoin/bitcoin/blob/master/src/txdb.cpp#L130-L133), which LevelDB sorts into SST files.\r\nBy increasing the default batch size, we can reduce overhead from repeated compaction cycles, minimize constant overhead per batch, and achieve more sequential writes.\r\n\r\nExperiments with different batch sizes (loaded via assumeutxo at block 840k, then measuring final flush time) show that 64 MiB batches significantly reduce flush time without notably increasing memory usage.\r\n<details>\r\n<summary>assumeUTXO flushing measurements</summary>\r\n\r\ndbbatchsize | flush_sum (ms)\r\n-- | --\r\n8 << 20 | 236993.73\r\n8 << 20 | 239557.79\r\n8 << 20 | 244149.25\r\n8 << 20 | 246116.93\r\n8 << 20 | 243496.98\r\n*16 << 20* | 209673.01\r\n*16 << 20* | 225029.97\r\n*16 << 20* | 230826.61\r\n*16 << 20* | 230312.84\r\n*16 << 20* | 235912.83\r\n32 << 20 | 201898.77\r\n32 << 20 | 196676.18\r\n32 << 20 | 198958.81\r\n32 << 20 | 196230.08\r\n32 << 20 | 199105.84\r\n64 << 20 | 150691.51\r\n64 << 20 | 151072.18\r\n64 << 20 | 151465.16\r\n64 << 20 | 150403.59\r\n64 << 20 | 150342.34\r\n128 << 20 | 155917.81\r\n128 << 20 | 156121.83\r\n128 << 20 | 156514.6\r\n128 << 20 | 155616.36\r\n128 << 20 | 156398.24\r\n256 << 20 | 166843.39\r\n256 << 20 | 166226.37\r\n256 << 20 | 166351.75\r\n256 << 20 | 166197.15\r\n256 << 20 | 166755.22\r\n512 << 20 | 186020.24\r\n512 << 20 | 186689.18\r\n512 << 20 | 186895.21\r\n512 << 20 | 185427.1\r\n512 << 20 | 186105.48\r\n1 << 30 | 185488.98\r\n1 << 30 | 185963.51\r\n1 << 30 | 185754.25\r\n1 << 30 | 186993.17\r\n1 << 30 | 186145.73\r\n\r\n</details>\r\n\r\n\r\nChecking the impact of a `-reindex-chainstate` with `-stopatheight=878000` and `-dbcache=30000` gives:\r\n\r\n#### On SSD:\r\n> 16 << 20\r\n\r\n```\r\n2025-01-12T07:31:05Z Flushed fee estimates to fee_estimates.dat.\r\n2025-01-12T07:31:05Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\r\n2025-01-12T07:53:51Z Shutdown: done\r\n```\r\nFlush time before: **~22 minutes and 46 seconds**\r\n\r\n> 64 << 20\r\n\r\n```\r\n2025-01-12T18:30:00Z Flushed fee estimates to fee_estimates.dat.\r\n2025-01-12T18:30:00Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\r\n2025-01-12T18:44:43Z Shutdown: done\r\n```\r\nFlush time after: **~14 minutes and 43 seconds**\r\n\r\n#### On HDD:\r\n> 16 << 20\r\n\r\n```\r\n2025-01-12T04:31:40Z Flushed fee estimates to fee_estimates.dat.\r\n2025-01-12T04:31:40Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\r\n2025-01-12T05:02:39Z Shutdown: done\r\n```\r\nFlush time before: **~30 minutes and 59 seconds**\r\n\r\n> 64 << 20\r\n\r\n```\r\n2025-01-12T20:22:24Z Flushed fee estimates to fee_estimates.dat.\r\n2025-01-12T20:22:24Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\r\n2025-01-12T20:42:57Z Shutdown: done\r\n```\r\nFlush time after: **~20 minutes and 33 seconds**\r\n\r\n---\r\n\r\n#### Reproducer:\r\n\r\nYou can either do a full IBD or a reindex(-chainstate) and check the final logs flush the 840k blocks or load the UTXO set from the assumeUTXO torrent and use that to measure:\r\n```bash\r\n# Build Bitcoin Core\r\ncmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc)\r\n\r\n# Set up a clean demo environment\r\nmkdir -p demo && rm -rfd demo/chainstate demo/chainstate_snapshot demo/debug.log\r\n\r\n# Download the UTXO set until 840k\r\nSee: https://github.com/bitcoin/bitcoin/pull/28553\r\n\r\n# Start bitcoind with minimal settings without mempool and internet connection\r\nbuild/src/bitcoind -datadir=demo -daemon -blocksonly=1 -connect=0\r\n\r\n# Load the AssumeUTXO snapshot, making sure the path is correct\r\n# Expected output includes `\"coins_loaded\": 176948713`\r\nbuild/src/bitcoin-cli -datadir=demo loadtxoutset ~/utxo-840000.dat\r\n\r\n# Stop the daemon and verify snapshot flushes in the logs\r\nbuild/src/bitcoin-cli -datadir=demo stop\r\ngrep \"FlushSnapshotToDisk\" demo/debug.log\r\n```\r\n",
    "labels": [],
    "created_at": "2025-01-12T20:08:03Z",
    "updated_at": "2025-01-12T22:16:50Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "c9f34a4d8d10f91a840401ac382ad859a3b46d92",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "l0rinc:l0rinc/utxo-dump-batching",
      "ref": "l0rinc/utxo-dump-batching",
      "sha": "d249a353be58868d41d2a7c57357038ffd779eba",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 674169038,
        "node_id": "R_kgDOKC8Azg",
        "name": "bitcoin",
        "full_name": "l0rinc/bitcoin",
        "owner": {
          "login": "l0rinc",
          "id": 1841944,
          "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/l0rinc",
          "html_url": "https://github.com/l0rinc",
          "followers_url": "https://api.github.com/users/l0rinc/followers",
          "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
          "organizations_url": "https://api.github.com/users/l0rinc/orgs",
          "repos_url": "https://api.github.com/users/l0rinc/repos",
          "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/l0rinc/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/l0rinc/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/l0rinc/bitcoin",
        "archive_url": "https://api.github.com/repos/l0rinc/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/l0rinc/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/l0rinc/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/l0rinc/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/l0rinc/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/l0rinc/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/l0rinc/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/l0rinc/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/l0rinc/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/l0rinc/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/l0rinc/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/l0rinc/bitcoin/events",
        "forks_url": "https://api.github.com/repos/l0rinc/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/l0rinc/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/l0rinc/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/l0rinc/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/l0rinc/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/l0rinc/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/l0rinc/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/l0rinc/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/l0rinc/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/l0rinc/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/l0rinc/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/l0rinc/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/l0rinc/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:l0rinc/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/l0rinc/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/l0rinc/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/l0rinc/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/l0rinc/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/l0rinc/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/l0rinc/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/l0rinc/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/l0rinc/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/l0rinc/bitcoin/hooks",
        "svn_url": "https://github.com/l0rinc/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 252156,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-01-12T21:54:12Z",
        "created_at": "2023-08-03T09:49:12Z",
        "updated_at": "2024-07-18T12:40:18Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "35bf426e02210c1bbb04926f4ca2e0285fbfcd11",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36523,
        "stargazers_count": 81349,
        "watchers_count": 81349,
        "size": 274035,
        "default_branch": "master",
        "open_issues_count": 689,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-01-10T15:30:04Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-01-12T22:37:59Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 1,
    "deletions": 1,
    "changed_files": 1,
    "commits": 1,
    "review_comments": 0,
    "comments": 2
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQyNDlhMzUzYmU1ODg2OGQ0MWQyYTdjNTczNTcwMzhmZmQ3NzllYmE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d249a353be58868d41d2a7c57357038ffd779eba",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d249a353be58868d41d2a7c57357038ffd779eba",
      "tree": {
        "sha": "dbd79d3430e867487305d8e7c42a171768ecda86",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dbd79d3430e867487305d8e7c42a171768ecda86"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/35bf426e02210c1bbb04926f4ca2e0285fbfcd11",
          "sha": "35bf426e02210c1bbb04926f4ca2e0285fbfcd11",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/35bf426e02210c1bbb04926f4ca2e0285fbfcd11"
        }
      ],
      "message": "coins: bump default LevelDB write batch size to 64 MiB\n\nThe UTXO set has grown significantly, and flushing it from memory to LevelDB often takes over 20 minutes after a successful IBD with large dbcache values.\nThe final UTXO set is written to disk in batches, which LevelDB sorts into SST files.\nBy increasing the default batch size, we can reduce overhead from repeated compaction cycles, minimize constant overhead per batch, and achieve more sequential writes.\n\nExperiments with different batch sizes (loaded via assumeutxo at block 840k, then measuring final flush time) show that 64 MiB batches significantly reduce flush time without notably increasing memory usage:\n\n| dbbatchsize | flush_sum (ms) |\n|-------------|----------------|\n| 8 MiB       | ~240,000       |\n| 16 MiB      | ~220,000       |\n| 32 MiB      | ~200,000       |\n| *64 MiB*    | *~150,000*     |\n| 128 MiB     | ~156,000       |\n| 256 MiB     | ~166,000       |\n| 512 MiB     | ~186,000       |\n| 1 GiB       | ~186,000       |\n\nChecking the impact of a `-reindex-chainstate` with `-stopatheight=878000` and `-dbcache=30000` gives:\n16 << 20\n```\n2025-01-12T07:31:05Z Flushed fee estimates to fee_estimates.dat.\n2025-01-12T07:31:05Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\n2025-01-12T07:53:51Z Shutdown: done\n```\nFlush time: 22 minutes and 46 seconds\n\n64 >> 20\n```\n2025-01-12T18:30:00Z Flushed fee estimates to fee_estimates.dat.\n2025-01-12T18:30:00Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\n2025-01-12T18:44:43Z Shutdown: done\n```\nFlush time: ~14 minutes 43 seconds.",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-01-12T20:04:06Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-01-05T20:44:27Z"
      },
      "sha": "d249a353be58868d41d2a7c57357038ffd779eba"
    },
    {
      "event": "commented",
      "id": 2585900399,
      "node_id": "IC_kwDOABII586aIbVv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2585900399",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-12T20:11:26Z",
      "updated_at": "2025-01-12T22:15:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "Visual representation of the assumeUTXO measurements (16MiB was the previous default, 64MiB is the proposed one):\r\n\r\n<img width=\"780\" alt=\"image\" src=\"https://github.com/user-attachments/assets/93ab3fff-385b-4093-8016-ab2a251cf92a\" />\r\n\r\n<details>\r\n<summary>Python file to sum the flush times</summary>\r\n\r\n```py\r\nimport re\r\nimport sys\r\n\r\n\r\ndef parse_bitcoin_debug_log(file_path):\r\n    results = []\r\n\r\n    flush_sum = 0.0\r\n    flush_count = 0\r\n\r\n    version_pattern = re.compile(r\"Bitcoin Core version\")\r\n    flush_pattern = re.compile(r'FlushSnapshotToDisk: completed \\(([\\d.]+)ms\\)')\r\n\r\n    def finalize_current_block():\r\n        nonlocal flush_sum, flush_count\r\n        if flush_count > 0:\r\n            results.append((flush_sum, flush_count))\r\n        flush_sum = 0.0\r\n        flush_count = 0\r\n\r\n    try:\r\n        with open(file_path, 'r') as file:\r\n            for line in file:\r\n                if version_pattern.search(line):\r\n                    finalize_current_block()\r\n                    continue\r\n\r\n                match_flush = flush_pattern.search(line)\r\n                if match_flush:\r\n                    flush_ms = float(match_flush.group(1))\r\n                    flush_sum += flush_ms\r\n                    flush_count += 1\r\n    except Exception as e:\r\n        print(f\"Error reading file: {e}\")\r\n        sys.exit(1)\r\n\r\n    finalize_current_block()\r\n\r\n    return results\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    if len(sys.argv) < 2:\r\n        print(\"Usage: python3 script.py <path_to_debug_log>\")\r\n        sys.exit(1)\r\n\r\n    file_path = sys.argv[1]\r\n    parsed_results = parse_bitcoin_debug_log(file_path)\r\n\r\n    for total_flush_time, total_flush_calls in parsed_results:\r\n        print(f\"{total_flush_time:.2f},{total_flush_calls}\")\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2585900399",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2585900409,
      "node_id": "IC_kwDOABII586aIbV5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2585900409",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-12T20:11:29Z",
      "updated_at": "2025-01-12T20:11:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31645.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2585900409",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    }
  ],
  "comments": []
}