{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645",
    "id": 2272673972,
    "node_id": "PR_kwDOABII586HdkC0",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31645",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31645.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31645.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/868413340f8d6058d74186b65ac3498d6b7f254a",
    "number": 31645,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "[IBD] flush UTXOs in bigger batches",
    "user": {
      "login": "l0rinc",
      "id": 1841944,
      "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/l0rinc",
      "html_url": "https://github.com/l0rinc",
      "followers_url": "https://api.github.com/users/l0rinc/followers",
      "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
      "organizations_url": "https://api.github.com/users/l0rinc/orgs",
      "repos_url": "https://api.github.com/users/l0rinc/repos",
      "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/l0rinc/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "This change is part of [[IBD] - Tracking PR for speeding up Initial Block Download](https://github.com/bitcoin/bitcoin/pull/32043)\r\n\r\n### Summary\r\n\r\nWhen the UTXO set  is [dumped to LevelDB](https://github.com/bitcoin/bitcoin/blob/master/src/txdb.cpp#L130-L133) (after IBD or AssumeUTXO load), it does so in smaller batches to avoid a gigantic spike at flush time.\r\nThe UTXO set has grown significantly [since 2017](https://github.com/bitcoin/bitcoin/pull/10148/files#diff-d102b6032635ce90158c1e6e614f03b50e4449aa46ce23370da5387a658342fdR26-R27), when the original 16MiB batch size was chosen.\r\nThere is already a [-dbbatchsize](https://github.com/bitcoin/bitcoin/blob/master/src/init.cpp#L490) config option to change this value, this PR adjusts the default only.\r\nBy increasing the default batch size, we can reduce overhead from repeated compaction cycles, minimize constant overhead per batch, and achieve more sequential writes.\r\n\r\n\r\n### Context\r\n\r\nWith the significant growth of the UTXO set and common usage of larger `-dbcache` settings, this fixed `16MiB` batch size can lead to inefficiencies:\r\n* Excessive Write Operations: Flushing multi-gigabyte UTXO sets requires hundreds or thousands of separate 16 MiB write batches.\r\n* I/O Inefficiency: Especially on Hard Disk Drives (HDDs), the overhead of initiating many small writes (including disk seek times) can significantly slow down the flushing process.\r\n* LevelDB Overhead: Each WriteBatch call incurs internal LevelDB overhead (MemTable handling, logging, potential compaction triggering). Frequent, small batches increase this cumulative overhead.\r\n* Suboptimal Resource Use: Systems with large -dbcache values have ample memory that could be leveraged for larger, more efficient batches, but the fixed size prevents this.\r\n\r\n### Considerations\r\n\r\nFlushing it from memory to LevelDB often takes 20-30 minutes on commodity hardware after a successful IBD with large dbcache values. Bigger batch allows more LevelDB optimizations before flushing (e.g. sorting the random keys resulting in more sequential writes), while minimally increasing memory footprint (the UTXO set is >1000x times bigger than the batch size). This is especially true now that we've [bumped the LevelDB max file size](https://github.com/bitcoin/bitcoin/pull/30039).\r\n\r\nAs [noted](https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2587500105) by @sipa, this will temporarily increase the required memory exactly when our memory needs are the greatest. This will be less problematic after [validation: write chainstate to disk every hour](https://github.com/bitcoin/bitcoin/pull/30611), where we can lose at most the last hour of work.\r\nWhile originally this PR increased the batch size to another constant (which would always increase peak memory), the latest version does it in steps, making sure there is no memory (or speed) change by default.\r\n\r\nThis change does result in extra memory usage at the peak and is primarily attributed to LevelDB's internal memory management (leveldb::Arena) and batch string allocations used in the batch itself.\r\nAlso note that this change is most significant with HDDs, the difference with high-end SSDs isn't always measurable.\r\n\r\n### Solution\r\n\r\nThis change introduces dynamic sizing for the LevelDB write batch used in `FlushSnapshotToDisk`, based on the configured `-dbcache` size (chosen to keep the current 16MiB for the default 450MiB dbcache size, scaling linearly otherwise):\r\n\r\n$$\r\n\\text{GetDbBatchSize}(x)\r\n= \\max\\Bigl(16\\mathrm{MiB},\\ \r\n   \\min\\bigl(256\\mathrm{MiB},\\ \r\n     \\frac{x}{450\\mathrm{MiB}} \\times 16\\mathrm{MiB}\r\n   \\bigr)\r\n\\Bigr).\r\n$$\r\n\r\n| dbcache (MiB) | Batch Size (MiB) | Batches |\r\n|---------------|------------------|---------|\r\n| 4             | 16.0             | 832     |\r\n| 10            | 16.0             | 832     |\r\n| 45            | 16.0             | 832     |\r\n| 100           | 16.0             | 832     |\r\n| 450           | 16.0             | 832     |\r\n| 1000          | 35.6             | 375     |\r\n| 2000          | 71.1             | 188     |\r\n| 4500          | 160.0            | 84      |\r\n| 10000         | 256.0            | 52      |\r\n| 45000         | 256.0            | 52      |\r\n\r\nThe goal is to use larger batches when sufficient memory is available, reducing the number of write operations and improving I/O efficiency.\r\n\r\n### Measurements\r\n\r\nExperiments with different batch sizes (loaded via AssumeUTXO 840k and the new 880k, then measuring final flush time) on different operating system show that 64 MiB batches significantly reduce flush time without notably increasing memory usage (both smaller and bigger ones are usually slower).\r\n\r\nChecking the impact of a `-reindex-chainstate` with `-stopatheight=878000` and `-dbcache=30000` on an HDD gives:\r\n\r\n<details>\r\n<summary>16 MiB batches</summary>\r\n\r\n```bash\r\n2025-01-12T04:31:40Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\r\n2025-01-12T05:02:39Z Shutdown: done\r\n```\r\n\r\n</details>\r\n\r\nFlush time before: **30 minutes and 59 seconds**\r\n\r\n<details>\r\n<summary>64 MiB batches</summary>\r\n\r\n```bash\r\n2025-01-12T20:22:24Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\r\n2025-01-12T20:42:57Z Shutdown: done\r\n```\r\n\r\n</details>\r\n\r\nFlush time after:  **20 minutes and 33 seconds**\r\n\r\n\r\n### Reproducer:\r\n\r\nYou can either do a full IBD or a reindex(-chainstate) and check the final logs flush the blocks or load the UTXO set from the AssumeUTXO until [840k](https://github.com/bitcoin/bitcoin/pull/28553) or [880k](https://github.com/bitcoin/bitcoin/pull/31969) and use them for the measurements.\r\n\r\n```bash\r\n# Set up a clean demo environment\r\nmkdir -p demo && rm -rfd demo/chainstate demo/chainstate_snapshot demo/debug.log\r\n\r\n# Build Bitcoin Core\r\ncmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc)\r\n\r\n# Start bitcoind with minimal settings without mempool and internet connection\r\nbuild/bin/bitcoind -datadir=demo -stopatheight=1\r\nbuild/bin/bitcoind -datadir=demo -blocksonly=1 -connect=0 -dbcache=30000 -daemon\r\n\r\n# Load the AssumeUTXO snapshot, making sure the path is correct\r\n# Expected output includes `\"coins_loaded\": 184821030`\r\nbuild/bin/bitcoin-cli -datadir=demo -rpcclienttimeout=0 loadtxoutset ~/utxo-880000.dat\r\n\r\n# Stop the daemon and verify snapshot flushes in the logs\r\nbuild/bin/bitcoin-cli -datadir=demo stop\r\ngrep \"FlushSnapshotToDisk: completed\" demo/debug.log\r\n```",
    "labels": [
      {
        "id": 97470796,
        "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
        "name": "UTXO Db and Indexes",
        "color": "fbca04",
        "default": false
      }
    ],
    "created_at": "2025-01-12T20:08:03Z",
    "updated_at": "2025-04-08T16:57:43Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "622ed1b2ce572314b540f19c20665f0dc8e0584f",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "l0rinc:l0rinc/utxo-dump-batching",
      "ref": "l0rinc/utxo-dump-batching",
      "sha": "868413340f8d6058d74186b65ac3498d6b7f254a",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 674169038,
        "node_id": "R_kgDOKC8Azg",
        "name": "bitcoin",
        "full_name": "l0rinc/bitcoin",
        "owner": {
          "login": "l0rinc",
          "id": 1841944,
          "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/l0rinc",
          "html_url": "https://github.com/l0rinc",
          "followers_url": "https://api.github.com/users/l0rinc/followers",
          "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
          "organizations_url": "https://api.github.com/users/l0rinc/orgs",
          "repos_url": "https://api.github.com/users/l0rinc/repos",
          "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/l0rinc/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/l0rinc/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/l0rinc/bitcoin",
        "archive_url": "https://api.github.com/repos/l0rinc/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/l0rinc/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/l0rinc/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/l0rinc/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/l0rinc/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/l0rinc/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/l0rinc/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/l0rinc/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/l0rinc/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/l0rinc/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/l0rinc/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/l0rinc/bitcoin/events",
        "forks_url": "https://api.github.com/repos/l0rinc/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/l0rinc/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/l0rinc/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/l0rinc/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/l0rinc/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/l0rinc/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/l0rinc/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/l0rinc/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/l0rinc/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/l0rinc/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/l0rinc/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/l0rinc/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/l0rinc/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:l0rinc/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/l0rinc/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/l0rinc/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/l0rinc/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/l0rinc/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/l0rinc/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/l0rinc/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/l0rinc/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/l0rinc/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/l0rinc/bitcoin/hooks",
        "svn_url": "https://github.com/l0rinc/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 257873,
        "default_branch": "master",
        "open_issues_count": 2,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-04-08T16:49:58Z",
        "created_at": "2023-08-03T09:49:12Z",
        "updated_at": "2025-04-04T07:50:27Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "df8bf657450d5383870d40790ea9f4fdb03c360d",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 37016,
        "stargazers_count": 82817,
        "watchers_count": 82817,
        "size": 279383,
        "default_branch": "master",
        "open_issues_count": 701,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-04-07T22:00:04Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-04-08T16:07:41Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": true,
    "additions": 1,
    "deletions": 1,
    "changed_files": 1,
    "commits": 1,
    "review_comments": 0,
    "comments": 18
  },
  "events": [
    {
      "event": "commented",
      "id": 2585900399,
      "node_id": "IC_kwDOABII586aIbVv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2585900399",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-12T20:11:26Z",
      "updated_at": "2025-03-15T12:03:44Z",
      "author_association": "CONTRIBUTOR",
      "body": "Visual representation of the AssumeUTXO 840k measurements (16MiB was the previous default, 64MiB is the proposed one):\r\n\r\n<img width=\"780\" alt=\"image\" src=\"https://github.com/user-attachments/assets/93ab3fff-385b-4093-8016-ab2a251cf92a\" />\r\n\r\n<details>\r\n<summary>Bash script to run assumeUTXO with differenty values</summary>\r\n\r\n```bash\r\nset -e\r\n\r\nkillall bitcoind 2>/dev/null || true\r\ncd /mnt/my_storage/bitcoin\r\nmkdir -p demo\r\n\r\nfor i in 1 2; do\r\n  for dbcache in 440 5000 30000; do\r\n    for dbbatchsize in 4194304 8388608 16777216 33554432 67108864 134217728 268435456; do\r\n      cmake -B build -DCMAKE_BUILD_TYPE=Release > /dev/null 2>&1\r\n      cmake --build build -j\"$(nproc)\" > /dev/null 2>&1\r\n\r\n      build/bin/bitcoin-cli -datadir=demo stop 2>/dev/null || true\r\n      killall bitcoind 2>/dev/null || true\r\n      sleep 10\r\n\r\n      rm -rfd demo/chainstate demo/chainstate_snapshot\r\n      build/bin/bitcoind -datadir=demo -stopatheight=1 -printtoconsole=0 && rm -f demo/debug.log\r\n\r\n      echo \"Starting bitcoind with dbcache=$dbcache\"\r\n      build/bin/bitcoind -datadir=demo -blocksonly=1 -connect=0 -dbcache=\"$dbcache\" -dbbatchsize=\"$dbbatchsize\" -daemon -printtoconsole=0\r\n      sleep 10\r\n\r\n      echo \"Loading UTXO snapshot...\"\r\n      build/bin/bitcoin-cli -datadir=demo -rpcclienttimeout=0 loadtxoutset /mnt/my_storage/utxo-880000.dat | grep -q '\"coins_loaded\": 184821030' || { echo \"ERROR: Wrong number of coins loaded\"; exit 1; }\r\n      build/bin/bitcoin-cli -datadir=demo stop\r\n      killall bitcoind 2>/dev/null || true\r\n      sleep 10\r\n\r\n      out_file=\"results_i_${i}_dbcache_${dbcache}_dbbatchsize_${dbbatchsize}.log\"\r\n      echo \"Collecting logs in ${out_file}\"\r\n      grep \"FlushSnapshotToDisk: completed\" demo/debug.log | tee -a \"${out_file}\"\r\n      echo \"---\" >> \"${out_file}\"\r\n\r\n      echo \"Done with i=${i}, dbcache=${dbcache}, dbbatchsize=${dbbatchsize}\"\r\n      echo\r\n    done\r\n  done\r\ndone\r\n\r\necho \"All runs complete. Logs are saved in results_dbcache*.log files.\"\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Python file to sum the flush times</summary>\r\n\r\n```py\r\nimport re\r\nimport sys\r\n\r\n\r\ndef parse_bitcoin_debug_log(file_path):\r\n    results = []\r\n\r\n    flush_sum = 0.0\r\n    flush_count = 0\r\n\r\n    version_pattern = re.compile(r\"Bitcoin Core version\")\r\n    flush_pattern = re.compile(r'FlushSnapshotToDisk: completed \\(([\\d.]+)ms\\)')\r\n\r\n    def finalize_current_block():\r\n        nonlocal flush_sum, flush_count\r\n        if flush_count > 0:\r\n            results.append((flush_sum, flush_count))\r\n        flush_sum = 0.0\r\n        flush_count = 0\r\n\r\n    try:\r\n        with open(file_path, 'r') as file:\r\n            for line in file:\r\n                if version_pattern.search(line):\r\n                    finalize_current_block()\r\n                    continue\r\n\r\n                match_flush = flush_pattern.search(line)\r\n                if match_flush:\r\n                    flush_ms = float(match_flush.group(1))\r\n                    flush_sum += flush_ms\r\n                    flush_count += 1\r\n    except Exception as e:\r\n        print(f\"Error reading file: {e}\")\r\n        sys.exit(1)\r\n\r\n    finalize_current_block()\r\n\r\n    return results\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    if len(sys.argv) < 2:\r\n        print(\"Usage: python3 script.py <path_to_debug_log>\")\r\n        sys.exit(1)\r\n\r\n    file_path = sys.argv[1]\r\n    parsed_results = parse_bitcoin_debug_log(file_path)\r\n\r\n    for total_flush_time, total_flush_calls in parsed_results:\r\n        print(f\"{total_flush_time:.2f},{total_flush_calls}\")\r\n```\r\n\r\n</details>\r\n\r\n\r\n---\r\n\r\nEdit: \r\nReran the benchmarks on a Hetzner Linux machine with the new AssumeUTXO 880k set, parsing the logged flush times and plotting the results.\r\nFor different `dbcache` (440, 5000, 30000) and `dbbatchsize` (4-256MiB range, 16MiB (current) and 64MiB (proposed) are highlighted and trendline is added for clarity), each one twice for stability:\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/bb1a51f0-1c2f-441a-8ed0-3c3eadc45a6f\" />\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/61bcf0f4-0723-4406-8a68-2d7d53e04902\" />\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/aaeb5311-c34e-4b3b-aba1-c30f5a967de5\" />\r\n\r\n---\r\n\r\n\r\nSorting the same measurements (and calculating the sums) might give us a better understanding of the trends:\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/ce56cfba-a59f-4360-a6d7-2cc3e74959a3\" />\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/6e612bb6-b3b0-43b7-a542-0f4ec42eefa8\" />\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/b151cabd-f7b0-401b-8623-9f29bc3a5a46\" />\r\n\r\n\r\n\r\n\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2585900399",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2585900409,
      "node_id": "IC_kwDOABII586aIbV5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2585900409",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-12T20:11:29Z",
      "updated_at": "2025-03-13T20:22:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31645.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/31645#pullrequestreview-2679668648), [jonatack](https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2722607551) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2585900409",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "labeled",
      "id": 15904783083,
      "node_id": "LE_lADOABII586l3CxmzwAAAAOz_7rr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15904783083",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T13:15:15Z",
      "label": {
        "name": "UTXO Db and Indexes",
        "color": "fbca04"
      }
    },
    {
      "event": "commented",
      "id": 2587500105,
      "node_id": "IC_kwDOABII586aOh5J",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2587500105",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T15:52:27Z",
      "updated_at": "2025-01-13T15:52:27Z",
      "author_association": "MEMBER",
      "body": "FWIW, the reason for the existence of the batch size behavior (as opposed to just writing everything at once) is that it causes a memory usage spike at flush time. If that spike exceeds the memory the process can allocate it causes a crash, at a particularly bad time (may require a replay to fix, which may be slower than just reprocessing the blocks).\r\n\r\nGiven that changing this appears to improve performance it's worth considering of course, but it is essentially a trade-off between speed and memory usage spiking.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2587500105",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2587807448,
      "node_id": "IC_kwDOABII586aPs7Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2587807448",
      "actor": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T18:00:34Z",
      "updated_at": "2025-01-13T18:00:34Z",
      "author_association": "NONE",
      "body": "If there are tradeoffs (speed, memory usage etc.) involved in changing default batch size, then it could remain the same.\r\n\r\nMaybe a config option can be provided to change it.",
      "user": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2587807448",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2587815370,
      "node_id": "IC_kwDOABII586aPu3K",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2587815370",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T18:02:58Z",
      "updated_at": "2025-01-13T18:02:58Z",
      "author_association": "MEMBER",
      "body": "There is a config option. This is about changing the dedault.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2587815370",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2587860455,
      "node_id": "IC_kwDOABII586aP53n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2587860455",
      "actor": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T18:12:29Z",
      "updated_at": "2025-01-13T18:12:29Z",
      "author_association": "NONE",
      "body": "> There is a config option. This is about changing the dedault.\r\n\r\nJust realized [`dbbatchsize`](https://github.com/bitcoin/bitcoin/blob/35bf426e02210c1bbb04926f4ca2e0285fbfcd11/src/init.cpp#L489) already exists. ",
      "user": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2587860455",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2587954338,
      "node_id": "IC_kwDOABII586aQQyi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2587954338",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T18:58:27Z",
      "updated_at": "2025-01-13T18:58:27Z",
      "author_association": "CONTRIBUTOR",
      "body": "> If that spike exceeds the memory the process can allocate it causes a crash\r\n\r\nThanks for the context, @sipa.\r\nOn the positive side, the extra allocation is constant (or at least non-proportional with the usage) and it's narrowing the window for other crashes during flushing (https://github.com/bitcoin/bitcoin/pull/30611 will also likely help here).\r\nThis change may also enable another one (that I'm currently re-measuring to be sure), which seems to halve the remaining flush time again (by sorting the values in descending order before adding them to the batch), e.g. from 30 minutes (on master) to 10 (with this change included).",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2587954338",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "mentioned",
      "id": 15910921721,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAO0XWX5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15910921721",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T18:58:29Z"
    },
    {
      "event": "subscribed",
      "id": 15910921729,
      "node_id": "SE_lADOABII586l3CxmzwAAAAO0XWYB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15910921729",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-13T18:58:29Z"
    },
    {
      "event": "commented",
      "id": 2591184498,
      "node_id": "IC_kwDOABII586aclZy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2591184498",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-14T21:55:38Z",
      "updated_at": "2025-01-14T21:55:38Z",
      "author_association": "MEMBER",
      "body": "Can we predict the memory usage spike size? Presumably as we flush, that releases memory, which allows for a larger and larger batch size?",
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2591184498",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2595151977,
      "node_id": "IC_kwDOABII586aruBp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2595151977",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:15Z",
      "updated_at": "2025-01-16T10:32:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "Since profilers may not catch these short-lived spikes, I've instrumented the code, loaded the UTXO set (as described the in the PR), parsed the logged flushing times and memory usages and plotted them against each other to see the effect of the batch size increase.\r\n\r\n<details>\r\n<summary>txdb.cpp flush time and memory instrumentation:</summary>\r\n\r\n```patch\r\ndiff --git a/src/txdb.cpp b/src/txdb.cpp\r\n--- a/src/txdb.cpp\t(revision d249a353be58868d41d2a7c57357038ffd779eba)\r\n+++ b/src/txdb.cpp\t(revision bae884969d35469320ed9967736eb15b5d87edff)\r\n@@ -90,7 +90,81 @@\r\n     return vhashHeadBlocks;\r\n }\r\n\r\n+/*\r\n+ * Author:  David Robert Nadeau\r\n+ * Site:    http://NadeauSoftware.com/\r\n+ * License: Creative Commons Attribution 3.0 Unported License\r\n+ *          http://creativecommons.org/licenses/by/3.0/deed.en_US\r\n+ */\r\n+#if defined(_WIN32)\r\n+#include <windows.h>\r\n+#include <psapi.h>\r\n+\r\n+#elif defined(__unix__) || defined(__unix) || defined(unix) || (defined(__APPLE__) && defined(__MACH__))\r\n+#include <unistd.h>\r\n+#include <sys/resource.h>\r\n+\r\n+#if defined(__APPLE__) && defined(__MACH__)\r\n+#include <mach/mach.h>\r\n+\r\n+#elif (defined(_AIX) || defined(__TOS__AIX__)) || (defined(__sun__) || defined(__sun) || defined(sun) && (defined(__SVR4) || defined(__svr4__)))\r\n+#include <fcntl.h>\r\n+#include <procfs.h>\r\n+\r\n+#elif defined(__linux__) || defined(__linux) || defined(linux) || defined(__gnu_linux__)\r\n+#include <stdio.h>\r\n+\r\n+#endif\r\n+\r\n+#else\r\n+#error \"Cannot define  getCurrentRSS( ) for an unknown OS.\"\r\n+#endif\r\n+\r\n+/**\r\n+ * Returns the current resident set size (physical memory use) measured\r\n+ * in bytes, or zero if the value cannot be determined on this OS.\r\n+ */\r\n+size_t getCurrentRSS( )\r\n+{\r\n+#if defined(_WIN32)\r\n+    /* Windows -------------------------------------------------- */\r\n+    PROCESS_MEMORY_COUNTERS info;\r\n+    GetProcessMemoryInfo( GetCurrentProcess( ), &info, sizeof(info) );\r\n+    return (size_t)info.WorkingSetSize;\r\n+\r\n+#elif defined(__APPLE__) && defined(__MACH__)\r\n+    /* OSX ------------------------------------------------------ */\r\n+    struct mach_task_basic_info info;\r\n+    mach_msg_type_number_t infoCount = MACH_TASK_BASIC_INFO_COUNT;\r\n+    if ( task_info( mach_task_self( ), MACH_TASK_BASIC_INFO,\r\n+        (task_info_t)&info, &infoCount ) != KERN_SUCCESS )\r\n+        return (size_t)0L;      /* Can't access? */\r\n+    return (size_t)info.resident_size;\r\n+\r\n+#elif defined(__linux__) || defined(__linux) || defined(linux) || defined(__gnu_linux__)\r\n+    /* Linux ---------------------------------------------------- */\r\n+    long rss = 0L;\r\n+    FILE* fp = NULL;\r\n+    if ( (fp = fopen( \"/proc/self/statm\", \"r\" )) == NULL )\r\n+        return (size_t)0L;      /* Can't open? */\r\n+    if ( fscanf( fp, \"%*s%ld\", &rss ) != 1 )\r\n+    {\r\n+        fclose( fp );\r\n+        return (size_t)0L;      /* Can't read? */\r\n+    }\r\n+    fclose( fp );\r\n+    return (size_t)rss * (size_t)sysconf( _SC_PAGESIZE);\r\n+\r\n+#else\r\n+    /* AIX, BSD, Solaris, and Unknown OS ------------------------ */\r\n+    return (size_t)0L;          /* Unsupported. */\r\n+#endif\r\n+}\r\n+\r\n bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashBlock) {\r\n+    const auto start = std::chrono::steady_clock::now();\r\n+    size_t max_mem{getCurrentRSS()};\r\n+\r\n     CDBBatch batch(*m_db);\r\n     size_t count = 0;\r\n     size_t changed = 0;\r\n@@ -129,7 +203,11 @@\r\n         it = cursor.NextAndMaybeErase(*it);\r\n         if (batch.SizeEstimate() > m_options.batch_write_bytes) {\r\n             LogDebug(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n+\r\n+            max_mem = std::max(max_mem, getCurrentRSS());\r\n             m_db->WriteBatch(batch);\r\n+            max_mem = std::max(max_mem, getCurrentRSS());\r\n+\r\n             batch.Clear();\r\n             if (m_options.simulate_crash_ratio) {\r\n                 static FastRandomContext rng;\r\n@@ -146,8 +224,16 @@\r\n     batch.Write(DB_BEST_BLOCK, hashBlock);\r\n\r\n     LogDebug(BCLog::COINDB, \"Writing final batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n+\r\n+    max_mem = std::max(max_mem, getCurrentRSS());\r\n     bool ret = m_db->WriteBatch(batch);\r\n+    max_mem = std::max(max_mem, getCurrentRSS());\r\n+\r\n     LogDebug(BCLog::COINDB, \"Committed %u changed transaction outputs (out of %u) to coin database...\\n\", (unsigned int)changed, (unsigned int)count);\r\n+    if (changed > 0) {\r\n+        const auto end{std::chrono::steady_clock::now()};\r\n+        LogInfo(\"BatchWrite took=%dms, maxMem=%dMiB\", duration_cast<std::chrono::milliseconds>(end - start).count(), max_mem >> 20);\r\n+    }\r\n     return ret;\r\n }\r\n ```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Python script to load the utxo set, parse the logs and create the flush and memory plots</summary>\r\n\r\n```python\r\nimport os\r\nimport re\r\nimport shutil\r\nimport statistics\r\nimport subprocess\r\nimport time\r\nimport datetime\r\nimport argparse\r\nimport matplotlib.pyplot as plt  # python3.12 -m pip install matplotlib --break-system-packages\r\n\r\n# Regex to parse logs\r\nBATCHWRITE_REGEX = re.compile(r\"^(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z) BatchWrite took=(\\d+)ms, maxMem=(\\d+)MiB\")\r\n\r\n\r\ndef parse_log(archive):\r\n    \"\"\"Parse the log file to extract elapsed times, flush times, and memory usage.\"\"\"\r\n    start_time = None\r\n    elapsed, batchwrite_times, usage_snapshots = [], [], []\r\n    with open(archive, \"r\") as f:\r\n        for line in f:\r\n            if m := BATCHWRITE_REGEX.search(line):\r\n                dt = datetime.datetime.strptime(m.group(1), \"%Y-%m-%dT%H:%M:%SZ\")\r\n                if start_time is None:\r\n                    start_time = dt\r\n                elapsed.append((dt - start_time).total_seconds())\r\n                batchwrite_times.append(int(m.group(2)))\r\n                usage_snapshots.append(int(m.group(3)))\r\n    return elapsed, batchwrite_times, usage_snapshots\r\n\r\n\r\ndef plot_results(results, output_dir):\r\n    \"\"\"Create separate plots for flush times and memory usage.\"\"\"\r\n    if len(results) != 2:\r\n        print(\"plot_results() requires exactly 2 runs for comparison.\")\r\n        return\r\n\r\n    (dbbatch0, elapsed0, flush0, mem0) = results[0]\r\n    (dbbatch1, elapsed1, flush1, mem1) = results[1]\r\n\r\n    # Compute percentage differences\r\n    avg_flush0, avg_flush1 = statistics.mean(flush0), statistics.mean(flush1)\r\n    max_mem0, max_mem1 = max(mem0), max(mem1)\r\n    flush_improvement = round(((avg_flush0 - avg_flush1) / avg_flush0) * 100, 1)\r\n    mem_increase = round(((max_mem1 - max_mem0) / max_mem0) * 100, 1)\r\n\r\n    # Plot flush times\r\n    plt.figure(figsize=(16, 8))\r\n    plt.plot(elapsed0, flush0, color=\"red\", linestyle=\"-\", label=f\"Flush Times (dbbatch={dbbatch0})\")\r\n    plt.axhline(y=avg_flush0, color=\"red\", linestyle=\"--\", alpha=0.5, label=f\"Mean ({dbbatch0})={avg_flush0:.1f}ms\")\r\n    plt.plot(elapsed1, flush1, color=\"orange\", linestyle=\"-\", label=f\"Flush Times (dbbatch={dbbatch1})\")\r\n    plt.axhline(y=avg_flush1, color=\"orange\", linestyle=\"--\", alpha=0.5, label=f\"Mean ({dbbatch1})={avg_flush1:.1f}ms\")\r\n    plt.title(f\"Flush Times (dbbatch {dbbatch0} vs {dbbatch1}) — {abs(flush_improvement)}% {'faster' if flush_improvement > 0 else 'slower'}\")\r\n    plt.xlabel(\"Elapsed Time (seconds)\")\r\n    plt.ylabel(\"Flush Times (ms)\")\r\n    plt.legend()\r\n    plt.grid(True)\r\n    plt.tight_layout()\r\n    flush_out_file = os.path.join(output_dir, \"plot_flush_times.png\")\r\n    plt.savefig(flush_out_file)\r\n    print(f\"Flush Times plot saved as {flush_out_file}\")\r\n    plt.close()\r\n\r\n    # Plot memory usage\r\n    plt.figure(figsize=(16, 8))\r\n    plt.plot(elapsed0, mem0, color=\"blue\", linestyle=\"-\", label=f\"Memory (dbbatch={dbbatch0})\")\r\n    plt.axhline(y=max_mem0, color=\"blue\", linestyle=\"--\", alpha=0.5, label=f\"Max Mem ({dbbatch0})={max_mem0}MiB\")\r\n    plt.plot(elapsed1, mem1, color=\"green\", linestyle=\"-\", label=f\"Memory (dbbatch={dbbatch1})\")\r\n    plt.axhline(y=max_mem1, color=\"green\", linestyle=\"--\", alpha=0.5, label=f\"Max Mem ({dbbatch1})={max_mem1}MiB\")\r\n    plt.title(f\"Memory Usage (dbbatch {dbbatch0} vs {dbbatch1}) — {abs(mem_increase)}% {'higher' if mem_increase > 0 else 'lower'}\")\r\n    plt.xlabel(\"Elapsed Time (seconds)\")\r\n    plt.ylabel(\"Memory Usage (MiB)\")\r\n    plt.legend()\r\n    plt.grid(True)\r\n    plt.tight_layout()\r\n    mem_out_file = os.path.join(output_dir, \"plot_memory_usage.png\")\r\n    plt.savefig(mem_out_file)\r\n    print(f\"Memory Usage plot saved as {mem_out_file}\")\r\n    plt.close()\r\n\r\n\r\ndef loadtxoutset(dbbatchsize, datadir, bitcoin_cli, bitcoind, utxo_file):\r\n    \"\"\"Load the UTXO set and run the Bitcoin node.\"\"\"\r\n    archive = os.path.join(datadir, f\"results_dbbatch-{dbbatchsize}.log\")\r\n\r\n    # Skip if logs already exist\r\n    if os.path.exists(archive):\r\n        print(f\"Log file {archive} already exists. Skipping loadtxoutset for dbbatchsize={dbbatchsize}.\")\r\n        return\r\n\r\n    os.makedirs(datadir, exist_ok=True)\r\n    debug_log = os.path.join(datadir, \"debug.log\")\r\n\r\n    try:\r\n        print(\"Cleaning up previous run\")\r\n        for subdir in [\"chainstate\", \"chainstate_snapshot\"]:\r\n            shutil.rmtree(os.path.join(datadir, subdir), ignore_errors=True)\r\n\r\n        print(\"Preparing UTXO load\")\r\n        subprocess.run([bitcoind, f\"-datadir={datadir}\", \"-stopatheight=1\"], cwd=bitcoin_core_path)\r\n        os.remove(debug_log)\r\n\r\n        print(f\"Starting bitcoind with dbbatchsize={dbbatchsize}\")\r\n        subprocess.run([bitcoind, f\"-datadir={datadir}\", \"-daemon\", \"-blocksonly=1\", \"-connect=0\", f\"-dbbatchsize={dbbatchsize}\", f\"-dbcache={440}\"], cwd=bitcoin_core_path)\r\n        time.sleep(5)\r\n\r\n        print(\"Loading UTXO set\")\r\n        subprocess.run([bitcoin_cli, f\"-datadir={datadir}\", \"loadtxoutset\", utxo_file], cwd=bitcoin_core_path)\r\n    except Exception as e:\r\n        print(f\"Error during loadtxoutset for dbbatchsize={dbbatchsize}: {e}\")\r\n        raise\r\n    finally:\r\n        print(\"Stopping bitcoind...\")\r\n        subprocess.run([bitcoin_cli, f\"-datadir={datadir}\", \"stop\"], cwd=bitcoin_core_path, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\r\n        time.sleep(5)\r\n\r\n    shutil.copy2(debug_log, archive)\r\n    print(f\"Archived logs to {archive}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    # Parse script arguments\r\n    parser = argparse.ArgumentParser(description=\"Benchmark Bitcoin dbbatchsize configurations.\")\r\n    parser.add_argument(\"--utxo-file\", required=True, help=\"Path to the UTXO snapshot file.\")\r\n    parser.add_argument(\"--bitcoin-core-path\", required=True, help=\"Path to the Bitcoin Core project directory.\")\r\n    args = parser.parse_args()\r\n\r\n    utxo_file = args.utxo_file\r\n    bitcoin_core_path = args.bitcoin_core_path\r\n    datadir = os.path.join(bitcoin_core_path, \"demo\")\r\n    debug_log = os.path.join(datadir, \"debug.log\")\r\n    bitcoin_cli = os.path.join(bitcoin_core_path, \"build/src/bitcoin-cli\")\r\n    bitcoind = os.path.join(bitcoin_core_path, \"build/src/bitcoind\")\r\n\r\n    # Build Bitcoin Core\r\n    print(\"Building Bitcoin Core...\")\r\n    subprocess.run([\"cmake\", \"-B\", \"build\", \"-DCMAKE_BUILD_TYPE=Release\"], cwd=bitcoin_core_path, check=True)\r\n    subprocess.run([\"cmake\", \"--build\", \"build\", \"-j\", str(os.cpu_count())], cwd=bitcoin_core_path, check=True)\r\n\r\n    # Run tests for each dbbatchsize\r\n    results = []\r\n    for dbbatchsize in [16777216, 67108864]:  # Original and proposed\r\n        loadtxoutset(dbbatchsize, datadir, bitcoin_cli, bitcoind, utxo_file)\r\n        archive = os.path.join(datadir, f\"results_dbbatch-{dbbatchsize}.log\")\r\n        elapsed, batchwrite_times, usage_snapshots = parse_log(archive)\r\n        results.append((dbbatchsize, elapsed, batchwrite_times, usage_snapshots))\r\n\r\n    # Plot results\r\n    plot_results(results, bitcoin_core_path)\r\n    print(\"All configurations processed.\")\r\n\r\n```\r\n\r\n</details>\r\n\r\n-----\r\n\r\nFor standard dbcache values the results are very close (though the memory measurements aren't as scientific as I'd like them to be (probably because there is still enough memory), some runs even indicate that 16MiB consumes a bit more memory than the 64MiB version), but the trend seems to be clear from the produced plots: the batch writes are faster (and seem more predictable) with bigger batches, while the memory usage is only slightly higher.\r\n\r\n![plot_flush_times](https://github.com/user-attachments/assets/3d7684e8-df49-471f-9cef-f7311e5680fd)\r\n![plot_memory_usage](https://github.com/user-attachments/assets/ee70565a-80a8-446f-9d5c-485b61c6b910)\r\n\r\nIs there any other way that you'd like me to test this @sipa, @luke-jr, @1440000bytes?\r\n\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2595151977",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "mentioned",
      "id": 15955314389,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAO3AsbV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15955314389",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:16Z"
    },
    {
      "event": "subscribed",
      "id": 15955314405,
      "node_id": "SE_lADOABII586l3CxmzwAAAAO3Asbl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15955314405",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:16Z"
    },
    {
      "event": "mentioned",
      "id": 15955314419,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAO3Asbz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15955314419",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:16Z"
    },
    {
      "event": "subscribed",
      "id": 15955314431,
      "node_id": "SE_lADOABII586l3CxmzwAAAAO3Asb_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15955314431",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:16Z"
    },
    {
      "event": "mentioned",
      "id": 15955314442,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAO3AscK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15955314442",
      "actor": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:17Z"
    },
    {
      "event": "subscribed",
      "id": 15955314458,
      "node_id": "SE_lADOABII586l3CxmzwAAAAO3Asca",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15955314458",
      "actor": {
        "login": "1440000bytes",
        "id": 147166694,
        "node_id": "U_kgDOCMWV5g",
        "avatar_url": "https://avatars.githubusercontent.com/u/147166694?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1440000bytes",
        "html_url": "https://github.com/1440000bytes",
        "followers_url": "https://api.github.com/users/1440000bytes/followers",
        "following_url": "https://api.github.com/users/1440000bytes/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1440000bytes/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1440000bytes/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1440000bytes/subscriptions",
        "organizations_url": "https://api.github.com/users/1440000bytes/orgs",
        "repos_url": "https://api.github.com/users/1440000bytes/repos",
        "events_url": "https://api.github.com/users/1440000bytes/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1440000bytes/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T10:32:17Z"
    },
    {
      "event": "labeled",
      "id": 15963315995,
      "node_id": "LE_lADOABII586l3CxmzwAAAAO3fN8b",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15963315995",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T15:11:12Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg2ODQxMzM0MGY4ZDYwNThkNzQxODZiNjVhYzM0OThkNmI3ZjI1NGE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/868413340f8d6058d74186b65ac3498d6b7f254a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/868413340f8d6058d74186b65ac3498d6b7f254a",
      "tree": {
        "sha": "c0de8be8712d13ec96582b5e0de1b5abca8d4cd9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c0de8be8712d13ec96582b5e0de1b5abca8d4cd9"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/df8bf657450d5383870d40790ea9f4fdb03c360d",
          "sha": "df8bf657450d5383870d40790ea9f4fdb03c360d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/df8bf657450d5383870d40790ea9f4fdb03c360d"
        }
      ],
      "message": "coins: bump default LevelDB write batch size to 64 MiB\n\nThe UTXO set has grown significantly, and flushing it from memory to LevelDB often takes over 20 minutes after a successful IBD with large dbcache values.\nThe final UTXO set is written to disk in batches, which LevelDB sorts into SST files.\nBy increasing the default batch size, we can reduce overhead from repeated compaction cycles, minimize constant overhead per batch, and achieve more sequential writes.\n\nExperiments with different batch sizes (loaded via assumeutxo at block 840k, then measuring final flush time) show that 64 MiB batches significantly reduce flush time without notably increasing memory usage:\n\n| dbbatchsize | flush_sum (ms) |\n|-------------|----------------|\n| 8 MiB       | ~240,000       |\n| 16 MiB      | ~220,000       |\n| 32 MiB      | ~200,000       |\n| *64 MiB*    | *~150,000*     |\n| 128 MiB     | ~156,000       |\n| 256 MiB     | ~166,000       |\n| 512 MiB     | ~186,000       |\n| 1 GiB       | ~186,000       |\n\nChecking the impact of a `-reindex-chainstate` with `-stopatheight=878000` and `-dbcache=30000` gives:\n16 << 20\n```\n2025-01-12T07:31:05Z Flushed fee estimates to fee_estimates.dat.\n2025-01-12T07:31:05Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\n2025-01-12T07:53:51Z Shutdown: done\n```\nFlush time: 22 minutes and 46 seconds\n\n64 >> 20\n```\n2025-01-12T18:30:00Z Flushed fee estimates to fee_estimates.dat.\n2025-01-12T18:30:00Z [warning] Flushing large (26 GiB) UTXO set to disk, it may take several minutes\n2025-01-12T18:44:43Z Shutdown: done\n```\nFlush time: ~14 minutes 43 seconds.",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-01-16T15:23:43Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-01-05T20:44:27Z"
      },
      "sha": "868413340f8d6058d74186b65ac3498d6b7f254a"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15963502062,
      "node_id": "HRFPE_lADOABII586l3CxmzwAAAAO3f7Xu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15963502062",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "868413340f8d6058d74186b65ac3498d6b7f254a",
      "commit_url": "https://api.github.com/repos/l0rinc/bitcoin/commits/868413340f8d6058d74186b65ac3498d6b7f254a",
      "created_at": "2025-01-16T15:24:03Z"
    },
    {
      "event": "commented",
      "id": 2597073268,
      "node_id": "IC_kwDOABII586azDF0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2597073268",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T22:56:58Z",
      "updated_at": "2025-01-16T22:56:58Z",
      "author_association": "MEMBER",
      "body": "I think those graphs need to be on height rather than seconds. The larger dbbatchsize making it faster means it gets further in the chain, leading to the higher max at the end...\r\n\r\nI would expect both lines to be essentially overlapping except during flushes.",
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2597073268",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2597893092,
      "node_id": "IC_kwDOABII586a2LPk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2597893092",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-17T10:14:28Z",
      "updated_at": "2025-01-17T10:14:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I would expect both lines to be essentially overlapping except during flushes.\r\n\r\nI was only measuring the memory here *during* flushes. There is no direct height available there, but if we instrument `UpdateTipLog` instead (and fetch some data from the assumeUTXO height), we'd get:\r\n\r\n> dbbatchsize=16MiB:\r\n\r\n![image](https://github.com/user-attachments/assets/a164d34a-6f10-4d74-bb8e-155f237ab565)\r\n\r\n> dbbatchsize=64MiB (+ experimental sorting):\r\n\r\n![image](https://github.com/user-attachments/assets/60c8debf-67f2-4424-b44a-50811606ecbb)\r\n\r\n----\r\n\r\noverlapped (blue 16, green 64):\r\n![image](https://github.com/user-attachments/assets/af87c9b1-9376-4e88-8688-9e48413558e6)\r\n\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2597893092",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "unlabeled",
      "id": 15977244154,
      "node_id": "UNLE_lADOABII586l3CxmzwAAAAO4UWX6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15977244154",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-17T13:08:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "referenced",
      "id": 16415797543,
      "node_id": "REFE_lADOABII586l3CxmzwAAAAPSdTEn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16415797543",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "aa56eaaa78211b5eb9cbe00801133395f3114888",
      "commit_url": "https://api.github.com/repos/bitcoinknots/bitcoin/commits/aa56eaaa78211b5eb9cbe00801133395f3114888",
      "created_at": "2025-02-22T21:04:40Z"
    },
    {
      "event": "renamed",
      "id": 16715994213,
      "node_id": "RTE_lADOABII586l3CxmzwAAAAPkWdRl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16715994213",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T15:22:25Z",
      "rename": {
        "from": "optimization: increase default LevelDB write batch size to 64 MiB",
        "to": "[IBD] Flush UXTOs in bigger batches"
      }
    },
    {
      "event": "mentioned",
      "id": 16715995113,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAPkWdfp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16715995113",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T15:22:28Z"
    },
    {
      "event": "subscribed",
      "id": 16715995144,
      "node_id": "SE_lADOABII586l3CxmzwAAAAPkWdgI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16715995144",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T15:22:28Z"
    },
    {
      "event": "renamed",
      "id": 16717039508,
      "node_id": "RTE_lADOABII586l3CxmzwAAAAPkaceU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16717039508",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T16:22:06Z",
      "rename": {
        "from": "[IBD] Flush UXTOs in bigger batches",
        "to": "[IBD] flush UXTOs in bigger batches"
      }
    },
    {
      "event": "reviewed",
      "id": 2679668648,
      "node_id": "PRR_kwDOABII586fuH-o",
      "url": null,
      "actor": null,
      "commit_id": "868413340f8d6058d74186b65ac3498d6b7f254a",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 868413340f8d6058d74186b65ac3498d6b7f254a\r\n\r\n> If that spike exceeds the memory the process can allocate it causes a crash, at a particularly bad time (may require a replay to fix, which may be slower than just reprocessing the blocks).\r\n\r\nIt is difficult for me to have a sense of how safe this change is but I'd hope we are not currently pushing systems so close to the edge that using an extra 48mb will cause them to start crashing. This does seem like a nice performance improvment if it doesn't cause crashes.\r\n\r\nIn theory, we could dynamically limit the batch size based on available memory to mitigate the risk of crashes. However, since the batch size is already small and further increases don’t provide much additional benefit (per the commit message), that added complexity probably isn’t worth it here.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#pullrequestreview-2679668648",
      "submitted_at": "2025-03-12T19:32:28Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645"
    },
    {
      "event": "reviewed",
      "id": 2682568821,
      "node_id": "PRR_kwDOABII586f5MB1",
      "url": null,
      "actor": null,
      "commit_id": "868413340f8d6058d74186b65ac3498d6b7f254a",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK on raising the default from 16 to 67 megabytes (note that `-dbbatchsize` is a hidden `-help-debug` config option). Testing.\r\n\r\n```\r\n$ ./build/bin/bitcoind -help-debug | grep -A2 dbbatch\r\n  -dbbatchsize\r\n       Maximum database write batch size in bytes (default: 67108864)\r\n\r\n```",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#pullrequestreview-2682568821",
      "submitted_at": "2025-03-13T16:08:47Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31645"
    },
    {
      "event": "unsubscribed",
      "id": 16744002095,
      "node_id": "UE_lADOABII586l3CxmzwAAAAPmBTIv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16744002095",
      "actor": {
        "login": "Joven24",
        "id": 173459179,
        "node_id": "U_kgDOClbG6w",
        "avatar_url": "https://avatars.githubusercontent.com/u/173459179?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Joven24",
        "html_url": "https://github.com/Joven24",
        "followers_url": "https://api.github.com/users/Joven24/followers",
        "following_url": "https://api.github.com/users/Joven24/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Joven24/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Joven24/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Joven24/subscriptions",
        "organizations_url": "https://api.github.com/users/Joven24/orgs",
        "repos_url": "https://api.github.com/users/Joven24/repos",
        "events_url": "https://api.github.com/users/Joven24/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Joven24/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T16:16:45Z"
    },
    {
      "event": "commented",
      "id": 2722607551,
      "node_id": "IC_kwDOABII586iR7G_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722607551",
      "actor": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T20:22:25Z",
      "updated_at": "2025-03-13T20:22:25Z",
      "author_association": "MEMBER",
      "body": "Review and testing-under-way ACK 868413340f8d6058d74186b65ac3498d6b7f254a\r\n\r\nAs described in the pull description, this value was set in 2017 in #10148 and hasn't been changed since.\r\n\r\n> Maybe a config option can be provided to change it.\r\n\r\n> Just realized [`dbbatchsize`](https://github.com/bitcoin/bitcoin/blob/35bf426e02210c1bbb04926f4ca2e0285fbfcd11/src/init.cpp#L489) already exists.\r\n\r\nThis is a hidden config option and the rationale might be https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110097256:\r\n\r\n\"the relevant constraint is the memory usage peak from allocating the batch, which depends on the batch memory usage, not dbcache memory usage. Also, I don't think anyone will need to change this property (except for tests, where it's very useful to get much more frequent partial flushes).\"\r\n\r\nThough, if an older machine might be constrained in memory during IBD after upgrading bitcoin core, that might be an argument to unhide `-dbbatchsize` with the larger default (and document its use in the conf file; I don't recall if conf file doc gen is automated yet).",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2722607551",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2724691617,
      "node_id": "IC_kwDOABII586iZ36h",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2724691617",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-14T13:24:12Z",
      "updated_at": "2025-03-19T17:33:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "Reran the benchmarks on a Hetzner Linux machine using GCC with the new AssumeUTXO 880k set, parsing the logged flush times and plotting the results.\r\nFor different `dbcache` (440, 5000, 30000) and `dbbatchsize` (4-256MiB range, 16MiB (current) and 64MiB (proposed) are highlighted and trendline is added for clarity) sizes, each one twice for stability:\r\n\r\nSorting the same measurements (+ sums) might give us a better understanding of the trends:\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/ce56cfba-a59f-4360-a6d7-2cc3e74959a3\" />\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/b151cabd-f7b0-401b-8623-9f29bc3a5a46\" />\r\n\r\n----\r\n\r\nEdit: running it on my Mac M4 Max gives more varied results in general:\r\n\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/9de2e6df-d965-457e-9710-4c8279b3dffa\" />\r\n\r\n---\r\n\r\n\r\nI will investigate if it depends on the compiler and operating system - can anyone else check Windows?",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2724691617",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2740766215,
      "node_id": "IC_kwDOABII586jXMYH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2740766215",
      "actor": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-20T15:01:05Z",
      "updated_at": "2025-03-21T05:42:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "I used `valgrind --tool=massif` [valgrind massif](https://valgrind.org/docs/manual/ms-manual.html) to profile memory usage of bitcoin-core IBD(840002 to 850000) for 16MiB and 64MiB batch sizes. Tested on an Ubuntu  22.04 Server and compiled with GCC 11.4.0.\r\n\r\n## Memory Usage Tests\r\n\r\n### Method\r\n```\r\nmkdir demo\r\nbuild/bin/bitcoind -datadir=demo -stopatheight=1\r\nbuild/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -stopatheight=840001\r\nbuild/bin/bitcoin-cli -datadir=demo -rpcclienttimeout=0 loadtxoutset ~/utxo-840000.dat\r\nmkdir demo-backup\r\ncp -r demo/* demo-backup\r\n\r\nvalgrind --tool=massif build/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -dbbatchsize=16777216 -stopatheight=850000\r\n\r\nrm -rf demo\r\nmkdir demo\r\ncp -r demo-backup/* demo\r\n\r\nvalgrind --tool=massif build/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -dbbatchsize=67108864 -stopatheight=850000\r\n```\r\n\r\n### Results\r\nRunning `ms_print` on the massif output files produces\r\n```\r\n--------------------------------------------------------------------------------\r\nCommand:            build/bin/bitcoind -datadir=../demo -daemon -blocksonly=1 -dbbatchsize=16777216 -stopatheight=850000\r\nMassif arguments:   (none)\r\nms_print arguments: massif.out.674977\r\n--------------------------------------------------------------------------------\r\n\r\n\r\n    MB\r\n811.4^        #                                                               \r\n     |     :: #                                                       :       \r\n     |     :  #                                                       :       \r\n     |     :  #             ::               ::                       :       \r\n     |  :  :  # @           :                :           :   :        :       \r\n     |  :  :  # @          ::  :   ::        :   @@      :   :   :    :  ::  @\r\n     |  :  : :# @   :  ::  ::  :   :        ::   @   :   :   :   :    :  :   @\r\n     | ::  : :# @ :::  :   ::  :   :  ::    ::   @   :   :  ::   :  :::  :   @\r\n     | ::  : :# @ : :  :  :::  :   :  :   :::: ::@   :  ::  ::   :  : :  :   @\r\n     | ::  : :#:@:: :  :  :::  : :::  :   : :: : @   :  ::  :: :::  : :  :   @\r\n     | ::::: :#:@:: :  :  ::: @: : :  :   : :: : @   :  ::  :: : :  : ::::   @\r\n     | ::: : :#:@:: :::: :::: @: : : ::   : :: : @   :  :::::: : :::: :: : ::@\r\n     | ::: : :#:@:: :: : :::: @: : : :: ::: :: : @   :@@::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ :::@ ::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ : :@ ::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ : :@ ::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ : :@ ::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ : :@ ::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ : :@ ::: :::: :: : :: : : @\r\n     | ::: : :#:@:: :: : :::: @::: : :: : : :: : @ : :@ ::: :::: :: : :: : : @\r\n   0 +----------------------------------------------------------------------->Ti\r\n     0                                                                   8.610\r\n\r\n```\r\n```\r\n--------------------------------------------------------------------------------\r\nCommand:            build/bin/bitcoind -datadir=../demo -daemon -blocksonly=1 -dbbatchsize=67108864 -stopatheight=850000\r\nMassif arguments:   (none)\r\nms_print arguments: massif.out.682470\r\n--------------------------------------------------------------------------------\r\n\r\n\r\n    GB\r\n1.005^          ##                                                            \r\n     |          #                        ::                                   \r\n     |          #               :        :   ::                               \r\n     |          #               :        :   :                        :       \r\n     |          #               :        :   :                        :       \r\n     |          #               :        :   :                        :      :\r\n     |          #               :        :   :        :               :      :\r\n     |  :  ::   #      :    :   :        :  ::   :    : ::   :   ::   :   :: :\r\n     |  :  : @  #      :    :  ::  :   :::  ::   :    : :    :   :  :::   :  @\r\n     |  :  : @  # ::   :    : :::  :   : : :::  ::  ::: :  :::  ::  : : :::  @\r\n     |  :  : @  # :   ::  ::: :::  :   : : :::  ::  : : :  : :  ::  : : : : :@\r\n     | ::::: @::# :   ::  : : :::  :  :: : ::: :::  : :::  : :  :: :: ::: : :@\r\n     | ::: : @: # :   ::  : : ::::::  :: : ::: :::  : :::  : :  :: :: ::: : :@\r\n     | ::: : @: # : ::::  : :::::: :  :: : ::: :::::: :::  : ::::: :: ::: : :@\r\n     | ::: : @: # : : ::::: :::::: ::::: : ::: :::: : ::: :: :: :: :: ::: : :@\r\n     | ::: : @: # : : ::: : :::::: :: :: : ::: :::: : ::: :: :: :: :: ::: : :@\r\n     | ::: : @: # : : ::: : :::::: :: :: : ::: :::: : ::: :: :: :: :: ::: : :@\r\n     | ::: : @: # : : ::: : :::::: :: :: : ::: :::: : ::: :: :: :: :: ::: : :@\r\n     | ::: : @: # : : ::: : :::::: :: :: : ::: :::: : ::: :: :: :: :: ::: : :@\r\n     | ::: : @: # : : ::: : :::::: :: :: : ::: :::: : ::: :: :: :: :: ::: : :@\r\n   0 +----------------------------------------------------------------------->Ti\r\n     0                                                                   8.477\r\n```\r\n\r\nThe graphs show that with the default dbcache size, bitcoin-core memory usage peaks at 811.4MB for 16MiB `dbbatchsize` and 1.005GB for 64MiB `dbbatchsize` . \r\n\r\nIf I'm not mistaken, Bitcoin-core runs on really small devices like Raspberry Pi with only 1GB RAM, if we raise the default  `dbbatchsize` to 64GB, there's a chance that Bitcoin-core could OOM if there's not enough Swap space. \r\nAlso note that if the bitcoin-core process uses swap space, it will run slower thereby negating potential speed gains from raising the `dbbatchsize`.\r\n\r\n## Speed Tests\r\n### Method\r\nApply the following diff to output Batch write time data to `debug.log`.\r\n```diff\r\ndiff --git a/src/txdb.cpp b/src/txdb.cpp\r\nindex 1622039d63..ef73378ce6 100644\r\n--- a/src/txdb.cpp\r\n+++ b/src/txdb.cpp\r\n@@ -91,6 +91,7 @@ std::vector<uint256> CCoinsViewDB::GetHeadBlocks() const {\r\n }\r\n \r\n bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashBlock) {\r\n+    const auto start = std::chrono::steady_clock::now();\r\n     CDBBatch batch(*m_db);\r\n     size_t count = 0;\r\n     size_t changed = 0;\r\n@@ -147,7 +148,9 @@ bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashB\r\n \r\n     LogDebug(BCLog::COINDB, \"Writing final batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n     bool ret = m_db->WriteBatch(batch);\r\n+    const auto end{std::chrono::steady_clock::now()};\r\n     LogDebug(BCLog::COINDB, \"Committed %u changed transaction outputs (out of %u) to coin database...\\n\", (unsigned int)changed, (unsigned int)count);\r\n+    LogDebug(BCLog::COINDB, \"BatchWrite: completed in %dms\\n\", duration_cast<std::chrono::milliseconds>(end - start).count());\r\n     return ret;\r\n }\r\n```\r\n\r\n```\r\nmkdir demo\r\nbuild/bin/bitcoind -datadir=demo -stopatheight=1\r\nbuild/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -stopatheight=840001\r\nbuild/bin/bitcoin-cli -datadir=demo -rpcclienttimeout=0 loadtxoutset ~/utxo-840000.dat\r\nmkdir demo-backup\r\ncp -r demo/* demo-backup\r\n\r\nbuild/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -dbbatchsize=16777216 -stopatheight=850000 -debug=coindb\r\ncp demo/debug.log defaultcache_16MiB_dbbatchsize.log\r\n\r\nrm -rf demo\r\nmkdir demo\r\ncp -r demo-backup/* demo\r\n\r\nbuild/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -dbbatchsize=67108864 -stopatheight=850000 -debug=coindb\r\ncp demo/debug.log defaultcache_64MiB_dbbatchsize.log\r\n\r\n// Parse log files using https://github.com/Eunovo/31645-data/blob/main/extract_batch_write_data.py\r\ncat defaultcache_64MiB_dbbatchsize.log | grep \"BatchWrite\" -B 1 | xargs ./extract_batch_write_data.py > defaultcache_64MiB_dbbatchsize.result\r\n```\r\n\r\n### Results\r\n```\r\nLogfile: defaultcache_16MiB_dbbatchsize.log\r\n--------------------------------------------\r\nAverage num_txouts_per_ms: 1018.2494977251025\r\n--------------------------------------------\r\nnum_txouts,write_times_ms,num_txouts_per_ms\r\n2862776,2830,1011.5816254416961\r\n2934562,2851,1029.3097158891617\r\n2921143,2753,1061.0762804213584\r\n2940809,2861,1027.8954910870325\r\n2948759,2870,1027.4421602787456\r\n2979042,2967,1004.0586450960566\r\n2956426,2917,1013.5159410353102\r\n3048466,3060,996.2307189542483\r\n2978184,2940,1012.9877551020409\r\n2944033,2945,999.6716468590832\r\n2973528,2970,1001.1878787878788\r\n2970816,2889,1028.3198338525442\r\n2982352,2898,1029.1069703243616\r\n2960008,2776,1066.28530259366\r\n3016540,2952,1021.8631436314363\r\n3007010,3033,991.4309264754369\r\n2976775,2982,998.2478202548625\r\n3084773,3085,999.92641815235\r\n2069630,2016,1026.6021825396826\r\n```\r\n\r\n```\r\nLogfile: defaultcache_64MiB_dbbatchsize.log\r\n--------------------------------------------\r\nAverage num_txouts_per_ms: 735.7374156918239\r\n--------------------------------------------\r\nnum_txouts,write_times_ms,num_txouts_per_ms\r\n2862776,3881,737.6387528987375\r\n2895729,3942,734.5837138508372\r\n2941575,3704,794.161717062635\r\n2941158,3924,749.5305810397554\r\n2965901,4129,718.3097602325018\r\n2978043,4095,727.2388278388279\r\n2946445,4041,729.1375897055184\r\n3034443,4319,702.5799953692984\r\n2993584,4154,720.6509388541165\r\n2947744,4113,716.6895210308777\r\n2979400,4072,731.679764243615\r\n2968346,3819,777.2573972244043\r\n2991885,3932,760.9066632756867\r\n2960911,3844,770.2682101977107\r\n2942739,4000,735.68475\r\n3031336,4282,707.9252685660906\r\n3007839,4118,730.4125789218067\r\n3057094,4257,718.133427296218\r\n2137921,2985,716.2214405360133\r\n```\r\n\r\nRunning with 64MiB `dbbatchsize` turns out to be about 27% slower. I was only able to oberserve a speedup when doing a large flush which doesn't happen often with the default 450MiB cache size. ",
      "user": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2740766215",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "commented",
      "id": 2740896169,
      "node_id": "IC_kwDOABII586jXsGp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2740896169",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-20T15:41:37Z",
      "updated_at": "2025-03-20T15:41:37Z",
      "author_association": "MEMBER",
      "body": "Maybe it's a better approach to scale the (default) batch size in function of the dbcache itself? That way, people who have configured their node to run with a low memory footprint to begin with will have relatively small flushing spikes, but people who run on beefy systems and thus likely can tolerate bigger spikes too get to enjoy the performance benefit those may be provide?",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2740896169",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "renamed",
      "id": 16974111123,
      "node_id": "RTE_lADOABII586l3CxmzwAAAAPzvGGT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16974111123",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-25T12:58:13Z",
      "rename": {
        "from": "[IBD] flush UXTOs in bigger batches",
        "to": "[IBD] flush UTXOs in bigger batches"
      }
    },
    {
      "event": "commented",
      "id": 2754814130,
      "node_id": "IC_kwDOABII586kMyCy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2754814130",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-26T15:23:16Z",
      "updated_at": "2025-03-26T15:24:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for your measurements @Eunovo!\r\n\r\nI'm not sure if we support 1GiB of total memory or not, but [even 8 years ago](https://github.com/bitcoin/bitcoin/issues/11752#issuecomment-346451450) that required a lower dbcache that 450MiB.\r\n\r\nIt took me a bit, but I finally finished comparing the 16 and 64 MiB batches with `valgrind --tool=massif` for full IBD until block 888888.\r\n\r\n<details>\r\n<summary>Benchmarks</summary>\r\n\r\n```bash\r\nCOMMITS=\"998386d4462f5e06412303ba559791da83b913fb 5cefc4bbadaa06f22089dd7991fac17ed5b283ca\"; \\\r\nSTOP_HEIGHT=888888; DBCACHE=1000; \\\r\nC_COMPILER=gcc; CXX_COMPILER=g++; \\\r\nDATA_DIR=\"/mnt/my_storage/BitcoinData\"; \\\r\nLOG_DIR=\"/mnt/my_storage/logs\"; \\\r\nmkdir -p $LOG_DIR; \\\r\nfor COMMIT in $COMMITS; do \\\r\n  git fetch --all -q && git fetch origin $COMMIT && git log -1 --oneline $COMMIT && \\\r\n  killall bitcoind || true && \\\r\n  rm -rf $DATA_DIR/* && \\\r\n  git checkout $COMMIT && \\\r\n  git clean -fxd && \\\r\n  git reset --hard && \\\r\n  cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_WALLET=OFF -DCMAKE_C_COMPILER=$C_COMPILER -DCMAKE_CXX_COMPILER=$CXX_COMPILER && \\\r\n  cmake --build build -j$(nproc) --target bitcoind && \\\r\n  ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=1 || true && \\\r\n  valgrind --tool=massif --time-unit=ms \\\r\n    --massif-out-file=\"$LOG_DIR/massif-$COMMIT-$STOP_HEIGHT-$DBCACHE.out\" \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR \\\r\n    -stopatheight=$STOP_HEIGHT \\\r\n    -dbcache=$DBCACHE \\\r\n    -blocksonly=1 \\\r\n    -printtoconsole=1 && \\\r\n  cp $DATA_DIR/debug.log \"$LOG_DIR/debug-$COMMIT-$STOP_HEIGHT-$DBCACHE.log\" && \\\r\n  ms_print \"$LOG_DIR/massif-$COMMIT-$STOP_HEIGHT-$DBCACHE.out\" | tee \"$LOG_DIR/massif-$COMMIT-$STOP_HEIGHT-$DBCACHE.txt\"; \\\r\ndone\r\n```\r\n\r\n</details>\r\n\r\nThe memory difference is measurable and non-negligible (~200MiB, seems the buffer may be copied 4 times), especially for small memory usecases.\r\nI have opened https://github.com/google/leveldb/pull/1259 to enable pre-sizing the memory, which might help us in reducing the spikes slightly.\r\n\r\n16 >> 10 with 1GiB `dbcache`:\r\n<img width=\"1000\" alt=\"16\" src=\"https://github.com/user-attachments/assets/78fb32ee-91f8-40ca-9ddc-18f136ae2540\" />\r\n\r\n64 >> 10 with 1GiB `dbcache`:\r\n<img width=\"1000\" alt=\"64\" src=\"https://github.com/user-attachments/assets/57def2e4-ffea-4aa4-ac19-431b7d992336\" />\r\n\r\n----\r\n\r\nI like @sipa's suggestion of making the batch size depend on cache size, I also thought of that while investigating it, but that may mean that the hidden `dbbatchsize` has to be changed.\r\nBasically we could have a fixed number of batch fills, currently 28 GiB is batched into 16 MiB chunks, we could set it to 1000 fixed writes - or something similar, I'll investigate.\r\n\r\n----\r\n\r\nAnd about the speedups, I found that on Mac the differences were tiny (see attachments), but on Linux they were basically always faster, regardless of the dbcache size. We have to find out in which case it's faster and when it's slower, thanks for helping me with that.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2754814130",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "mentioned",
      "id": 16995217833,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAP0_nGp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16995217833",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-26T15:23:18Z"
    },
    {
      "event": "subscribed",
      "id": 16995217876,
      "node_id": "SE_lADOABII586l3CxmzwAAAAP0_nHU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16995217876",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-26T15:23:18Z"
    },
    {
      "event": "mentioned",
      "id": 16995217923,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAP0_nID",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16995217923",
      "actor": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-26T15:23:18Z"
    },
    {
      "event": "subscribed",
      "id": 16995217973,
      "node_id": "SE_lADOABII586l3CxmzwAAAAP0_nI1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16995217973",
      "actor": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-26T15:23:18Z"
    },
    {
      "event": "commented",
      "id": 2756833986,
      "node_id": "IC_kwDOABII586kUfLC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2756833986",
      "actor": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-27T06:05:09Z",
      "updated_at": "2025-03-27T06:05:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "> The memory difference is measurable and non-negligible (~200MiB, seems the buffer may be copied 4 times), especially for small memory usecases.\r\n> I have opened [google/leveldb#1259](https://github.com/google/leveldb/pull/1259) to enable pre-sizing the memory, which might help us in reducing the spikes slightly.\r\n\r\n@l0rinc  you can also check `leveldb.approximate-memory-usage`. [Use db.GetProperty](https://github.com/google/leveldb/blob/main/include/leveldb/db.h#L122) before and after batch writes. I noticed that it shows a non-negligible spike in memory usage. Could be useful to quickly check if https://github.com/google/leveldb/pull/1259 works",
      "user": {
        "login": "Eunovo",
        "id": 37949128,
        "node_id": "MDQ6VXNlcjM3OTQ5MTI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/37949128?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Eunovo",
        "html_url": "https://github.com/Eunovo",
        "followers_url": "https://api.github.com/users/Eunovo/followers",
        "following_url": "https://api.github.com/users/Eunovo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Eunovo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Eunovo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Eunovo/subscriptions",
        "organizations_url": "https://api.github.com/users/Eunovo/orgs",
        "repos_url": "https://api.github.com/users/Eunovo/repos",
        "events_url": "https://api.github.com/users/Eunovo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Eunovo/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2756833986",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    },
    {
      "event": "mentioned",
      "id": 17005679975,
      "node_id": "MEE_lADOABII586l3CxmzwAAAAP1nhVn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17005679975",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-27T06:05:10Z"
    },
    {
      "event": "subscribed",
      "id": 17005679985,
      "node_id": "SE_lADOABII586l3CxmzwAAAAP1nhVx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17005679985",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-27T06:05:10Z"
    },
    {
      "event": "convert_to_draft",
      "id": 17048071471,
      "node_id": "CTDE_lADOABII586l3CxmzwAAAAP4JO0v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17048071471",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-30T14:13:30Z"
    },
    {
      "event": "commented",
      "id": 2764621216,
      "node_id": "IC_kwDOABII586kyMWg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2764621216",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-30T15:47:45Z",
      "updated_at": "2025-04-08T16:48:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "<details>\r\n<summary>Edit: old experiment values</summary>\r\n\r\nI've experimented a bit with changing the fixed write batch size to a dynamic value that scales with dbcache size, basically something like:\r\n```C++\r\nstatic int64_t GetDefaultDbBatchSize(int64_t dbcache_bytes) {\r\n    return std::min<int64_t>(\r\n        MAX_DB_CACHE_BATCH, // 512 MiB upper limit\r\n        std::max<int64_t>(\r\n            MIN_DB_CACHE,   // 4 MiB lower limit\r\n            dbcache_bytes * DEFAULT_KERNEL_CACHE_BATCH_SIZE / DEFAULT_KERNEL_CACHE\r\n        )\r\n    );\r\n}\r\n```\r\n\r\nCorresponding to:\r\n\r\n| dbcache (MiB) | Before (Fixed) |  | After (Dynamic) |  |\r\n|---------------|----------------|-----------------|----------------|-----------------|\r\n|               | **Batch Size** | **Batch Count** | **Batch Size** | **Batch Count** |\r\n| 4             | 16 MiB         | 1,546           | 4 MiB          | 3,111           |\r\n| 10            | 16 MiB         | 1,546           | 4 MiB          | 3,090           |\r\n| 45            | 16 MiB         | 780             | 4 MiB          | 3,090           |\r\n| 100           | 16 MiB         | 929             | 4 MiB          | 3,085           |\r\n| 450 (default) | 16 MiB         | 775             | 19.6 MiB       | 646             |\r\n| 1,000         | 16 MiB         | 788             | 44 MiB         | 285             |\r\n| 4,500         | 16 MiB         | 774             | 200 MiB        | 69              |\r\n| 10,000        | 16 MiB         | 772             | 444 MiB        | 33              |\r\n| 45,000        | 16 MiB         | 771             | 512 MiB        | 28              |\r\n\r\nThis would:\r\n* Provide smaller batches (4 MiB) for memory-constrained systems (likely making them a bit slower).\r\n* Maintains a similar batch size for default dbcache (20 MiB instead of 16 MiB, making it a bit faster, using a bit more memory).\r\n* Scales to larger batches for high-memory systems (up to 512 MiB, making it a lot faster, using a lot more memory).\r\n\r\n-----\r\n\r\nThe chart illustrates how the dynamic batch sizing maintains approximately a 1:22 ratio (~4.5%) between batch size and dbcache size, while capping at 4 MiB minimum for memory-constrained systems and 512 MiB maximum for high-memory systems (I chose this simply to maintain a similar batch size for the default value (20 MiB instead of 16 MiB for dbcache=440) while scaling linearly for other values).\r\n\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/cf237a62-e303-4bbb-aa28-d3fc7aaa0b9f\" />\r\n\r\nI have drafted the PR until I fine-tune these values based on performance and memory usage.\r\n\r\n</details>\r\n\r\n\r\nEdit:\r\n\r\nEnded up with keeping the `16 MiB` batch size for `dbcache` sizes below-or-equal to the default:\r\n\r\n$$\r\n\\text{GetDbBatchSize}(x)\r\n= \\max\\Bigl(16\\mathrm{MiB},\\ \r\n   \\min\\bigl(256\\mathrm{MiB},\\ \r\n     \\frac{x}{450\\mathrm{MiB}} \\times 16\\mathrm{MiB}\r\n   \\bigr)\r\n\\Bigr).\r\n$$\r\n\r\nWhich produces:\r\n\r\n<details>\r\n<summary>dbcache (MiB) | Batch Size (MiB) | Batches </summary>\r\n\r\n```bash\r\n           4 |          16.0 |     832\r\n          10 |          16.0 |     832\r\n          45 |          16.0 |     832\r\n         100 |          16.0 |     832\r\n         450 |          16.0 |     832\r\n        1000 |          35.6 |     375\r\n        2000 |          71.1 |     188\r\n        4500 |         160.0 |      84\r\n       10000 |         256.0 |      52\r\n       45000 |         256.0 |      52\r\n```\r\n\r\n</details>\r\n\r\n\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/f9a779e4-a8d6-43fc-be75-958aede9fb31\" />\r\n\r\nWhich corresponds to the following peak memory increase per `dbcache`:\r\n\r\n<details>\r\n<summary>dbcache (MiB) | Before (GB) | After (GB) | Increase (GB) | Increase (%) | Batch Size (Before → After)</summary>\r\n\r\n```bash\r\n         450 |     0.753 |    0.755 |       0.001 |       0.2% | 16 MiB → 16 MiB\r\n        1000 |     1.240 |    1.313 |       0.073 |       5.9% | 16 MiB → 35 MiB\r\n        4500 |     4.564 |    5.109 |       0.545 |      11.9% | 16 MiB → 128 MiB\r\n       10000 |     9.785 |   10.770 |       0.985 |      10.1% | 16 MiB → 256 MiB\r\n```\r\n\r\n</details>\r\n\r\n<img width=\"1000\" alt=\"image\" src=\"https://github.com/user-attachments/assets/f80ecfd9-8505-48b8-aefc-6b1bcc4f31b1\" />\r\n\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-2764621216",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31645"
    }
  ],
  "comments": []
}