{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495",
    "id": 2234616382,
    "node_id": "PR_kwDOABII586FMYo-",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31495",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31495.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31495.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31495",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31495/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/86c54283f860f3feb5c96d470a7590d2e89b6000",
    "number": 31495,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "wallet: Utilize IsMine() and CanProvide() in migration to cover edge cases",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "The legacy wallet `IsMine()` is essentially a black box that would tell us whether the wallet is watching an output script. In order to migrate legacy wallets to descriptor wallets, we need to be able to compute all of the output scripts that a legacy wallet would watch. The original approach for this was to understand `IsMine()` and write a function which would be its inverse. This was partially done in the original migration code, and attempted to be completed in #30328. However, further analysis of `IsMine()` has continued to reveal additional edge cases which make writing an inverse function increasingly difficult to verify correctness.\r\n\r\nThis PR instead changes migration to utilize `IsMine()` to produce the output scripts by first computing a superset of all of the output scripts that `IsMine()` would watch and testing each script against `IsMine()` to filter for the ones that actually are watched. The superset is constructed by computing all possible output scripts for the keys and scripts in the wallet - for keys, every key could be a P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH; for scripts, every script could be an output script, the redeemScript of a P2SH, the witnessScript of a P2WSH, and the witnessScript of a P2SH-P2WSH.\r\n\r\nAdditionally, the legacy wallet can contain scripts that are redeemScripts and witnessScripts, while not watching for any output script utilizing that script. These are known as solvable scripts and are migrated to a separate \"solvables\" wallet. The previous approach to identifying these solvables was similar to identifying output scripts - finding known solvable conditions and computing the scripts. However, this also can miss scripts, so the solvables are now identified in a manner similar to the output scripts but using the function `CanProvide()`. Using the same superset as before, all output scripts which are `ISMINE_NO` are put through `CanProvide()` which will perform a dummy signing and then a key lookup to determine whether the legacy wallet could provide any solving data for the output script. The scripts that pass will have their descriptors inferred and the script included in the solvables wallet.\r\n\r\nThe main downside of this approach is that `IsMine()` and `CanProvide()` can no longer be deleted. They will need to be refactored to be migration only code instead in #28710.\r\n\r\nLastly, I've added 2 test cases for the edge cases that prompted this change of approach. In particular, miniscript witnessScripts and `rawtr()` output scripts are  solvable and signable in a legacy wallet, although never `ISMINE_SPENDABLE`.",
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      },
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2024-12-13T22:07:10Z",
    "updated_at": "2025-01-21T21:58:32Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "2d0f2f2ec5b284adada8b107d2506294183bc7d6",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "achow101:migrate-corner-case-scripts",
      "ref": "migrate-corner-case-scripts",
      "sha": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 45006379,
        "node_id": "MDEwOlJlcG9zaXRvcnk0NTAwNjM3OQ==",
        "name": "bitcoin",
        "full_name": "achow101/bitcoin",
        "owner": {
          "login": "achow101",
          "id": 3782274,
          "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
          "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/achow101",
          "html_url": "https://github.com/achow101",
          "followers_url": "https://api.github.com/users/achow101/followers",
          "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
          "organizations_url": "https://api.github.com/users/achow101/orgs",
          "repos_url": "https://api.github.com/users/achow101/repos",
          "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/achow101/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/achow101/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/achow101/bitcoin",
        "archive_url": "https://api.github.com/repos/achow101/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/achow101/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/achow101/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/achow101/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/achow101/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/achow101/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/achow101/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/achow101/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/achow101/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/achow101/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/achow101/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/achow101/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/achow101/bitcoin/events",
        "forks_url": "https://api.github.com/repos/achow101/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/achow101/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/achow101/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/achow101/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/achow101/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/achow101/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/achow101/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/achow101/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/achow101/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/achow101/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/achow101/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/achow101/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/achow101/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/achow101/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/achow101/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/achow101/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:achow101/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/achow101/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/achow101/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/achow101/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/achow101/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/achow101/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/achow101/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/achow101/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/achow101/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/achow101/bitcoin/hooks",
        "svn_url": "https://github.com/achow101/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 8,
        "stargazers_count": 39,
        "watchers_count": 39,
        "size": 288409,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-01-21T20:40:13Z",
        "created_at": "2015-10-27T00:20:28Z",
        "updated_at": "2024-10-04T23:43:44Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "5691fa93c48c5b2c767f19aad5e972e4d760414a",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36583,
        "stargazers_count": 81545,
        "watchers_count": 81545,
        "size": 274398,
        "default_branch": "master",
        "open_issues_count": 698,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-01-21T17:04:41Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-01-21T21:14:21Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 413,
    "deletions": 109,
    "changed_files": 3,
    "commits": 9,
    "review_comments": 36,
    "comments": 4
  },
  "events": [
    {
      "event": "commented",
      "id": 2542459023,
      "node_id": "IC_kwDOABII586XitiP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2542459023",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-13T22:07:13Z",
      "updated_at": "2025-01-21T21:58:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31495.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [sipa](https://github.com/bitcoin/bitcoin/pull/31495#issuecomment-2543324905), [theStack](https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2530939442), [brunoerg](https://github.com/bitcoin/bitcoin/pull/31495#issuecomment-2595294790), [Sjors](https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2564262259) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31423](https://github.com/bitcoin/bitcoin/pull/31423) (wallet: migration, don't create spendable wallet from a watch-only legacy wallet by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#issuecomment-2542459023",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31495"
    },
    {
      "event": "labeled",
      "id": 15654009826,
      "node_id": "LE_lADOABII586jRhxQzwAAAAOlDTvi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15654009826",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-13T22:07:16Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15654029170,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAOlDYdy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15654029170",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "ef20f9f476aa9e38df8358f4a0293cb669f2a336",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/ef20f9f476aa9e38df8358f4a0293cb669f2a336",
      "created_at": "2024-12-13T22:10:29Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15654040451,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAOlDbOD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15654040451",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "1780617cdb38742d820bfb2d66a798c0e3ce3afc",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/1780617cdb38742d820bfb2d66a798c0e3ce3afc",
      "created_at": "2024-12-13T22:12:19Z"
    },
    {
      "event": "commented",
      "id": 2543324905,
      "node_id": "IC_kwDOABII586XmA7p",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2543324905",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-14T19:46:53Z",
      "updated_at": "2024-12-14T19:46:53Z",
      "author_association": "MEMBER",
      "body": "Concept ACK",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#issuecomment-2543324905",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31495"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15675947653,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAOmW_qF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15675947653",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "d8608d140cf3064ecccd09ce5714a04375d8a78e",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/d8608d140cf3064ecccd09ce5714a04375d8a78e",
      "created_at": "2024-12-16T20:09:35Z"
    },
    {
      "event": "reviewed",
      "id": 2530939442,
      "node_id": "PRR_kwDOABII586W2xIy",
      "url": null,
      "actor": null,
      "commit_id": "d8608d140cf3064ecccd09ce5714a04375d8a78e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2530939442",
      "submitted_at": "2025-01-05T19:16:52Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15830206734,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAOvjckO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15830206734",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "3474524ee56dc3d0d009fe1462092ae5d6cbd775",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/3474524ee56dc3d0d009fe1462092ae5d6cbd775",
      "created_at": "2025-01-06T19:43:50Z"
    },
    {
      "event": "labeled",
      "id": 15831675342,
      "node_id": "LE_lADOABII586jRhxQzwAAAAOvpDHO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15831675342",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-06T22:46:35Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 15835612736,
      "node_id": "UNLE_lADOABII586jRhxQzwAAAAOv4EZA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15835612736",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-07T08:54:36Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2547082375,
      "node_id": "PRR_kwDOABII586X0WSH",
      "url": null,
      "actor": null,
      "commit_id": "3474524ee56dc3d0d009fe1462092ae5d6cbd775",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Some questions in the form of feedback...",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2547082375",
      "submitted_at": "2025-01-13T17:16:20Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "commented",
      "id": 2595294790,
      "node_id": "IC_kwDOABII586asQ5G",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2595294790",
      "actor": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-16T11:40:23Z",
      "updated_at": "2025-01-16T11:40:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#issuecomment-2595294790",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31495"
    },
    {
      "event": "reviewed",
      "id": 2556310008,
      "node_id": "PRR_kwDOABII586YXjH4",
      "url": null,
      "actor": null,
      "commit_id": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2556310008",
      "submitted_at": "2025-01-16T14:20:48Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "reviewed",
      "id": 2556701280,
      "node_id": "PRR_kwDOABII586YZCpg",
      "url": null,
      "actor": null,
      "commit_id": "0f0ce579fffe533534dc117c854ebef3f277f18e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2556701280",
      "submitted_at": "2025-01-16T16:43:34Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "reviewed",
      "id": 2556856579,
      "node_id": "PRR_kwDOABII586YZokD",
      "url": null,
      "actor": null,
      "commit_id": "56d5a6a495bfa5da540e9832443ce8f130c4c960",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2556856579",
      "submitted_at": "2025-01-16T17:55:21Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "reviewed",
      "id": 2559952973,
      "node_id": "PRR_kwDOABII586YlchN",
      "url": null,
      "actor": null,
      "commit_id": "3474524ee56dc3d0d009fe1462092ae5d6cbd775",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2559952973",
      "submitted_at": "2025-01-17T21:02:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16005264417,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAO5_PQh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16005264417",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "76a6c9610b61e4b7f86bfff3b60c0ddee0e4ea35",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/76a6c9610b61e4b7f86bfff3b60c0ddee0e4ea35",
      "created_at": "2025-01-20T23:24:37Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGMzOWIzY2ZjZDFiYzUwMDJhYTA2ZDFiNzljOTQ4Y2U5NGYzZWM4ZGM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c39b3cfcd1bc5002aa06d1b79c948ce94f3ec8dc",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c39b3cfcd1bc5002aa06d1b79c948ce94f3ec8dc",
      "tree": {
        "sha": "e17bfa8ed0c5b6e3c0359a29d06d1d1f67f82392",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e17bfa8ed0c5b6e3c0359a29d06d1d1f67f82392"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d73f37dda221835b5109ede1b84db2dc7c4b74a1",
          "sha": "d73f37dda221835b5109ede1b84db2dc7c4b74a1",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d73f37dda221835b5109ede1b84db2dc7c4b74a1"
        }
      ],
      "message": "test: Extra verification that migratewallet migrates",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T00:03:22Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-07T16:34:26Z"
      },
      "sha": "c39b3cfcd1bc5002aa06d1b79c948ce94f3ec8dc"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16005438929,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAO5_53R",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16005438929",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "feb96d8c1c4dfcdf087250a55f893aed0c768398",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/feb96d8c1c4dfcdf087250a55f893aed0c768398",
      "created_at": "2025-01-21T00:03:26Z"
    },
    {
      "event": "commented",
      "id": 2603384536,
      "node_id": "IC_kwDOABII586bLH7Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2603384536",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T00:04:14Z",
      "updated_at": "2025-01-21T00:04:14Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n🚧 At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/35901153066</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#issuecomment-2603384536",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31495"
    },
    {
      "event": "labeled",
      "id": 16005442694,
      "node_id": "LE_lADOABII586jRhxQzwAAAAO5_6yG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16005442694",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T00:04:14Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 16005953698,
      "node_id": "UNLE_lADOABII586jRhxQzwAAAAO6B3ii",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16005953698",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T01:53:11Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2564262259,
      "node_id": "PRR_kwDOABII586Y14lz",
      "url": null,
      "actor": null,
      "commit_id": "feb96d8c1c4dfcdf087250a55f893aed0c768398",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\nMostly happy with feb96d8c1c4dfcdf087250a55f893aed0c768398",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#pullrequestreview-2564262259",
      "submitted_at": "2025-01-21T12:48:46Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGU5MjBhMTVhYWVkZmQyZjVhYzQ2Zjk3YTIxZmQ4ZGM4OGE1OTZhMzU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e920a15aaedfd2f5ac46f97a21fd8dc88a596a35",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e920a15aaedfd2f5ac46f97a21fd8dc88a596a35",
      "tree": {
        "sha": "feeffee5059dec7155c1bf453549654c05ddc289",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/feeffee5059dec7155c1bf453549654c05ddc289"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c39b3cfcd1bc5002aa06d1b79c948ce94f3ec8dc",
          "sha": "c39b3cfcd1bc5002aa06d1b79c948ce94f3ec8dc",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c39b3cfcd1bc5002aa06d1b79c948ce94f3ec8dc"
        }
      ],
      "message": "tests: Test migration of additional P2WSH scripts",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T18:57:15Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-11-16T01:22:18Z"
      },
      "sha": "e920a15aaedfd2f5ac46f97a21fd8dc88a596a35"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGNlNDkyYmU4ZWJmOGIxN2Q0MjlkYzVmM2E1ZjI3YjFjOGJlYzA5OTU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ce492be8ebf8b17d429dc5f3a5f27b1c8bec0995",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/ce492be8ebf8b17d429dc5f3a5f27b1c8bec0995",
      "tree": {
        "sha": "816c07bad150628c5af5f3d2bd93ba24456119bf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/816c07bad150628c5af5f3d2bd93ba24456119bf"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e920a15aaedfd2f5ac46f97a21fd8dc88a596a35",
          "sha": "e920a15aaedfd2f5ac46f97a21fd8dc88a596a35",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e920a15aaedfd2f5ac46f97a21fd8dc88a596a35"
        }
      ],
      "message": "legacy spkm: Move CanProvide to LegacyDataSPKM\n\nThis function will be needed in migration",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T18:57:17Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-13T19:41:00Z"
      },
      "sha": "ce492be8ebf8b17d429dc5f3a5f27b1c8bec0995"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUwODc0ODE1MjcyMjgxZDYxMWFiNGJiMjc0ZmI0NGE3YjQzNDBhYTk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/50874815272281d611ab4bb274fb44a7b4340aa9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/50874815272281d611ab4bb274fb44a7b4340aa9",
      "tree": {
        "sha": "d53e2f70e140997da4ba8d8c74520039e5ae26cd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d53e2f70e140997da4ba8d8c74520039e5ae26cd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ce492be8ebf8b17d429dc5f3a5f27b1c8bec0995",
          "sha": "ce492be8ebf8b17d429dc5f3a5f27b1c8bec0995",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ce492be8ebf8b17d429dc5f3a5f27b1c8bec0995"
        }
      ],
      "message": "legacy spkm: use IsMine() to extract watched output scripts\n\nInstead of (partially) trying to reverse IsMine() to get the output\nscripts that a LegacySPKM would track, we can preserve it in migration\nonly code and utilize it to get an accurate set of output scripts.\n\nThis is accomplished by computing a set of output script candidates from\nmap(Crypted)Keys, mapScripts, and setWatchOnly. This candidate set is an\nupper bound on the scripts tracked by the wallet. Then IsMine() is used\nto filter to the exact output scripts that LegacySPKM would track.\n\nBy changing GetScriptPubKeys() this way, we can avoid complexities in\nreversing IsMine() and get a more complete set of output scripts.",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T19:12:13Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-13T19:41:32Z"
      },
      "sha": "50874815272281d611ab4bb274fb44a7b4340aa9"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUyNTQ1OGYzOGMyOTAyODI2YzkxOTBmN2MzYzJhZTI2Y2Q0MTU5OWY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/525458f38c2902826c9190f7c3c2ae26cd41599f",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/525458f38c2902826c9190f7c3c2ae26cd41599f",
      "tree": {
        "sha": "6ecaf6cfe1256274393aeaf5632e851b1aef9ac4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6ecaf6cfe1256274393aeaf5632e851b1aef9ac4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/50874815272281d611ab4bb274fb44a7b4340aa9",
          "sha": "50874815272281d611ab4bb274fb44a7b4340aa9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/50874815272281d611ab4bb274fb44a7b4340aa9"
        }
      ],
      "message": "migration: Skip descriptors which do not parse\n\nInferDescriptors can sometimes make descriptors which are actually\ninvalid and cannot be parsed. Detect and skip such descriptors by doing\na Parse() check before adding the descriptor to the wallet.",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T19:17:03Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-13T19:45:32Z"
      },
      "sha": "525458f38c2902826c9190f7c3c2ae26cd41599f"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16019159419,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAO60Pl7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16019159419",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "52de36df8ea3bd32cf598dab8391032d2a9b5fda",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/52de36df8ea3bd32cf598dab8391032d2a9b5fda",
      "created_at": "2025-01-21T19:19:56Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDA5NDQyOTgzNzIxMjdlNDk4NTg2ZDA2ZmQyNDU5OWVlNmIyMDZkYzY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0944298372127e498586d06fd24599ee6b206dc6",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0944298372127e498586d06fd24599ee6b206dc6",
      "tree": {
        "sha": "cb646c4fcf94e0a4c2b6f403a74bf2603b29f822",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cb646c4fcf94e0a4c2b6f403a74bf2603b29f822"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/525458f38c2902826c9190f7c3c2ae26cd41599f",
          "sha": "525458f38c2902826c9190f7c3c2ae26cd41599f",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/525458f38c2902826c9190f7c3c2ae26cd41599f"
        }
      ],
      "message": "wallet migration: Determine Solvables with CanProvide\n\nLegacySPKM would determine whether it could provide any script data to a\ntransaction through the use of the CanProvide function. Instead of\npartially reversing signing logic to figure out the output scripts of\nsolvable things, we use the same candidate set approach in\nGetScriptPubKeys() and instead filter the candidate set first for\nthings that are ISMINE_NO, and second with CanProvide(). This should\ngive a more accurate solvables wallet.",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T19:54:49Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-13T19:46:31Z"
      },
      "sha": "0944298372127e498586d06fd24599ee6b206dc6"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGM0MjliYTNjM2EzZmQ5MDIzNTkzYTEyN2MzNmYzZjA0OTdlZWE1ODM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c429ba3c3a3fd9023593a127c36f3f0497eea583",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c429ba3c3a3fd9023593a127c36f3f0497eea583",
      "tree": {
        "sha": "8fff27d1d64c302c7327f8399ea87bc894effa1c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8fff27d1d64c302c7327f8399ea87bc894effa1c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0944298372127e498586d06fd24599ee6b206dc6",
          "sha": "0944298372127e498586d06fd24599ee6b206dc6",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0944298372127e498586d06fd24599ee6b206dc6"
        }
      ],
      "message": "test: Test migration of miniscript in legacy wallets",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T19:54:49Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-13T21:07:10Z"
      },
      "sha": "c429ba3c3a3fd9023593a127c36f3f0497eea583"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI5MWQ0M2JiM2FmNjY0YzgxMmUyNjRjNmEyZTZjMWE0MGJmYThmOGQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b91d43bb3af664c812e264c6a2e6c1a40bfa8f8d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b91d43bb3af664c812e264c6a2e6c1a40bfa8f8d",
      "tree": {
        "sha": "d63a9c9b8f9bc5954aadd0513154de25fd957298",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d63a9c9b8f9bc5954aadd0513154de25fd957298"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c429ba3c3a3fd9023593a127c36f3f0497eea583",
          "sha": "c429ba3c3a3fd9023593a127c36f3f0497eea583",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c429ba3c3a3fd9023593a127c36f3f0497eea583"
        }
      ],
      "message": "test: Test migration of taproot output scripts",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T19:54:49Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-13T21:49:40Z"
      },
      "sha": "b91d43bb3af664c812e264c6a2e6c1a40bfa8f8d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg2YzU0MjgzZjg2MGYzZmViNWM5NmQ0NzBhNzU5MGQyZTg5YjYwMDA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/86c54283f860f3feb5c96d470a7590d2e89b6000",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/86c54283f860f3feb5c96d470a7590d2e89b6000",
      "tree": {
        "sha": "2fa1c903afa846effb10ce472ca098c3b8c57d7a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2fa1c903afa846effb10ce472ca098c3b8c57d7a"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b91d43bb3af664c812e264c6a2e6c1a40bfa8f8d",
          "sha": "b91d43bb3af664c812e264c6a2e6c1a40bfa8f8d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b91d43bb3af664c812e264c6a2e6c1a40bfa8f8d"
        }
      ],
      "message": "test: Test migration of a solvable script with no privkeys\n\nThe legacy wallet will be able to solve output scripts where the\nredeemScript or witnessScript is known, but does not know any of the\nprivate keys involved in that script. These should be migrated to the\nsolvables wallet.",
      "committer": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2025-01-21T19:54:49Z"
      },
      "author": {
        "name": "Ava Chow",
        "email": "github@achow101.com",
        "date": "2024-12-16T20:07:19Z"
      },
      "sha": "86c54283f860f3feb5c96d470a7590d2e89b6000"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16019507652,
      "node_id": "HRFPE_lADOABII586jRhxQzwAAAAO61knE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16019507652",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "commit_url": "https://api.github.com/repos/achow101/bitcoin/commits/86c54283f860f3feb5c96d470a7590d2e89b6000",
      "created_at": "2025-01-21T19:54:53Z"
    },
    {
      "event": "labeled",
      "id": 16019509369,
      "node_id": "LE_lADOABII586jRhxQzwAAAAO61lB5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16019509369",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T19:55:04Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1903312194",
      "pull_request_review_id": 2530939442,
      "id": 1903312194,
      "node_id": "PRRC_kwDOABII585xcj1C",
      "diff_hunk": "@@ -1063,6 +1065,155 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)\n+\n+        def_wallet.sendtoaddress(wsh_pkh_addr, 5)\n+        self.generate(self.nodes[0], 6)\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+\n+        _, wallet = self.migrate_and_get_rpc(\"p2wsh\")\n+\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+        addr_info = wallet.getaddressinfo(wsh_pkh_addr)\n+        assert_equal(addr_info[\"ismine\"], True)\n+        assert_equal(addr_info[\"iswatchonly\"], False)\n+        assert_equal(addr_info[\"solvable\"], True)\n+\n+        wallet.unloadwallet()\n+\n+    def test_disallowed_p2wsh(self):\n+        self.log.info(\"Test that P2WSH output scripts with invalid witnessScripts are not migrated and do not cause migration failure\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"invalid_p2wsh\")\n+\n+        invalid_addrs = []\n+\n+        # For a P2WSH output script stored in the legacy wallet's mapScripts, both the native P2WSH\n+        # and the P2SH-P2WSH are detected by IsMine. We need to verify that descriptors for both\n+        # output scripts are added to the resulting descriptor wallet.\n+        # However, this cannot be done using a multisig as wallet migration treats multisigs specially.\n+        # Instead, this is tested by importing a wsh(pkh()) script. But importing this directly will\n+        # insert the wsh() into setWatchOnly which means that the setWatchOnly migration ends up handling\n+        # this case, which we do not want.\n+        # In order to get the wsh(pkh()) into only mapScripts and not setWatchOnly, we need to utilize\n+        # importmulti and wrap the wsh(pkh()) inside of a sh(). This will insert the sh(wsh(pkh())) into\n+        # setWatchOnly but not the wsh(pkh()).\n+        # Furthermore, migration should not migrate the wsh(pkh()) if the key is uncompressed.\n+        comp_eckey = ECKey()\n+        comp_eckey.generate(compressed=True)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 71,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9c21b8f581542aee0f599f1d8996ac97071bdf6f",
      "in_reply_to_id": null,
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "seems like the picked commit 9c21b8f581542aee0f599f1d8996ac97071bdf6f is out-dated, as this sub-test was already changed to use `generate_keypair` in #30328 (see e.g. https://github.com/bitcoin/bitcoin/pull/30328#discussion_r1878288769)",
      "created_at": "2025-01-05T17:37:04Z",
      "updated_at": "2025-01-05T19:16:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1903312194",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1903312194"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": 1116,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1903322566",
      "pull_request_review_id": 2530939442,
      "id": 1903322566,
      "node_id": "PRRC_kwDOABII585xcmXG",
      "diff_hunk": "@@ -1955,6 +1955,7 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n         std::string desc_str;\n         bool watchonly = !desc->ToPrivateString(*this, desc_str);\n         if (watchonly && !m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+            WalletLogPrintf(\"%s\\n\", desc->ToString());",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "850962d0074683cccbe0f63c864a70e0f31a8caf",
      "in_reply_to_id": null,
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "in commit 850962d0074683cccbe0f63c864a70e0f31a8caf: is this a left-over from debugging or introduced intentionally?",
      "created_at": "2025-01-05T18:56:57Z",
      "updated_at": "2025-01-05T19:16:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1903322566",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1903322566"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1958,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1904565515",
      "pull_request_review_id": 2532847501,
      "id": 1904565515,
      "node_id": "PRRC_kwDOABII585xhV0L",
      "diff_hunk": "@@ -1063,6 +1065,155 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)\n+\n+        def_wallet.sendtoaddress(wsh_pkh_addr, 5)\n+        self.generate(self.nodes[0], 6)\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+\n+        _, wallet = self.migrate_and_get_rpc(\"p2wsh\")\n+\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+        addr_info = wallet.getaddressinfo(wsh_pkh_addr)\n+        assert_equal(addr_info[\"ismine\"], True)\n+        assert_equal(addr_info[\"iswatchonly\"], False)\n+        assert_equal(addr_info[\"solvable\"], True)\n+\n+        wallet.unloadwallet()\n+\n+    def test_disallowed_p2wsh(self):\n+        self.log.info(\"Test that P2WSH output scripts with invalid witnessScripts are not migrated and do not cause migration failure\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"invalid_p2wsh\")\n+\n+        invalid_addrs = []\n+\n+        # For a P2WSH output script stored in the legacy wallet's mapScripts, both the native P2WSH\n+        # and the P2SH-P2WSH are detected by IsMine. We need to verify that descriptors for both\n+        # output scripts are added to the resulting descriptor wallet.\n+        # However, this cannot be done using a multisig as wallet migration treats multisigs specially.\n+        # Instead, this is tested by importing a wsh(pkh()) script. But importing this directly will\n+        # insert the wsh() into setWatchOnly which means that the setWatchOnly migration ends up handling\n+        # this case, which we do not want.\n+        # In order to get the wsh(pkh()) into only mapScripts and not setWatchOnly, we need to utilize\n+        # importmulti and wrap the wsh(pkh()) inside of a sh(). This will insert the sh(wsh(pkh())) into\n+        # setWatchOnly but not the wsh(pkh()).\n+        # Furthermore, migration should not migrate the wsh(pkh()) if the key is uncompressed.\n+        comp_eckey = ECKey()\n+        comp_eckey.generate(compressed=True)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 71,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9c21b8f581542aee0f599f1d8996ac97071bdf6f",
      "in_reply_to_id": 1903312194,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ah, fixed.",
      "created_at": "2025-01-06T19:44:07Z",
      "updated_at": "2025-01-06T19:44:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1904565515",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1904565515"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": 1116,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1904565593",
      "pull_request_review_id": 2532847639,
      "id": 1904565593,
      "node_id": "PRRC_kwDOABII585xhV1Z",
      "diff_hunk": "@@ -1955,6 +1955,7 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n         std::string desc_str;\n         bool watchonly = !desc->ToPrivateString(*this, desc_str);\n         if (watchonly && !m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+            WalletLogPrintf(\"%s\\n\", desc->ToString());",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "850962d0074683cccbe0f63c864a70e0f31a8caf",
      "in_reply_to_id": 1903322566,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Removed",
      "created_at": "2025-01-06T19:44:13Z",
      "updated_at": "2025-01-06T19:44:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1904565593",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1904565593"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1958,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1913418467",
      "pull_request_review_id": 2547082375,
      "id": 1913418467,
      "node_id": "PRRC_kwDOABII585yDHLj",
      "diff_hunk": "@@ -111,7 +112,9 @@ def migrate_and_get_rpc(self, wallet_name, **kwargs):\n         # Migrate, checking that rescan does not occur\n         with self.master_node.assert_debug_log(expected_msgs=[], unexpected_msgs=[\"Rescanning\"]):\n             migrate_info = self.master_node.migratewallet(wallet_name=wallet_name, **kwargs)\n-        return migrate_info, self.master_node.get_wallet_rpc(wallet_name)\n+        rpc = self.master_node.get_wallet_rpc(wallet_name)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 13,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b nit: `wallet =` would be more consistent",
      "created_at": "2025-01-13T15:54:08Z",
      "updated_at": "2025-01-13T17:16:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1913418467",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1913418467"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 115,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1913428791",
      "pull_request_review_id": 2547082375,
      "id": 1913428791,
      "node_id": "PRRC_kwDOABII585yDJs3",
      "diff_hunk": "@@ -1063,6 +1064,151 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)",
      "path": "test/functional/wallet_migration.py",
      "position": 119,
      "original_position": 18,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9452f06a0283299c420a52f6b7f59f484cb60ca3",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "9452f06a0283299c420a52f6b7f59f484cb60ca3 nit: maybe call it `funding_wallet =`, or `default =` for consistency with `test_basic`. Alternatively you could introduce a helper `self.fund(address, amount)`",
      "created_at": "2025-01-13T16:00:43Z",
      "updated_at": "2025-01-13T17:16:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1913428791",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1913428791"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1054,
      "original_line": 1054,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1913528143",
      "pull_request_review_id": 2547082375,
      "id": 1913528143,
      "node_id": "PRRC_kwDOABII585yDh9P",
      "diff_hunk": "@@ -1063,6 +1064,151 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)",
      "path": "test/functional/wallet_migration.py",
      "position": 133,
      "original_position": 29,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9452f06a0283299c420a52f6b7f59f484cb60ca3",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "9452f06a0283299c420a52f6b7f59f484cb60ca3: maybe add a comment to explain what's going on here. In particular why `pkh_script` needs to be imported, even though the legacy wallet tracks a `pkh(pubkey)` for every address you generate.\r\n\r\nIIUC:\r\n- normally the legacy wallet doesn't consider the `wsh(pkh(pubkey))` variant\r\n- It only has `pkh(pubkey)`, `wpkh(pubkey)` and `sh(wpkh(pukey)`\r\n  - but `pkh(pubkey)` is not in `mapScripts` (?) \r\n- The two `importaddress` calls add `pkh(pubkey)` and `wsh(pkh(pubkey))` scripts\r\n  - now `pkh(pubkey)` is in `mapScripts` (?)\r\n- The reason this doesn't end up in the seperate watch-only wallet, i.e. `ismine` and `solvable` below are true and `iswatchonly` is false:\r\n  - magic in the legacy IsMine when asked about `wsh(pkh(pubkey))`\r\n  - it goes through `case TxoutType::WITNESS_V0_SCRIPTHASH:`\r\n  - which looks for the subscript `pkh(pubkey)`, only in `mapScripts`\r\n  - and then recurses into `LegacyWalletIsMineInner` for `pkh(pubkey)`\r\n    -  which identifies it as a PUBKEYHASH, which finds `pubkey` in `mapKeys` and so we know it's spendable ",
      "created_at": "2025-01-13T17:09:23Z",
      "updated_at": "2025-01-13T17:16:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1913528143",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1913528143"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1068,
      "original_line": 1068,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918646257",
      "pull_request_review_id": 2556310008,
      "id": 1918646257,
      "node_id": "PRRC_kwDOABII585yXDfx",
      "diff_hunk": "@@ -111,7 +112,9 @@ def migrate_and_get_rpc(self, wallet_name, **kwargs):\n         # Migrate, checking that rescan does not occur\n         with self.master_node.assert_debug_log(expected_msgs=[], unexpected_msgs=[\"Rescanning\"]):\n             migrate_info = self.master_node.migratewallet(wallet_name=wallet_name, **kwargs)\n-        return migrate_info, self.master_node.get_wallet_rpc(wallet_name)\n+        rpc = self.master_node.get_wallet_rpc(wallet_name)\n+        assert_equal(rpc.getwalletinfo()[\"descriptors\"], True)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 14,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b: Since you're checking the \"descriptors\" field into `migrate_and_get_rpc`, you could also assert the wallet is sqlite and then remove the duplicated code along the test. e.g.:\r\n\r\n```py\r\n_, multisig0 = self.migrate_and_get_rpc(\"multisig0\")\r\nassert_equal(multisig0.getwalletinfo()[\"descriptors\"], True)\r\nself.assert_is_sqlite(\"multisig0\")\r\n```\r\n\r\n```py\r\n_, multisig1 = self.migrate_and_get_rpc(\"multisig1\")\r\nassert_equal(multisig1.getwalletinfo()[\"descriptors\"], True)\r\nself.assert_is_sqlite(\"multisig1\")\r\n```",
      "created_at": "2025-01-16T14:20:48Z",
      "updated_at": "2025-01-16T14:21:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1918646257",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918646257"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918868486",
      "pull_request_review_id": 2556687827,
      "id": 1918868486,
      "node_id": "PRRC_kwDOABII585yX5wG",
      "diff_hunk": "@@ -1063,6 +1064,151 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)",
      "path": "test/functional/wallet_migration.py",
      "position": 133,
      "original_position": 29,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9452f06a0283299c420a52f6b7f59f484cb60ca3",
      "in_reply_to_id": 1913528143,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I had same doubt. I understand that the generated address would be watch-only if we do not import as it's done in the test.",
      "created_at": "2025-01-16T16:38:05Z",
      "updated_at": "2025-01-16T16:38:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1918868486",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918868486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1068,
      "original_line": 1068,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918877108",
      "pull_request_review_id": 2556701280,
      "id": 1918877108,
      "node_id": "PRRC_kwDOABII585yX720",
      "diff_hunk": "@@ -1925,6 +1925,19 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n \n         // InferDescriptor as that will get us all the solving info if it is there\n         std::unique_ptr<Descriptor> desc = InferDescriptor(spk, *GetSolvingProvider(spk));\n+\n+        // Past bugs in InferDescriptor has caused it to create descriptors which cannot be re-parsed\n+        // Re-parse the descriptors to detect that, and skip any that do not parse.\n+        {\n+            std::string desc_str = desc->ToString();\n+            FlatSigningProvider parsed_keys;\n+            std::string parse_error;\n+            std::vector<std::unique_ptr<Descriptor>> parsed_descs = Parse(desc_str, parsed_keys, parse_error, false);",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "0f0ce579fffe533534dc117c854ebef3f277f18e",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "0f0ce579fffe533534dc117c854ebef3f277f18e: nit: No need to set `require_checksum`. It's false by default.",
      "created_at": "2025-01-16T16:43:34Z",
      "updated_at": "2025-01-16T16:43:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1918877108",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918877108"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1935,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918971327",
      "pull_request_review_id": 2556856579,
      "id": 1918971327,
      "node_id": "PRRC_kwDOABII585yYS2_",
      "diff_hunk": "@@ -1209,6 +1209,60 @@ def test_disallowed_p2wsh(self):\n \n         wallet.unloadwallet()\n \n+    def test_miniscript(self):\n+        # It turns out that due to how signing logic works, legacy wallets that have valid miniscript witnessScripts\n+        # and the private keys for them can still sign and spend them, even though output scripts involving them\n+        # as a witnessScript would not be detected as ISMINE_SPENDABLE.\n+        self.log.info(\"Test migration of a legacy wallet containing miniscript\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+        wallet = self.create_legacy_wallet(\"miniscript\")\n+\n+        privkey, _ = generate_keypair(compressed=True, wif=True)\n+\n+        # Make a descriptor where we only have some of the keys. This will be migrated to the watchonly wallet.\n+        some_keys_priv_desc = descsum_create(f\"wsh(or_b(pk({privkey}),s:pk(029ffbe722b147f3035c87cb1c60b9a5947dd49c774cc31e94773478711a929ac0)))\")\n+        some_keys_addr = self.master_node.deriveaddresses(some_keys_priv_desc)[0]\n+\n+        # Make a descriptor where we have all of the keys. This will stay in the migrated wallet\n+        all_keys_priv_desc = descsum_create(f\"wsh(and_v(v:pk({privkey}),1))\")\n+        all_keys_addr = self.master_node.deriveaddresses(all_keys_priv_desc)[0]\n+\n+        imp = wallet.importmulti([\n+            {\n+                \"desc\": some_keys_priv_desc,\n+                \"timestamp\": \"now\",\n+            },\n+            {\n+                \"desc\": all_keys_priv_desc,\n+                \"timestamp\": \"now\",\n+            }\n+        ])\n+        assert_equal(imp[0][\"success\"], True)\n+        assert_equal(imp[1][\"success\"], True)\n+\n+        def_wallet.sendtoaddress(some_keys_addr, 1)\n+        def_wallet.sendtoaddress(all_keys_addr, 1)\n+        self.generate(self.master_node, 6)\n+        # Double check that the miniscript can be spent by the legacy wallet\n+        send_res = wallet.send(outputs=[{some_keys_addr: 1},{all_keys_addr: 0.75}], include_watching=True, change_address=def_wallet.getnewaddress())\n+        assert_equal(send_res[\"complete\"], True)\n+        self.generate(self.old_node, 6)\n+        assert_equal(wallet.getbalances()[\"watchonly\"][\"trusted\"], 1.75)\n+\n+        res, wallet = self.migrate_and_get_rpc(\"miniscript\")",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 44,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "56d5a6a495bfa5da540e9832443ce8f130c4c960",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "56d5a6a495bfa5da540e9832443ce8f130c4c960: nit: `res` is not being used.",
      "created_at": "2025-01-16T17:55:21Z",
      "updated_at": "2025-01-16T17:55:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1918971327",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1918971327"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1252,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1920735492",
      "pull_request_review_id": 2559952973,
      "id": 1920735492,
      "node_id": "PRRC_kwDOABII585yfBkE",
      "diff_hunk": "@@ -1320,6 +1320,34 @@ def test_taproot(self):\n         assert_equal(watchonly.getaddressinfo(tr_addr)[\"ismine\"], True)\n         assert_equal(watchonly.getaddressinfo(tr_script_addr)[\"ismine\"], True)\n \n+    def test_solvable_no_privs(self):\n+        self.log.info(\"Test migrating a multisig that we do not have any private keys for\")\n+        wallet = self.create_legacy_wallet(\"multisig_noprivs\")\n+\n+        privkey, pubkey = generate_keypair(compressed=True, wif=True)\n+\n+        add_ms_res = wallet.addmultisigaddress(nrequired=1, keys=[pubkey.hex()])\n+        addr = add_ms_res[\"address\"]\n+\n+        # The multisig address should be ISMINE_NO but we should have the script info\n+        addr_info = wallet.getaddressinfo(addr)\n+        assert_equal(addr_info[\"ismine\"], False)\n+        assert \"hex\" in addr_info\n+\n+        migrate_res, wallet = self.migrate_and_get_rpc(\"multisig_noprivs\")\n+        assert_equal(migrate_res[\"solvables_name\"], \"multisig_noprivs_solvables\")\n+        solvables = self.master_node.get_wallet_rpc(migrate_res[\"solvables_name\"])\n+\n+        # The multisig should not be in the spendable wallet\n+        addr_info = wallet.getaddressinfo(addr)\n+        assert_equal(addr_info[\"ismine\"], False)\n+        assert \"hex\" not in addr_info\n+\n+        # The multisig address should be in the solvables wallet\n+        addr_info = solvables.getaddressinfo(addr)",
      "path": "test/functional/wallet_migration.py",
      "position": 404,
      "original_position": 28,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "3474524ee56dc3d0d009fe1462092ae5d6cbd775",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "3474524ee56dc3d0d009fe1462092ae5d6cbd775: It should be in the solvables wallet, so we could check it in `getaddressinfo`:\r\n```diff\r\n@@ -1346,6 +1346,7 @@ class WalletMigrationTest(BitcoinTestFramework):\r\n         # The multisig address should be in the solvables wallet\r\n         addr_info = solvables.getaddressinfo(addr)\r\n         assert_equal(addr_info[\"ismine\"], True)\r\n+        assert_equal(addr_info['solvable'], True)\r\n         assert \"hex\" in addr_info\r\n```",
      "created_at": "2025-01-17T21:02:41Z",
      "updated_at": "2025-01-17T21:02:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1920735492",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1920735492"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1339,
      "original_line": 1339,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922902352",
      "pull_request_review_id": 2563224089,
      "id": 1922902352,
      "node_id": "PRRC_kwDOABII585ynSlQ",
      "diff_hunk": "@@ -1063,6 +1064,151 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)",
      "path": "test/functional/wallet_migration.py",
      "position": 119,
      "original_position": 18,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9452f06a0283299c420a52f6b7f59f484cb60ca3",
      "in_reply_to_id": 1913428791,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`def_wallet` is a common name used for several other test cases, I don't think it's necessary to rename it.\r\n\r\nI don't think a `self.fund()` helper would be all that useful considering that this is basically 2 lines, and several tests still need to access the default wallet anyways outside of funding the test wallet.",
      "created_at": "2025-01-20T23:10:11Z",
      "updated_at": "2025-01-20T23:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922902352",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922902352"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1054,
      "original_line": 1054,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922907885",
      "pull_request_review_id": 2563231853,
      "id": 1922907885,
      "node_id": "PRRC_kwDOABII585ynT7t",
      "diff_hunk": "@@ -111,7 +112,9 @@ def migrate_and_get_rpc(self, wallet_name, **kwargs):\n         # Migrate, checking that rescan does not occur\n         with self.master_node.assert_debug_log(expected_msgs=[], unexpected_msgs=[\"Rescanning\"]):\n             migrate_info = self.master_node.migratewallet(wallet_name=wallet_name, **kwargs)\n-        return migrate_info, self.master_node.get_wallet_rpc(wallet_name)\n+        rpc = self.master_node.get_wallet_rpc(wallet_name)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 13,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b",
      "in_reply_to_id": 1913418467,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2025-01-20T23:25:14Z",
      "updated_at": "2025-01-20T23:25:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922907885",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922907885"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 115,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922907952",
      "pull_request_review_id": 2563231940,
      "id": 1922907952,
      "node_id": "PRRC_kwDOABII585ynT8w",
      "diff_hunk": "@@ -1063,6 +1064,151 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)",
      "path": "test/functional/wallet_migration.py",
      "position": 133,
      "original_position": 29,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9452f06a0283299c420a52f6b7f59f484cb60ca3",
      "in_reply_to_id": 1913528143,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Added a comment.",
      "created_at": "2025-01-20T23:25:24Z",
      "updated_at": "2025-01-20T23:25:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922907952",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922907952"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1068,
      "original_line": 1068,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922907977",
      "pull_request_review_id": 2563231999,
      "id": 1922907977,
      "node_id": "PRRC_kwDOABII585ynT9J",
      "diff_hunk": "@@ -111,7 +112,9 @@ def migrate_and_get_rpc(self, wallet_name, **kwargs):\n         # Migrate, checking that rescan does not occur\n         with self.master_node.assert_debug_log(expected_msgs=[], unexpected_msgs=[\"Rescanning\"]):\n             migrate_info = self.master_node.migratewallet(wallet_name=wallet_name, **kwargs)\n-        return migrate_info, self.master_node.get_wallet_rpc(wallet_name)\n+        rpc = self.master_node.get_wallet_rpc(wallet_name)\n+        assert_equal(rpc.getwalletinfo()[\"descriptors\"], True)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 14,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "88b67c95cbc9c3ae75ccbc39e4aba215b9910b8b",
      "in_reply_to_id": 1918646257,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2025-01-20T23:25:28Z",
      "updated_at": "2025-01-20T23:25:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922907977",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922907977"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922908018",
      "pull_request_review_id": 2563232039,
      "id": 1922908018,
      "node_id": "PRRC_kwDOABII585ynT9y",
      "diff_hunk": "@@ -1925,6 +1925,19 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n \n         // InferDescriptor as that will get us all the solving info if it is there\n         std::unique_ptr<Descriptor> desc = InferDescriptor(spk, *GetSolvingProvider(spk));\n+\n+        // Past bugs in InferDescriptor has caused it to create descriptors which cannot be re-parsed\n+        // Re-parse the descriptors to detect that, and skip any that do not parse.\n+        {\n+            std::string desc_str = desc->ToString();\n+            FlatSigningProvider parsed_keys;\n+            std::string parse_error;\n+            std::vector<std::unique_ptr<Descriptor>> parsed_descs = Parse(desc_str, parsed_keys, parse_error, false);",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "0f0ce579fffe533534dc117c854ebef3f277f18e",
      "in_reply_to_id": 1918877108,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2025-01-20T23:25:32Z",
      "updated_at": "2025-01-20T23:25:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922908018",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922908018"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1935,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922908068",
      "pull_request_review_id": 2563232182,
      "id": 1922908068,
      "node_id": "PRRC_kwDOABII585ynT-k",
      "diff_hunk": "@@ -1209,6 +1209,60 @@ def test_disallowed_p2wsh(self):\n \n         wallet.unloadwallet()\n \n+    def test_miniscript(self):\n+        # It turns out that due to how signing logic works, legacy wallets that have valid miniscript witnessScripts\n+        # and the private keys for them can still sign and spend them, even though output scripts involving them\n+        # as a witnessScript would not be detected as ISMINE_SPENDABLE.\n+        self.log.info(\"Test migration of a legacy wallet containing miniscript\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+        wallet = self.create_legacy_wallet(\"miniscript\")\n+\n+        privkey, _ = generate_keypair(compressed=True, wif=True)\n+\n+        # Make a descriptor where we only have some of the keys. This will be migrated to the watchonly wallet.\n+        some_keys_priv_desc = descsum_create(f\"wsh(or_b(pk({privkey}),s:pk(029ffbe722b147f3035c87cb1c60b9a5947dd49c774cc31e94773478711a929ac0)))\")\n+        some_keys_addr = self.master_node.deriveaddresses(some_keys_priv_desc)[0]\n+\n+        # Make a descriptor where we have all of the keys. This will stay in the migrated wallet\n+        all_keys_priv_desc = descsum_create(f\"wsh(and_v(v:pk({privkey}),1))\")\n+        all_keys_addr = self.master_node.deriveaddresses(all_keys_priv_desc)[0]\n+\n+        imp = wallet.importmulti([\n+            {\n+                \"desc\": some_keys_priv_desc,\n+                \"timestamp\": \"now\",\n+            },\n+            {\n+                \"desc\": all_keys_priv_desc,\n+                \"timestamp\": \"now\",\n+            }\n+        ])\n+        assert_equal(imp[0][\"success\"], True)\n+        assert_equal(imp[1][\"success\"], True)\n+\n+        def_wallet.sendtoaddress(some_keys_addr, 1)\n+        def_wallet.sendtoaddress(all_keys_addr, 1)\n+        self.generate(self.master_node, 6)\n+        # Double check that the miniscript can be spent by the legacy wallet\n+        send_res = wallet.send(outputs=[{some_keys_addr: 1},{all_keys_addr: 0.75}], include_watching=True, change_address=def_wallet.getnewaddress())\n+        assert_equal(send_res[\"complete\"], True)\n+        self.generate(self.old_node, 6)\n+        assert_equal(wallet.getbalances()[\"watchonly\"][\"trusted\"], 1.75)\n+\n+        res, wallet = self.migrate_and_get_rpc(\"miniscript\")",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 44,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "56d5a6a495bfa5da540e9832443ce8f130c4c960",
      "in_reply_to_id": 1918971327,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Removed",
      "created_at": "2025-01-20T23:25:38Z",
      "updated_at": "2025-01-20T23:25:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922908068",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922908068"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1252,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922908116",
      "pull_request_review_id": 2563232311,
      "id": 1922908116,
      "node_id": "PRRC_kwDOABII585ynT_U",
      "diff_hunk": "@@ -1320,6 +1320,34 @@ def test_taproot(self):\n         assert_equal(watchonly.getaddressinfo(tr_addr)[\"ismine\"], True)\n         assert_equal(watchonly.getaddressinfo(tr_script_addr)[\"ismine\"], True)\n \n+    def test_solvable_no_privs(self):\n+        self.log.info(\"Test migrating a multisig that we do not have any private keys for\")\n+        wallet = self.create_legacy_wallet(\"multisig_noprivs\")\n+\n+        privkey, pubkey = generate_keypair(compressed=True, wif=True)\n+\n+        add_ms_res = wallet.addmultisigaddress(nrequired=1, keys=[pubkey.hex()])\n+        addr = add_ms_res[\"address\"]\n+\n+        # The multisig address should be ISMINE_NO but we should have the script info\n+        addr_info = wallet.getaddressinfo(addr)\n+        assert_equal(addr_info[\"ismine\"], False)\n+        assert \"hex\" in addr_info\n+\n+        migrate_res, wallet = self.migrate_and_get_rpc(\"multisig_noprivs\")\n+        assert_equal(migrate_res[\"solvables_name\"], \"multisig_noprivs_solvables\")\n+        solvables = self.master_node.get_wallet_rpc(migrate_res[\"solvables_name\"])\n+\n+        # The multisig should not be in the spendable wallet\n+        addr_info = wallet.getaddressinfo(addr)\n+        assert_equal(addr_info[\"ismine\"], False)\n+        assert \"hex\" not in addr_info\n+\n+        # The multisig address should be in the solvables wallet\n+        addr_info = solvables.getaddressinfo(addr)",
      "path": "test/functional/wallet_migration.py",
      "position": 404,
      "original_position": 28,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "3474524ee56dc3d0d009fe1462092ae5d6cbd775",
      "in_reply_to_id": 1920735492,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Added",
      "created_at": "2025-01-20T23:25:42Z",
      "updated_at": "2025-01-20T23:25:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1922908116",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1922908116"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1339,
      "original_line": 1339,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923515986",
      "pull_request_review_id": 2564262259,
      "id": 1923515986,
      "node_id": "PRRC_kwDOABII585ypoZS",
      "diff_hunk": "@@ -1047,6 +1048,154 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        # Legacy single key scripts (i.e. pkh(key) and pk(key)) are not inserted into mapScripts\n+        # automatically, they need to be imported directly if we want to receive to P2WSH (or P2SH)\n+        # wrappings of such scripts.\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)\n+\n+        def_wallet.sendtoaddress(wsh_pkh_addr, 5)\n+        self.generate(self.nodes[0], 6)\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+\n+        _, wallet = self.migrate_and_get_rpc(\"p2wsh\")\n+\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+        addr_info = wallet.getaddressinfo(wsh_pkh_addr)\n+        assert_equal(addr_info[\"ismine\"], True)\n+        assert_equal(addr_info[\"iswatchonly\"], False)\n+        assert_equal(addr_info[\"solvable\"], True)\n+\n+        wallet.unloadwallet()\n+\n+    def test_disallowed_p2wsh(self):\n+        self.log.info(\"Test that P2WSH output scripts with invalid witnessScripts are not migrated and do not cause migration failure\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"invalid_p2wsh\")\n+\n+        invalid_addrs = []\n+\n+        # For a P2WSH output script stored in the legacy wallet's mapScripts, both the native P2WSH\n+        # and the P2SH-P2WSH are detected by IsMine. We need to verify that descriptors for both\n+        # output scripts are added to the resulting descriptor wallet.\n+        # However, this cannot be done using a multisig as wallet migration treats multisigs specially.\n+        # Instead, this is tested by importing a wsh(pkh()) script. But importing this directly will\n+        # insert the wsh() into setWatchOnly which means that the setWatchOnly migration ends up handling\n+        # this case, which we do not want.\n+        # In order to get the wsh(pkh()) into only mapScripts and not setWatchOnly, we need to utilize\n+        # importmulti and wrap the wsh(pkh()) inside of a sh(). This will insert the sh(wsh(pkh())) into\n+        # setWatchOnly but not the wsh(pkh()).\n+        # Furthermore, migration should not migrate the wsh(pkh()) if the key is uncompressed.\n+        comp_wif, comp_pubkey = generate_keypair(compressed=True, wif=True)\n+        comp_pkh_script = key_to_p2pkh_script(comp_pubkey).hex()\n+        comp_wsh_pkh_script = script_to_p2wsh_script(comp_pkh_script).hex()\n+        comp_sh_wsh_pkh_script = script_to_p2sh_script(comp_wsh_pkh_script).hex()\n+        comp_wsh_pkh_addr = script_to_p2wsh(comp_pkh_script)\n+\n+        uncomp_wif, uncomp_pubkey = generate_keypair(compressed=False, wif=True)\n+        uncomp_pkh_script = key_to_p2pkh_script(uncomp_pubkey).hex()\n+        uncomp_wsh_pkh_script = script_to_p2wsh_script(uncomp_pkh_script).hex()\n+        uncomp_sh_wsh_pkh_script = script_to_p2sh_script(uncomp_wsh_pkh_script).hex()\n+        uncomp_wsh_pkh_addr = script_to_p2wsh(uncomp_pkh_script)\n+        invalid_addrs.append(uncomp_wsh_pkh_addr)\n+\n+        import_res = wallet.importmulti([\n+            {\n+                \"scriptPubKey\": comp_sh_wsh_pkh_script,\n+                \"timestamp\": \"now\",\n+                \"redeemscript\": comp_wsh_pkh_script,\n+                \"witnessscript\": comp_pkh_script,\n+                \"keys\": [\n+                    comp_wif,\n+                ],\n+            },\n+            {\n+                \"scriptPubKey\": uncomp_sh_wsh_pkh_script,\n+                \"timestamp\": \"now\",\n+                \"redeemscript\": uncomp_wsh_pkh_script,\n+                \"witnessscript\": uncomp_pkh_script,\n+                \"keys\": [\n+                    uncomp_wif,\n+                ],\n+            },\n+        ])\n+        assert_equal(import_res[0][\"success\"], True)\n+        assert_equal(import_res[1][\"success\"], True)\n+\n+        # Create a wsh(sh(pkh())) - P2SH inside of P2WSH is invalid\n+        comp_sh_pkh_script = script_to_p2sh_script(comp_pkh_script).hex()\n+        wsh_sh_pkh_script = script_to_p2wsh_script(comp_sh_pkh_script).hex()\n+        wsh_sh_pkh_addr = script_to_p2wsh(comp_sh_pkh_script)\n+        invalid_addrs.append(wsh_sh_pkh_addr)\n+\n+        # Import wsh(sh(pkh()))\n+        wallet.importaddress(address=comp_sh_pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_sh_pkh_script, p2sh=False)\n+\n+        # Create a wsh(wsh(pkh())) - P2WSH inside of P2WSH is invalid\n+        wsh_wsh_pkh_script = script_to_p2wsh_script(comp_wsh_pkh_script).hex()\n+        wsh_wsh_pkh_addr = script_to_p2wsh(comp_wsh_pkh_script)\n+        invalid_addrs.append(wsh_wsh_pkh_addr)\n+\n+        # Import wsh(wsh(pkh()))\n+        wallet.importaddress(address=wsh_wsh_pkh_script, p2sh=False)\n+\n+        # The wsh(pkh()) with a compressed key is always valid, so we should see that the wallet detects it as ismine, not\n+        # watchonly, and can provide us information about the witnessScript via \"embedded\"\n+        comp_wsh_pkh_addr_info = wallet.getaddressinfo(comp_wsh_pkh_addr)\n+        assert_equal(comp_wsh_pkh_addr_info[\"ismine\"], True)\n+        assert_equal(comp_wsh_pkh_addr_info[\"iswatchonly\"], False)\n+        assert \"embedded\" in comp_wsh_pkh_addr_info\n+\n+        # The invalid addresses are invalid, so the legcy wallet should not detect them as ismine,\n+        # nor consider them watchonly. However, because the legacy wallet has the witnessScripts/redeemScripts,\n+        # we should see information about those in \"embedded\"\n+        for addr in invalid_addrs:\n+            addr_info = wallet.getaddressinfo(addr)\n+            assert_equal(addr_info[\"ismine\"], False)\n+            assert_equal(addr_info[\"iswatchonly\"], False)\n+            assert \"embedded\" in addr_info\n+\n+        # Fund those output scripts\n+        def_wallet.send([{comp_wsh_pkh_addr: 1}] + [{k: i + 1} for i, k in enumerate(invalid_addrs)])\n+        self.generate(self.nodes[0], 6)\n+        assert_equal(wallet.getbalances()[\"mine\"][\"trusted\"], 1)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 140,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9c0d5856d2065119232bb4ca651391ed829a99d4",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "9c0d5856d2065119232bb4ca651391ed829a99d4: maybe add a comment here that coins sent to invalid addresses won't show up in the destination wallet.\r\n\r\nYou can also add:\r\n\r\n```py\r\nassert_equal(wallet.getbalances()[\"watchonly\"][\"trusted\"], 0)\r\n```\r\n\r\nAnd maybe:\r\n\r\n```py\r\nassert_equal(len(wallet.listtransactions(include_watchonly=True)), 1)\r\n```",
      "created_at": "2025-01-21T11:00:30Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923515986",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923515986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1175,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923553764",
      "pull_request_review_id": 2564262259,
      "id": 1923553764,
      "node_id": "PRRC_kwDOABII585ypxnk",
      "diff_hunk": "@@ -1700,59 +1700,59 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     return set_address;\n }\n \n-std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetScriptPubKeys() const\n+std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetCandidateScriptPubKeys() const\n {\n     LOCK(cs_KeyStore);\n-    std::unordered_set<CScript, SaltedSipHasher> spks;\n+    std::unordered_set<CScript, SaltedSipHasher> candidate_spks;\n \n-    // All keys have at least P2PK and P2PKH\n-    for (const auto& key_pair : mapKeys) {\n-        const CPubKey& pub = key_pair.second.GetPubKey();\n-        spks.insert(GetScriptForRawPubKey(pub));\n-        spks.insert(GetScriptForDestination(PKHash(pub)));\n+    // For every private key in the wallet, there should be a P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 25,
      "original_position": 16,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "936fe5899f9086f99a9a7f05584f467add2bc45b",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "936fe5899f9086f99a9a7f05584f467add2bc45b: should or could? IIUC if we migrate a pre-segwit wallet, then the `IsMine()` check below will throw out `P2WPKH` and `P2SH-P2WPKH`. But the migrated wallet will watch those addresses anyway, because it uses a `combo()` descriptor.\r\n\r\nIf so, it would be good to note that.",
      "created_at": "2025-01-21T11:28:33Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923553764",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923553764"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1708,
      "original_line": 1708,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923574532",
      "pull_request_review_id": 2564262259,
      "id": 1923574532,
      "node_id": "PRRC_kwDOABII585yp2sE",
      "diff_hunk": "@@ -1700,59 +1700,59 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     return set_address;\n }\n \n-std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetScriptPubKeys() const\n+std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetCandidateScriptPubKeys() const\n {\n     LOCK(cs_KeyStore);\n-    std::unordered_set<CScript, SaltedSipHasher> spks;\n+    std::unordered_set<CScript, SaltedSipHasher> candidate_spks;\n \n-    // All keys have at least P2PK and P2PKH\n-    for (const auto& key_pair : mapKeys) {\n-        const CPubKey& pub = key_pair.second.GetPubKey();\n-        spks.insert(GetScriptForRawPubKey(pub));\n-        spks.insert(GetScriptForDestination(PKHash(pub)));\n+    // For every private key in the wallet, there should be a P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH\n+    const auto& add_pubkey = [&candidate_spks](const CPubKey& pub) -> void {\n+        candidate_spks.insert(GetScriptForRawPubKey(pub));\n+        candidate_spks.insert(GetScriptForDestination(PKHash(pub)));\n+\n+        CScript wpkh = GetScriptForDestination(WitnessV0KeyHash(pub));\n+        candidate_spks.insert(wpkh);\n+        candidate_spks.insert(GetScriptForDestination(ScriptHash(wpkh)));\n+    };\n+    for (const auto& [_, key] : mapKeys) {\n+        add_pubkey(key.GetPubKey());\n     }\n-    for (const auto& key_pair : mapCryptedKeys) {\n-        const CPubKey& pub = key_pair.second.first;\n-        spks.insert(GetScriptForRawPubKey(pub));\n-        spks.insert(GetScriptForDestination(PKHash(pub)));\n+    for (const auto& [_, ckeypair] : mapCryptedKeys) {\n+        add_pubkey(ckeypair.first);\n     }\n \n-    // For every script in mapScript, only the ISMINE_SPENDABLE ones are being tracked.\n-    // The watchonly ones will be in setWatchOnly which we deal with later\n-    // For all keys, if they have segwit scripts, those scripts will end up in mapScripts\n-    for (const auto& script_pair : mapScripts) {\n-        const CScript& script = script_pair.second;\n-        if (IsMine(script) == ISMINE_SPENDABLE) {\n-            // Add ScriptHash for scripts that are not already P2SH\n-            if (!script.IsPayToScriptHash()) {\n-                spks.insert(GetScriptForDestination(ScriptHash(script)));\n-            }\n-            // For segwit scripts, we only consider them spendable if we have the segwit spk\n-            int wit_ver = -1;\n-            std::vector<unsigned char> witprog;\n-            if (script.IsWitnessProgram(wit_ver, witprog) && wit_ver == 0) {\n-                spks.insert(script);\n-            }\n-        } else {\n-            // Multisigs are special. They don't show up as ISMINE_SPENDABLE unless they are in a P2SH\n-            // So check the P2SH of a multisig to see if we should insert it\n-            std::vector<std::vector<unsigned char>> sols;\n-            TxoutType type = Solver(script, sols);\n-            if (type == TxoutType::MULTISIG) {\n-                CScript ms_spk = GetScriptForDestination(ScriptHash(script));\n-                if (IsMine(ms_spk) != ISMINE_NO) {\n-                    spks.insert(ms_spk);\n-                }\n-            }\n-        }\n+    // mapScripts contains all redeemScripts and witnessScripts. Therefore each script in it has\n+    // itself, P2SH, P2WSH, and P2SH-P2WSH as a candidate.",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 82,
      "original_position": 65,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "936fe5899f9086f99a9a7f05584f467add2bc45b",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "936fe5899f9086f99a9a7f05584f467add2bc45b: it seems worth noting here that we'll add some p2sh-of-p2sh scripts, but that those will get filtered, so we don't bother with a `script.IsPayToScriptHash()` check.\r\n\r\nDitto for the segwit and multisig checks that are now removed, I think it's worth mentioning that are intentionally added here for simplicity, and then filtered.",
      "created_at": "2025-01-21T11:45:40Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923574532",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923574532"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1725,
      "original_line": 1725,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923583439",
      "pull_request_review_id": 2564262259,
      "id": 1923583439,
      "node_id": "PRRC_kwDOABII585yp43P",
      "diff_hunk": "@@ -1925,6 +1925,19 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n \n         // InferDescriptor as that will get us all the solving info if it is there\n         std::unique_ptr<Descriptor> desc = InferDescriptor(spk, *GetSolvingProvider(spk));\n+\n+        // Past bugs in InferDescriptor has caused it to create descriptors which cannot be re-parsed\n+        // Re-parse the descriptors to detect that, and skip any that do not parse.\n+        {\n+            std::string desc_str = desc->ToString();\n+            FlatSigningProvider parsed_keys;\n+            std::string parse_error;\n+            std::vector<std::unique_ptr<Descriptor>> parsed_descs = Parse(desc_str, parsed_keys, parse_error);\n+            if (parsed_descs.empty()) {",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 131,
      "original_position": 12,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "7d199d062d8794cde46631e61f2c116b9e37f573",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "7d199d062d8794cde46631e61f2c116b9e37f573: why is it safe to not abort the migration over this?\r\n\r\nAlso, won't this hit the `assert(spks.size() == 0);` added by the next commit?",
      "created_at": "2025-01-21T11:52:32Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923583439",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923583439"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1939,
      "original_line": 1939,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923632724",
      "pull_request_review_id": 2564262259,
      "id": 1923632724,
      "node_id": "PRRC_kwDOABII585yqE5U",
      "diff_hunk": "@@ -1987,57 +1987,51 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n         }\n     }\n \n-    // Multisigs are special. They don't show up as ISMINE_SPENDABLE unless they are in a P2SH\n-    // So we have to check if any of our scripts are a multisig and if so, add the P2SH\n-    for (const auto& script_pair : mapScripts) {\n-        const CScript script = script_pair.second;\n+    // Make sure that we have accounted for all scriptPubKeys\n+    assert(spks.size() == 0);\n+\n+    // Legacy wallets can also contains scripts whose P2SH, P2WSH, or P2SH-P2WSH it is not watching for\n+    // but can provide script data to a PSBT spending them. These \"solvable\" output scripts will need to\n+    // be put into the separate \"solvables\" wallet.\n+    // These can be detected by going through the entire candidate output scripts, finding the ISMINE_NO scripts,\n+    // and checking CanProvide() which will dummy sign.\n+    for (const CScript& script : GetCandidateScriptPubKeys()) {\n+        // Since we only care about P2SH, P2WSH, and P2SH-P2WSH, filter out any scripts that are not those\n+        if (!script.IsPayToScriptHash() && !script.IsPayToWitnessScriptHash()) {\n+            continue;\n+        }\n+        if (IsMine(script) != ISMINE_NO) {\n+            continue;\n+        }\n+        SignatureData dummy_sigdata;\n+        if (!CanProvide(script, dummy_sigdata)) {\n+            continue;\n+        }\n \n         // Get birthdate from script meta\n         uint64_t creation_time = 0;\n-        const auto& it = m_script_metadata.find(CScriptID(script));\n-        if (it != m_script_metadata.end()) {\n-            creation_time = it->second.nCreateTime;\n+        const auto& mit = m_script_metadata.find(CScriptID(script));\n+        if (mit != m_script_metadata.end()) {",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "ca0564e02c72ea57d89ec37f0f4948e6a5d0096e",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "ca0564e02c72ea57d89ec37f0f4948e6a5d0096e: you're renaming `it` to `mit` for consistency with above? Not sure if it's helpful though.",
      "created_at": "2025-01-21T12:23:06Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923632724",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923632724"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2014,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923639342",
      "pull_request_review_id": 2564262259,
      "id": 1923639342,
      "node_id": "PRRC_kwDOABII585yqGgu",
      "diff_hunk": "@@ -1987,57 +1987,51 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n         }\n     }\n \n-    // Multisigs are special. They don't show up as ISMINE_SPENDABLE unless they are in a P2SH\n-    // So we have to check if any of our scripts are a multisig and if so, add the P2SH\n-    for (const auto& script_pair : mapScripts) {\n-        const CScript script = script_pair.second;\n+    // Make sure that we have accounted for all scriptPubKeys\n+    assert(spks.size() == 0);\n+\n+    // Legacy wallets can also contains scripts whose P2SH, P2WSH, or P2SH-P2WSH it is not watching for\n+    // but can provide script data to a PSBT spending them. These \"solvable\" output scripts will need to\n+    // be put into the separate \"solvables\" wallet.\n+    // These can be detected by going through the entire candidate output scripts, finding the ISMINE_NO scripts,\n+    // and checking CanProvide() which will dummy sign.\n+    for (const CScript& script : GetCandidateScriptPubKeys()) {\n+        // Since we only care about P2SH, P2WSH, and P2SH-P2WSH, filter out any scripts that are not those\n+        if (!script.IsPayToScriptHash() && !script.IsPayToWitnessScriptHash()) {\n+            continue;\n+        }\n+        if (IsMine(script) != ISMINE_NO) {\n+            continue;\n+        }\n+        SignatureData dummy_sigdata;\n+        if (!CanProvide(script, dummy_sigdata)) {\n+            continue;\n+        }\n \n         // Get birthdate from script meta\n         uint64_t creation_time = 0;\n-        const auto& it = m_script_metadata.find(CScriptID(script));\n-        if (it != m_script_metadata.end()) {\n-            creation_time = it->second.nCreateTime;\n+        const auto& mit = m_script_metadata.find(CScriptID(script));\n+        if (mit != m_script_metadata.end()) {\n+            creation_time = mit->second.nCreateTime;\n         }\n \n-        std::vector<std::vector<unsigned char>> sols;\n-        TxoutType type = Solver(script, sols);\n-        if (type == TxoutType::MULTISIG) {\n-            CScript sh_spk = GetScriptForDestination(ScriptHash(script));\n-            CTxDestination witdest = WitnessV0ScriptHash(script);\n-            CScript witprog = GetScriptForDestination(witdest);\n-            CScript sh_wsh_spk = GetScriptForDestination(ScriptHash(witprog));\n-\n-            // We only want the multisigs that we have not already seen, i.e. they are not watchonly and not spendable",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 184,
      "original_position": 47,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "ca0564e02c72ea57d89ec37f0f4948e6a5d0096e",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "ca0564e02c72ea57d89ec37f0f4948e6a5d0096e: I think it's worth preserving some of this comment, if only to explain to future readers why we went for the `GetCandidateScriptPubKeys() | CanProvide` approach.\r\n\r\nPerhaps in `CanProvide`?",
      "created_at": "2025-01-21T12:26:32Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923639342",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923639342"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1997,
      "original_line": 1997,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923653059",
      "pull_request_review_id": 2564262259,
      "id": 1923653059,
      "node_id": "PRRC_kwDOABII585yqJ3D",
      "diff_hunk": "@@ -1196,6 +1196,60 @@ def test_disallowed_p2wsh(self):\n \n         wallet.unloadwallet()\n \n+    def test_miniscript(self):\n+        # It turns out that due to how signing logic works, legacy wallets that have valid miniscript witnessScripts\n+        # and the private keys for them can still sign and spend them, even though output scripts involving them\n+        # as a witnessScript would not be detected as ISMINE_SPENDABLE.",
      "path": "test/functional/wallet_migration.py",
      "position": 273,
      "original_position": 7,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "e41f47597d86022d5a9947ee0b08151d4336cffc",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "e41f47597d86022d5a9947ee0b08151d4336cffc: Is this only intended for users who called `importmulti` on a legacy wallet? Or could those scripts have ended up in legacy wallets in other ways?\r\n\r\nIf the latter is the case, do you mean that only modern node versions with miniscript support can sign them? Or could pre-miniscript nodes spend them as well? Might be worth illustrating with an older node (< v25?), if the `miniscript ` wallet here can be loaded by that older version.\r\n",
      "created_at": "2025-01-21T12:36:40Z",
      "updated_at": "2025-01-21T12:48:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923653059",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923653059"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1208,
      "original_line": 1208,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923657743",
      "pull_request_review_id": 2564262259,
      "id": 1923657743,
      "node_id": "PRRC_kwDOABII585yqLAP",
      "diff_hunk": "@@ -1196,6 +1196,60 @@ def test_disallowed_p2wsh(self):\n \n         wallet.unloadwallet()\n \n+    def test_miniscript(self):\n+        # It turns out that due to how signing logic works, legacy wallets that have valid miniscript witnessScripts\n+        # and the private keys for them can still sign and spend them, even though output scripts involving them\n+        # as a witnessScript would not be detected as ISMINE_SPENDABLE.\n+        self.log.info(\"Test migration of a legacy wallet containing miniscript\")",
      "path": "test/functional/wallet_migration.py",
      "position": 274,
      "original_position": 8,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "e41f47597d86022d5a9947ee0b08151d4336cffc",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "e41f47597d86022d5a9947ee0b08151d4336cffc: \"containing scripts matching miniscript\" / \"containing scripts imported from miniscript\"?",
      "created_at": "2025-01-21T12:39:50Z",
      "updated_at": "2025-01-21T12:50:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1923657743",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1923657743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1209,
      "original_line": 1209,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924134722",
      "pull_request_review_id": 2565308406,
      "id": 1924134722,
      "node_id": "PRRC_kwDOABII585yr_dC",
      "diff_hunk": "@@ -1925,6 +1925,19 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n \n         // InferDescriptor as that will get us all the solving info if it is there\n         std::unique_ptr<Descriptor> desc = InferDescriptor(spk, *GetSolvingProvider(spk));\n+\n+        // Past bugs in InferDescriptor has caused it to create descriptors which cannot be re-parsed\n+        // Re-parse the descriptors to detect that, and skip any that do not parse.\n+        {\n+            std::string desc_str = desc->ToString();\n+            FlatSigningProvider parsed_keys;\n+            std::string parse_error;\n+            std::vector<std::unique_ptr<Descriptor>> parsed_descs = Parse(desc_str, parsed_keys, parse_error);\n+            if (parsed_descs.empty()) {",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 131,
      "original_position": 12,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "7d199d062d8794cde46631e61f2c116b9e37f573",
      "in_reply_to_id": 1923583439,
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> Also, won't this hit the `assert(spks.size() == 0);` added by the next commit?\r\n\r\nWas also wondering about this. IIUC, we can't directly `continue` here, but would need execute the \"`// Remove the scriptPubKeys from our current set`\" loop below for also for skipped output scripts, as otherwise the set isn't empty and the assertion throws. Would be good to have test coverage for the skipping scenario, but I presume that isn't possible, as we'd need to intentionally modify the behaviour of `InferDescriptor` only for the test (to re-introduce past bugs that caused this)?",
      "created_at": "2025-01-21T17:36:22Z",
      "updated_at": "2025-01-21T17:36:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924134722",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924134722"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1939,
      "original_line": 1939,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924202539",
      "pull_request_review_id": 2565421658,
      "id": 1924202539,
      "node_id": "PRRC_kwDOABII585ysQAr",
      "diff_hunk": "@@ -1700,59 +1700,59 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     return set_address;\n }\n \n-std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetScriptPubKeys() const\n+std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetCandidateScriptPubKeys() const\n {\n     LOCK(cs_KeyStore);\n-    std::unordered_set<CScript, SaltedSipHasher> spks;\n+    std::unordered_set<CScript, SaltedSipHasher> candidate_spks;\n \n-    // All keys have at least P2PK and P2PKH\n-    for (const auto& key_pair : mapKeys) {\n-        const CPubKey& pub = key_pair.second.GetPubKey();\n-        spks.insert(GetScriptForRawPubKey(pub));\n-        spks.insert(GetScriptForDestination(PKHash(pub)));\n+    // For every private key in the wallet, there should be a P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 25,
      "original_position": 16,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "936fe5899f9086f99a9a7f05584f467add2bc45b",
      "in_reply_to_id": 1923553764,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Should, because loading a legacy wallet will add the P2WPKH script to `mapScripts` for all keys, regardless of pre or post segwit. This is done in memory only, on loading.",
      "created_at": "2025-01-21T18:34:37Z",
      "updated_at": "2025-01-21T18:34:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924202539",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924202539"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1708,
      "original_line": 1708,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924211960",
      "pull_request_review_id": 2565437878,
      "id": 1924211960,
      "node_id": "PRRC_kwDOABII585ysST4",
      "diff_hunk": "@@ -1196,6 +1196,60 @@ def test_disallowed_p2wsh(self):\n \n         wallet.unloadwallet()\n \n+    def test_miniscript(self):\n+        # It turns out that due to how signing logic works, legacy wallets that have valid miniscript witnessScripts\n+        # and the private keys for them can still sign and spend them, even though output scripts involving them\n+        # as a witnessScript would not be detected as ISMINE_SPENDABLE.",
      "path": "test/functional/wallet_migration.py",
      "position": 273,
      "original_position": 7,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "e41f47597d86022d5a9947ee0b08151d4336cffc",
      "in_reply_to_id": 1923653059,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I believe the only way is through `importmulti`.\r\n\r\nVersions without miniscript cannot sign for miniscript. I feel like that's obvious and we don't need a test for that.",
      "created_at": "2025-01-21T18:43:18Z",
      "updated_at": "2025-01-21T18:43:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924211960",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924211960"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1208,
      "original_line": 1208,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924212782",
      "pull_request_review_id": 2565439206,
      "id": 1924212782,
      "node_id": "PRRC_kwDOABII585ysSgu",
      "diff_hunk": "@@ -1196,6 +1196,60 @@ def test_disallowed_p2wsh(self):\n \n         wallet.unloadwallet()\n \n+    def test_miniscript(self):\n+        # It turns out that due to how signing logic works, legacy wallets that have valid miniscript witnessScripts\n+        # and the private keys for them can still sign and spend them, even though output scripts involving them\n+        # as a witnessScript would not be detected as ISMINE_SPENDABLE.\n+        self.log.info(\"Test migration of a legacy wallet containing miniscript\")",
      "path": "test/functional/wallet_migration.py",
      "position": 274,
      "original_position": 8,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "e41f47597d86022d5a9947ee0b08151d4336cffc",
      "in_reply_to_id": 1923657743,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Miniscript is a subset of script. Definitionally, a miniscript is also a script, so this sentence is correct.",
      "created_at": "2025-01-21T18:44:03Z",
      "updated_at": "2025-01-21T18:44:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924212782",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924212782"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1209,
      "original_line": 1209,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924251495",
      "pull_request_review_id": 2565505475,
      "id": 1924251495,
      "node_id": "PRRC_kwDOABII585ysb9n",
      "diff_hunk": "@@ -1987,57 +1987,51 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n         }\n     }\n \n-    // Multisigs are special. They don't show up as ISMINE_SPENDABLE unless they are in a P2SH\n-    // So we have to check if any of our scripts are a multisig and if so, add the P2SH\n-    for (const auto& script_pair : mapScripts) {\n-        const CScript script = script_pair.second;\n+    // Make sure that we have accounted for all scriptPubKeys\n+    assert(spks.size() == 0);\n+\n+    // Legacy wallets can also contains scripts whose P2SH, P2WSH, or P2SH-P2WSH it is not watching for\n+    // but can provide script data to a PSBT spending them. These \"solvable\" output scripts will need to\n+    // be put into the separate \"solvables\" wallet.\n+    // These can be detected by going through the entire candidate output scripts, finding the ISMINE_NO scripts,\n+    // and checking CanProvide() which will dummy sign.\n+    for (const CScript& script : GetCandidateScriptPubKeys()) {\n+        // Since we only care about P2SH, P2WSH, and P2SH-P2WSH, filter out any scripts that are not those\n+        if (!script.IsPayToScriptHash() && !script.IsPayToWitnessScriptHash()) {\n+            continue;\n+        }\n+        if (IsMine(script) != ISMINE_NO) {\n+            continue;\n+        }\n+        SignatureData dummy_sigdata;\n+        if (!CanProvide(script, dummy_sigdata)) {\n+            continue;\n+        }\n \n         // Get birthdate from script meta\n         uint64_t creation_time = 0;\n-        const auto& it = m_script_metadata.find(CScriptID(script));\n-        if (it != m_script_metadata.end()) {\n-            creation_time = it->second.nCreateTime;\n+        const auto& mit = m_script_metadata.find(CScriptID(script));\n+        if (mit != m_script_metadata.end()) {\n+            creation_time = mit->second.nCreateTime;\n         }\n \n-        std::vector<std::vector<unsigned char>> sols;\n-        TxoutType type = Solver(script, sols);\n-        if (type == TxoutType::MULTISIG) {\n-            CScript sh_spk = GetScriptForDestination(ScriptHash(script));\n-            CTxDestination witdest = WitnessV0ScriptHash(script);\n-            CScript witprog = GetScriptForDestination(witdest);\n-            CScript sh_wsh_spk = GetScriptForDestination(ScriptHash(witprog));\n-\n-            // We only want the multisigs that we have not already seen, i.e. they are not watchonly and not spendable",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 184,
      "original_position": 47,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "ca0564e02c72ea57d89ec37f0f4948e6a5d0096e",
      "in_reply_to_id": 1923639342,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't think any part of this comment is relevant to the current code.",
      "created_at": "2025-01-21T19:19:36Z",
      "updated_at": "2025-01-21T19:19:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924251495",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924251495"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1997,
      "original_line": 1997,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924252155",
      "pull_request_review_id": 2565506403,
      "id": 1924252155,
      "node_id": "PRRC_kwDOABII585yscH7",
      "diff_hunk": "@@ -1047,6 +1048,154 @@ def test_manual_keys_import(self):\n         assert_equal(expected_descs, migrated_desc)\n         wo_wallet.unloadwallet()\n \n+    def test_p2wsh(self):\n+        self.log.info(\"Test that non-multisig P2WSH output scripts are migrated\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"p2wsh\")\n+\n+        # Craft wsh(pkh(key))\n+        pubkey = wallet.getaddressinfo(wallet.getnewaddress())[\"pubkey\"]\n+        pkh_script = key_to_p2pkh_script(pubkey).hex()\n+        wsh_pkh_script = script_to_p2wsh_script(pkh_script).hex()\n+        wsh_pkh_addr = script_to_p2wsh(pkh_script)\n+\n+        # Legacy single key scripts (i.e. pkh(key) and pk(key)) are not inserted into mapScripts\n+        # automatically, they need to be imported directly if we want to receive to P2WSH (or P2SH)\n+        # wrappings of such scripts.\n+        wallet.importaddress(address=pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_pkh_script, p2sh=False)\n+\n+        def_wallet.sendtoaddress(wsh_pkh_addr, 5)\n+        self.generate(self.nodes[0], 6)\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+\n+        _, wallet = self.migrate_and_get_rpc(\"p2wsh\")\n+\n+        assert_equal(wallet.getbalances()['mine']['trusted'], 5)\n+        addr_info = wallet.getaddressinfo(wsh_pkh_addr)\n+        assert_equal(addr_info[\"ismine\"], True)\n+        assert_equal(addr_info[\"iswatchonly\"], False)\n+        assert_equal(addr_info[\"solvable\"], True)\n+\n+        wallet.unloadwallet()\n+\n+    def test_disallowed_p2wsh(self):\n+        self.log.info(\"Test that P2WSH output scripts with invalid witnessScripts are not migrated and do not cause migration failure\")\n+        def_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n+\n+        wallet = self.create_legacy_wallet(\"invalid_p2wsh\")\n+\n+        invalid_addrs = []\n+\n+        # For a P2WSH output script stored in the legacy wallet's mapScripts, both the native P2WSH\n+        # and the P2SH-P2WSH are detected by IsMine. We need to verify that descriptors for both\n+        # output scripts are added to the resulting descriptor wallet.\n+        # However, this cannot be done using a multisig as wallet migration treats multisigs specially.\n+        # Instead, this is tested by importing a wsh(pkh()) script. But importing this directly will\n+        # insert the wsh() into setWatchOnly which means that the setWatchOnly migration ends up handling\n+        # this case, which we do not want.\n+        # In order to get the wsh(pkh()) into only mapScripts and not setWatchOnly, we need to utilize\n+        # importmulti and wrap the wsh(pkh()) inside of a sh(). This will insert the sh(wsh(pkh())) into\n+        # setWatchOnly but not the wsh(pkh()).\n+        # Furthermore, migration should not migrate the wsh(pkh()) if the key is uncompressed.\n+        comp_wif, comp_pubkey = generate_keypair(compressed=True, wif=True)\n+        comp_pkh_script = key_to_p2pkh_script(comp_pubkey).hex()\n+        comp_wsh_pkh_script = script_to_p2wsh_script(comp_pkh_script).hex()\n+        comp_sh_wsh_pkh_script = script_to_p2sh_script(comp_wsh_pkh_script).hex()\n+        comp_wsh_pkh_addr = script_to_p2wsh(comp_pkh_script)\n+\n+        uncomp_wif, uncomp_pubkey = generate_keypair(compressed=False, wif=True)\n+        uncomp_pkh_script = key_to_p2pkh_script(uncomp_pubkey).hex()\n+        uncomp_wsh_pkh_script = script_to_p2wsh_script(uncomp_pkh_script).hex()\n+        uncomp_sh_wsh_pkh_script = script_to_p2sh_script(uncomp_wsh_pkh_script).hex()\n+        uncomp_wsh_pkh_addr = script_to_p2wsh(uncomp_pkh_script)\n+        invalid_addrs.append(uncomp_wsh_pkh_addr)\n+\n+        import_res = wallet.importmulti([\n+            {\n+                \"scriptPubKey\": comp_sh_wsh_pkh_script,\n+                \"timestamp\": \"now\",\n+                \"redeemscript\": comp_wsh_pkh_script,\n+                \"witnessscript\": comp_pkh_script,\n+                \"keys\": [\n+                    comp_wif,\n+                ],\n+            },\n+            {\n+                \"scriptPubKey\": uncomp_sh_wsh_pkh_script,\n+                \"timestamp\": \"now\",\n+                \"redeemscript\": uncomp_wsh_pkh_script,\n+                \"witnessscript\": uncomp_pkh_script,\n+                \"keys\": [\n+                    uncomp_wif,\n+                ],\n+            },\n+        ])\n+        assert_equal(import_res[0][\"success\"], True)\n+        assert_equal(import_res[1][\"success\"], True)\n+\n+        # Create a wsh(sh(pkh())) - P2SH inside of P2WSH is invalid\n+        comp_sh_pkh_script = script_to_p2sh_script(comp_pkh_script).hex()\n+        wsh_sh_pkh_script = script_to_p2wsh_script(comp_sh_pkh_script).hex()\n+        wsh_sh_pkh_addr = script_to_p2wsh(comp_sh_pkh_script)\n+        invalid_addrs.append(wsh_sh_pkh_addr)\n+\n+        # Import wsh(sh(pkh()))\n+        wallet.importaddress(address=comp_sh_pkh_script, p2sh=False)\n+        wallet.importaddress(address=wsh_sh_pkh_script, p2sh=False)\n+\n+        # Create a wsh(wsh(pkh())) - P2WSH inside of P2WSH is invalid\n+        wsh_wsh_pkh_script = script_to_p2wsh_script(comp_wsh_pkh_script).hex()\n+        wsh_wsh_pkh_addr = script_to_p2wsh(comp_wsh_pkh_script)\n+        invalid_addrs.append(wsh_wsh_pkh_addr)\n+\n+        # Import wsh(wsh(pkh()))\n+        wallet.importaddress(address=wsh_wsh_pkh_script, p2sh=False)\n+\n+        # The wsh(pkh()) with a compressed key is always valid, so we should see that the wallet detects it as ismine, not\n+        # watchonly, and can provide us information about the witnessScript via \"embedded\"\n+        comp_wsh_pkh_addr_info = wallet.getaddressinfo(comp_wsh_pkh_addr)\n+        assert_equal(comp_wsh_pkh_addr_info[\"ismine\"], True)\n+        assert_equal(comp_wsh_pkh_addr_info[\"iswatchonly\"], False)\n+        assert \"embedded\" in comp_wsh_pkh_addr_info\n+\n+        # The invalid addresses are invalid, so the legcy wallet should not detect them as ismine,\n+        # nor consider them watchonly. However, because the legacy wallet has the witnessScripts/redeemScripts,\n+        # we should see information about those in \"embedded\"\n+        for addr in invalid_addrs:\n+            addr_info = wallet.getaddressinfo(addr)\n+            assert_equal(addr_info[\"ismine\"], False)\n+            assert_equal(addr_info[\"iswatchonly\"], False)\n+            assert \"embedded\" in addr_info\n+\n+        # Fund those output scripts\n+        def_wallet.send([{comp_wsh_pkh_addr: 1}] + [{k: i + 1} for i, k in enumerate(invalid_addrs)])\n+        self.generate(self.nodes[0], 6)\n+        assert_equal(wallet.getbalances()[\"mine\"][\"trusted\"], 1)",
      "path": "test/functional/wallet_migration.py",
      "position": null,
      "original_position": 140,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "9c0d5856d2065119232bb4ca651391ed829a99d4",
      "in_reply_to_id": 1923515986,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2025-01-21T19:20:09Z",
      "updated_at": "2025-01-21T19:20:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924252155",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924252155"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1175,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924252349",
      "pull_request_review_id": 2565506701,
      "id": 1924252349,
      "node_id": "PRRC_kwDOABII585yscK9",
      "diff_hunk": "@@ -1700,59 +1700,59 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     return set_address;\n }\n \n-std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetScriptPubKeys() const\n+std::unordered_set<CScript, SaltedSipHasher> LegacyDataSPKM::GetCandidateScriptPubKeys() const\n {\n     LOCK(cs_KeyStore);\n-    std::unordered_set<CScript, SaltedSipHasher> spks;\n+    std::unordered_set<CScript, SaltedSipHasher> candidate_spks;\n \n-    // All keys have at least P2PK and P2PKH\n-    for (const auto& key_pair : mapKeys) {\n-        const CPubKey& pub = key_pair.second.GetPubKey();\n-        spks.insert(GetScriptForRawPubKey(pub));\n-        spks.insert(GetScriptForDestination(PKHash(pub)));\n+    // For every private key in the wallet, there should be a P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH\n+    const auto& add_pubkey = [&candidate_spks](const CPubKey& pub) -> void {\n+        candidate_spks.insert(GetScriptForRawPubKey(pub));\n+        candidate_spks.insert(GetScriptForDestination(PKHash(pub)));\n+\n+        CScript wpkh = GetScriptForDestination(WitnessV0KeyHash(pub));\n+        candidate_spks.insert(wpkh);\n+        candidate_spks.insert(GetScriptForDestination(ScriptHash(wpkh)));\n+    };\n+    for (const auto& [_, key] : mapKeys) {\n+        add_pubkey(key.GetPubKey());\n     }\n-    for (const auto& key_pair : mapCryptedKeys) {\n-        const CPubKey& pub = key_pair.second.first;\n-        spks.insert(GetScriptForRawPubKey(pub));\n-        spks.insert(GetScriptForDestination(PKHash(pub)));\n+    for (const auto& [_, ckeypair] : mapCryptedKeys) {\n+        add_pubkey(ckeypair.first);\n     }\n \n-    // For every script in mapScript, only the ISMINE_SPENDABLE ones are being tracked.\n-    // The watchonly ones will be in setWatchOnly which we deal with later\n-    // For all keys, if they have segwit scripts, those scripts will end up in mapScripts\n-    for (const auto& script_pair : mapScripts) {\n-        const CScript& script = script_pair.second;\n-        if (IsMine(script) == ISMINE_SPENDABLE) {\n-            // Add ScriptHash for scripts that are not already P2SH\n-            if (!script.IsPayToScriptHash()) {\n-                spks.insert(GetScriptForDestination(ScriptHash(script)));\n-            }\n-            // For segwit scripts, we only consider them spendable if we have the segwit spk\n-            int wit_ver = -1;\n-            std::vector<unsigned char> witprog;\n-            if (script.IsWitnessProgram(wit_ver, witprog) && wit_ver == 0) {\n-                spks.insert(script);\n-            }\n-        } else {\n-            // Multisigs are special. They don't show up as ISMINE_SPENDABLE unless they are in a P2SH\n-            // So check the P2SH of a multisig to see if we should insert it\n-            std::vector<std::vector<unsigned char>> sols;\n-            TxoutType type = Solver(script, sols);\n-            if (type == TxoutType::MULTISIG) {\n-                CScript ms_spk = GetScriptForDestination(ScriptHash(script));\n-                if (IsMine(ms_spk) != ISMINE_NO) {\n-                    spks.insert(ms_spk);\n-                }\n-            }\n-        }\n+    // mapScripts contains all redeemScripts and witnessScripts. Therefore each script in it has\n+    // itself, P2SH, P2WSH, and P2SH-P2WSH as a candidate.",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 82,
      "original_position": 65,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "936fe5899f9086f99a9a7f05584f467add2bc45b",
      "in_reply_to_id": 1923574532,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Expanded the comment a bit.",
      "created_at": "2025-01-21T19:20:18Z",
      "updated_at": "2025-01-21T19:20:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924252349",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924252349"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1725,
      "original_line": 1725,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924252703",
      "pull_request_review_id": 2565507234,
      "id": 1924252703,
      "node_id": "PRRC_kwDOABII585yscQf",
      "diff_hunk": "@@ -1925,6 +1925,19 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n \n         // InferDescriptor as that will get us all the solving info if it is there\n         std::unique_ptr<Descriptor> desc = InferDescriptor(spk, *GetSolvingProvider(spk));\n+\n+        // Past bugs in InferDescriptor has caused it to create descriptors which cannot be re-parsed\n+        // Re-parse the descriptors to detect that, and skip any that do not parse.\n+        {\n+            std::string desc_str = desc->ToString();\n+            FlatSigningProvider parsed_keys;\n+            std::string parse_error;\n+            std::vector<std::unique_ptr<Descriptor>> parsed_descs = Parse(desc_str, parsed_keys, parse_error);\n+            if (parsed_descs.empty()) {",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": 131,
      "original_position": 12,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "7d199d062d8794cde46631e61f2c116b9e37f573",
      "in_reply_to_id": 1923583439,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Changed this to also delete the offending script from `spks`.",
      "created_at": "2025-01-21T19:20:37Z",
      "updated_at": "2025-01-21T19:20:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924252703",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924252703"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1939,
      "original_line": 1939,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924253038",
      "pull_request_review_id": 2565507780,
      "id": 1924253038,
      "node_id": "PRRC_kwDOABII585yscVu",
      "diff_hunk": "@@ -1987,57 +1987,51 @@ std::optional<MigrationData> LegacyDataSPKM::MigrateToDescriptor()\n         }\n     }\n \n-    // Multisigs are special. They don't show up as ISMINE_SPENDABLE unless they are in a P2SH\n-    // So we have to check if any of our scripts are a multisig and if so, add the P2SH\n-    for (const auto& script_pair : mapScripts) {\n-        const CScript script = script_pair.second;\n+    // Make sure that we have accounted for all scriptPubKeys\n+    assert(spks.size() == 0);\n+\n+    // Legacy wallets can also contains scripts whose P2SH, P2WSH, or P2SH-P2WSH it is not watching for\n+    // but can provide script data to a PSBT spending them. These \"solvable\" output scripts will need to\n+    // be put into the separate \"solvables\" wallet.\n+    // These can be detected by going through the entire candidate output scripts, finding the ISMINE_NO scripts,\n+    // and checking CanProvide() which will dummy sign.\n+    for (const CScript& script : GetCandidateScriptPubKeys()) {\n+        // Since we only care about P2SH, P2WSH, and P2SH-P2WSH, filter out any scripts that are not those\n+        if (!script.IsPayToScriptHash() && !script.IsPayToWitnessScriptHash()) {\n+            continue;\n+        }\n+        if (IsMine(script) != ISMINE_NO) {\n+            continue;\n+        }\n+        SignatureData dummy_sigdata;\n+        if (!CanProvide(script, dummy_sigdata)) {\n+            continue;\n+        }\n \n         // Get birthdate from script meta\n         uint64_t creation_time = 0;\n-        const auto& it = m_script_metadata.find(CScriptID(script));\n-        if (it != m_script_metadata.end()) {\n-            creation_time = it->second.nCreateTime;\n+        const auto& mit = m_script_metadata.find(CScriptID(script));\n+        if (mit != m_script_metadata.end()) {",
      "path": "src/wallet/scriptpubkeyman.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "86c54283f860f3feb5c96d470a7590d2e89b6000",
      "original_commit_id": "ca0564e02c72ea57d89ec37f0f4948e6a5d0096e",
      "in_reply_to_id": 1923632724,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Reverted",
      "created_at": "2025-01-21T19:20:55Z",
      "updated_at": "2025-01-21T19:20:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31495#discussion_r1924253038",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924253038"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31495"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2014,
      "side": "RIGHT"
    }
  ]
}