{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703",
    "id": 2290692434,
    "node_id": "PR_kwDOABII586IiTFS",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31703",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31703.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31703.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31703",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31703/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/15619a1c99f6cc815291adf150bb8049c75a91cc",
    "number": 31703,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "Use number of dirty cache entries in flush warnings/logs",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "Since #28280 and #28233, the percentage of dirty entries in the cache when a flush happen may in practice be far from 100%. The log output, the decision to warn about a large flush (#31534), and the disk-full detection, however always use the entire size of the cache.\r\n\r\nFix this by keeping track of the number of dirty entries in `CCoinsViewCache`, and using that number. I've dropped the usage of `DynamicMemoryUsage` as it's the wrong metric, even before the non-wiping flushes were introduced (if everything is dirty, memory usage is correlated with, but not the same as, the amount of disk space written or used). They could be improved by keeping track of proper write size estimates in a follow-up, but here I'm just using a fixed 48 bytes per entry estimate.",
    "labels": [
      {
        "id": 241832923,
        "node_id": "MDU6TGFiZWwyNDE4MzI5MjM=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs",
        "name": "Utils/log/libs",
        "description": "",
        "color": "5319e7",
        "default": false
      }
    ],
    "created_at": "2025-01-21T19:27:26Z",
    "updated_at": "2025-03-21T07:39:58Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "24e3e74a91fc2bc60c487755b4e77830a454b18c",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "sipa:202501_dirty_coin_count",
      "ref": "202501_dirty_coin_count",
      "sha": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1458655,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDU4NjU1",
        "name": "bitcoin",
        "full_name": "sipa/bitcoin",
        "owner": {
          "login": "sipa",
          "id": 548488,
          "node_id": "MDQ6VXNlcjU0ODQ4OA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sipa",
          "html_url": "https://github.com/sipa",
          "followers_url": "https://api.github.com/users/sipa/followers",
          "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
          "organizations_url": "https://api.github.com/users/sipa/orgs",
          "repos_url": "https://api.github.com/users/sipa/repos",
          "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sipa/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/sipa/bitcoin",
        "description": "Bitcoin integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sipa/bitcoin",
        "archive_url": "https://api.github.com/repos/sipa/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sipa/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sipa/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sipa/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sipa/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sipa/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sipa/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sipa/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sipa/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sipa/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sipa/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sipa/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sipa/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sipa/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sipa/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sipa/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sipa/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sipa/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sipa/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sipa/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sipa/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sipa/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sipa/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sipa/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sipa/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sipa/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sipa/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sipa/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sipa/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sipa/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sipa/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sipa/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sipa/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sipa/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sipa/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sipa/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sipa/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sipa/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sipa/bitcoin/hooks",
        "svn_url": "https://github.com/sipa/bitcoin",
        "homepage": "http://www.bitcoin.org",
        "language": "TypeScript",
        "forks_count": 20,
        "stargazers_count": 90,
        "watchers_count": 90,
        "size": 258155,
        "default_branch": "lows",
        "open_issues_count": 16,
        "is_template": false,
        "topics": [],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-03-20T21:20:08Z",
        "created_at": "2011-03-09T10:46:59Z",
        "updated_at": "2025-02-27T11:11:39Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "78fa88c53ad88639ed3a52b810870caff652be2e",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36939,
        "stargazers_count": 82563,
        "watchers_count": 82563,
        "size": 278636,
        "default_branch": "master",
        "open_issues_count": 682,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-03-21T07:34:34Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-03-21T07:34:40Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 50,
    "deletions": 15,
    "changed_files": 5,
    "commits": 2,
    "review_comments": 58,
    "comments": 4
  },
  "events": [
    {
      "event": "commented",
      "id": 2605565260,
      "node_id": "IC_kwDOABII586bTcVM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2605565260",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T19:27:29Z",
      "updated_at": "2025-03-21T07:39:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31703.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/31703#issuecomment-2605622412), [andrewtoth](https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2565615706), [l0rinc](https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2566967750), [tdb3](https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2568482558) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31132](https://github.com/bitcoin/bitcoin/pull/31132) (validation: fetch block inputs on parallel threads 10% faster IBD by andrewtoth)\n* [#30673](https://github.com/bitcoin/bitcoin/pull/30673) (coins: remove logic for spent-and-FRESH cache entries and writing non-DIRTY entries by andrewtoth)\n* [#30611](https://github.com/bitcoin/bitcoin/pull/30611) (validation: write chainstate to disk every hour by andrewtoth)\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n* [#28216](https://github.com/bitcoin/bitcoin/pull/28216) (fuzz: a new target for the coins database by darosior)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#issuecomment-2605565260",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31703"
    },
    {
      "event": "renamed",
      "id": 16019240836,
      "node_id": "RTE_lADOABII586nDOVQzwAAAAO60jeE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16019240836",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T19:27:59Z",
      "rename": {
        "from": "202501 dirty coin count",
        "to": "Use number of dirty cache entries in flush warnings/logs"
      }
    },
    {
      "event": "commented",
      "id": 2605622412,
      "node_id": "IC_kwDOABII586bTqSM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2605622412",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T19:59:36Z",
      "updated_at": "2025-01-21T19:59:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "Nice, Concept ACK",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#issuecomment-2605622412",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31703"
    },
    {
      "event": "reviewed",
      "id": 2565615706,
      "node_id": "PRR_kwDOABII586Y7DBa",
      "url": null,
      "actor": null,
      "commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2565615706",
      "submitted_at": "2025-01-21T20:26:28Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16020071935,
      "node_id": "HRFPE_lADOABII586nDOVQzwAAAAO63uX_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16020071935",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4d7c8489cacc540141fe75e79e5f69767775787a",
      "commit_url": "https://api.github.com/repos/sipa/bitcoin/commits/4d7c8489cacc540141fe75e79e5f69767775787a",
      "created_at": "2025-01-21T20:52:36Z"
    },
    {
      "event": "labeled",
      "id": 16021037137,
      "node_id": "LE_lADOABII586nDOVQzwAAAAO67aBR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16021037137",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T22:37:36Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2605882390,
      "node_id": "IC_kwDOABII586bUpwW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2605882390",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-21T22:37:37Z",
      "updated_at": "2025-01-21T22:37:37Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n🚧 At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/35957028069</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#issuecomment-2605882390",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31703"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16023171024,
      "node_id": "HRFPE_lADOABII586nDOVQzwAAAAO7Di_Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16023171024",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "commit_url": "https://api.github.com/repos/sipa/bitcoin/commits/d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "created_at": "2025-01-22T04:21:23Z"
    },
    {
      "event": "unlabeled",
      "id": 16023457393,
      "node_id": "UNLE_lADOABII586nDOVQzwAAAAO7Eo5x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16023457393",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-22T05:06:55Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2566967750,
      "node_id": "PRR_kwDOABII586ZANHG",
      "url": null,
      "actor": null,
      "commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nI have tried reproducing it via AssumeUTXO but the warning is never triggered.\r\nThat's my main concern (it's probably my mistake in the related PR), other than not applying it in other cases where the sizes are displayed.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2566967750",
      "submitted_at": "2025-01-22T14:10:58Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16030581446,
      "node_id": "HRFPE_lADOABII586nDOVQzwAAAAO7f0LG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16030581446",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "56fef1e36f2c2608318b2054a2b7b09e2c1fe62f",
      "commit_url": "https://api.github.com/repos/sipa/bitcoin/commits/56fef1e36f2c2608318b2054a2b7b09e2c1fe62f",
      "created_at": "2025-01-22T15:08:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16030734638,
      "node_id": "HRFPE_lADOABII586nDOVQzwAAAAO7gZku",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16030734638",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "1c892561dcbafaf3c64a7100d776e6f542cd0bf3",
      "commit_url": "https://api.github.com/repos/sipa/bitcoin/commits/1c892561dcbafaf3c64a7100d776e6f542cd0bf3",
      "created_at": "2025-01-22T15:17:40Z"
    },
    {
      "event": "labeled",
      "id": 16030743910,
      "node_id": "LE_lADOABII586nDOVQzwAAAAO7gb1m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16030743910",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-22T15:18:17Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2607527329,
      "node_id": "IC_kwDOABII586ba7Wh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2607527329",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-22T15:18:18Z",
      "updated_at": "2025-01-22T15:18:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n🚧 At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/36002777403</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#issuecomment-2607527329",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31703"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU4NmYyYTZiMWI1M2NiNTczNDJmYTdjMTEzNWYxZWExZTljNjM3MDU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/586f2a6b1b53cb57342fa7c1135f1ea1e9c63705",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/586f2a6b1b53cb57342fa7c1135f1ea1e9c63705",
      "tree": {
        "sha": "b0654b80cbe8f0281f29f970bcdf8309f855ebc7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b0654b80cbe8f0281f29f970bcdf8309f855ebc7"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/78fa88c53ad88639ed3a52b810870caff652be2e",
          "sha": "78fa88c53ad88639ed3a52b810870caff652be2e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/78fa88c53ad88639ed3a52b810870caff652be2e"
        }
      ],
      "message": "coins: keep track of number of dirty entries in cache",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2025-01-22T19:15:52Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2025-01-21T19:02:10Z"
      },
      "sha": "586f2a6b1b53cb57342fa7c1135f1ea1e9c63705"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE1NjE5YTFjOTlmNmNjODE1MjkxYWRmMTUwYmI4MDQ5Yzc1YTkxY2M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/15619a1c99f6cc815291adf150bb8049c75a91cc",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/15619a1c99f6cc815291adf150bb8049c75a91cc",
      "tree": {
        "sha": "aa2ff65536047305f82e4ebf6b4e52e6c77897be",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/aa2ff65536047305f82e4ebf6b4e52e6c77897be"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/586f2a6b1b53cb57342fa7c1135f1ea1e9c63705",
          "sha": "586f2a6b1b53cb57342fa7c1135f1ea1e9c63705",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/586f2a6b1b53cb57342fa7c1135f1ea1e9c63705"
        }
      ],
      "message": "validation: use dirty coins count in flush warnings",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2025-01-22T19:15:52Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2025-01-21T19:20:54Z"
      },
      "sha": "15619a1c99f6cc815291adf150bb8049c75a91cc"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16033778274,
      "node_id": "HRFPE_lADOABII586nDOVQzwAAAAO7sApi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16033778274",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "commit_url": "https://api.github.com/repos/sipa/bitcoin/commits/15619a1c99f6cc815291adf150bb8049c75a91cc",
      "created_at": "2025-01-22T19:15:58Z"
    },
    {
      "event": "reviewed",
      "id": 2568482558,
      "node_id": "PRR_kwDOABII586ZF-7-",
      "url": null,
      "actor": null,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK for now.\r\nMakes sense to ensure warnings use a more accurate data point (`m_dirty_count`). Helps prevent a \"chicken little\" effect.",
      "user": {
        "login": "tdb3",
        "id": 106488469,
        "node_id": "U_kgDOBljilQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/106488469?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tdb3",
        "html_url": "https://github.com/tdb3",
        "followers_url": "https://api.github.com/users/tdb3/followers",
        "following_url": "https://api.github.com/users/tdb3/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/tdb3/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/tdb3/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/tdb3/subscriptions",
        "organizations_url": "https://api.github.com/users/tdb3/orgs",
        "repos_url": "https://api.github.com/users/tdb3/repos",
        "events_url": "https://api.github.com/users/tdb3/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/tdb3/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2568482558",
      "submitted_at": "2025-01-22T23:12:29Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
    },
    {
      "event": "unsubscribed",
      "id": 16129555620,
      "node_id": "UE_lADOABII586nDOVQzwAAAAPBZXyk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16129555620",
      "actor": {
        "login": "PRADACANDI18",
        "id": 91190628,
        "node_id": "MDQ6VXNlcjkxMTkwNjI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/91190628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PRADACANDI18",
        "html_url": "https://github.com/PRADACANDI18",
        "followers_url": "https://api.github.com/users/PRADACANDI18/followers",
        "following_url": "https://api.github.com/users/PRADACANDI18/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PRADACANDI18/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PRADACANDI18/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PRADACANDI18/subscriptions",
        "organizations_url": "https://api.github.com/users/PRADACANDI18/orgs",
        "repos_url": "https://api.github.com/users/PRADACANDI18/repos",
        "events_url": "https://api.github.com/users/PRADACANDI18/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PRADACANDI18/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-30T20:12:46Z"
    },
    {
      "event": "reviewed",
      "id": 2588328910,
      "node_id": "PRR_kwDOABII586aRsPO",
      "url": null,
      "actor": null,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "I have reviewed it in multiple steps, I have a few remaining questions and concerns, let me know if I can help in any other way.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2588328910",
      "submitted_at": "2025-02-01T14:00:54Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
    },
    {
      "event": "unlabeled",
      "id": 16163915178,
      "node_id": "UNLE_lADOABII586nDOVQzwAAAAPDccWq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16163915178",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-03T15:07:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 16562065095,
      "node_id": "LE_lADOABII586nDOVQzwAAAAPbLQ7H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16562065095",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-04T14:16:09Z",
      "label": {
        "name": "Utils/log/libs",
        "color": "5319e7"
      }
    },
    {
      "event": "reviewed",
      "id": 2620965099,
      "node_id": "PRR_kwDOABII586cOMDr",
      "url": null,
      "actor": null,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "After our last discussion (and with the new AssumeUTXO included) I've rebased and re-reviewed and added examples to my suggestions to simplify the review.\r\n\r\nMy remaining concerns are that AssumeUTXO doesn't warn in the same way as other dumps do, a few leftover refactoring misses, redundant calculation now that we have a dirty count, missing code coverage for modified code, a leftover memory accounting bug in affected area, and a few code nits to make the change less surprising.\r\n\r\n<details>\r\n<summary>Suggestions</summary>\r\n\r\n```patch\r\ndiff --git a/src/coins.cpp b/src/coins.cpp\r\nindex 30d82e1d08..b126622490 100644\r\n--- a/src/coins.cpp\r\n+++ b/src/coins.cpp\r\n@@ -113,10 +113,11 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\r\n }\r\n \r\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\r\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\r\n+    const auto mem_usage{coin.DynamicMemoryUsage()};\r\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\r\n     if (inserted) {\r\n         CCoinsCacheEntry::SetDirty(*it, m_sentinel);\r\n+        cachedCoinsUsage += mem_usage;\r\n         ++m_dirty_count;\r\n     }\r\n }\r\n@@ -245,8 +246,8 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\r\n                 }\r\n                 cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\r\n                 if (!itUs->second.IsDirty()) {\r\n-                    ++m_dirty_count;\r\n                     CCoinsCacheEntry::SetDirty(*itUs, m_sentinel);\r\n+                    ++m_dirty_count;\r\n                 }\r\n                 // NOTE: It isn't safe to mark the coin as FRESH in the parent\r\n                 // cache. If it already existed and was spent in the parent\r\n@@ -342,7 +343,7 @@ void CCoinsViewCache::SanityCheck() const\r\n         // Recompute cachedCoinsUsage.\r\n         recomputed_usage += entry.coin.DynamicMemoryUsage();\r\n \r\n-        // Recompute m_num_dirty;\r\n+        // Recompute m_dirty_count.\r\n         dirty_count += entry.IsDirty();\r\n \r\n         // Count the number of entries we expect in the linked list.\r\ndiff --git a/src/coins.h b/src/coins.h\r\nindex f897bce749..474cf77fdb 100644\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -272,11 +272,11 @@ struct CoinsViewCacheCursor\r\n     //! Calling CCoinsMap::clear() afterwards is faster because a CoinsCachePair cannot be coerced back into a\r\n     //! CCoinsMap::iterator to be erased, and must therefore be looked up again by key in the CCoinsMap before being erased.\r\n     CoinsViewCacheCursor(size_t& usage LIFETIMEBOUND,\r\n-                        size_t& dirty LIFETIMEBOUND,\r\n-                        CoinsCachePair& sentinel LIFETIMEBOUND,\r\n-                        CCoinsMap& map LIFETIMEBOUND,\r\n-                        bool will_erase) noexcept\r\n-        : m_usage(usage), m_dirty(dirty), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}\r\n+                         size_t& dirty_count LIFETIMEBOUND,\r\n+                         CoinsCachePair& sentinel LIFETIMEBOUND,\r\n+                         CCoinsMap& map LIFETIMEBOUND,\r\n+                         bool will_erase) noexcept\r\n+        : m_usage(usage), m_dirty_count(dirty_count), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}\r\n \r\n     inline CoinsCachePair* Begin() const noexcept { return m_sentinel.second.Next(); }\r\n     inline CoinsCachePair* End() const noexcept { return &m_sentinel; }\r\n@@ -285,7 +285,7 @@ struct CoinsViewCacheCursor\r\n     inline CoinsCachePair* NextAndMaybeErase(CoinsCachePair& current) noexcept\r\n     {\r\n         const auto next_entry{current.second.Next()};\r\n-        m_dirty -= current.second.IsDirty();\r\n+        m_dirty_count -= current.second.IsDirty();\r\n         // If we are not going to erase the cache, we must still erase spent entries.\r\n         // Otherwise, clear the state of the entry.\r\n         if (!m_will_erase) {\r\n@@ -300,9 +300,11 @@ struct CoinsViewCacheCursor\r\n     }\r\n \r\n     inline bool WillErase(CoinsCachePair& current) const noexcept { return m_will_erase || current.second.coin.IsSpent(); }\r\n+    size_t GetDirtyCount() const noexcept { return m_dirty_count; }\r\n+\r\n private:\r\n     size_t& m_usage;\r\n-    size_t& m_dirty;\r\n+    size_t& m_dirty_count;\r\n     CoinsCachePair& m_sentinel;\r\n     CCoinsMap& m_map;\r\n     bool m_will_erase;\r\ndiff --git a/src/test/coins_tests.cpp b/src/test/coins_tests.cpp\r\nindex 261859ff9a..0cef222024 100644\r\n--- a/src/test/coins_tests.cpp\r\n+++ b/src/test/coins_tests.cpp\r\n@@ -99,8 +99,8 @@ public:\r\n \r\n     CCoinsMap& map() const { return cacheCoins; }\r\n     CoinsCachePair& sentinel() const { return m_sentinel; }\r\n-    size_t& usage() const { return cachedCoinsUsage; }\r\n-    size_t& GetDirtyCount() const { return m_dirty_count; }\r\n+    void AddUsage(size_t usage) const { cachedCoinsUsage += usage; }\r\n+    void AddDirtyCount(size_t count) const { m_dirty_count += count; }\r\n };\r\n \r\n } // namespace\r\n@@ -197,8 +197,11 @@ void SimulationTest(CCoinsView* base, bool fake_best_block)\r\n                     (coin.IsSpent() ? added_an_entry : updated_an_entry) = true;\r\n                     coin = newcoin;\r\n                 }\r\n-                bool is_overwrite = !coin.IsSpent() || m_rng.rand32() & 1;\r\n-                stack.back()->AddCoin(COutPoint(txid, 0), std::move(newcoin), is_overwrite);\r\n+                if (COutPoint op(txid, 0); !stack.back()->map().contains(op) && !(coin.IsSpent() || (m_rng.rand32() & 1))) {\r\n+                    stack.back()->EmplaceCoinInternalDANGER(std::move(op), std::move(newcoin));\r\n+                } else {\r\n+                    stack.back()->AddCoin(std::move(op), std::move(newcoin), /*possible_overwrite=*/(!coin.IsSpent() || (m_rng.rand32() & 1)));\r\n+                }\r\n             } else {\r\n                 // Spend the coin.\r\n                 removed_an_entry = true;\r\n@@ -653,8 +656,8 @@ static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\r\n     CCoinsMapMemoryResource resource;\r\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\r\n     auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\r\n-    size_t dirty = cache_coin ? cache_coin->IsDirty() : 0;\r\n-    auto cursor{CoinsViewCacheCursor(usage, dirty, sentinel, map, /*will_erase=*/true)};\r\n+    size_t dirty_count = cache_coin ? cache_coin->IsDirty() : 0;\r\n+    auto cursor{CoinsViewCacheCursor(usage, dirty_count, sentinel, map, /*will_erase=*/true)};\r\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\r\n }\r\n \r\n@@ -666,8 +669,8 @@ public:\r\n         auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\r\n         WriteCoinsViewEntry(base, base_cache_coin);\r\n         if (cache_coin) {\r\n-            cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\r\n-            cache.GetDirtyCount() += cache_coin->IsDirty();\r\n+            cache.AddUsage(InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin));\r\n+            cache.AddDirtyCount(cache_coin->IsDirty());\r\n         }\r\n     }\r\n \r\ndiff --git a/src/test/fuzz/coins_view.cpp b/src/test/fuzz/coins_view.cpp\r\nindex a9b91b9efe..64cec03fd5 100644\r\n--- a/src/test/fuzz/coins_view.cpp\r\n+++ b/src/test/fuzz/coins_view.cpp\r\n@@ -123,7 +123,7 @@ FUZZ_TARGET(coins_view, .init = initialize_coins_view)\r\n                 CoinsCachePair sentinel{};\r\n                 sentinel.second.SelfRef(sentinel);\r\n                 size_t usage{0};\r\n-                size_t num_dirty{0};\r\n+                size_t dirty_count{0};\r\n                 CCoinsMapMemoryResource resource;\r\n                 CCoinsMap coins_map{0, SaltedOutpointHasher{/*deterministic=*/true}, CCoinsMap::key_equal{}, &resource};\r\n                 LIMITED_WHILE(good_data && fuzzed_data_provider.ConsumeBool(), 10'000)\r\n@@ -145,11 +145,11 @@ FUZZ_TARGET(coins_view, .init = initialize_coins_view)\r\n                     if (dirty) CCoinsCacheEntry::SetDirty(*it, sentinel);\r\n                     if (fresh) CCoinsCacheEntry::SetFresh(*it, sentinel);\r\n                     usage += it->second.coin.DynamicMemoryUsage();\r\n-                    num_dirty += dirty;\r\n+                    dirty_count += dirty;\r\n                 }\r\n                 bool expected_code_path = false;\r\n                 try {\r\n-                    auto cursor{CoinsViewCacheCursor(usage, num_dirty, sentinel, coins_map, /*will_erase=*/true)};\r\n+                    auto cursor{CoinsViewCacheCursor(usage, dirty_count, sentinel, coins_map, /*will_erase=*/true)};\r\n                     coins_view_cache.BatchWrite(cursor, fuzzed_data_provider.ConsumeBool() ? ConsumeUInt256(fuzzed_data_provider) : coins_view_cache.GetBestBlock());\r\n                     expected_code_path = true;\r\n                 } catch (const std::logic_error& e) {\r\ndiff --git a/src/txdb.cpp b/src/txdb.cpp\r\nindex 1622039d63..9587a62db7 100644\r\n--- a/src/txdb.cpp\r\n+++ b/src/txdb.cpp\r\n@@ -25,6 +25,9 @@ static constexpr uint8_t DB_HEAD_BLOCKS{'H'};\r\n // Keys used in previous version that might still be found in the DB:\r\n static constexpr uint8_t DB_COINS{'c'};\r\n \r\n+// Threshold for warning when writing this many dirty cache entries to disk.\r\n+static constexpr size_t WARN_FLUSH_COINS_COUNT{10'000'000};\r\n+\r\n bool CCoinsViewDB::NeedsUpgrade()\r\n {\r\n     std::unique_ptr<CDBIterator> cursor{m_db->NewIterator()};\r\n@@ -93,6 +96,7 @@ std::vector<uint256> CCoinsViewDB::GetHeadBlocks() const {\r\n bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashBlock) {\r\n     CDBBatch batch(*m_db);\r\n     size_t count = 0;\r\n+    size_t dirty_count{cursor.GetDirtyCount()};\r\n     size_t changed = 0;\r\n     assert(!hashBlock.IsNull());\r\n \r\n@@ -109,6 +113,8 @@ bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashB\r\n         }\r\n     }\r\n \r\n+    if (dirty_count > WARN_FLUSH_COINS_COUNT) LogWarning(\"Flushing large (%d entries) UTXO set to disk, it may take several minutes\", dirty_count);\r\n+\r\n     // In the first batch, mark the database as being in the middle of a\r\n     // transition from old_tip to hashBlock.\r\n     // A vector is used for future extensibility, as we may want to support\r\n@@ -145,9 +151,10 @@ bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashB\r\n     batch.Erase(DB_HEAD_BLOCKS);\r\n     batch.Write(DB_BEST_BLOCK, hashBlock);\r\n \r\n-    LogDebug(BCLog::COINDB, \"Writing final batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n+    LogDebug(BCLog::COINDB, \"Writing final batch of %.2f MiB\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n     bool ret = m_db->WriteBatch(batch);\r\n-    LogDebug(BCLog::COINDB, \"Committed %u changed transaction outputs (out of %u) to coin database...\\n\", (unsigned int)changed, (unsigned int)count);\r\n+    assert(changed == dirty_count); // TODO remove `changed` after all scenarios pass\r\n+    LogDebug(BCLog::COINDB, \"Committed %u changed transaction outputs (out of %u) to coin database...\", (unsigned int)dirty_count, (unsigned int)count);\r\n     return ret;\r\n }\r\n \r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 1f4f2e1ae8..3323a037dc 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -88,8 +88,6 @@ using node::CBlockIndexHeightOnlyComparator;\r\n using node::CBlockIndexWorkComparator;\r\n using node::SnapshotMetadata;\r\n \r\n-/** Threshold for warning when writing this many dirty cache entries to disk. */\r\n-static constexpr size_t WARN_FLUSH_COINS_COUNT = 10'000'000;\r\n /** Time to wait between writing blocks/block index to disk. */\r\n static constexpr std::chrono::hours DATABASE_WRITE_INTERVAL{1};\r\n /** Time to wait between flushing chainstate to disk. */\r\n@@ -2932,7 +2930,6 @@ bool Chainstate::FlushStateToDisk(\r\n         }\r\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\r\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\r\n-            if (coins_dirty_count >= WARN_FLUSH_COINS_COUNT) LogWarning(\"Flushing large (%d entries) UTXO set to disk, it may take several minutes\", coins_dirty_count);\r\n             LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d out of %d cached coins)\",\r\n                 coins_dirty_count, coins_count), BCLog::BENCH);\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#pullrequestreview-2620965099",
      "submitted_at": "2025-03-18T11:54:35Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924316780",
      "pull_request_review_id": 2565615706,
      "id": 1924316780,
      "node_id": "PRRC_kwDOABII585ysr5s",
      "diff_hunk": "@@ -463,6 +468,9 @@ class CCoinsViewCache : public CCoinsViewBacked\n     //! Calculate the size of the cache (in number of transaction outputs)\n     unsigned int GetCacheSize() const;\n \n+    //! Calculate the number of dirty cache entries (transaction outputs)\n+    unsigned int GetDirtyCount() const noexcept { return m_num_dirty; }",
      "path": "src/coins.h",
      "position": null,
      "original_position": 43,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit\r\n```suggestion\r\n    size_t GetDirtyCount() const noexcept { return m_num_dirty; }\r\n```",
      "created_at": "2025-01-21T20:20:21Z",
      "updated_at": "2025-01-21T20:26:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1924316780",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924316780"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 472,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924323177",
      "pull_request_review_id": 2565615706,
      "id": 1924323177,
      "node_id": "PRRC_kwDOABII585ystdp",
      "diff_hunk": "@@ -2953,8 +2954,8 @@ bool Chainstate::FlushStateToDisk(\n             TRACEPOINT(utxocache, flush,\n                    int64_t{Ticks<std::chrono::microseconds>(SteadyClock::now() - nNow)},\n                    (uint32_t)mode,\n-                   (uint64_t)coins_count,\n-                   (uint64_t)coins_mem_usage,",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This tracepoint was previously recording an estimate of memory usage of the entire cache, now it is an estimate of the disk usage of the dirty entries that were just written. Is that what we want to record here?\r\n\r\ncc @0xB10C ",
      "created_at": "2025-01-21T20:26:21Z",
      "updated_at": "2025-01-21T20:26:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1924323177",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924323177"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2957,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924349544",
      "pull_request_review_id": 2565669555,
      "id": 1924349544,
      "node_id": "PRRC_kwDOABII585ysz5o",
      "diff_hunk": "@@ -2953,8 +2954,8 @@ bool Chainstate::FlushStateToDisk(\n             TRACEPOINT(utxocache, flush,\n                    int64_t{Ticks<std::chrono::microseconds>(SteadyClock::now() - nNow)},\n                    (uint32_t)mode,\n-                   (uint64_t)coins_count,\n-                   (uint64_t)coins_mem_usage,",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "in_reply_to_id": 1924323177,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Reverted this change.",
      "created_at": "2025-01-21T20:52:42Z",
      "updated_at": "2025-01-21T20:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1924349544",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924349544"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2957,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924349634",
      "pull_request_review_id": 2565669725,
      "id": 1924349634,
      "node_id": "PRRC_kwDOABII585ysz7C",
      "diff_hunk": "@@ -463,6 +468,9 @@ class CCoinsViewCache : public CCoinsViewBacked\n     //! Calculate the size of the cache (in number of transaction outputs)\n     unsigned int GetCacheSize() const;\n \n+    //! Calculate the number of dirty cache entries (transaction outputs)\n+    unsigned int GetDirtyCount() const noexcept { return m_num_dirty; }",
      "path": "src/coins.h",
      "position": null,
      "original_position": 43,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "in_reply_to_id": 1924316780,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-01-21T20:52:49Z",
      "updated_at": "2025-01-21T20:52:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1924349634",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924349634"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 472,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924549339",
      "pull_request_review_id": 2565977500,
      "id": 1924549339,
      "node_id": "PRRC_kwDOABII585ytkrb",
      "diff_hunk": "@@ -2953,8 +2954,8 @@ bool Chainstate::FlushStateToDisk(\n             TRACEPOINT(utxocache, flush,\n                    int64_t{Ticks<std::chrono::microseconds>(SteadyClock::now() - nNow)},\n                    (uint32_t)mode,\n-                   (uint64_t)coins_count,\n-                   (uint64_t)coins_mem_usage,",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "in_reply_to_id": 1924323177,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Hmm now we need to only declare `coins_mem_usage` if building trace points.",
      "created_at": "2025-01-22T01:02:01Z",
      "updated_at": "2025-01-22T01:02:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1924549339",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1924549339"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2957,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925176427",
      "pull_request_review_id": 2566967750,
      "id": 1925176427,
      "node_id": "PRRC_kwDOABII585yv9xr",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This warning became more useful now - a few questions:\r\n* Would it make sense to mention the coin count and do the warning based on that instead? May be too much information, not sure, it's just an idea:\r\n```C++\r\n“Flushing %s dirty coins to disk...”\r\n```\r\n* If we keep GiB (while `double` is likely still precise enough for the billions range), I wonder if the users are really interested in fraction of GiB here\r\n* The limit for triggering this has changed here - does the `WARN_FLUSH_COINS_SIZE` threshold still make sense?",
      "created_at": "2025-01-22T11:40:41Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925176427",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925176427"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925193678",
      "pull_request_review_id": 2566967750,
      "id": 1925193678,
      "node_id": "PRRC_kwDOABII585ywB_O",
      "diff_hunk": "@@ -377,6 +380,8 @@ class CCoinsViewCache : public CCoinsViewBacked\n \n     /* Cached dynamic memory usage for the inner Coin objects. */\n     mutable size_t cachedCoinsUsage{0};\n+    /* Cached number of dirty Coin objects. */",
      "path": "src/coins.h",
      "position": null,
      "original_position": 33,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We're already in a `Cache` object, maybe we could clarify that this is a running count:\r\n```suggestion\r\n    /* Running count of dirty Coin entries. */\r\n```",
      "created_at": "2025-01-22T11:53:52Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925193678",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925193678"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 383,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925195638",
      "pull_request_review_id": 2566967750,
      "id": 1925195638,
      "node_id": "PRRC_kwDOABII585ywCd2",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I understand that the hard-coded value was here before, and was wondering if we could explain how we got to this magic number (and not mention the value in comments at all since code can express that better), maybe something like:\r\n```C++\r\nstatic constexpr size_t COIN_DISK_USAGE_BYTES{sizeof(Coin)}; // Approximate size on disk\r\n```\r\n\r\n----\r\n\r\nLoading the UTXO set to memory:\r\n> 2025-01-22T11:56:22Z [snapshot] loaded 176948713 (27440 MB) coins from snapshot 0000000000000000000320283a032748cef8227873ff4872689bf23f1cda83a5\r\n\r\n and checking the resulting disk size:\r\n ```bash\r\ndu -sk /Users/lorinc/IdeaProjects/bitcoin/demo/chainstate_snapshot | cut -f1\r\n11524472\r\n```\r\nSuggests we may want to add a ~40% overhead here:\r\n```\r\n((11524472*1024)/176948713)/48\r\n```\r\ni.e.\r\n```C++\r\nstatic constexpr size_t COIN_DISK_USAGE_BYTES{static_cast<size_t>(sizeof(Coin) * 1.4)}; // Approximate size on disk\r\n```",
      "created_at": "2025-01-22T11:55:28Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925195638",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925195638"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2936,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925198387",
      "pull_request_review_id": 2566967750,
      "id": 1925198387,
      "node_id": "PRRC_kwDOABII585ywDIz",
      "diff_hunk": "@@ -306,6 +317,7 @@ void CCoinsViewCache::ReallocateCache()\n {\n     // Cache should be empty when we're calling this.\n     assert(cacheCoins.size() == 0);\n+    assert(m_num_dirty == 0);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "given that this is mainly used for logging, do we want to crash the client when this isn't accurate?",
      "created_at": "2025-01-22T11:57:43Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925198387",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925198387"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 320,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925202151",
      "pull_request_review_id": 2566967750,
      "id": 1925202151,
      "node_id": "PRRC_kwDOABII585ywEDn",
      "diff_hunk": "@@ -100,6 +100,7 @@ class CCoinsViewCacheTest : public CCoinsViewCache\n     CCoinsMap& map() const { return cacheCoins; }\n     CoinsCachePair& sentinel() const { return m_sentinel; }\n     size_t& usage() const { return cachedCoinsUsage; }\n+    size_t& GetNumDirty() const { return m_num_dirty; }",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit 1: `num` doesn't obviate what the number represents, just its type. It could mean bytes or count or an int representation of a boolean. Given that in other cases we called this `DirtyCount`, could we use that here as well?\r\nNit 2: not sure it matters, but in other cases here we didn't add the \"Get\" prefix, I don't see the value it adds (and it kinda' gets confusing when we're mutating it in `SingleEntryCacheTest`), might as well trim it I guess.\r\n```suggestion\r\n    size_t& DirtyCount() const { return m_dirty_count; }\r\n```",
      "created_at": "2025-01-22T12:00:51Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925202151",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925202151"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 103,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925215393",
      "pull_request_review_id": 2566967750,
      "id": 1925215393,
      "node_id": "PRRC_kwDOABII585ywHSh",
      "diff_hunk": "@@ -145,6 +151,7 @@ bool CCoinsViewCache::SpendCoin(const COutPoint &outpoint, Coin* moveout) {\n     } else {\n         CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n         it->second.coin.Clear();\n+        ++m_num_dirty;",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Super-nit: `m_num_dirty` increment is related to the `SetDirty` call, not the `Clear` call, if you think it makes sense, we could group them as such (like we do in `EmplaceCoinInternalDANGER` and `BatchWrite`)",
      "created_at": "2025-01-22T12:11:35Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925215393",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925215393"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 154,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925224383",
      "pull_request_review_id": 2566967750,
      "id": 1925224383,
      "node_id": "PRRC_kwDOABII585ywJe_",
      "diff_hunk": "@@ -286,6 +287,7 @@ struct CoinsViewCacheCursor\n         const auto next_entry{current.second.Next()};\n         // If we are not going to erase the cache, we must still erase spent entries.\n         // Otherwise, clear the state of the entry.\n+        if (current.second.IsDirty()) --m_dirty;",
      "path": "src/coins.h",
      "position": null,
      "original_position": 17,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't mind either the conditional increment or the implicit boolean-to-int conversion, but I get distracted when both are used without an easy to understand reason.\r\nUnless there's a good reason here, could we change this to:\r\n```suggestion\r\n        m_dirty -= current.second.IsDirty();\r\n```",
      "created_at": "2025-01-22T12:17:46Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925224383",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925224383"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 290,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925236472",
      "pull_request_review_id": 2566967750,
      "id": 1925236472,
      "node_id": "PRRC_kwDOABII585ywMb4",
      "diff_hunk": "@@ -624,15 +625,15 @@ static void SetCoinsValue(const CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n+static std::pair<size_t, size_t> InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 13,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: it's test code so it's not super-important, but we're basically returning the state of a modified parameter here - seems a bit hacky to me.\r\nI think we could return the same value as before and call `IsDirty()` on the call site, e.g.\r\n```C++\r\nsize_t usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\r\nsize_t dirty{cache_coin->IsDirty()};\r\n```\r\nand\r\n```C++\r\ncache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\r\ncache.GetNumDirty() += cache_coin->IsDirty();\r\n```",
      "created_at": "2025-01-22T12:26:53Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925236472",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925236472"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 628,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925244875",
      "pull_request_review_id": 2566967750,
      "id": 1925244875,
      "node_id": "PRRC_kwDOABII585ywOfL",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Should we make this consistent with `FlushSnapshotToDisk` and `ChainstateManager::PopulateAndValidateSnapshot` as well to log the estimated disk usage based on dirty count instead of `DynamicMemoryUsage`?\r\n```bash\r\n2025-01-22T11:56:22Z FlushSnapshotToDisk: saving snapshot chainstate (27440 MB) started\r\n```\r\n(and maybe use MiB as well to avoid further confusion)\r\nand\r\n```\r\n2025-01-22T11:56:22Z [snapshot] loaded 176948713 (27440 MB)\r\n```",
      "created_at": "2025-01-22T12:33:16Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925244875",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925244875"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925248327",
      "pull_request_review_id": 2566967750,
      "id": 1925248327,
      "node_id": "PRRC_kwDOABII585ywPVH",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));\n+            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d out of %d cached coins)\",\n+                coins_dirty_count, coins_count), BCLog::BENCH);\n+\n             // Pushing a new one to the database can cause it to be written\n             // twice (once in the log, and once in the tables). This is already\n             // an overestimation, as most will delete an existing entry or\n             // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n+            if (!CheckDiskSpace(m_chainman.m_options.datadir, 2 * 2 * approx_disk_usage)) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 29,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Slightly unrelated, but we probably need something similar for memory as well.\r\nCurrently, there's no explicit warning when `-dbcache` is set to a value exceeding available system memory (especially problematic after https://github.com/bitcoin/bitcoin/pull/28358).\r\nA similar warning in this scenario would be very helpful - but likely outside the scope of this PR.\r\n",
      "created_at": "2025-01-22T12:36:04Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925248327",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925248327"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2945,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925303241",
      "pull_request_review_id": 2566967750,
      "id": 1925303241,
      "node_id": "PRRC_kwDOABII585ywcvJ",
      "diff_hunk": "@@ -235,6 +244,7 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\n                     itUs->second.coin = it->second.coin;\n                 }\n                 cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\n+                m_num_dirty += !itUs->second.IsDirty();",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 64,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It took me a while to understand this one - still not sure I follow completely.",
      "created_at": "2025-01-22T13:15:10Z",
      "updated_at": "2025-01-22T14:13:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925303241",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925303241"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 247,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925313702",
      "pull_request_review_id": 2566967750,
      "id": 1925313702,
      "node_id": "PRRC_kwDOABII585ywfSm",
      "diff_hunk": "@@ -78,6 +78,7 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n     bool fresh = false;\n     if (!inserted) {\n         cachedCoinsUsage -= it->second.coin.DynamicMemoryUsage();\n+        m_num_dirty -= it->second.IsDirty();",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We're modifying `m_num_dirty` multiple times in the `AddCoin` method, possibly even cancelling out previous modifications. If it's not too involved, could we calculate the final diff and only update it a single time in this method for clarity? Same applies to `SpendCoin`.",
      "created_at": "2025-01-22T13:22:05Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925313702",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925313702"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 81,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925317571",
      "pull_request_review_id": 2566967750,
      "id": 1925317571,
      "node_id": "PRRC_kwDOABII585ywgPD",
      "diff_hunk": "@@ -343,6 +359,7 @@ void CCoinsViewCache::SanityCheck() const\n     }\n     assert(count_linked == count_flagged);\n     assert(recomputed_usage == cachedCoinsUsage);\n+    assert(num_dirty == m_num_dirty);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 121,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Before we merge I'd like to run a full IBD with `SanityCheck` enabled throughout the code - can you recommend other settings that I should enable?",
      "created_at": "2025-01-22T13:24:39Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925317571",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925317571"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 362,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925347150",
      "pull_request_review_id": 2566967750,
      "id": 1925347150,
      "node_id": "PRRC_kwDOABII585ywndO",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This is likely my mistake in https://github.com/bitcoin/bitcoin/pull/31534, but loading the UTXO set (as described in https://github.com/bitcoin/bitcoin/pull/31645) will call `Flush` via `FlushSnapshotToDisk` at the end (taking a really long time but never warning) https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L5878, reset `m_num_dirty = 0` so when we get to `FlushStateToDisk` (through `ActivateSnapshot`) we're never warning since `coins_dirty_count` is always `0`.",
      "created_at": "2025-01-22T13:44:32Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925347150",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925347150"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925351830",
      "pull_request_review_id": 2566967750,
      "id": 1925351830,
      "node_id": "PRRC_kwDOABII585ywomW",
      "diff_hunk": "@@ -2828,7 +2828,8 @@ bool Chainstate::FlushStateToDisk(\n     bool full_flush_completed = false;\n \n     const size_t coins_count = CoinsTip().GetCacheSize();\n-    const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();\n+    [[maybe_unused]] const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();",
      "path": "src/validation.cpp",
      "position": 16,
      "original_position": 5,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I guess we can't just inline this, but maybe we can guard it with `#ifdef ENABLE_TRACING` alternatively",
      "created_at": "2025-01-22T13:47:25Z",
      "updated_at": "2025-01-22T14:10:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925351830",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925351830"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2831,
      "original_line": 2831,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925432560",
      "pull_request_review_id": 2567397111,
      "id": 1925432560,
      "node_id": "PRRC_kwDOABII585yw8Tw",
      "diff_hunk": "@@ -2953,8 +2954,8 @@ bool Chainstate::FlushStateToDisk(\n             TRACEPOINT(utxocache, flush,\n                    int64_t{Ticks<std::chrono::microseconds>(SteadyClock::now() - nNow)},\n                    (uint32_t)mode,\n-                   (uint64_t)coins_count,\n-                   (uint64_t)coins_mem_usage,",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "19f1f6980200ef1341d1e4bf3c369cca6f439b05",
      "in_reply_to_id": 1924323177,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Added `[[maybe_unused]]`, which seems to suffice.",
      "created_at": "2025-01-22T14:36:48Z",
      "updated_at": "2025-01-22T14:36:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925432560",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925432560"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2957,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925488620",
      "pull_request_review_id": 2567491725,
      "id": 1925488620,
      "node_id": "PRRC_kwDOABII585yxJ_s",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925176427,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I have switched everything to be dirty-count based, rather than size-based.",
      "created_at": "2025-01-22T15:08:29Z",
      "updated_at": "2025-01-22T15:08:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925488620",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925488620"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925488829",
      "pull_request_review_id": 2567492010,
      "id": 1925488829,
      "node_id": "PRRC_kwDOABII585yxKC9",
      "diff_hunk": "@@ -377,6 +380,8 @@ class CCoinsViewCache : public CCoinsViewBacked\n \n     /* Cached dynamic memory usage for the inner Coin objects. */\n     mutable size_t cachedCoinsUsage{0};\n+    /* Cached number of dirty Coin objects. */",
      "path": "src/coins.h",
      "position": null,
      "original_position": 33,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925193678,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-01-22T15:08:36Z",
      "updated_at": "2025-01-22T15:08:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925488829",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925488829"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 383,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925498435",
      "pull_request_review_id": 2567508274,
      "id": 1925498435,
      "node_id": "PRRC_kwDOABII585yxMZD",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925195638,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Estimating sizes of the UTXO set is hard, because these are all very distinct numbers:\r\n* The size on disk in a snapshot of a UTXO set\r\n* The size on disk in the chainstate LevelDB database (the database has different per-entry overhead, prefix compression, bloom filters, ...).\r\n* The amount of data that will be written to disk to flush a number of dirty entries (because e.g. writing a removal/spending of a UTXO temporarily takes up space in the log before it's compacted into the tables)\r\n* The amount of memory a UTXO entry takes up in RAM (as approximated by `DynamicMemoryUsage()`).\r\n\r\nIf we actually care about disk sizes, we should actually try to estimate the thing we care about, and not use snapshot size as a proxy.",
      "created_at": "2025-01-22T15:14:29Z",
      "updated_at": "2025-01-22T15:14:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925498435",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925498435"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2936,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925498660",
      "pull_request_review_id": 2567508672,
      "id": 1925498660,
      "node_id": "PRRC_kwDOABII585yxMck",
      "diff_hunk": "@@ -306,6 +317,7 @@ void CCoinsViewCache::ReallocateCache()\n {\n     // Cache should be empty when we're calling this.\n     assert(cacheCoins.size() == 0);\n+    assert(m_num_dirty == 0);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925198387,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Changed to `Assume`.",
      "created_at": "2025-01-22T15:14:37Z",
      "updated_at": "2025-01-22T15:14:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925498660",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925498660"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 320,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499202",
      "pull_request_review_id": 2567509549,
      "id": 1925499202,
      "node_id": "PRRC_kwDOABII585yxMlC",
      "diff_hunk": "@@ -100,6 +100,7 @@ class CCoinsViewCacheTest : public CCoinsViewCache\n     CCoinsMap& map() const { return cacheCoins; }\n     CoinsCachePair& sentinel() const { return m_sentinel; }\n     size_t& usage() const { return cachedCoinsUsage; }\n+    size_t& GetNumDirty() const { return m_num_dirty; }",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925202151,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Changed to `m_dirty_count` and `GetDirtyCount()` everywhere.",
      "created_at": "2025-01-22T15:14:55Z",
      "updated_at": "2025-01-22T15:14:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925499202",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499202"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 103,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499412",
      "pull_request_review_id": 2567509932,
      "id": 1925499412,
      "node_id": "PRRC_kwDOABII585yxMoU",
      "diff_hunk": "@@ -145,6 +151,7 @@ bool CCoinsViewCache::SpendCoin(const COutPoint &outpoint, Coin* moveout) {\n     } else {\n         CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n         it->second.coin.Clear();\n+        ++m_num_dirty;",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925215393,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-01-22T15:15:04Z",
      "updated_at": "2025-01-22T15:15:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925499412",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499412"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 154,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499564",
      "pull_request_review_id": 2567510229,
      "id": 1925499564,
      "node_id": "PRRC_kwDOABII585yxMqs",
      "diff_hunk": "@@ -286,6 +287,7 @@ struct CoinsViewCacheCursor\n         const auto next_entry{current.second.Next()};\n         // If we are not going to erase the cache, we must still erase spent entries.\n         // Otherwise, clear the state of the entry.\n+        if (current.second.IsDirty()) --m_dirty;",
      "path": "src/coins.h",
      "position": null,
      "original_position": 17,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925224383,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-01-22T15:15:09Z",
      "updated_at": "2025-01-22T15:15:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925499564",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499564"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 290,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499735",
      "pull_request_review_id": 2567510529,
      "id": 1925499735,
      "node_id": "PRRC_kwDOABII585yxMtX",
      "diff_hunk": "@@ -624,15 +625,15 @@ static void SetCoinsValue(const CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n+static std::pair<size_t, size_t> InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 13,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925236472,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-01-22T15:15:15Z",
      "updated_at": "2025-01-22T15:15:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925499735",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925499735"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 628,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925500413",
      "pull_request_review_id": 2567511530,
      "id": 1925500413,
      "node_id": "PRRC_kwDOABII585yxM39",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925244875,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think that can wait for an independent improvement.",
      "created_at": "2025-01-22T15:15:36Z",
      "updated_at": "2025-01-22T15:15:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925500413",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925500413"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925500902",
      "pull_request_review_id": 2567512348,
      "id": 1925500902,
      "node_id": "PRRC_kwDOABII585yxM_m",
      "diff_hunk": "@@ -235,6 +244,7 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\n                     itUs->second.coin = it->second.coin;\n                 }\n                 cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\n+                m_num_dirty += !itUs->second.IsDirty();",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 64,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925303241,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I've reworked it a bit. LMK if it's clearer now.",
      "created_at": "2025-01-22T15:15:55Z",
      "updated_at": "2025-01-22T15:15:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925500902",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925500902"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 247,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925501920",
      "pull_request_review_id": 2567513969,
      "id": 1925501920,
      "node_id": "PRRC_kwDOABII585yxNPg",
      "diff_hunk": "@@ -343,6 +359,7 @@ void CCoinsViewCache::SanityCheck() const\n     }\n     assert(count_linked == count_flagged);\n     assert(recomputed_usage == cachedCoinsUsage);\n+    assert(num_dirty == m_num_dirty);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 121,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925317571,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Anything that involves a reorg would perhaps be interesting to test.",
      "created_at": "2025-01-22T15:16:29Z",
      "updated_at": "2025-01-22T15:16:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925501920",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925501920"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 362,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925502188",
      "pull_request_review_id": 2567514438,
      "id": 1925502188,
      "node_id": "PRRC_kwDOABII585yxNTs",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925347150,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm not familiar with the snapshot code.",
      "created_at": "2025-01-22T15:16:40Z",
      "updated_at": "2025-01-22T15:16:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925502188",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925502188"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925502523",
      "pull_request_review_id": 2567514984,
      "id": 1925502523,
      "node_id": "PRRC_kwDOABII585yxNY7",
      "diff_hunk": "@@ -2828,7 +2828,8 @@ bool Chainstate::FlushStateToDisk(\n     bool full_flush_completed = false;\n \n     const size_t coins_count = CoinsTip().GetCacheSize();\n-    const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();\n+    [[maybe_unused]] const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();",
      "path": "src/validation.cpp",
      "position": 16,
      "original_position": 5,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925351830,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think `[[maybe_unused]]` is fine.",
      "created_at": "2025-01-22T15:16:51Z",
      "updated_at": "2025-01-22T15:16:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925502523",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925502523"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2831,
      "original_line": 2831,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925856487",
      "pull_request_review_id": 2568097485,
      "id": 1925856487,
      "node_id": "PRRC_kwDOABII585yyjzn",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925347150,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I posted the steps to reproduce it at https://github.com/bitcoin/bitcoin/pull/31645 - but we can move this warning to `Flush` in a different PR to make sure it works for `AssumeUTXO` as well.\r\n\r\n---\r\n\r\nChecked that the current PR displays the warning correctly.\r\n\r\n> 2025-01-22T19:20:54Z UpdateTip: new best=0000000000000000000162ce2492545600d6e6780ee22bf464166a4faa28ba28 height=824665 version=0x32000000 log2_work=94.650129 tx=948674213 date='2024-01-06T21:32:54Z' progress=0.822859 cache=9687.2MiB(67719102txo)\r\n...\r\n2025-01-22T19:20:55Z [warning] Flushing large (67721262 entries) UTXO set to disk, it may take several minutes",
      "created_at": "2025-01-22T19:28:39Z",
      "updated_at": "2025-01-22T19:28:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925856487",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925856487"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925859605",
      "pull_request_review_id": 2568102812,
      "id": 1925859605,
      "node_id": "PRRC_kwDOABII585yykkV",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925195638,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I understand that it's complex, but we seem to be off here by 40% - I don't mind if we tackle that in a separate PR/issue and would appreciate your opinion on how to handle this better.",
      "created_at": "2025-01-22T19:31:34Z",
      "updated_at": "2025-01-22T19:31:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925859605",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925859605"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2936,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925863841",
      "pull_request_review_id": 2568109722,
      "id": 1925863841,
      "node_id": "PRRC_kwDOABII585yylmh",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925195638,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't understand why you're looking at snapshot size at all, that's not a good measure of data written. We may be off by a lot more, or a lot less. If we want to do better, we should look at how much is actually written, and then add to CCoinsViewCache a way to predict that number. None of that seems a good fit for this PR, though.",
      "created_at": "2025-01-22T19:35:22Z",
      "updated_at": "2025-01-22T19:38:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925863841",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1925863841"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2936,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1928981459",
      "pull_request_review_id": 2573153241,
      "id": 1928981459,
      "node_id": "PRRC_kwDOABII585y-evT",
      "diff_hunk": "@@ -343,6 +359,7 @@ void CCoinsViewCache::SanityCheck() const\n     }\n     assert(count_linked == count_flagged);\n     assert(recomputed_usage == cachedCoinsUsage);\n+    assert(num_dirty == m_num_dirty);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 121,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925317571,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I ran an IBD until 800k with `-DCMAKE_BUILD_TYPE=Debug` for the current PR (it's *really* slow this way) - no issues found.\r\n\r\n> a reorg would perhaps be interesting to test\r\n\r\nDo we have a way of triggering random reorgs during IBD (at least undo/redo style)?\r\nIf not, would it be helpful to create a PR that adds a hidden `-simulatereorgonibd` argument (similarly to `-dbcrashratio`) that randomly triggers small, temporary reorgs during IBD on `mainnet`? Specifically, at a random height between every ~`[10,000, 100,000]` blocks, we disconnect and reconnect ~`[1, 100]` blocks (favoring smaller counts), performing a `CoinsTip#SanityCheck()` before and after (and maybe validating that we have the UTXOs in cache that will be removed, asserting after undo that they're missing, and revalidating after reapplication that they're back in cache). This would test reorg logic in a semi-realistic scenario - though it wouldn't stress diverging chains, as it reconnects the same blocks.",
      "created_at": "2025-01-24T16:56:09Z",
      "updated_at": "2025-01-24T17:32:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1928981459",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1928981459"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 362,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935978404",
      "pull_request_review_id": 2584526630,
      "id": 1935978404,
      "node_id": "PRRC_kwDOABII585zZK-k",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925347150,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> I'm not familiar with the snapshot code.\r\n\r\nIt seems to me that it may make more sense to move the warning to `CCoinsViewDB::BatchWrite` instead, which could already have `m_dirty` available through the `CoinsViewCacheCursor`, and since it's called from `Flush` and `Sync`, an AssumeUTXO load-and-dump would also trigger the warning (not just an IBD).\r\n\r\nI also don't mind doing it myself in a follow-up, if you think it's a good idea.",
      "created_at": "2025-01-30T17:10:21Z",
      "updated_at": "2025-01-30T17:10:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1935978404",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935978404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935983684",
      "pull_request_review_id": 2584535459,
      "id": 1935983684,
      "node_id": "PRRC_kwDOABII585zZMRE",
      "diff_hunk": "@@ -235,6 +244,7 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\n                     itUs->second.coin = it->second.coin;\n                 }\n                 cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\n+                m_num_dirty += !itUs->second.IsDirty();",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 64,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925303241,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yes, thank you.\r\nThe only remaining nit is that in [other cases we set it dirty first](https://github.com/bitcoin/bitcoin/blob/586f2a6b1b53cb57342fa7c1135f1ea1e9c63705/src/coins.cpp#L103-L104), before incrementing (edit: to obviate that the call doesn't rely on the value of `m_dirty_count`).",
      "created_at": "2025-01-30T17:14:21Z",
      "updated_at": "2025-01-30T17:23:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1935983684",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935983684"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 247,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935992350",
      "pull_request_review_id": 2584550052,
      "id": 1935992350,
      "node_id": "PRRC_kwDOABII585zZOYe",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925195638,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> I don't understand why you're looking at snapshot size\r\n\r\n> not a good measure of data written\r\n\r\n> and not use snapshot size as a proxy\r\n\r\nI understand that the dirty entries in the snapshot are not a perfect representation (except for the AssumeUTXO tests I was doing, which likely skewed my recommendations), but I though it's what we're already doing here when we're calculating \"approx_disk_usage\" from \"coins_dirty_count\".\r\n\r\n> None of that seems a good fit for this PR, though\r\n\r\nI agree, if we want a better representation. But replacing the magic `48` with `sizeof(Coin)` could be. But I'm also fine if not, it's just an alternative that I found.",
      "created_at": "2025-01-30T17:20:40Z",
      "updated_at": "2025-01-30T17:20:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1935992350",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935992350"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2936,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935997972",
      "pull_request_review_id": 2584558967,
      "id": 1935997972,
      "node_id": "PRRC_kwDOABII585zZPwU",
      "diff_hunk": "@@ -2828,7 +2828,8 @@ bool Chainstate::FlushStateToDisk(\n     bool full_flush_completed = false;\n \n     const size_t coins_count = CoinsTip().GetCacheSize();\n-    const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();\n+    [[maybe_unused]] const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();",
      "path": "src/validation.cpp",
      "position": 16,
      "original_position": 5,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925351830,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Sure, though this won't warn us if it actually becomes unused.",
      "created_at": "2025-01-30T17:24:56Z",
      "updated_at": "2025-01-30T17:24:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1935997972",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935997972"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2831,
      "original_line": 2831,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935999555",
      "pull_request_review_id": 2584561502,
      "id": 1935999555,
      "node_id": "PRRC_kwDOABII585zZQJD",
      "diff_hunk": "@@ -343,6 +359,7 @@ void CCoinsViewCache::SanityCheck() const\n     }\n     assert(count_linked == count_flagged);\n     assert(recomputed_usage == cachedCoinsUsage);\n+    assert(num_dirty == m_num_dirty);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 121,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925317571,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Alternatively, we could collect a few hundred stale blocks (found 219 raw blocks so far via https://github.com/bitcoin-data/stale-blocks and https://learnmeabitcoin.com) and create a stale-block-proxy node for end-to-end regression testing of reorgs with historical data:\r\n* A freshly built test node would connect only to this proxy, which would simulate the original chain forks.\r\n* It serves headers & blocks exactly as they were originally seen (without storing them, requesting non-stale ones from the network).\r\n* The proxy pretends a stale block is the tip, letting the test node sync up to it.\r\n* Once the test node reaches that stale block, the proxy sets the next stale block as the new tip, triggering a natural reorg.\r\n\r\nWould that work and be a useful way to test reorg behavior during IBD?",
      "created_at": "2025-01-30T17:26:06Z",
      "updated_at": "2025-01-31T18:42:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1935999555",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1935999555"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 362,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938266129",
      "pull_request_review_id": 2588328910,
      "id": 1938266129,
      "node_id": "PRRC_kwDOABII585zh5gR",
      "diff_hunk": "@@ -100,6 +100,7 @@ class CCoinsViewCacheTest : public CCoinsViewCache\n     CCoinsMap& map() const { return cacheCoins; }\n     CoinsCachePair& sentinel() const { return m_sentinel; }\n     size_t& usage() const { return cachedCoinsUsage; }\n+    size_t& GetDirtyCount() const { return m_dirty_count; }",
      "path": "src/test/coins_tests.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This now hides `GetDirtyCount` in `CCoinsViewCache` with a `size_t` return value (changed to `size_t&` here), used later as `cache.usage() +=` and `cache.GetDirtyCount() +=`.\r\n\r\nTo avoid the confusing override and the method return value assignment, please consider making them explicit setters/adders:\r\n\r\n```C++\r\nvoid AddUsage(size_t usage) const { cachedCoinsUsage += usage; }\r\nvoid AddDirtyCount(size_t count) const { m_dirty_count += count; }\r\n```\r\n\r\n```C++\r\ncache.AddUsage(InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin));\r\ncache.AddDirtyCount(cache_coin->IsDirty());\r\n```",
      "created_at": "2025-02-01T12:20:17Z",
      "updated_at": "2025-02-01T14:00:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938266129",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938266129"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 103,
      "original_line": 103,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938267534",
      "pull_request_review_id": 2588328910,
      "id": 1938267534,
      "node_id": "PRRC_kwDOABII585zh52O",
      "diff_hunk": "@@ -88,8 +88,8 @@ using node::CBlockIndexHeightOnlyComparator;\n using node::CBlockIndexWorkComparator;\n using node::SnapshotMetadata;\n \n-/** Size threshold for warning about slow UTXO set flush to disk. */\n-static constexpr size_t WARN_FLUSH_COINS_SIZE = 1 << 30; // 1 GiB\n+/** Threshold for warning when writing this many dirty cache entries to disk. */\n+static constexpr size_t WARN_FLUSH_COINS_COUNT = 10'000'000;",
      "path": "src/validation.cpp",
      "position": 7,
      "original_position": 7,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "👍 10m seems like a good approximation for the previous value:\r\n\r\n> 2025-01-31T09:45:42Z UpdateTip: new best=0000000000000000cc22cc938f92ecc3a3844f23775c4ad4e66404563c8594c8 height=287000 version=0x00000002 log2_work=76.752105 tx=33340892 date='2014-02-2\r\n1T05:18:42Z' progress=0.028794 cache=1245.8MiB(10004443txo)",
      "created_at": "2025-02-01T12:30:37Z",
      "updated_at": "2025-02-01T14:00:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938267534",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938267534"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 92,
      "original_line": 92,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938269653",
      "pull_request_review_id": 2588328910,
      "id": 1938269653,
      "node_id": "PRRC_kwDOABII585zh6XV",
      "diff_hunk": "@@ -113,7 +115,10 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {",
      "path": "src/coins.cpp",
      "position": 17,
      "original_position": 17,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This change doesn't seem to be covered by `coins_tests` at all.\r\nCan we extend `SimulationTest` to call `stack.back()->EmplaceCoinInternalDANGER` instead of `AddCoin` randomly?\r\n\r\nMaybe something like:\r\n```C++\r\nif (COutPoint op(txid, 0); !stack.back()->map().contains(op) && !(coin.IsSpent() || (m_rng.rand32() & 1))) {\r\n    stack.back()->EmplaceCoinInternalDANGER(std::move(op), std::move(newcoin));\r\n} else {\r\n    stack.back()->AddCoin(std::move(op), std::move(newcoin), /*possible_overwrite=*/(!coin.IsSpent() || (m_rng.rand32() & 1)));\r\n}\r\n```",
      "created_at": "2025-02-01T12:44:58Z",
      "updated_at": "2025-02-01T14:00:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938269653",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938269653"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 115,
      "original_line": 115,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938275296",
      "pull_request_review_id": 2588328910,
      "id": 1938275296,
      "node_id": "PRRC_kwDOABII585zh7vg",
      "diff_hunk": "@@ -113,7 +115,10 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        CCoinsCacheEntry::SetDirty(*it, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 22,
      "original_position": 22,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The documentation of `EmplaceCoinInternalDANGER` claims that:\r\n> Emplace a coin into cacheCoins without performing any checks, marking the emplaced coin as dirty.\r\n\r\nHow come we're updating `cachedCoinsUsage` unconditionally in this method - but `m_dirty_count` only when inserted?",
      "created_at": "2025-02-01T13:23:02Z",
      "updated_at": "2025-02-01T14:00:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938275296",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938275296"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 119,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938281310",
      "pull_request_review_id": 2588343501,
      "id": 1938281310,
      "node_id": "PRRC_kwDOABII585zh9Ne",
      "diff_hunk": "@@ -113,7 +115,10 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        CCoinsCacheEntry::SetDirty(*it, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 22,
      "original_position": 22,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": 1938275296,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "That's a bug from #28280. It should be done conditionally. I fix it in the first commit of #31132. The only caller of this method will not add coins that already exist in the cache though, so it will always enter the `if (inserted)` block.",
      "created_at": "2025-02-01T14:06:11Z",
      "updated_at": "2025-02-01T14:06:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938281310",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938281310"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 119,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938284772",
      "pull_request_review_id": 2588346662,
      "id": 1938284772,
      "node_id": "PRRC_kwDOABII585zh-Dk",
      "diff_hunk": "@@ -113,7 +115,10 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        CCoinsCacheEntry::SetDirty(*it, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 22,
      "original_position": 22,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": 1938275296,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Thanks for validating it, I only noticed it now, when trying to test `EmplaceCoinInternalDANGER` in [SimulationTest](https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938269653)",
      "created_at": "2025-02-01T14:29:55Z",
      "updated_at": "2025-02-01T14:29:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1938284772",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1938284772"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 119,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1958176752",
      "pull_request_review_id": 2620965099,
      "id": 1958176752,
      "node_id": "PRRC_kwDOABII5850t2fw",
      "diff_hunk": "@@ -272,10 +272,11 @@ struct CoinsViewCacheCursor\n     //! Calling CCoinsMap::clear() afterwards is faster because a CoinsCachePair cannot be coerced back into a\n     //! CCoinsMap::iterator to be erased, and must therefore be looked up again by key in the CCoinsMap before being erased.\n     CoinsViewCacheCursor(size_t& usage LIFETIMEBOUND,\n+                        size_t& dirty LIFETIMEBOUND,",
      "path": "src/coins.h",
      "position": 4,
      "original_position": 4,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: parameters slightly unaligned with first parameter",
      "created_at": "2025-02-17T12:47:44Z",
      "updated_at": "2025-03-18T11:54:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1958176752",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1958176752"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 275,
      "original_line": 275,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1958190950",
      "pull_request_review_id": 2620965099,
      "id": 1958190950,
      "node_id": "PRRC_kwDOABII5850t59m",
      "diff_hunk": "@@ -272,10 +272,11 @@ struct CoinsViewCacheCursor\n     //! Calling CCoinsMap::clear() afterwards is faster because a CoinsCachePair cannot be coerced back into a\n     //! CCoinsMap::iterator to be erased, and must therefore be looked up again by key in the CCoinsMap before being erased.\n     CoinsViewCacheCursor(size_t& usage LIFETIMEBOUND,\n+                        size_t& dirty LIFETIMEBOUND,\n                         CoinsCachePair& sentinel LIFETIMEBOUND,\n                         CCoinsMap& map LIFETIMEBOUND,\n                         bool will_erase) noexcept\n-        : m_usage(usage), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}\n+        : m_usage(usage), m_dirty(dirty), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}",
      "path": "src/coins.h",
      "position": 9,
      "original_position": 9,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Do we still need to track [`CCoinsViewDB::BatchWrite#changed`](https://github.com/bitcoin/bitcoin/blob/master/src/txdb.cpp#L96) now that we're tracking dirty count already?\r\nI think we should be able to use the new `m_dirty(_count)` [there](https://github.com/bitcoin/bitcoin/blob/4feaa28728442b0fd29a677d2b170a05fdf967c0/src/txdb.cpp#L150) instead, i.e. something like:\r\n```C++\r\nsize_t dirty_count{cursor.GetDirtyCount()};\r\nsize_t changed{0};\r\n...\r\nif (dirty_count > WARN_FLUSH_COINS_COUNT) LogWarning(\"Flushing large (%d entries) UTXO set to disk, it may take several minutes\", dirty_count);\r\n...\r\nassert(changed == dirty_count); // TODO remove `changed` after all scenarios pass\r\nLogDebug(BCLog::COINDB, \"Committed %u changed transaction outputs (out of %u) to coin database...\", (unsigned int)dirty_count, (unsigned int)count);\r\n```\r\n\r\nFor me locally this passes all tests, quick IBD (ran it with `-dbcache=5 -maxmempool=5 -stopatheight=120000`), reindex and `AssumeUTXO`.",
      "created_at": "2025-02-17T12:58:04Z",
      "updated_at": "2025-03-18T11:54:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1958190950",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1958190950"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 279,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000583711",
      "pull_request_review_id": 2620965099,
      "id": 2000583711,
      "node_id": "PRRC_kwDOABII5853Pnwf",
      "diff_hunk": "@@ -327,6 +342,9 @@ void CCoinsViewCache::SanityCheck() const\n         // Recompute cachedCoinsUsage.\n         recomputed_usage += entry.coin.DynamicMemoryUsage();\n \n+        // Recompute m_num_dirty;",
      "path": "src/coins.cpp",
      "position": 115,
      "original_position": 115,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "[leftover](https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925499202) `num_dirty` (& other comments here end with fullstop)\r\n```suggestion\r\n        // Recompute m_dirty_count.\r\n````",
      "created_at": "2025-03-18T09:31:03Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000583711",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000583711"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 345,
      "original_line": 345,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000616997",
      "pull_request_review_id": 2620965099,
      "id": 2000616997,
      "node_id": "PRRC_kwDOABII5853Pv4l",
      "diff_hunk": "@@ -2931,16 +2932,17 @@ bool Chainstate::FlushStateToDisk(\n         }\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            if (coins_mem_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%d GiB) UTXO set to disk, it may take several minutes\", coins_mem_usage >> 30);\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fKiB)\",\n-                coins_count, coins_mem_usage >> 10), BCLog::BENCH);\n-\n             // Typical Coin structures on disk are around 48 bytes in size.\n+            size_t approx_disk_usage = 48 * coins_dirty_count;\n+            if (approx_disk_usage >= WARN_FLUSH_COINS_SIZE) LogWarning(\"Flushing large (%.1f GiB) UTXO set to disk, it may take several minutes\", double(approx_disk_usage) / (1 << 30));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925347150,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "To clarify, currently AssumeUTXO doesn't display the warning:\r\n```bash\r\n2025-03-18T10:08:47Z [snapshot] 184000000 coins loaded (99.56%, 29332 MB)\r\n2025-03-18T10:08:48Z [snapshot] loaded 184821030 (29456 MB) coins from snapshot 000000000000000000010b17283c3c400507969a9c2afd1dcf2082ec5cca2880\r\n2025-03-18T10:08:48Z FlushSnapshotToDisk: saving snapshot chainstate (29456 MB) started\r\n2025-03-18T10:09:57Z FlushSnapshotToDisk: completed (69461.66ms)\r\n```\r\n\r\nBut if we moved the warning introduced in https://github.com/bitcoin/bitcoin/pull/31534 into to the method that does the actual long operation it would show the warning for AssumeUTXO case as well (i.e. both for Flush and Sync):\r\n```patch\r\ndiff --git a/src/coins.h b/src/coins.h\r\nindex f897bce749..a23b663a1a 100644\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -300,6 +300,7 @@ struct CoinsViewCacheCursor\r\n     }\r\n \r\n     inline bool WillErase(CoinsCachePair& current) const noexcept { return m_will_erase || current.second.coin.IsSpent(); }\r\n+    size_t GetDirtyCount() const noexcept { return m_dirty; }\r\n private:\r\n     size_t& m_usage;\r\n     size_t& m_dirty;\r\ndiff --git a/src/txdb.cpp b/src/txdb.cpp\r\nindex 1622039d63..083cab3279 100644\r\n--- a/src/txdb.cpp\r\n+++ b/src/txdb.cpp\r\n@@ -25,6 +25,9 @@ static constexpr uint8_t DB_HEAD_BLOCKS{'H'};\r\n // Keys used in previous version that might still be found in the DB:\r\n static constexpr uint8_t DB_COINS{'c'};\r\n \r\n+// Threshold for warning when writing this many dirty cache entries to disk.\r\n+static constexpr size_t WARN_FLUSH_COINS_COUNT{10'000'000};\r\n+\r\n bool CCoinsViewDB::NeedsUpgrade()\r\n {\r\n     std::unique_ptr<CDBIterator> cursor{m_db->NewIterator()};\r\n@@ -109,6 +112,8 @@ bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashB\r\n         }\r\n     }\r\n \r\n+    if (cursor.GetDirtyCount() > WARN_FLUSH_COINS_COUNT) LogWarning(\"Flushing large (%d entries) UTXO set to disk, it may take several minutes\", cursor.GetDirtyCount());\r\n+\r\n     // In the first batch, mark the database as being in the middle of a\r\n     // transition from old_tip to hashBlock.\r\n     // A vector is used for future extensibility, as we may want to support\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 1f4f2e1ae8..3323a037dc 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -88,8 +88,6 @@ using node::CBlockIndexHeightOnlyComparator;\r\n using node::CBlockIndexWorkComparator;\r\n using node::SnapshotMetadata;\r\n \r\n-/** Threshold for warning when writing this many dirty cache entries to disk. */\r\n-static constexpr size_t WARN_FLUSH_COINS_COUNT = 10'000'000;\r\n /** Time to wait between writing blocks/block index to disk. */\r\n static constexpr std::chrono::hours DATABASE_WRITE_INTERVAL{1};\r\n /** Time to wait between flushing chainstate to disk. */\r\n@@ -2932,7 +2930,6 @@ bool Chainstate::FlushStateToDisk(\r\n         }\r\n         // Flush best chain related state. This can only be done if the blocks / block index write was also done.\r\n         if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\r\n-            if (coins_dirty_count >= WARN_FLUSH_COINS_COUNT) LogWarning(\"Flushing large (%d entries) UTXO set to disk, it may take several minutes\", coins_dirty_count);\r\n             LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d out of %d cached coins)\",\r\n                 coins_dirty_count, coins_count), BCLog::BENCH);\r\n```\r\n\r\nReproducer:\r\n```bash\r\ncmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc)\r\nmkdir -p demo && rm -rfd demo/chainstate demo/chainstate_snapshot demo/debug.log\r\nbuild/bin/bitcoind -datadir=demo -stopatheight=1\r\nbuild/bin/bitcoind -datadir=demo -daemon -blocksonly=1 -connect=0 -dbcache=30000\r\nbuild/bin/bitcoin-cli -datadir=demo -rpcclienttimeout=0 loadtxoutset ~/utxo-880000.dat\r\nbuild/bin/bitcoin-cli -datadir=demo stop\r\n```\r\nResult:\r\n```bash\r\n2025-03-18T09:59:40Z [snapshot] 184000000 coins loaded (99.56%, 29332 MB)\r\n2025-03-18T09:59:41Z [snapshot] loaded 184821030 (29456 MB) coins from snapshot 000000000000000000010b17283c3c400507969a9c2afd1dcf2082ec5cca2880\r\n2025-03-18T09:59:41Z FlushSnapshotToDisk: saving snapshot chainstate (29456 MB) started\r\n*2025-03-18T09:59:41Z [warning] Flushing large (184821030 entries) UTXO set to disk, it may take several minutes*\r\n2025-03-18T10:00:50Z FlushSnapshotToDisk: completed (68776.27ms)\r\n```\r\n\r\nWould it be simpler if I pushed this change in a separate PR instead?",
      "created_at": "2025-03-18T09:49:21Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000616997",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000616997"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2937,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000688081",
      "pull_request_review_id": 2620965099,
      "id": 2000688081,
      "node_id": "PRRC_kwDOABII5853QBPR",
      "diff_hunk": "@@ -113,7 +115,10 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        CCoinsCacheEntry::SetDirty(*it, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 22,
      "original_position": 22,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": 1938275296,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Following @andrewtoth's solution we can do:\r\n```C++\r\nvoid CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\r\n    const auto mem_usage{coin.DynamicMemoryUsage()};\r\n    auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\r\n    if (inserted) {\r\n        cachedCoinsUsage += mem_usage;\r\n        CCoinsCacheEntry::SetDirty(*it, m_sentinel);\r\n        ++m_dirty_count;\r\n    }\r\n}\r\n```",
      "created_at": "2025-03-18T10:23:28Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000688081",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000688081"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 119,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000696000",
      "pull_request_review_id": 2620965099,
      "id": 2000696000,
      "node_id": "PRRC_kwDOABII5853QDLA",
      "diff_hunk": "@@ -343,6 +359,7 @@ void CCoinsViewCache::SanityCheck() const\n     }\n     assert(count_linked == count_flagged);\n     assert(recomputed_usage == cachedCoinsUsage);\n+    assert(num_dirty == m_num_dirty);",
      "path": "src/coins.cpp",
      "position": null,
      "original_position": 121,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "d99b0ec47ce9ed601b9edc38a38edb6dfcf36b11",
      "in_reply_to_id": 1925317571,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I will do this later to test reorg behavior in a functional test, you can resolve this comment.",
      "created_at": "2025-03-18T10:26:52Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000696000",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000696000"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 362,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000703255",
      "pull_request_review_id": 2620965099,
      "id": 2000703255,
      "node_id": "PRRC_kwDOABII5853QE8X",
      "diff_hunk": "@@ -123,6 +123,7 @@ FUZZ_TARGET(coins_view, .init = initialize_coins_view)\n                 CoinsCachePair sentinel{};\n                 sentinel.second.SelfRef(sentinel);\n                 size_t usage{0};\n+                size_t num_dirty{0};",
      "path": "src/test/fuzz/coins_view.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "[Leftover](https://github.com/bitcoin/bitcoin/pull/31703#discussion_r1925499202) `num_dirty`",
      "created_at": "2025-03-18T10:30:04Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000703255",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000703255"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 126,
      "original_line": 126,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000712052",
      "pull_request_review_id": 2620965099,
      "id": 2000712052,
      "node_id": "PRRC_kwDOABII5853QHF0",
      "diff_hunk": "@@ -272,10 +272,11 @@ struct CoinsViewCacheCursor\n     //! Calling CCoinsMap::clear() afterwards is faster because a CoinsCachePair cannot be coerced back into a\n     //! CCoinsMap::iterator to be erased, and must therefore be looked up again by key in the CCoinsMap before being erased.\n     CoinsViewCacheCursor(size_t& usage LIFETIMEBOUND,\n+                        size_t& dirty LIFETIMEBOUND,\n                         CoinsCachePair& sentinel LIFETIMEBOUND,\n                         CCoinsMap& map LIFETIMEBOUND,\n                         bool will_erase) noexcept\n-        : m_usage(usage), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}\n+        : m_usage(usage), m_dirty(dirty), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}",
      "path": "src/coins.h",
      "position": 9,
      "original_position": 9,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't mind if we're mixing booleans and ints as long as the types and names are obvious, e.g.\r\n```C++\r\nsize_t dirty = cache_coin ? cache_coin->IsDirty() : 0;\r\nauto cursor{CoinsViewCacheCursor(usage, dirty, sentinel, map, /*will_erase=*/true)};\r\n```\r\nwhere we're setting a parameter called `dirty` to the result of `IsDirty`, but it gets converted to dirty count.\r\nWe could obviate this by calling it `dirty_count` here as well:\r\n```C++\r\n    CoinsViewCacheCursor(size_t& usage LIFETIMEBOUND,\r\n                         size_t& dirty_count LIFETIMEBOUND,\r\n                         CoinsCachePair& sentinel LIFETIMEBOUND,\r\n                         CCoinsMap& map LIFETIMEBOUND,\r\n                         bool will_erase) noexcept\r\n        : m_usage(usage), m_dirty_count(dirty_count), m_sentinel(sentinel), m_map(map), m_will_erase(will_erase) {}\r\n```",
      "created_at": "2025-03-18T10:34:19Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000712052",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000712052"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 279,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000724657",
      "pull_request_review_id": 2620965099,
      "id": 2000724657,
      "node_id": "PRRC_kwDOABII5853QKKx",
      "diff_hunk": "@@ -235,7 +244,10 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\n                     itUs->second.coin = it->second.coin;\n                 }\n                 cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\n-                CCoinsCacheEntry::SetDirty(*itUs, m_sentinel);\n+                if (!itUs->second.IsDirty()) {\n+                    ++m_dirty_count;\n+                    CCoinsCacheEntry::SetDirty(*itUs, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 67,
      "original_position": 67,
      "commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "original_commit_id": "15619a1c99f6cc815291adf150bb8049c75a91cc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "in other cases we set it to dirty first and only increment `m_dirty_count` after (shouldn't matter on single thread but at least we don't have to think about whether that's the case or not):\r\n```suggestion\r\n                    CCoinsCacheEntry::SetDirty(*itUs, m_sentinel);\r\n                    ++m_dirty_count;\r\n```",
      "created_at": "2025-03-18T10:39:17Z",
      "updated_at": "2025-03-18T11:54:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31703#discussion_r2000724657",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2000724657"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31703"
        }
      },
      "start_line": 248,
      "original_start_line": 248,
      "start_side": "RIGHT",
      "line": 249,
      "original_line": 249,
      "side": "RIGHT"
    }
  ]
}