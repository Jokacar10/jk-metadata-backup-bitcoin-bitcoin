{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405",
    "id": 2211158070,
    "node_id": "PR_kwDOABII586Dy5g2",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31405",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31405.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31405.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
    "number": 31405,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "validation: stricter internal handling of invalid blocks",
    "user": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "Some fields in validation are set opportunistically by \"best effort\":\r\n- The `BLOCK_FAILED_CHILD` status (which means that the block index has an invalid predecessor)\r\n- `m_best_header` (the most-work header not known to be invalid).\r\n\r\nThis means that there are known situations in which these fields are not set when they should be, or set to wrong values. This is tolerated because the fields are not used for anything consensus-critical and triggering these situations involved creating invalid blocks with valid PoW header, so would have a cost attached. Also, having stricter guarantees for these fields requires iterating over the entire block index, which has some DoS potential, especially with any header above the checkpoint being accepted int he past (see e.g. #11531). \r\n\r\nHowever, there are reasons to change this now:\r\n- RPCs use these fields and can report wrong results\r\n- There is the constant possibility that someone could add code that expects these fields to be correct, especially because it is not well documented that these fields cannot always be relied upon.\r\n- DoS concerns have become less of an issue after #25717 - now an attacker would need to invest much more work because they can't fork off the last checkpoint anymore\r\n\r\nThis PR continues the work from #30666 to ensure that `BLOCK_FAILED_CHILD` status and `m_best_header` are always correct:\r\n- it adds a call to `InvalidChainFound()` in `AcceptBlock()`.\r\n- it adds checks for `BLOCK_FAILED_CHILD` and `m_best_header`  to `CheckBlockIndex()`. In order to be able to do this, two more caches were added to the RPC-only `InvalidateBlock()` similar to the existing `candidate_blocks_by_work` for `setBlockIndexCandidates`. These are performance optimizations with the goal of avoiding having a call of `InvalidChainFound()` / looping over the block index after each disconnected block.\r\nI also wrote a fuzz test to find possible edge cases violating `CheckBlockIndex`, which I will PR separately soon.\r\n- it removes the `m_failed_blocks` set, which was a heuristic necessary when we couldn't be sure if a given block index had an invalid predecessor or not. Now that we have that guarantee, the set is no longer needed.",
    "labels": [
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      }
    ],
    "created_at": "2024-12-02T19:29:15Z",
    "updated_at": "2025-03-17T19:23:01Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "f987edc96dfbcffb75ae32f22caad926be22380c",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "mzumsande:202411_stricter_invalidblock_handling",
      "ref": "202411_stricter_invalidblock_handling",
      "sha": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 187673073,
        "node_id": "MDEwOlJlcG9zaXRvcnkxODc2NzMwNzM=",
        "name": "bitcoin",
        "full_name": "mzumsande/bitcoin",
        "owner": {
          "login": "mzumsande",
          "id": 48763452,
          "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
          "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/mzumsande",
          "html_url": "https://github.com/mzumsande",
          "followers_url": "https://api.github.com/users/mzumsande/followers",
          "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
          "organizations_url": "https://api.github.com/users/mzumsande/orgs",
          "repos_url": "https://api.github.com/users/mzumsande/repos",
          "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/mzumsande/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/mzumsande/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/mzumsande/bitcoin",
        "archive_url": "https://api.github.com/repos/mzumsande/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/mzumsande/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/mzumsande/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/mzumsande/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/mzumsande/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/mzumsande/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/mzumsande/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/mzumsande/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/mzumsande/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/mzumsande/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/mzumsande/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/mzumsande/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/mzumsande/bitcoin/events",
        "forks_url": "https://api.github.com/repos/mzumsande/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/mzumsande/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/mzumsande/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/mzumsande/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/mzumsande/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/mzumsande/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/mzumsande/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/mzumsande/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/mzumsande/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/mzumsande/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/mzumsande/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/mzumsande/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/mzumsande/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/mzumsande/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/mzumsande/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/mzumsande/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:mzumsande/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/mzumsande/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/mzumsande/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/mzumsande/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/mzumsande/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/mzumsande/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/mzumsande/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/mzumsande/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/mzumsande/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/mzumsande/bitcoin/hooks",
        "svn_url": "https://github.com/mzumsande/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 258032,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-03-17T15:06:27Z",
        "created_at": "2019-05-20T16:03:10Z",
        "updated_at": "2025-01-28T18:53:41Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "b432e367427f1f9fe0f0a5800e31e496f00cd38d",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36944,
        "stargazers_count": 82506,
        "watchers_count": 82506,
        "size": 278333,
        "default_branch": "master",
        "open_issues_count": 688,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-03-17T13:44:23Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-03-17T19:40:23Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 40,
    "deletions": 64,
    "changed_files": 2,
    "commits": 5,
    "review_comments": 11,
    "comments": 6
  },
  "events": [
    {
      "event": "commented",
      "id": 2512566754,
      "node_id": "IC_kwDOABII586Vwrni",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2512566754",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T19:29:20Z",
      "updated_at": "2025-03-14T18:23:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31405.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [stratospher](https://github.com/bitcoin/bitcoin/pull/31405#pullrequestreview-2598002988) |\n| Concept ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/31405#pullrequestreview-2655396246), [stringintech](https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2708437327) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31835](https://github.com/bitcoin/bitcoin/pull/31835) (validation: set BLOCK_FAILED_CHILD correctly by stratospher)\n* [#30479](https://github.com/bitcoin/bitcoin/pull/30479) (validation: Add eligible ancestors of reconsidered block to setBlockIndexCandidates by mzumsande)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2512566754",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405"
    },
    {
      "event": "labeled",
      "id": 15498367331,
      "node_id": "LE_lADOABII586ht3A5zwAAAAObxlFj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15498367331",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T19:29:22Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15499211539,
      "node_id": "HRFPE_lADOABII586ht3A5zwAAAAOb0zMT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15499211539",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "commit_url": "https://api.github.com/repos/mzumsande/bitcoin/commits/b2136da98df61f10ff8283d42f112f69f041fa7a",
      "created_at": "2024-12-02T20:47:07Z"
    },
    {
      "event": "labeled",
      "id": 15499212806,
      "node_id": "LE_lADOABII586ht3A5zwAAAAOb0zgG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15499212806",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T20:47:12Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2512791401,
      "node_id": "IC_kwDOABII586Vxidp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2512791401",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T20:47:13Z",
      "updated_at": "2024-12-02T20:47:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n🚧 At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33808912013</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2512791401",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405"
    },
    {
      "event": "unlabeled",
      "id": 15499774752,
      "node_id": "UNLE_lADOABII586ht3A5zwAAAAOb28sg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15499774752",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T21:38:30Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "ready_for_review",
      "id": 15501587308,
      "node_id": "RFRE_lADOABII586ht3A5zwAAAAOb93Ns",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15501587308",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-03T01:05:41Z"
    },
    {
      "event": "reviewed",
      "id": 2546740188,
      "node_id": "PRR_kwDOABII586XzCvc",
      "url": null,
      "actor": null,
      "commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "ACK b2136da9\r\n\r\n- Went through the logs in `rpc_invalidateblock.py` and checked how the children were marked invalid/`m_best_header` was set on master vs in this PR\r\n- Went through logs of some functional tests like `feature_block.py` and verified that BLOCK_FAILED_CHILD wasn't being set in [`m_failed_blocks` loop](https://github.com/bitcoin/bitcoin/blob/35bf426e02210c1bbb04926f4ca2e0285fbfcd11/src/validation.cpp#L4395)\r\n- Ran `invalidateblock` RPC on a full node.\r\n",
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#pullrequestreview-2546740188",
      "submitted_at": "2025-01-13T14:14:02Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
    },
    {
      "event": "reviewed",
      "id": 2548919720,
      "node_id": "PRR_kwDOABII586X7W2o",
      "url": null,
      "actor": null,
      "commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#pullrequestreview-2548919720",
      "submitted_at": "2025-01-15T08:54:53Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE2M2IwMWVhZTgyYTlkZDk0ZGNkYTk0Y2YxMzAwMWU0NmI0YThhNTY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/163b01eae82a9dd94dcda94cf13001e46b4a8a56",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/163b01eae82a9dd94dcda94cf13001e46b4a8a56",
      "tree": {
        "sha": "b9b8999e2e7187819cc6b166eb4604ea2cd0aea4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b9b8999e2e7187819cc6b166eb4604ea2cd0aea4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b432e367427f1f9fe0f0a5800e31e496f00cd38d",
          "sha": "b432e367427f1f9fe0f0a5800e31e496f00cd38d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b432e367427f1f9fe0f0a5800e31e496f00cd38d"
        }
      ],
      "message": "validation: call InvalidChainfound also from AcceptBlock\n\nIn this scenario we have stored a valid header with an invalid (but not\nmutated!) block, so it can only be triggered by doing the\nnecessary PoW.\nThe added call ensures that descendant blocks failure flags and m_best_header\nwill be set correctly - at the cost of looping over the entire block\nindex, which, because of the mentioned necessary PoW, is not a DoS\nvector.",
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2025-01-28T16:36:37Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2024-12-01T04:46:10Z"
      },
      "sha": "163b01eae82a9dd94dcda94cf13001e46b4a8a56"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGUzMmRmNDVhNjJlNjk5OWIxMmQwMzU3NThjOWM2YmQ0OTk0ZWE2ODI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e32df45a62e6999b12d035758c9c6bd4994ea682",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e32df45a62e6999b12d035758c9c6bd4994ea682",
      "tree": {
        "sha": "a979dac7c8a70479b2efd89f61535bfdd8b3bd33",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a979dac7c8a70479b2efd89f61535bfdd8b3bd33"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/163b01eae82a9dd94dcda94cf13001e46b4a8a56",
          "sha": "163b01eae82a9dd94dcda94cf13001e46b4a8a56",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/163b01eae82a9dd94dcda94cf13001e46b4a8a56"
        }
      ],
      "message": "validation: in invalidateblock, mark children as invalid right away\n\nBefore, they would be marked as invalid only after disconnecting\nmultiple blocks, letting go of cs_main in the meantime.\nThis is in preparation for adding a check to\nCheckBlockIndex() requiring that descendants of invalid block indexes\nare always marked as invalid.",
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2025-01-28T16:58:19Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2024-11-30T20:39:55Z"
      },
      "sha": "e32df45a62e6999b12d035758c9c6bd4994ea682"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQxMDA0OTUxMjVlOWEwNmIyNDAzZjc1MjBmYWU5ZjQ1YzNmZDllNGM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4100495125e9a06b2403f7520fae9f45c3fd9e4c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4100495125e9a06b2403f7520fae9f45c3fd9e4c",
      "tree": {
        "sha": "2bd0ec8c670ca59a771d9b57d7a385082a6feeec",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2bd0ec8c670ca59a771d9b57d7a385082a6feeec"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e32df45a62e6999b12d035758c9c6bd4994ea682",
          "sha": "e32df45a62e6999b12d035758c9c6bd4994ea682",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e32df45a62e6999b12d035758c9c6bd4994ea682"
        }
      ],
      "message": "validation: in invalidateblock, calculate m_best_header right away\n\nBefore, m_best_header would be calculated only after disconnecting\nmultiple blocks, letting go of cs_main in the meantime.\nThis is in preparation for adding checks to CheckBlockIndex()\nrequiring that m_best_header is the most-work header not known to be invalid.",
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2025-01-28T16:58:19Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2024-11-25T22:07:53Z"
      },
      "sha": "4100495125e9a06b2403f7520fae9f45c3fd9e4c"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16097499132,
      "node_id": "HRFPE_lADOABII586ht3A5zwAAAAO_fFf8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16097499132",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "b35d16344d50fdb8c227fe78ccea9b449c4779fc",
      "commit_url": "https://api.github.com/repos/mzumsande/bitcoin/commits/b35d16344d50fdb8c227fe78ccea9b449c4779fc",
      "created_at": "2025-01-28T18:05:13Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGVjYThkOTE4MmU5N2Y4MGQwN2JkYTJiYjU0NDgxODUyMjgwZTI2ZjE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/eca8d9182e97f80d07bda2bb54481852280e26f1",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/eca8d9182e97f80d07bda2bb54481852280e26f1",
      "tree": {
        "sha": "494736482531f66692878d058bce7a353e9d8396",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/494736482531f66692878d058bce7a353e9d8396"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4100495125e9a06b2403f7520fae9f45c3fd9e4c",
          "sha": "4100495125e9a06b2403f7520fae9f45c3fd9e4c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4100495125e9a06b2403f7520fae9f45c3fd9e4c"
        }
      ],
      "message": "validation: Add more checks to CheckBlockIndex()\n\nThis adds checks that\n1) Descendants of invalid block indexes are also marked invalid\n2) m_best_header cannot be invalid, and there can be no valid\nblock with more work than it.",
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2025-01-28T18:06:47Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2024-12-02T16:22:26Z"
      },
      "sha": "eca8d9182e97f80d07bda2bb54481852280e26f1"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDRiYTJlNDgwZmZhMGI3NzExMzk1M2JlZTRmZjVjOTM0OWUyNzdlN2U",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "tree": {
        "sha": "cb961fe364300917a2e3cee213f3877b624f1c22",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cb961fe364300917a2e3cee213f3877b624f1c22"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/eca8d9182e97f80d07bda2bb54481852280e26f1",
          "sha": "eca8d9182e97f80d07bda2bb54481852280e26f1",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/eca8d9182e97f80d07bda2bb54481852280e26f1"
        }
      ],
      "message": "validation: remove m_failed_blocks\n\nWe now mark all blocks that descend from an invalid block\nimmediately as the invalid block is encountered\n(by iterating over the entire block index).\nAs a result, m_failed_blocks, which was a heuristic to only\nmark descendants of failed blocks as failed when necessary,\n(i.e., when we have do decide whether to add another descendant or not)\nis no longer required.",
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2025-01-28T18:06:47Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2024-12-01T05:08:51Z"
      },
      "sha": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16097544162,
      "node_id": "HRFPE_lADOABII586ht3A5zwAAAAO_fQfi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16097544162",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "commit_url": "https://api.github.com/repos/mzumsande/bitcoin/commits/4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "created_at": "2025-01-28T18:09:18Z"
    },
    {
      "event": "commented",
      "id": 2619726595,
      "node_id": "IC_kwDOABII586cJdsD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2619726595",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-28T18:10:03Z",
      "updated_at": "2025-01-28T18:10:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "[b2136da](https://github.com/bitcoin/bitcoin/commit/b2136da98df61f10ff8283d42f112f69f041fa7a) to [4ba2e48](https://github.com/bitcoin/bitcoin/commit/4ba2e480ffa0b77113953bee4ff5c9349e277e7e):\r\nAddressed review comments by @stratospher (Thanks!) and rebased.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2619726595",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405"
    },
    {
      "event": "mentioned",
      "id": 16097552471,
      "node_id": "MEE_lADOABII586ht3A5zwAAAAO_fShX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16097552471",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-28T18:10:04Z"
    },
    {
      "event": "subscribed",
      "id": 16097552499,
      "node_id": "SE_lADOABII586ht3A5zwAAAAO_fShz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16097552499",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-28T18:10:04Z"
    },
    {
      "event": "reviewed",
      "id": 2598002988,
      "node_id": "PRR_kwDOABII586a2mEs",
      "url": null,
      "actor": null,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "reACK 4ba2e48.",
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#pullrequestreview-2598002988",
      "submitted_at": "2025-02-10T15:17:43Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
    },
    {
      "event": "commented",
      "id": 2694989641,
      "node_id": "IC_kwDOABII586gokdJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2694989641",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-03T16:48:52Z",
      "updated_at": "2025-03-03T16:48:52Z",
      "author_association": "CONTRIBUTOR",
      "body": "PSA: Bitcoin Core PR Review Club will cover this PR in its next meeting at 2025-03-05 at 17:00 UTC. See https://bitcoincore.reviews/31405 for notes, questions, and instructions on [how to join](https://bitcoincore.reviews/).",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2694989641",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405"
    },
    {
      "event": "reviewed",
      "id": 2655396246,
      "node_id": "PRR_kwDOABII586eRiGW",
      "url": null,
      "actor": null,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK for making `m_best_header` and `nStatus` more reliably correct, and the trade-offs seem reasonable. Even though the diff is small, I find reasoning about these changes fairly complex and require a lot of context, so I'll need to think through the implications more.",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#pullrequestreview-2655396246",
      "submitted_at": "2025-03-04T00:58:56Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
    },
    {
      "event": "commented",
      "id": 2708437327,
      "node_id": "IC_kwDOABII586hb3lP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2708437327",
      "actor": {
        "login": "stringintech",
        "id": 157148846,
        "node_id": "U_kgDOCV3mrg",
        "avatar_url": "https://avatars.githubusercontent.com/u/157148846?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stringintech",
        "html_url": "https://github.com/stringintech",
        "followers_url": "https://api.github.com/users/stringintech/followers",
        "following_url": "https://api.github.com/users/stringintech/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stringintech/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stringintech/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stringintech/subscriptions",
        "organizations_url": "https://api.github.com/users/stringintech/orgs",
        "repos_url": "https://api.github.com/users/stringintech/repos",
        "events_url": "https://api.github.com/users/stringintech/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stringintech/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-08T18:37:40Z",
      "updated_at": "2025-03-09T07:20:28Z",
      "author_association": "NONE",
      "body": "Concept ACK.\r\n\r\nI wrote two test cases to understand the general behavior of `InvalidateBlock`, not specifically to test this PR's changes:\r\n```\r\nA->B->C->D->E->F (main chain)\r\nA->B->C->G (fork 1)\r\nA->B->H->I->J (fork 2)\r\nA->B->H->K (fork 3)\r\n```\r\n\r\nIn the [first test](https://github.com/stringintech/bitcoin/blob/1b36dd6a66a44e8756d92e71baa7676646b5f1ce/src/test/validation_block_tests.cpp#L455), I invalidate block C (on active chain) which should invalidate C, D, E, F, and G. The [second test](https://github.com/stringintech/bitcoin/blob/1b36dd6a66a44e8756d92e71baa7676646b5f1ce/src/test/validation_block_tests.cpp#L509) invalidates H (on a fork) which should invalidate H, I, J, and K.\r\n\r\nBoth tests behave the same on the master and PR branches. The first test fails on both because D, E, and F are not marked as `BLOCK_FAILED_CHILD`, which I did not expect.\r\n\r\nI have two questions:\r\n\r\n1 )\r\nI found what appears to be a bug in `InvalidateBlock`:\r\nhttps://github.com/bitcoin/bitcoin/blob/4637cb1eec48d1af8d23eeae1bb4c6f8de55eed9/src/validation.cpp#L3750\r\n\r\nThe first part of the condition seems incorrect and should probably be:\r\n```cpp\r\nif (to_mark_failed->pprev == invalid_walk_tip ...) {\r\n```\r\nThe assertions that fail in the first test are for blocks D, E, and F which were all part of the best chain before invalidation, which led me to this part of the code. I'm not sure if fixing this is in scope for this PR.\r\n\r\n_Update: Just saw the PR #31835 which fixes this issue. :)_\r\n\r\n2 )\r\nTo validate my understanding: Since both branches behave similarly (even on master the `m_best_header` and `BLOCK_FAILED_CHILD` statuses are set correctly because of the final call to `InvalidChainFound` - except for the ones not set as `BLOCK_FAILED_CHILD` because of the potential bug), is it correct that the main goal of changes applied in `InvalidateBlock` is to maintain proper block statuses and best header between tip disconnections by marking children as invalid right away and recalculating the best header immediately rather than doing it later?",
      "user": {
        "login": "stringintech",
        "id": 157148846,
        "node_id": "U_kgDOCV3mrg",
        "avatar_url": "https://avatars.githubusercontent.com/u/157148846?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stringintech",
        "html_url": "https://github.com/stringintech",
        "followers_url": "https://api.github.com/users/stringintech/followers",
        "following_url": "https://api.github.com/users/stringintech/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stringintech/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stringintech/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stringintech/subscriptions",
        "organizations_url": "https://api.github.com/users/stringintech/orgs",
        "repos_url": "https://api.github.com/users/stringintech/repos",
        "events_url": "https://api.github.com/users/stringintech/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stringintech/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2708437327",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405"
    },
    {
      "event": "commented",
      "id": 2730598301,
      "node_id": "IC_kwDOABII586iwZ-d",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2730598301",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-17T19:23:00Z",
      "updated_at": "2025-03-17T19:23:00Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Update: Just saw the PR https://github.com/bitcoin/bitcoin/pull/31835 which fixes this issue. :)\r\n\r\nHeh, looks like you are at least the third person who found that bug independently, first one was in #16856!\r\n\r\n>  Since both branches behave similarly (even on master the m_best_header and BLOCK_FAILED_CHILD statuses are set correctly because of the final call to InvalidChainFound - except for the ones not set as BLOCK_FAILED_CHILD because of the potential bug), is it correct that the main goal of changes applied in InvalidateBlock is to maintain proper block statuses and best header between tip disconnections by marking children as invalid right away and recalculating the best header immediately rather than doing it later?\r\n\r\nYes, that's correct. The main goal of this PR to add these assumptions to `CheckBlockIndex()` - this means they should always be true when `cs_main` is not held. Since `InvalidateBlock` will release `cs_main` and call `CheckBlockIndex()` after each step, some tests would fail without the changes to `InvalidateBlock()`  - even if the final `InvalidChainFound()` in that function will eventually correct it!",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#issuecomment-2730598301",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31405"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1914320847",
      "pull_request_review_id": 2548919720,
      "id": 1914320847,
      "node_id": "PRRC_kwDOABII585yGjfP",
      "diff_hunk": "@@ -5367,6 +5359,8 @@ void ChainstateManager::CheckBlockIndex()\n         if (pindexFirstInvalid == nullptr) {\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n+        } else {",
      "path": "src/validation.cpp",
      "position": 153,
      "original_position": 152,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "528b8cc:  this would be more accurate for descendants.\r\n```suggestion\r\n        } else if (pindexFirstInvalid != pindex) {\r\n```",
      "created_at": "2025-01-14T06:41:56Z",
      "updated_at": "2025-01-15T08:54:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1914320847",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1914320847"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5395,
      "original_line": 5395,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1914366243",
      "pull_request_review_id": 2548919720,
      "id": 1914366243,
      "node_id": "PRRC_kwDOABII585yGukj",
      "diff_hunk": "@@ -3729,6 +3739,28 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n             m_blockman.m_dirty_blockindex.insert(to_mark_failed);\n         }\n \n+        // Mark descendants of the invalidated block as invalid\n+        auto range = cand_invalid_descendants.equal_range(invalid_walk_tip);\n+        for (auto it = range.first; it != range.second; ++it) {\n+            it->second->nStatus |= BLOCK_FAILED_CHILD;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "7f88af8b: when `invalidateblock` is called multiple times, we would need to clear the `BLOCK_FAILED_VALID` from previous iteration so that both `BLOCK_FAILED_VALID` and `BLOCK_FAILED_CHILD` don't happen together on the same block. ex: [this situation](https://github.com/bitcoin/bitcoin/blob/35bf426e02210c1bbb04926f4ca2e0285fbfcd11/test/functional/rpc_invalidateblock.py#L91)\r\n```\r\nif (it->second->nStatus & BLOCK_FAILED_VALID) {\r\n    it->second->nStatus = (it->second->nStatus ^ BLOCK_FAILED_VALID) | BLOCK_FAILED_CHILD;\r\n} else {\r\n    it->second->nStatus |= BLOCK_FAILED_CHILD;\r\n}\r\n```",
      "created_at": "2025-01-14T07:33:29Z",
      "updated_at": "2025-01-15T08:54:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1914366243",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1914366243"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3745,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1932643967",
      "pull_request_review_id": 2579064521,
      "id": 1932643967,
      "node_id": "PRRC_kwDOABII585zMc5_",
      "diff_hunk": "@@ -5367,6 +5359,8 @@ void ChainstateManager::CheckBlockIndex()\n         if (pindexFirstInvalid == nullptr) {\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n+        } else {",
      "path": "src/validation.cpp",
      "position": 153,
      "original_position": 152,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "in_reply_to_id": 1914320847,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I changed the comment to \"Invalid blocks and their descendants must be marked as invalid\" - doesn't really make sense to me to make an exception for the block itself.",
      "created_at": "2025-01-28T18:07:45Z",
      "updated_at": "2025-01-28T18:07:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1932643967",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1932643967"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5395,
      "original_line": 5395,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1932645135",
      "pull_request_review_id": 2579066563,
      "id": 1932645135,
      "node_id": "PRRC_kwDOABII585zMdMP",
      "diff_hunk": "@@ -3729,6 +3739,28 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n             m_blockman.m_dirty_blockindex.insert(to_mark_failed);\n         }\n \n+        // Mark descendants of the invalidated block as invalid\n+        auto range = cand_invalid_descendants.equal_range(invalid_walk_tip);\n+        for (auto it = range.first; it != range.second; ++it) {\n+            it->second->nStatus |= BLOCK_FAILED_CHILD;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "b2136da98df61f10ff8283d42f112f69f041fa7a",
      "in_reply_to_id": 1914366243,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done, made it a bit shorter:\r\n`it->second->nStatus = (it->second->nStatus & ~BLOCK_FAILED_VALID) | BLOCK_FAILED_CHILD;`",
      "created_at": "2025-01-28T18:08:49Z",
      "updated_at": "2025-01-28T18:08:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1932645135",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1932645135"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3745,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1944318554",
      "pull_request_review_id": 2598002988,
      "id": 1944318554,
      "node_id": "PRRC_kwDOABII585z4_Ja",
      "diff_hunk": "@@ -5434,6 +5435,8 @@ void ChainstateManager::CheckBlockIndex()\n         if (pindexFirstInvalid == nullptr) {\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n+        } else {\n+            assert((pindex->nStatus & BLOCK_FAILED_MASK)); // Invalid blocks and their descendants must be marked as invalid",
      "path": "src/validation.cpp",
      "position": 154,
      "original_position": 13,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "eca8d9182e97f80d07bda2bb54481852280e26f1",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "eca8d91:   micro-style-nit only if you have to retouch - could make double (()) to ().",
      "created_at": "2025-02-06T08:40:53Z",
      "updated_at": "2025-02-10T15:17:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1944318554",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1944318554"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5396,
      "original_line": 5439,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1978269926",
      "pull_request_review_id": 2655396246,
      "id": 1978269926,
      "node_id": "PRRC_kwDOABII58516gDm",
      "diff_hunk": "@@ -3754,6 +3764,29 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n             m_blockman.m_dirty_blockindex.insert(to_mark_failed);\n         }\n \n+        // Mark descendants of the invalidated block as invalid\n+        // (possibly replacing a pre-existing BLOCK_FAILED_VALID with BLOCK_FAILED_CHILD)\n+        auto range = cand_invalid_descendants.equal_range(invalid_walk_tip);\n+        for (auto it = range.first; it != range.second; ++it) {\n+            it->second->nStatus = (it->second->nStatus & ~BLOCK_FAILED_VALID) | BLOCK_FAILED_CHILD;\n+        }",
      "path": "src/validation.cpp",
      "position": 42,
      "original_position": 42,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Is there a reason why we forcefully unset `BLOCK_FAILED_VALID`? Since both flags store orthogonal information in separate bits, intuitively I'd expect we could have both co-exist? If this breaks other assumptions, perhaps good to add to the documentation here?",
      "created_at": "2025-03-03T21:32:44Z",
      "updated_at": "2025-03-04T00:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1978269926",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1978269926"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": 3767,
      "original_start_line": 3767,
      "start_side": "RIGHT",
      "line": 3772,
      "original_line": 3772,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1978292997",
      "pull_request_review_id": 2655396246,
      "id": 1978292997,
      "node_id": "PRRC_kwDOABII58516lsF",
      "diff_hunk": "@@ -3707,6 +3711,12 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n                     candidate->HaveNumChainTxs()) {\n                 candidate_blocks_by_work.insert(std::make_pair(candidate->nChainWork, candidate));\n             }\n+            // Similarly, populate cache for blocks not in main chain to invalidate\n+            if (!m_chain.Contains(candidate) &&\n+                !CBlockIndexWorkComparator()(candidate, pindex->pprev)) {\n+                cand_invalid_descendants.insert(std::make_pair(m_chain.FindFork(candidate), candidate));",
      "path": "src/validation.cpp",
      "position": 27,
      "original_position": 27,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It's not clear to me why we would only want to mark blocks with large-enough PoW as invalid descendants. If this is not a bug, I think behaviour is inconsistent with the commit message and should probably be document in the code too?",
      "created_at": "2025-03-03T21:48:45Z",
      "updated_at": "2025-03-04T00:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1978292997",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1978292997"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3717,
      "original_line": 3717,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1978437444",
      "pull_request_review_id": 2655396246,
      "id": 1978437444,
      "node_id": "PRRC_kwDOABII58517I9E",
      "diff_hunk": "@@ -3691,6 +3690,11 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n     // build a map once so that we can look up candidate blocks by chain\n     // work as we go.\n     std::multimap<const arith_uint256, CBlockIndex *> candidate_blocks_by_work;\n+    // Map to cache candidates not in the main chain that might need invalidating.\n+    // Maps fork block in chain to the candidates for invalidation.\n+    std::multimap<const CBlockIndex*, CBlockIndex*> cand_invalid_descendants;\n+    // Map to cache candidates for m_best_header\n+    std::multimap<const arith_uint256, CBlockIndex*> best_header_blocks_by_work;",
      "path": "src/validation.cpp",
      "position": 16,
      "original_position": 16,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Since this map is a superset of `candidate_blocks_by_work `, I think we could just have one, and instead check for `IsValid(BLOCK_VALID_TRANSACTIONS) && HaveNumChainTxs()` further down when we update `setBlockIndexCandidates`? I suspect the memory impllications should be negligible either way, but I think it would clean up the code a bit?\r\n\r\nE.g. something like:\r\n\r\n<details>\r\n<summary>git diff on 4ba2e480ff</summary>\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f9c900ef27..ead0454f7b 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3689,12 +3689,10 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\r\n     // To avoid walking the block index repeatedly in search of candidates,\r\n     // build a map once so that we can look up candidate blocks by chain\r\n     // work as we go.\r\n-    std::multimap<const arith_uint256, CBlockIndex *> candidate_blocks_by_work;\r\n+    std::multimap<const arith_uint256, CBlockIndex *> highpow_outofchain_headers;\r\n     // Map to cache candidates not in the main chain that might need invalidating.\r\n     // Maps fork block in chain to the candidates for invalidation.\r\n     std::multimap<const CBlockIndex*, CBlockIndex*> cand_invalid_descendants;\r\n-    // Map to cache candidates for m_best_header\r\n-    std::multimap<const arith_uint256, CBlockIndex*> best_header_blocks_by_work;\r\n \r\n     {\r\n         LOCK(cs_main);\r\n@@ -3706,16 +3704,9 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\r\n             // Instead, consider only non-active-chain blocks that have at\r\n             // least as much work as where we expect the new tip to end up.\r\n             if (!m_chain.Contains(candidate) &&\r\n-                    !CBlockIndexWorkComparator()(candidate, pindex->pprev) &&\r\n-                    candidate->IsValid(BLOCK_VALID_TRANSACTIONS) &&\r\n-                    candidate->HaveNumChainTxs()) {\r\n-                candidate_blocks_by_work.insert(std::make_pair(candidate->nChainWork, candidate));\r\n-            }\r\n-            // Similarly, populate cache for blocks not in main chain to invalidate\r\n-            if (!m_chain.Contains(candidate) &&\r\n-                !CBlockIndexWorkComparator()(candidate, pindex->pprev)) {\r\n+                    !CBlockIndexWorkComparator()(candidate, pindex->pprev)) {\r\n+                highpow_outofchain_headers.insert(std::make_pair(candidate->nChainWork, candidate));\r\n                 cand_invalid_descendants.insert(std::make_pair(m_chain.FindFork(candidate), candidate));\r\n-                best_header_blocks_by_work.insert(std::make_pair(candidate->nChainWork, candidate));\r\n             }\r\n         }\r\n     }\r\n@@ -3774,11 +3765,9 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\r\n         // Determine new best header\r\n         if (m_chainman.m_best_header->nStatus & BLOCK_FAILED_MASK) {\r\n             m_chainman.m_best_header = invalid_walk_tip->pprev;\r\n-            auto best_header_it = best_header_blocks_by_work.lower_bound(m_chainman.m_best_header->nChainWork);\r\n-            while (best_header_it != best_header_blocks_by_work.end()) {\r\n-                if (best_header_it->second->nStatus & BLOCK_FAILED_MASK) {\r\n-                    best_header_it = best_header_blocks_by_work.erase(best_header_it);\r\n-                } else {\r\n+            auto best_header_it = highpow_outofchain_headers.lower_bound(m_chainman.m_best_header->nChainWork);\r\n+            while (best_header_it != highpow_outofchain_headers.end()) {\r\n+                if (!(best_header_it->second->nStatus & BLOCK_FAILED_MASK)) {\r\n                     if (!CBlockIndexWorkComparator()(best_header_it->second, m_chainman.m_best_header)) {\r\n                         m_chainman.m_best_header = best_header_it->second;\r\n                     }\r\n@@ -3788,11 +3777,12 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\r\n         }\r\n \r\n         // Add any equal or more work headers to setBlockIndexCandidates\r\n-        auto candidate_it = candidate_blocks_by_work.lower_bound(invalid_walk_tip->pprev->nChainWork);\r\n-        while (candidate_it != candidate_blocks_by_work.end()) {\r\n-            if (!CBlockIndexWorkComparator()(candidate_it->second, invalid_walk_tip->pprev)) {\r\n-                setBlockIndexCandidates.insert(candidate_it->second);\r\n-                candidate_it = candidate_blocks_by_work.erase(candidate_it);\r\n+        auto candidate_it = highpow_outofchain_headers.lower_bound(invalid_walk_tip->pprev->nChainWork);\r\n+        while (candidate_it != highpow_outofchain_headers.end()) {\r\n+            if (!CBlockIndexWorkComparator()(candidate_it->second, invalid_walk_tip->pprev) &&\r\n+                candidate_it->second->IsValid(BLOCK_VALID_TRANSACTIONS) &&\r\n+                candidate_it->second->HaveNumChainTxs()) {\r\n+                    setBlockIndexCandidates.insert(candidate_it->second);\r\n             } else {\r\n                 ++candidate_it;\r\n             }\r\n\r\n```\r\n</details>\r\n",
      "created_at": "2025-03-04T00:49:42Z",
      "updated_at": "2025-03-04T00:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1978437444",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1978437444"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3697,
      "original_line": 3697,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1980008065",
      "pull_request_review_id": 2658598209,
      "id": 1980008065,
      "node_id": "PRRC_kwDOABII5852BIaB",
      "diff_hunk": "@@ -3754,6 +3764,29 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n             m_blockman.m_dirty_blockindex.insert(to_mark_failed);\n         }\n \n+        // Mark descendants of the invalidated block as invalid\n+        // (possibly replacing a pre-existing BLOCK_FAILED_VALID with BLOCK_FAILED_CHILD)\n+        auto range = cand_invalid_descendants.equal_range(invalid_walk_tip);\n+        for (auto it = range.first; it != range.second; ++it) {\n+            it->second->nStatus = (it->second->nStatus & ~BLOCK_FAILED_VALID) | BLOCK_FAILED_CHILD;\n+        }",
      "path": "src/validation.cpp",
      "position": 42,
      "original_position": 42,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "in_reply_to_id": 1978269926,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "There is some more discussion about this in #31835, where I wrote my opinion. Since `BLOCK_FAILED_CHILD` has never been used for anything, it's hard to say what the intentions really were, but my impression is that the first invalid block should be marked as `BLOCK_FAILED_VALID` and all of its descendants as `BLOCK_FAILED_CHILD` - so having both `BLOCK_FAILED_VALID` and  `BLOCK_FAILED_CHILD` at the same time doesn't make sense to me.",
      "created_at": "2025-03-04T18:34:51Z",
      "updated_at": "2025-03-04T18:34:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1980008065",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1980008065"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": 3767,
      "original_start_line": 3767,
      "start_side": "RIGHT",
      "line": 3772,
      "original_line": 3772,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1980042629",
      "pull_request_review_id": 2658649844,
      "id": 1980042629,
      "node_id": "PRRC_kwDOABII5852BQ2F",
      "diff_hunk": "@@ -3707,6 +3711,12 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n                     candidate->HaveNumChainTxs()) {\n                 candidate_blocks_by_work.insert(std::make_pair(candidate->nChainWork, candidate));\n             }\n+            // Similarly, populate cache for blocks not in main chain to invalidate\n+            if (!m_chain.Contains(candidate) &&\n+                !CBlockIndexWorkComparator()(candidate, pindex->pprev)) {\n+                cand_invalid_descendants.insert(std::make_pair(m_chain.FindFork(candidate), candidate));",
      "path": "src/validation.cpp",
      "position": 27,
      "original_position": 27,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "in_reply_to_id": 1978292997,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "With `pindex->pprev` being the predecessor of the block passed to the `invalidateblock` rpc call, the logic in `InvalidateBlock()` is to go from the tip back to `pindex->pprev` -  and we may need to update other forked descendants of the blocks encountered along that way (which must have more accumulated work than their parents), which is why we put them in the cache. But all blocks with lower work can never be encountered by that process and therefore don't need to be in the caches.\r\nI'll add more documentation with my next push.",
      "created_at": "2025-03-04T18:52:34Z",
      "updated_at": "2025-03-04T18:52:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1980042629",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1980042629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3717,
      "original_line": 3717,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1981280478",
      "pull_request_review_id": 2660916195,
      "id": 1981280478,
      "node_id": "PRRC_kwDOABII5852F_De",
      "diff_hunk": "@@ -3707,6 +3711,12 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n                     candidate->HaveNumChainTxs()) {\n                 candidate_blocks_by_work.insert(std::make_pair(candidate->nChainWork, candidate));\n             }\n+            // Similarly, populate cache for blocks not in main chain to invalidate\n+            if (!m_chain.Contains(candidate) &&\n+                !CBlockIndexWorkComparator()(candidate, pindex->pprev)) {\n+                cand_invalid_descendants.insert(std::make_pair(m_chain.FindFork(candidate), candidate));",
      "path": "src/validation.cpp",
      "position": 27,
      "original_position": 27,
      "commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "original_commit_id": "4ba2e480ffa0b77113953bee4ff5c9349e277e7e",
      "in_reply_to_id": 1978292997,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Oh sorry, I get it now, thanks. For some reason (I think I had just been reviewing the next section dealing with disconnecting the tip) I was confusing `pindex` for the chain tip here. I don't really have any doc suggestions, so can be marked as resolved.",
      "created_at": "2025-03-05T12:07:30Z",
      "updated_at": "2025-03-05T12:07:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31405#discussion_r1981280478",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1981280478"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31405"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3717,
      "original_line": 3717,
      "side": "RIGHT"
    }
  ]
}