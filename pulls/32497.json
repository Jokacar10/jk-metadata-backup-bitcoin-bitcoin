{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497",
    "id": 2519262912,
    "node_id": "PR_kwDOABII586WKObA",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/32497",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/32497.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/32497.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32497",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32497/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/4cc5942895673591de4edceb6dd0c7188c302a72",
    "number": 32497,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "merkle: pre‑reserve leaves to prevent reallocs with odd vtx count",
    "user": {
      "login": "l0rinc",
      "id": 1841944,
      "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/l0rinc",
      "html_url": "https://github.com/l0rinc",
      "followers_url": "https://api.github.com/users/l0rinc/followers",
      "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
      "organizations_url": "https://api.github.com/users/l0rinc/orgs",
      "repos_url": "https://api.github.com/users/l0rinc/repos",
      "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/l0rinc/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "### Summary\r\n`ComputeMerkleRoot` duplicates the last hash when the input size is odd:\r\nhttps://github.com/bitcoin/bitcoin/blob/39b6c139bd6be33699af781f1d71f6fed303d468/src/consensus/merkle.cpp#L54-L56\r\nIf the caller gave it a `std::vector` whose capacity equals its size (the common case when the vector was created with `resize()`), that single `push_back` forces a reallocation (doubling its size).\r\nWe pay this penalty on every Merkle‑root calculation even though we know the final size in advance.\r\n\r\n### Fix\r\nWhat this PR does:\r\n* call sites: replace `resize(n)` + index assignment with `reserve((n + 1) & ~1ULL)` + `emplace_back(...)`;\r\n* guarantees one extra slot when `vtx.size()` is odd (filled later);\r\n* removes default construction of `uint256` objects we overwrite anyway.\r\n\r\n### Validation\r\n\r\nThe bench was updated to use an even leaf count for simplicity and to focus on hashing speed rather than reallocations.\r\n\r\nAsserts (not pushed in this PR): temporary checks confirm that push_back never reallocates and that the coinbase witness hash remains null:\r\n\r\n```C++\r\nif (hashes.size() & 1) {\r\n    assert(hashes.size() < hashes.capacity()); // TODO remove\r\n    hashes.push_back(hashes.back());\r\n}\r\n```\r\nand\r\n```C++\r\nleaves.reserve((block.vtx.size() + 1) & ~1ULL); // capacity rounded up to even\r\nleaves.emplace_back();\r\nassert(leaves.back().IsNull()); // TODO remove\r\n```\r\n\r\nA full `-reindex-chainstate` up to block **896 408** ran without triggering the asserts.\r\n\r\n",
    "labels": [],
    "created_at": "2025-05-14T13:01:42Z",
    "updated_at": "2025-06-15T09:56:25Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "f1de657660c8f64ca93a6cc0b8136037ce345e64",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "l0rinc:l0rinc/pre‑reserve-merkle-leaves-to-max",
      "ref": "l0rinc/pre‑reserve-merkle-leaves-to-max",
      "sha": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 674169038,
        "node_id": "R_kgDOKC8Azg",
        "name": "bitcoin",
        "full_name": "l0rinc/bitcoin",
        "owner": {
          "login": "l0rinc",
          "id": 1841944,
          "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/l0rinc",
          "html_url": "https://github.com/l0rinc",
          "followers_url": "https://api.github.com/users/l0rinc/followers",
          "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
          "organizations_url": "https://api.github.com/users/l0rinc/orgs",
          "repos_url": "https://api.github.com/users/l0rinc/repos",
          "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/l0rinc/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/l0rinc/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/l0rinc/bitcoin",
        "archive_url": "https://api.github.com/repos/l0rinc/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/l0rinc/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/l0rinc/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/l0rinc/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/l0rinc/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/l0rinc/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/l0rinc/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/l0rinc/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/l0rinc/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/l0rinc/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/l0rinc/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/l0rinc/bitcoin/events",
        "forks_url": "https://api.github.com/repos/l0rinc/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/l0rinc/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/l0rinc/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/l0rinc/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/l0rinc/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/l0rinc/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/l0rinc/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/l0rinc/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/l0rinc/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/l0rinc/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/l0rinc/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/l0rinc/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/l0rinc/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:l0rinc/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/l0rinc/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/l0rinc/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/l0rinc/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/l0rinc/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/l0rinc/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/l0rinc/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/l0rinc/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/l0rinc/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/l0rinc/bitcoin/hooks",
        "svn_url": "https://github.com/l0rinc/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 263591,
        "default_branch": "master",
        "open_issues_count": 3,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-06-15T09:56:24Z",
        "created_at": "2023-08-03T09:49:12Z",
        "updated_at": "2025-06-11T10:14:23Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "2def85847318513afa7765e042567d13f616c54c",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 37376,
        "stargazers_count": 84156,
        "watchers_count": 84156,
        "size": 283876,
        "default_branch": "master",
        "open_issues_count": 749,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-06-14T00:27:57Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-06-15T08:42:46Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 31,
    "deletions": 19,
    "changed_files": 4,
    "commits": 2,
    "review_comments": 8,
    "comments": 2
  },
  "events": [
    {
      "event": "commented",
      "id": 2880167395,
      "node_id": "IC_kwDOABII586rq93j",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2880167395",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-05-14T13:01:47Z",
      "updated_at": "2025-06-13T20:34:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32497.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [luke-jr](https://github.com/bitcoin/bitcoin/pull/32497#pullrequestreview-2853787748), [yuvicc](https://github.com/bitcoin/bitcoin/pull/32497#pullrequestreview-2926329777) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32189](https://github.com/bitcoin/bitcoin/pull/32189) (refactor: Txid type safety (parent PR) by marcofleon)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#issuecomment-2880167395",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32497"
    },
    {
      "event": "reviewed",
      "id": 2853787748,
      "node_id": "PRR_kwDOABII586qGVhk",
      "url": null,
      "actor": null,
      "commit_id": "39b6c139bd6be33699af781f1d71f6fed303d468",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "utACK main commit. Not sure why the benchmark is being changed.",
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#pullrequestreview-2853787748",
      "submitted_at": "2025-05-20T11:34:01Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
    },
    {
      "event": "reviewed",
      "id": 2854173281,
      "node_id": "PRR_kwDOABII586qHzph",
      "url": null,
      "actor": null,
      "commit_id": "39b6c139bd6be33699af781f1d71f6fed303d468",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for the review!",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#pullrequestreview-2854173281",
      "submitted_at": "2025-05-20T13:28:50Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
    },
    {
      "event": "reviewed",
      "id": 2926329777,
      "node_id": "PRR_kwDOABII586ubD-x",
      "url": null,
      "actor": null,
      "commit_id": "39b6c139bd6be33699af781f1d71f6fed303d468",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nMemory allocation/deallocation is slow and expensive. ",
      "user": {
        "login": "yuvicc",
        "id": 92994932,
        "node_id": "U_kgDOBYr9dA",
        "avatar_url": "https://avatars.githubusercontent.com/u/92994932?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yuvicc",
        "html_url": "https://github.com/yuvicc",
        "followers_url": "https://api.github.com/users/yuvicc/followers",
        "following_url": "https://api.github.com/users/yuvicc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yuvicc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yuvicc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yuvicc/subscriptions",
        "organizations_url": "https://api.github.com/users/yuvicc/orgs",
        "repos_url": "https://api.github.com/users/yuvicc/repos",
        "events_url": "https://api.github.com/users/yuvicc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yuvicc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#pullrequestreview-2926329777",
      "submitted_at": "2025-06-13T20:34:19Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
    },
    {
      "event": "commented",
      "id": 2971637588,
      "node_id": "IC_kwDOABII586xH5dU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2971637588",
      "actor": {
        "login": "yuvicc",
        "id": 92994932,
        "node_id": "U_kgDOBYr9dA",
        "avatar_url": "https://avatars.githubusercontent.com/u/92994932?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yuvicc",
        "html_url": "https://github.com/yuvicc",
        "followers_url": "https://api.github.com/users/yuvicc/followers",
        "following_url": "https://api.github.com/users/yuvicc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yuvicc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yuvicc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yuvicc/subscriptions",
        "organizations_url": "https://api.github.com/users/yuvicc/orgs",
        "repos_url": "https://api.github.com/users/yuvicc/repos",
        "events_url": "https://api.github.com/users/yuvicc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yuvicc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-13T20:42:19Z",
      "updated_at": "2025-06-13T20:42:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "I have thought on changing the benchmark tests as we would want to test the worst case scenario right? or else we could have both case for testing? ",
      "user": {
        "login": "yuvicc",
        "id": 92994932,
        "node_id": "U_kgDOBYr9dA",
        "avatar_url": "https://avatars.githubusercontent.com/u/92994932?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yuvicc",
        "html_url": "https://github.com/yuvicc",
        "followers_url": "https://api.github.com/users/yuvicc/followers",
        "following_url": "https://api.github.com/users/yuvicc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yuvicc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yuvicc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yuvicc/subscriptions",
        "organizations_url": "https://api.github.com/users/yuvicc/orgs",
        "repos_url": "https://api.github.com/users/yuvicc/repos",
        "events_url": "https://api.github.com/users/yuvicc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yuvicc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#issuecomment-2971637588",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/32497"
    },
    {
      "event": "reviewed",
      "id": 2926489759,
      "node_id": "PRR_kwDOABII586ubrCf",
      "url": null,
      "actor": null,
      "commit_id": "39b6c139bd6be33699af781f1d71f6fed303d468",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "# Benchmark Testing\r\n\r\nmaster@5757de4ddd37f9321ee6b338b40888fd3561fc00\r\n\r\n- With 9000\r\n```\r\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|               52.62 |       19,005,746.07 |    0.2% |      0.01 | `MerkleRoot`\r\n|               52.64 |       18,998,504.40 |    0.3% |      0.01 | `MerkleRoot`\r\n|               52.63 |       18,999,727.67 |    0.2% |      0.01 | `MerkleRoot`\r\n```\r\n\r\n- With 9001\r\n```\r\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|               53.50 |       18,693,063.88 |    0.3% |      0.01 | `MerkleRoot`\r\n|               53.53 |       18,681,211.49 |    0.5% |      0.01 | `MerkleRoot`\r\n|               53.49 |       18,694,053.87 |    0.5% |      0.01 | `MerkleRoot`\r\n```\r\n\r\n--------------------------------------------------------------------\r\n\r\nCommit 39b6c139bd6be33699af781f1d71f6fed303d468\r\n\r\n- With 9000\r\n```\r\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|               52.51 |       19,043,628.95 |    0.2% |      0.01 | `MerkleRoot`\r\n|               52.52 |       19,040,989.96 |    0.2% |      0.01 | `MerkleRoot`\r\n|               52.53 |       19,036,358.39 |    0.2% |      0.01 | `MerkleRoot`\r\n```\r\n\r\n- With 9001\r\n```\r\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|               53.40 |       18,713,525.67 |    0.3% |      0.01 | `MerkleRoot`\r\n|               53.44 |       19,314,655.73 |    0.3% |      0.01 | `MerkleRoot`\r\n|               53.41 |       18,883,462.75 |    0.3% |      0.01 | `MerkleRoot`\r\n```",
      "user": {
        "login": "yuvicc",
        "id": 92994932,
        "node_id": "U_kgDOBYr9dA",
        "avatar_url": "https://avatars.githubusercontent.com/u/92994932?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/yuvicc",
        "html_url": "https://github.com/yuvicc",
        "followers_url": "https://api.github.com/users/yuvicc/followers",
        "following_url": "https://api.github.com/users/yuvicc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/yuvicc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/yuvicc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/yuvicc/subscriptions",
        "organizations_url": "https://api.github.com/users/yuvicc/orgs",
        "repos_url": "https://api.github.com/users/yuvicc/repos",
        "events_url": "https://api.github.com/users/yuvicc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/yuvicc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#pullrequestreview-2926489759",
      "submitted_at": "2025-06-13T21:35:47Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDA2NGYzM2JiZTJiNjQ2YTQzZjM3ODA3Nzg1YzU5ZTEwMzEwMjkxMzE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/064f33bbe2b646a43f37807785c59e1031029131",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/064f33bbe2b646a43f37807785c59e1031029131",
      "tree": {
        "sha": "443fc2efbedef848ad80b4db8fca89f57af71eb9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/443fc2efbedef848ad80b4db8fca89f57af71eb9"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2def85847318513afa7765e042567d13f616c54c",
          "sha": "2def85847318513afa7765e042567d13f616c54c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/2def85847318513afa7765e042567d13f616c54c"
        }
      ],
      "message": "bench: use even number of Merkle leaves\n\nTo avoid copying the vector inside the timed lambda, we create 1000 test cases and move each vector into `ComputeMerkleRoot` during measurement, similar to actual usages.\n\nInstead of mutating the input after each round to avoid unwanted compiler optimizations, we assert the expected hash, which likewise inhibits aggressive optimization.\n\n> rm -rf build && cmake -B build -DBUILD_BENCH=ON -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc) && build/bin/bench_bitcoin -filter='MerkleRoot'\n\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------:|:----------\n|               45.90 |       21,784,461.44 |    0.0% |      0.41 | `MerkleRoot`\n|               45.83 |       21,818,944.28 |    0.0% |      0.41 | `MerkleRoot`\n|               45.90 |       21,785,375.33 |    0.0% |      0.41 | `MerkleRoot`",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-06-15T09:56:14Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-05-14T12:32:08Z"
      },
      "sha": "064f33bbe2b646a43f37807785c59e1031029131"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDRjYzU5NDI4OTU2NzM1OTFkZTRlZGNlYjZkZDBjNzE4OGMzMDJhNzI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4cc5942895673591de4edceb6dd0c7188c302a72",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4cc5942895673591de4edceb6dd0c7188c302a72",
      "tree": {
        "sha": "8645c4df00517079b73975606315227bd5e24f8a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8645c4df00517079b73975606315227bd5e24f8a"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/064f33bbe2b646a43f37807785c59e1031029131",
          "sha": "064f33bbe2b646a43f37807785c59e1031029131",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/064f33bbe2b646a43f37807785c59e1031029131"
        }
      ],
      "message": "merkle: pre-reserve leaves to prevent reallocs with odd vtx count\n\nThis prevents the input vector from doubling in size when the input count is odd.\nThe rounding adds 1 when the size is odd (least significant bit is 1); otherwise it adds 0, keeping the value even.\n\n> rm -rf build && cmake -B build -DBUILD_BENCH=ON -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc) && build/bin/bench_bitcoin -filter='MerkleRoot'\n\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------:|:----------\n|               45.35 |       22,051,694.45 |    0.0% |      0.41 | `MerkleRoot`\n|               45.15 |       22,150,818.81 |    0.0% |      0.41 | `MerkleRoot`\n|               45.02 |       22,212,145.61 |    0.0% |      0.41 | `MerkleRoot`",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-06-15T09:56:14Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2025-05-14T12:32:11Z"
      },
      "sha": "4cc5942895673591de4edceb6dd0c7188c302a72"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 18154933868,
      "node_id": "HRFPE_lADOABII5862klqrzwAAAAQ6Hk5s",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18154933868",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "commit_url": "https://api.github.com/repos/l0rinc/bitcoin/commits/4cc5942895673591de4edceb6dd0c7188c302a72",
      "created_at": "2025-06-15T09:56:25Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097711372",
      "pull_request_review_id": 2853787748,
      "id": 2097711372,
      "node_id": "PRRC_kwDOABII5859CIkM",
      "diff_hunk": "@@ -66,20 +66,20 @@ uint256 ComputeMerkleRoot(std::vector<uint256> hashes, bool* mutated) {\n uint256 BlockMerkleRoot(const CBlock& block, bool* mutated)\n {\n     std::vector<uint256> leaves;\n-    leaves.resize(block.vtx.size());\n-    for (size_t s = 0; s < block.vtx.size(); s++) {\n-        leaves[s] = block.vtx[s]->GetHash();\n+    leaves.reserve((block.vtx.size() + 1) & ~1ULL); // capacity rounded up to even",
      "path": "src/consensus/merkle.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "original_commit_id": "39b6c139bd6be33699af781f1d71f6fed303d468",
      "in_reply_to_id": null,
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This assumes `size_t` is `unsigned long long` I think? Can we avoid that easily?",
      "created_at": "2025-05-20T11:25:51Z",
      "updated_at": "2025-05-20T11:34:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#discussion_r2097711372",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097711372"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 69,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097724115",
      "pull_request_review_id": 2853787748,
      "id": 2097724115,
      "node_id": "PRRC_kwDOABII5859CLrT",
      "diff_hunk": "@@ -11,16 +11,15 @@\n \n static void MerkleRoot(benchmark::Bench& bench)\n {\n-    FastRandomContext rng(true);\n-    std::vector<uint256> leaves;\n-    leaves.resize(9001);\n+    FastRandomContext rng{/*fDeterministic=*/true};\n+    std::vector<uint256> leaves(9000); // even number of leaves",
      "path": "src/bench/merkle_root.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "original_commit_id": "899e4662374e73e3b5a3fb5b22fba8e94d64a49f",
      "in_reply_to_id": null,
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Wouldn't it be better to benchmark the less-performant input?",
      "created_at": "2025-05-20T11:33:07Z",
      "updated_at": "2025-05-20T11:34:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#discussion_r2097724115",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097724115"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097725346",
      "pull_request_review_id": 2853787748,
      "id": 2097725346,
      "node_id": "PRRC_kwDOABII5859CL-i",
      "diff_hunk": "@@ -11,16 +11,15 @@\n \n static void MerkleRoot(benchmark::Bench& bench)\n {\n-    FastRandomContext rng(true);\n-    std::vector<uint256> leaves;\n-    leaves.resize(9001);\n+    FastRandomContext rng{/*fDeterministic=*/true};\n+    std::vector<uint256> leaves(9000); // even number of leaves\n     for (auto& item : leaves) {\n         item = rng.rand256();\n     }\n     bench.batch(leaves.size()).unit(\"leaf\").run([&] {\n-        bool mutation = false;\n-        uint256 hash = ComputeMerkleRoot(std::vector<uint256>(leaves), &mutation);\n-        leaves[mutation] = hash;\n+        bool mutation{false};\n+        const uint256 hash{ComputeMerkleRoot(std::vector(leaves), &mutation)};\n+        assert(mutation == false && hash == uint256{\"18ff9b2bef46a834b2625871b2839fec3b67fc1243920c424858324fbde1a8de\"});",
      "path": "src/bench/merkle_root.cpp",
      "position": null,
      "original_position": 18,
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "original_commit_id": "899e4662374e73e3b5a3fb5b22fba8e94d64a49f",
      "in_reply_to_id": null,
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "How does this avoid optimisations?",
      "created_at": "2025-05-20T11:33:49Z",
      "updated_at": "2025-05-20T11:34:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#discussion_r2097725346",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097725346"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 22,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097962172",
      "pull_request_review_id": 2854173281,
      "id": 2097962172,
      "node_id": "PRRC_kwDOABII5859DFy8",
      "diff_hunk": "@@ -11,16 +11,15 @@\n \n static void MerkleRoot(benchmark::Bench& bench)\n {\n-    FastRandomContext rng(true);\n-    std::vector<uint256> leaves;\n-    leaves.resize(9001);\n+    FastRandomContext rng{/*fDeterministic=*/true};\n+    std::vector<uint256> leaves(9000); // even number of leaves\n     for (auto& item : leaves) {\n         item = rng.rand256();\n     }\n     bench.batch(leaves.size()).unit(\"leaf\").run([&] {\n-        bool mutation = false;\n-        uint256 hash = ComputeMerkleRoot(std::vector<uint256>(leaves), &mutation);\n-        leaves[mutation] = hash;\n+        bool mutation{false};\n+        const uint256 hash{ComputeMerkleRoot(std::vector(leaves), &mutation)};\n+        assert(mutation == false && hash == uint256{\"18ff9b2bef46a834b2625871b2839fec3b67fc1243920c424858324fbde1a8de\"});",
      "path": "src/bench/merkle_root.cpp",
      "position": null,
      "original_position": 18,
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "original_commit_id": "899e4662374e73e3b5a3fb5b22fba8e94d64a49f",
      "in_reply_to_id": 2097725346,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "the `ComputeMerkleRoot` calculation has to be performed to be able to validate this assert - it's can't eliminate the call.",
      "created_at": "2025-05-20T13:21:31Z",
      "updated_at": "2025-05-20T13:28:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#discussion_r2097962172",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097962172"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 22,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097969142",
      "pull_request_review_id": 2854173281,
      "id": 2097969142,
      "node_id": "PRRC_kwDOABII5859DHf2",
      "diff_hunk": "@@ -11,16 +11,15 @@\n \n static void MerkleRoot(benchmark::Bench& bench)\n {\n-    FastRandomContext rng(true);\n-    std::vector<uint256> leaves;\n-    leaves.resize(9001);\n+    FastRandomContext rng{/*fDeterministic=*/true};\n+    std::vector<uint256> leaves(9000); // even number of leaves",
      "path": "src/bench/merkle_root.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "original_commit_id": "899e4662374e73e3b5a3fb5b22fba8e94d64a49f",
      "in_reply_to_id": 2097724115,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "After this change all call-sites are pre-sized to even number of leaves, so this reflects the usage better.\r\nI could also round to `9002` to mimic the new `leaves.reserve((9001 + 1) & ~1ULL)` behavior, if you thinks that's more representative.",
      "created_at": "2025-05-20T13:24:35Z",
      "updated_at": "2025-05-20T13:28:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#discussion_r2097969142",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097969142"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097976720",
      "pull_request_review_id": 2854173281,
      "id": 2097976720,
      "node_id": "PRRC_kwDOABII5859DJWQ",
      "diff_hunk": "@@ -66,20 +66,20 @@ uint256 ComputeMerkleRoot(std::vector<uint256> hashes, bool* mutated) {\n uint256 BlockMerkleRoot(const CBlock& block, bool* mutated)\n {\n     std::vector<uint256> leaves;\n-    leaves.resize(block.vtx.size());\n-    for (size_t s = 0; s < block.vtx.size(); s++) {\n-        leaves[s] = block.vtx[s]->GetHash();\n+    leaves.reserve((block.vtx.size() + 1) & ~1ULL); // capacity rounded up to even",
      "path": "src/consensus/merkle.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "4cc5942895673591de4edceb6dd0c7188c302a72",
      "original_commit_id": "39b6c139bd6be33699af781f1d71f6fed303d468",
      "in_reply_to_id": 2097711372,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "we could either do `size_t{1}` or `leaves.reserve(block.vtx.size() + (block.vtx.size() & 1))`, I think, if you think this could be problematic on 32 bit systems.",
      "created_at": "2025-05-20T13:27:20Z",
      "updated_at": "2025-05-20T13:29:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/32497#discussion_r2097976720",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2097976720"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/32497"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 69,
      "side": "RIGHT"
    }
  ]
}